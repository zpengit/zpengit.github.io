<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Chrome 插件推荐</title>
    <url>/2020/04/15/Chrome%E6%8F%92%E4%BB%B6%E6%8E%A8%E8%8D%90/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><h2 id="Chrome-插件推荐"><a href="#Chrome-插件推荐" class="headerlink" title="Chrome 插件推荐"></a>Chrome 插件推荐</h2><p>&emsp;&emsp;不知不觉我的chrome浏览器装了如此之多的插件，以前都没注意过，现在就简单介绍几个给大家，说明，不建议大家安装太多插件，因为会占用太多内存。&emsp;<br>&emsp;&emsp;作为一名开发人员，浏览器是我们平时用到的最多的工具之一，信很多人都在使用 Chrome 浏览器，其流畅的浏览体验得到了不少用户的偏爱，但流畅只是一方面， Chrome 最大的优势还是其支持众多强大好用的扩展程序,以下都是我正在使用或用过的，个人认为比较实用的，排名不分先后。</p>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/image-0922fde27aba486bbd9960f656ef2862.png" alt="image"></p>
<h3 id="1-IDM"><a href="#1-IDM" class="headerlink" title="1.IDM"></a>1.IDM</h3><p>&emsp;&emsp;已经记不清多久没用浏览器下载了，这是我用过的最好用的下载器，简直是神器。软件安装过时会自动安装浏览器插件。<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/image-84889e2c53f64c089a4a47f1595382a8.png" alt="image.png"><br>简单功能介绍：<br>1、批量下载<br>InternetDownloadManager支持批量下载功能，如果下载链接是有规律可循，可以用通配符*来代替变化的部分，举例如图（下载网页中的所有有图片）。</p>
<p>2、站点抓取<br>这个功能可以代替离线浏览器的功能，它可以将网站内容全部存储在你的硬盘上，以便你在离线、连接慢、链接不稳定等情况下顺利访问网站。</p>
<p>3、搭配网盘使用<br>绝大多数BT资源和磁力链接可以利用【百度网盘+IDM】来进行离线下载，离线成功，就可以像网盘资源一样高速下载了。</p>
<p>4、视频抓取<br>打开任意一个网页视频，在视频的右上解会出现IDM的嗅探按钮，点击即可一键下载。如果你嫌图标碍眼，可以在【选项】——【常规】——【自定义浏览器中的IDM浮动条】中选择迷你模式。</p>
<p>5、直播源录制<br>打开要录制的直播，可以看到视频右上角出现了IDM下载按钮，点击按钮，开始下载，还支持同时下载多个直接源！<br>这个功能非常强大，直接抓取直接播源数据，保证视频画质音质无损！该功能支持所有直接平台，斗鱼直播需要安装一个叫“斗鱼HTML5播放器”的拓展。</p>
<p>6、代理下载<br>想下载Y2B等需要代理才能访问的网站视频，在IDM【选项】——【代理服务器】中设置一下端口即可，如果在Y2B等网站无法显示浮动条，需要在【高级/socks】中勾选Socks选项，此方法支持Y2B4K视频下载。</p>
<h3 id="2-剪藏"><a href="#2-剪藏" class="headerlink" title="2.剪藏"></a>2.剪藏</h3><p>&emsp;&emsp;经常使用印象笔记来写东西，这个插件一键保存各类网页图文到印象笔记，并能随时随地查看和编辑。告别复制粘贴，高效收集信息。<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/image-2094f975130a46f2baa8af7dac95425e.png" alt="image.png"></p>
<h3 id="3-Google-Helper谷歌上网助手"><a href="#3-Google-Helper谷歌上网助手" class="headerlink" title="3. Google Helper谷歌上网助手"></a>3. Google Helper谷歌上网助手</h3><p>可以让你访问 Google、Gmail 等，装了它你就可以自由的使用 Chrome 应用商店了。下面的插件都是依靠他了。<br>插件地址：<a href="http://googlehelper.net/" target="_blank" rel="noopener">http://googlehelper.net/</a><br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/image-aa5e4a92747040f49df8fe0ffc25f288.png" alt="image.png"><br>注册登录就可以使用了。<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/image-b65b6daf002944b6991b04d3c12fd032.png" alt="image.png"></p>
<h3 id="4-WEB前端助手-FeHelper"><a href="#4-WEB前端助手-FeHelper" class="headerlink" title="4.WEB前端助手(FeHelper)"></a>4.WEB前端助手(FeHelper)</h3><p><a href="https://chrome.google.com/webstore/detail/fehelper%E5%89%8D%E7%AB%AF%E5%8A%A9%E6%89%8B/pkgccpejnmalmdinmhkkfafefagiiiad/related" target="_blank" rel="noopener">FeHelper(前端助手)</a><br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/image-e949ec92dd0547ceae0875bbf940631d.png" alt="image.png"><br>扩展功能：</p>
<p>JSON自动美化（页面自动检测并格式化）<br>JSON手动美化（粘贴文本、手动格式化）<br>JSON比对工具（支持左右两个JSON片段进行键值对比较）<br>字符串编解码（Unicode/UTF8/Base64/MD5/HEX）<br>代码美化工具（HTML/CSS/JS/XML/SQL）<br>代码压缩工具（HTML/CSS/JS）<br>简易Postman（Api接口测试，模拟HEAD/GET/POST方式）<br>二维码生成器（支持当前页面、图片、链接、选中的文字生成QrCode）<br>二维码解码器（支持网页二维码右键解码）<br>网页转为图片（将当前整个网页转为图片并保存）<br>Markdown转换（支持Html到Markdown的互转）<br>页面取色工具（滑动鼠标随意取色）<br>Js正则表达式（正则测试、常用正则列表）<br>时间(戳)转换（Unix戳与本地时间的互转）<br>图片Base64（任意图片转DataURI格式）<br>随机密码生成（任意长度、任意字符、随机）<br>编码规范检测（HTML/CSS/JS规范检测）<br>页面性能检测（页面响应时间、Header监测）<br>页面栅格标尺（页面栅格化、屏幕标尺）<br>Ajax调试功能（需在控制台中使用）<br>网页油猴工具（网页特效、网页定制、脚本注入、自动刷新等）<br>网页编码设置（UTF-8、GBK、日文、韩文等）<br>我的便签笔记（便签笔记，支持导出）<br>下载/分享插件（在商店下载任意扩展文件）<br>人像背景移除（将人物照片中的背景移除：抠图工具）<br>多维小工具集（进制转换、颜色转换、还款计算器、Crontab等）</p>
<h3 id="5-OneTab"><a href="#5-OneTab" class="headerlink" title="5.OneTab"></a>5.OneTab</h3><p>节省高达95％的内存，并减轻标签页混乱现象<br>当您发现自己有太多的标签页时，单击OneTab图标，将所有标签页转换成一个列表。当您需要再次访问这些标签页时，可以单独或全部恢复它们。</p>
<p>当您的标签页位于OneTab列表时，您将节省高达95％的内存，因为你将减少Google Chrome浏览器中打开的标签页的数量。<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/image-61a29bc513d144ceb70f561a77307162.png" alt="image.png"></p>
<h3 id="6-Tampermonkey"><a href="#6-Tampermonkey" class="headerlink" title="6.Tampermonkey"></a>6.Tampermonkey</h3><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/image-e297b02825fd47f9829efe99e0b70b6b.png" alt="image.png"><br>&emsp;&emsp;神器，哈哈。　Tampermonkey 是最受欢迎的用户脚本管理器。<br>用户脚本集合：<a href="https://greasyfork.org/zh-CN/scripts" target="_blank" rel="noopener">https://greasyfork.org/zh-CN/scripts</a><br>啥也不说，先放截图：<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/image-d63cda1fd884493d925ad092a1caf380.png" alt="image.png"></p>
<h3 id="7-Infinity-新标签页"><a href="#7-Infinity-新标签页" class="headerlink" title="7.Infinity 新标签页"></a>7.Infinity 新标签页</h3><p><a href="https://chrome.google.com/webstore/detail/infinity-new-tab-producti/dbfmnekepjoapopniengjbcpnbljalfg" target="_blank" rel="noopener">Infinity 新标签页</a><br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/image-45e70089ddca41c3a25951144d9bb5bd.png" alt="image.png"><br>&emsp;&emsp;百万用户选择的新标签页，自由添加网站图标，云端高清壁纸，快速访问书签、天气、笔记、待办事项、扩展管理与历史记录。</p>
<h3 id="8-Fatkun图片批量下载"><a href="#8-Fatkun图片批量下载" class="headerlink" title="8.Fatkun图片批量下载"></a>8.Fatkun图片批量下载</h3><p><a href="https://chrome.google.com/webstore/detail/fatkun-batch-download-ima/nnjjahlikiabnchcpehcpkdeckfgnohf/related" target="_blank" rel="noopener">Fatkun图片批量下载</a></p>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/image-1cc6d2647782455ca801ecd30219911a.png" alt="image.png"><br>&emsp;&emsp;可能大多数人用不上，我喜欢收集图片哈哈<br>找出当前页面的所有图片，提供按分辨率、链接等筛选图片，做一个简单好用的下载图片扩展！<br>只需点击一下，即可下载页面上选择的所有图像。</p>
<p>可以使用你自己的规则下载图像列表。</p>
<p>可以批量重命名下载的图像</p>
<h3 id="9-AdGuard-广告拦截器"><a href="#9-AdGuard-广告拦截器" class="headerlink" title="9.AdGuard 广告拦截器"></a>9.AdGuard 广告拦截器</h3><p><a href="https://chrome.google.com/webstore/detail/adguard-adblocker/bgnkhhnnamicmpeenaelnjfhikgbkllg/related" target="_blank" rel="noopener">AdGuard 广告拦截器</a><br>&emsp;&emsp;一款无与伦比的广告拦截扩展，用以对抗各式广告与弹窗。可以拦截 Facebook、YouTube 和其它所有网站的广告。<br>AdGuard 广告拦截器可有效的拦截所有网页上的所有类型的广告，甚至是在 Facebook、Youtube 以及其他万千网站上的广告！</p>
<p>AdGuard AdBlocker 可以：</p>
<ol>
<li>拦截所有广告，包括：</li>
</ol>
<ul>
<li>视频广告（包括 Youtube 视频广告）</li>
<li>各种媒体广告，例如视频广告，插播广告和浮动广告</li>
<li>令人讨厌的弹窗</li>
<li>横幅广告和文字广告（包括 Facebook 广告）</li>
</ul>
<ol start="2">
<li>加速页面载入，节省带宽，屏蔽广告和弹窗</li>
<li>拦截各种间谍软件，广告软件和拨号安装程序（可选）</li>
<li>通过拦截常见第三方跟踪系统保护您的隐私（可选）</li>
<li>保护您对抗恶意和钓鱼攻击（可选）</li>
</ol>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/image-3573ad76c93c4e78a4bac9a2c6918342.png" alt="image.png"></p>
<h3 id="10-扩展管理器（Extension-Manager）"><a href="#10-扩展管理器（Extension-Manager）" class="headerlink" title="10.扩展管理器（Extension Manager）"></a>10.扩展管理器（Extension Manager）</h3><p>插件太多啦！那就需要一个插件来管理插件啦！<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/image-6f19798c05404caa81ef1a33264e7ac0.png" alt="image.png"><br>一键管理所有扩展，快速开启/禁用、批量闪电管理，智能排序，右键卸载、锁定、选项配置，角标提醒，大小布局随心配。快捷、简单、安全。<br>一键开启/禁用扩展</p>
<ol>
<li>闪电分组：根据场景快速开启/禁用扩展组（被锁定或主题类扩展除外）</li>
<li>智能排序：可根据您的使用频率智能排序（默认根据名称排序）</li>
<li>右键菜单：提供锁定、卸载、选项配置、主页、APP运行等快捷功能</li>
<li>智能搜索：通过关键字或词组快速找到需要的扩展</li>
<li>角标提醒：实时显示扩展状态，用完后提醒重置，减少资源占用（被锁定或主题类扩展除外）</li>
<li>视图选择：提供列表视图和网格视图，符合用户习惯</li>
<li>分组管理：普通分组和固定分组，灵活管理</li>
<li>扩展命名：给扩展起一个你喜欢的别名</li>
<li>自动匹配：可以根据不同的网站开启和关闭扩展<h3 id="11-其他"><a href="#11-其他" class="headerlink" title="11.其他"></a>11.其他</h3><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/image-a68938571b3647b8b2cf7e6b2b333d6d.png" alt="image.png"></li>
</ol>
<p>chrome浏览器的插件也是相当的多，非常的方便，不经常用的可以暂时不启用。有兴趣的可以自己找找哟</p>
]]></content>
      <categories>
        <category>前端</category>
      </categories>
      <tags>
        <tag>Chrome</tag>
        <tag>插件</tag>
      </tags>
  </entry>
  <entry>
    <title>Github上那些Java面试、学习相关仓库</title>
    <url>/2020/04/13/Github%E4%B8%8A%E9%82%A3%E4%BA%9BJava%E9%9D%A2%E8%AF%95%E3%80%81%E5%AD%A6%E4%B9%A0%E7%9B%B8%E5%85%B3%E4%BB%93%E5%BA%93/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><h3 id="1-JavaGuide"><a href="#1-JavaGuide" class="headerlink" title="1.JavaGuide"></a>1.JavaGuide</h3><p>•Github地址： <a href="https://github.com/Snailclimb/JavaGuide" target="_blank" rel="noopener">https://github.com/Snailclimb/JavaGuide</a> 64.0k• 介绍: 【Java学习+面试指南】 一份涵盖大部分Java程序员所需要掌握的核心知识。</p>
<h3 id="2-CS-Notes"><a href="#2-CS-Notes" class="headerlink" title="2.CS-Notes"></a>2.CS-Notes</h3><p>•Github 地址：<a href="https://github.com/CyC2018/CS-Notes" target="_blank" rel="noopener">https://github.com/CyC2018/CS-Notes</a> [2]•Star: 68.3k•介绍: 技术面试必备基础知识、Leetcode 题解、后端面试、Java 面试、春招、秋招、操作系统、计算机网络、系统设计。</p>
<h3 id="3-advanced-java"><a href="#3-advanced-java" class="headerlink" title="3.advanced-java"></a>3.advanced-java</h3><p>•Github地址：<a href="https://github.com/doocs/advanced-java" target="_blank" rel="noopener">https://github.com/doocs/advanced-java</a> [3]•star: 23.4k•介绍: 互联网 Java 工程师进阶知识完全扫盲：涵盖高并发、分布式、高可用、微服务等领域知识，后端同学必看，前端同学也可学习。</p>
<h3 id="4-JCSprout"><a href="#4-JCSprout" class="headerlink" title="4.JCSprout"></a>4.JCSprout</h3><p>•Github地址：<a href="https://github.com/crossoverJie/JCSprout" target="_blank" rel="noopener">https://github.com/crossoverJie/JCSprout</a> [4]•star: 21.2k•介绍: Java Core Sprout：处于萌芽阶段的 Java 核心知识库。</p>
<h3 id="5-technology-talk"><a href="#5-technology-talk" class="headerlink" title="5.technology-talk"></a>5.technology-talk</h3><p>•Github地址： <a href="https://github.com/aalansehaiyang/technology-talk[5]•star" target="_blank" rel="noopener">https://github.com/aalansehaiyang/technology-talk[5]•star</a>: 6.1k•介绍: 汇总java生态圈常用技术框架、开源中间件，系统架构、项目管理、经典架构案例、数据库、常用三方库、线上运维等知识。</p>
<h3 id="6-Linux-Tutorial"><a href="#6-Linux-Tutorial" class="headerlink" title="6.Linux-Tutorial"></a>6.Linux-Tutorial</h3><p>后端（尤其是Java）程序员的 Linux 学习仓库-Linux-Tutorial：<a href="https://github.com/judasn/Linux-Tutorial" target="_blank" rel="noopener">https://github.com/judasn/Linux-Tutorial</a> ( Star:4.6k)</p>
]]></content>
      <categories>
        <category>面试题</category>
      </categories>
      <tags>
        <tag>github</tag>
      </tags>
  </entry>
  <entry>
    <title>Dubbo</title>
    <url>/2020/03/28/Dubbo/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><h1 id="Dubbo"><a href="#Dubbo" class="headerlink" title="Dubbo"></a>Dubbo</h1><h2 id="1-1-SOA思想"><a href="#1-1-SOA思想" class="headerlink" title="1.1 SOA思想"></a>1.1 SOA思想</h2><h3 id="1-1-1-SOA介绍"><a href="#1-1-1-SOA介绍" class="headerlink" title="1.1.1 SOA介绍"></a>1.1.1 SOA介绍</h3><p><strong>SOA</strong> （面向服务的架构）<br/><br>  面向服务的架构（SOA）是一个组件模型，它将应用程序的不同功能单元（称为服务）进行拆分，并通过这些服务之间定义良好的接口和协议联系起来。接口是采用中立的方式进行定义的，它应该独立于实现服务的硬件平台、操作系统和编程语言。这使得构件在各种各样的系统中的服务可以以一种统一和通用的方式进行交互。</p>
<hr>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-ae856a7313ea47bd8f74c64d9fa6222a.png" alt="image.png"></p>
<h2 id="1-2-RPC协议"><a href="#1-2-RPC协议" class="headerlink" title="1.2 RPC协议"></a>1.2 RPC协议</h2><h3 id="1-2-1-RPC介绍"><a href="#1-2-1-RPC介绍" class="headerlink" title="1.2.1 RPC介绍"></a>1.2.1 RPC介绍</h3><p>  RPC是远程过程调用（Remote Procedure Call）的缩写形式。SAP系统RPC调用的原理其实很简单，有一些类似于三层构架的C/S系统，第三方的客户程序通过接口调用SAP内部的标准或自定义函数，获得函数返回的数据进行处理后显示或打印。<br/><br>  RPC:实现系统之间的通信,用户不需要了解底层原理.</p>
<h3 id="1-1-2-RPC与HTTP区别"><a href="#1-1-2-RPC与HTTP区别" class="headerlink" title="1.1.2 RPC与HTTP区别"></a>1.1.2 RPC与HTTP区别</h3><p>网络7层协议如图所示.</p>
<hr>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-f5538a7b128f47afba3045baa6e87bf5.png" alt="image.png"></p>
<p>层级关系与对应的协议.</p>
<hr>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-c655388dc2494930aa4790fbba69eee7.png" alt="image.png"></p>
<p>区别:<br/><br>  1.RPC是传输层协议(4层).而HTTP协议是应用层协议(7层).<br/><br>  2.RPC协议可以直接调用中立接口,HTTP协议不可以.<br/><br>  3.RPC通信协议是长链接,HTTP协议一般采用短连接需要3次握手(可以配置长链接添加请求头Keep-Alive: timeout=20).(长连接，指在一个连接上可以连续发送多个数据包，在连接保持期间，如果没有数据包发送，需要双方发链路检测包。)<br/><br>  4.RPC协议传递数据是加密压缩传输.HTTP协议需要传递大量的请求头信息.<br/><br>  5.RPC协议一般都有注册中心.有丰富的监控机制.<br/></p>
<h2 id="1-3-Dubbo"><a href="#1-3-Dubbo" class="headerlink" title="1.3 Dubbo"></a>1.3 Dubbo</h2><h3 id="1-3-1-Dubbo介绍"><a href="#1-3-1-Dubbo介绍" class="headerlink" title="1.3.1 Dubbo介绍"></a>1.3.1 Dubbo介绍</h3><p>   Apache Dubbo |ˈdʌbəʊ| 是一款高性能、轻量级的开源Java RPC框架，它提供了三大核心能力：面向接口的远程方法调用，智能容错和负载均衡，以及服务自动注册和发现。<br>   Dubbo(读音[ˈdʌbəʊ])是阿里巴巴公司开源的一个高性能优秀的服务框架，使得应用可通过高性能的 RPC 实现服务的输出和输入功能，可以和 [1]  Spring框架无缝集成。<br><a href="http://dubbo.apache.org/en-us/" target="_blank" rel="noopener" title="http://dubbo.apache.org/en-us/">http://dubbo.apache.org/en-us/</a></p>
<h3 id="1-3-2-Dubbo调用原理"><a href="#1-3-2-Dubbo调用原理" class="headerlink" title="1.3.2 Dubbo调用原理"></a>1.3.2 Dubbo调用原理</h3><hr>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-6c7a6b6179be4349b18d174583961183.png" alt="image.png"></p>
<hr>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-88b29022ac3148cf8390805f527708e0.png" alt="image.png"></p>
<h2 id="1-4-Dubbo负载均衡算法"><a href="#1-4-Dubbo负载均衡算法" class="headerlink" title="1.4 Dubbo负载均衡算法"></a>1.4 Dubbo负载均衡算法</h2><h3 id="1-4-1-Nginx负载均衡机制"><a href="#1-4-1-Nginx负载均衡机制" class="headerlink" title="1.4.1 Nginx负载均衡机制"></a>1.4.1 Nginx负载均衡机制</h3><p>说明:nginx是服务端负载均衡,所有的请求都会由nginx实现负载.</p>
<hr>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-925dac6ef8b3409db365d2480b0cb6a6.png" alt="image.png"></p>
<h3 id="1-4-2-Dubbo的负载均衡模式"><a href="#1-4-2-Dubbo的负载均衡模式" class="headerlink" title="1.4.2 Dubbo的负载均衡模式"></a>1.4.2 Dubbo的负载均衡模式</h3><p>dubbo采用客户端负载均衡机制,并且是正向代理.</p>
<hr>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-0573b98f88c2453f8ece46a0e497d2f0.png" alt="image.png"></p>
<p>1.6.3    随机机制<br>说明:dubbo默认采用的负载均衡算法为随机.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Reference</span>(timeout=<span class="number">3000</span>,check=<span class="keyword">false</span>,</span><br><span class="line">		loadbalance = <span class="string">"random"</span>)</span><br><span class="line"><span class="keyword">private</span> UserService userService;</span><br></pre></td></tr></table></figure>

<p>1.6.4    轮循算法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Reference</span>(timeout=<span class="number">3000</span>,check=<span class="keyword">false</span>,</span><br><span class="line">			loadbalance = <span class="string">"roundrobin"</span>)</span><br><span class="line">	<span class="keyword">private</span> UserService userService;</span><br></pre></td></tr></table></figure>
<p>1.6.5    IPHASH算法<br>说明:根据IP绑定服务器.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Reference</span>(timeout=<span class="number">3000</span>,check=<span class="keyword">false</span>,</span><br><span class="line">		loadbalance = <span class="string">"consistenthash"</span>)</span><br><span class="line"><span class="keyword">private</span> UserService userService;</span><br></pre></td></tr></table></figure>
<p>1.6.6    最小访问量机制<br>说明:根据当前服务器的最小访问量实现负载均衡.(压力小先访问)</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Reference</span>(timeout=<span class="number">3000</span>,check=<span class="keyword">false</span>,</span><br><span class="line">		loadbalance = <span class="string">"leastactive"</span>)</span><br><span class="line"><span class="keyword">private</span> UserService userService;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>后端</category>
      </categories>
      <tags>
        <tag>Dubbo</tag>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>Mybatis 原理分析</title>
    <url>/2020/03/20/Mybatis%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><h1 id="Mybatis-原理分析"><a href="#Mybatis-原理分析" class="headerlink" title="Mybatis 原理分析"></a>Mybatis 原理分析</h1><h2 id="1-MYBATIS-框架核心基础"><a href="#1-MYBATIS-框架核心基础" class="headerlink" title="1.MYBATIS 框架核心基础"></a>1.MYBATIS 框架核心基础</h2><h3 id="1-1-MYBATIS-架构分析"><a href="#1-1-MYBATIS-架构分析" class="headerlink" title="1.1.MYBATIS 架构分析"></a>1.1.MYBATIS 架构分析</h3><h4 id="1-1-1-Mybatis-应用架构-重点"><a href="#1-1-1-Mybatis-应用架构-重点" class="headerlink" title="1.1.1.Mybatis 应用架构(重点)"></a>1.1.1.Mybatis 应用架构(重点)</h4><p>  MyBatis 本是apache的一个开源项目iBatis, 2010年这个项目由apache software foundation 迁移到了google code，并且改名为MyBatis 。2013年11月迁移到Github。<br/><br>  iBATIS一词来源于“internet”和“abatis”的组合，是一个基于Java的持久层框架。iBATIS提供的持久层框架包括SQL Maps和Data Access Objects（DAOs）<br/><br>  当前，最新版本是MyBatis 3.5.3 ，其发布时间是2019年10月20日。<br/><br>  谈谈对mybatis的应用架构的理解？<br/><br>  MyBatis 是一个优秀的持久层框架，实现了对JDBC操作（标准API）的封装，主要用于传统简化JDBC操作中的一些相对繁琐的步骤，例如参数的映射，结果集的映射（数据库中记录存储到内存中的对象中）等。</p>
<hr>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-560a50a7839f4872849ab1ccbfad6469.png" alt="image.png"></p>
<p>为何使用mybatis实现数据持久层应用？<br/><br>  1)第一稳定，灵活（动态SQL），功能强大(池，日志，缓存)<br/><br>  2)学习以及使用成本低<br/><br>  3)解耦，SQL的可维护性，可复用性比较高。<br/><br>说明:mybatis官网参考<br/><br>  1)mybatis.org/mybatis-3<br/><br>  2)github.com/mybatis<br/><br>  <a href="http://www.mybatis.org/spring/" target="_blank" rel="noopener">http://www.mybatis.org/spring/</a><br/></p>
<h4 id="1-1-2-Mybatis-产品架构"><a href="#1-1-2-Mybatis-产品架构" class="headerlink" title="1.1.2.Mybatis 产品架构"></a>1.1.2.Mybatis 产品架构</h4><p>  所有框架都要解决一些共性问题（持久化），都是一种半成品，mybatis也不例外，它作为一种框架，它要解决相关问题，如何解决问题？采用怎样的架构解决问题，这是我们要学习的一个点。<br/></p>
<hr>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-ce73a35989d24609bea1e690e4fefbe8.png" alt="image.png">)<img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://182.92.171.224/upload/20191123_11104417.png" alt=""><br>思考:mybatis作为一个持久层框架,应该解决哪些功能性问题?<br/><br>  1)会话功能 (SqlSession)<br/><br>  2)会话语言 (SQL,动态SQL)<br/><br>  3)会话协议 (TCP)<br/><br>  4)用户体验 (连接池,缓存,日志)<br/></p>
<h4 id="1-1-3-MyBatis-技术架构"><a href="#1-1-3-MyBatis-技术架构" class="headerlink" title="1.1.3.MyBatis 技术架构"></a>1.1.3.MyBatis 技术架构</h4><hr>
<p>Mybatis 框架”构成”分析,如下图所示:</p>
<hr>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-a20f8c95d3b9434ebc3b31b227e67ad1.png" alt="image.png"></p>
<p>资源配置技术架构,如下图所示:</p>
<hr>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-06be9ff35c7c4e91b120bcd7037e6724.png" alt="image.png"></p>
<p>会话工厂对象创建(说说SqlSessionFactory对象的创建过程),如下图所示:</p>
<hr>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-bcc803a719c34a9ba811d459227e8a5b.png" alt="image.png"></p>
<p>会话对象创建？(说说sqlsession对象创建过程),如下图所示:</p>
<hr>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-b694dc22593a49fba51c7e8e797825fc.png" alt="image.png"></p>
<p>会话对象应用方式,如下图所示:</p>
<hr>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-a42b6b7b51a644f5b2e4d05d2ab4e37d.png" alt="image.png"></p>
<h3 id="1-2-MYBATIS-环境配置实践"><a href="#1-2-MYBATIS-环境配置实践" class="headerlink" title="1.2.MYBATIS 环境配置实践"></a>1.2.MYBATIS 环境配置实践</h3><h4 id="1-2-1-初始化数据环境"><a href="#1-2-1-初始化数据环境" class="headerlink" title="1.2.1.初始化数据环境"></a>1.2.1.初始化数据环境</h4><p>本次数据初始化直接在mysql的命令行执行:<br/><br>1.启动系统命令行控制台<br/><br>2.登陆数据库:mysql -u root -p<br/><br>3.设置客户端编码：set names utf8<br/><br>4.导入数据：source d:/xxx.sql<br/><br>说明：查询时，假如有中文要显示，可先执行set names gbk.<br/></p>
<h4 id="1-2-2-创建并配置项目"><a href="#1-2-2-创建并配置项目" class="headerlink" title="1.2.2.创建并配置项目"></a>1.2.2.创建并配置项目</h4><p>1.打开IDE并进行配置(新的工作区)<br/><br>1)配置工作区编码(utf-8)<br/><br/><br>2)配置maven环境(本地库,私服配置)<br/></p>
<p>2.创建maven项目并添加依赖<br/><br/><br>项目名称:CGB-MYBATIS-01<br/><br>打包方式:jar包<br/><br>组id:com.cy<br/></p>
<p>MySQL驱动依赖(假如驱动版本与当前数据库不一致可能会有问题)</p>
<pre><code>&lt;dependency&gt;
     &lt;groupId&gt;mysql&lt;/groupId&gt;
   &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;
     &lt;version&gt;8.0.17&lt;/version&gt;
 &lt;/dependency&gt;</code></pre><p>Mybatis 框架依赖（参考官方 mybatis.org/mybatis-3）</p>
<pre><code>&lt;dependency&gt;
    &lt;groupId&gt;org.mybatis&lt;/groupId&gt;
    &lt;artifactId&gt;mybatis&lt;/artifactId&gt;
    &lt;version&gt;3.5.2&lt;/version&gt;
&lt;/dependency&gt;</code></pre><p>Junit单元测试依赖</p>
<pre><code>&lt;dependency&gt;
          &lt;groupId&gt;junit&lt;/groupId&gt;
          &lt;artifactId&gt;junit&lt;/artifactId&gt;
          &lt;version&gt;4.12&lt;/version&gt;
      &lt;/dependency&gt;</code></pre><p>说明:学了spring boot以后还有一种测试方式<br/><br>3.配置项目<br/><br>在src/main/resources目录下创建mybatis-configs.xml配置文件如下：</p>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;!DOCTYPE configuration
  PUBLIC &quot;-//mybatis.org//DTD Config 3.0//EN&quot;
  &quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;&gt;
&lt;!-- mybatis 核心配置 --&gt;
&lt;configuration&gt;
  &lt;!-- 配置初始化环境(连接) --&gt;
  &lt;environments default=&quot;development&quot;&gt;
    &lt;environment id=&quot;development&quot;&gt;
      &lt;transactionManager type=&quot;JDBC&quot;/&gt;
      &lt;!-- 使用mybatis自带连接池 --&gt;
      &lt;dataSource type=&quot;POOLED&quot;&gt;
        &lt;property name=&quot;driver&quot; value=&quot;com.mysql.jdbc.Driver&quot;/&gt;
        &lt;property name=&quot;url&quot;  value=&quot;jdbc:mysql:///dbgoods?serverTimezone=GMT&quot;/&gt;
        &lt;property name=&quot;username&quot; value=&quot;root&quot;/&gt;
        &lt;property name=&quot;password&quot; value=&quot;root&quot;/&gt;
      &lt;/dataSource&gt;
    &lt;/environment&gt;
  &lt;/environments&gt;
&lt;/configuration&gt;</code></pre><p>其模板：参考官方配置实现（Getting start ）</p>
<h4 id="1-2-3-项目环境单元测试"><a href="#1-2-3-项目环境单元测试" class="headerlink" title="1.2.3.项目环境单元测试"></a>1.2.3.项目环境单元测试</h4><p>在测试包中，创建测试类，测试是否可以获取与数据库的连接<br/></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestBase</span> </span>&#123;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 借助此对象创建SqlSession(通过此对象</span></span><br><span class="line"><span class="comment">	 * 实现与数据库之间的会话)</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">protected</span> SqlSessionFactory factory;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 此方会在<span class="doctag">@Test</span>注解修饰的方法之前执行,</span></span><br><span class="line"><span class="comment">     * 通常用于做一些初始化操作(方法名自己定义)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">	<span class="meta">@Before</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span><span class="keyword">throws</span> IOException</span>&#123;</span><br><span class="line">		InputStream in=</span><br><span class="line">Resources.getResourceAsStream(<span class="string">"mybatis-configs.xml"</span>);</span><br><span class="line">		factory=<span class="keyword">new</span> SqlSessionFactoryBuilder().build(in);</span><br><span class="line">		<span class="comment">//系统底层建造者模式构建工厂对象(此对象构建过程相对复杂)</span></span><br><span class="line">		System.out.println(factory);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSqlSessionConnection</span><span class="params">()</span></span>&#123;</span><br><span class="line">		SqlSession session=factory.openSession();</span><br><span class="line">		Connection conn=session.getConnection();</span><br><span class="line">		System.out.println(conn);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>API 创建过程分析:</p>
<hr>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-dc8bb262568b4dea95913f0c517f4486.png" alt="image.png"></p>
<h3 id="1-3-MYBATIS业务应用快速实践"><a href="#1-3-MYBATIS业务应用快速实践" class="headerlink" title="1.3.MYBATIS业务应用快速实践"></a>1.3.MYBATIS业务应用快速实践</h3><p>参考官网：<a href="http://www.mybatis.org/mybatis-3" target="_blank" rel="noopener">www.mybatis.org/mybatis-3</a> 实现对商品模块数据的CRUD操作。</p>
<h4 id="1-3-1-基于业务实现"><a href="#1-3-1-基于业务实现" class="headerlink" title="1.3.1.基于业务实现"></a>1.3.1.基于业务实现</h4><p>添加业务实现(以添加商品信息为例进行实现)<br/><br>第一步：编写pojo对象(com.cy.pj.goods.pojo.Goods),<br/><br>借助此对象存储内存中的数据,最后将内存中的数据持久化到数据库.<br/></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cy.pj.goods.pojo;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * POJO:借助此对象在内存中封装商品信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Goods</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">6239917530570596544L</span>;</span><br><span class="line">	<span class="keyword">private</span> Long id;</span><br><span class="line">	<span class="keyword">private</span> String name;</span><br><span class="line">	<span class="keyword">private</span> String remark;</span><br><span class="line">	<span class="keyword">private</span> Date createdTime;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Long <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> id;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.id = id;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> name;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.name = name;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getRemark</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> remark;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRemark</span><span class="params">(String remark)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.remark = remark;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Date <span class="title">getCreatedTime</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> createdTime;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCreatedTime</span><span class="params">(Date createdTime)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.createdTime = createdTime;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第二步:编写映射文件(mapper/GoodsMapper.xml),实现内存中对象(一般是pojo对象)与数据库表的映射(例如属性与字段进行映射)</p>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;!DOCTYPE mapper
  PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;
  &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;
&lt;mapper namespace=&quot;com.cy.pj.goods.dao.GoodsDao&quot;&gt;
    &lt;insert id=&quot;insertObject&quot;
            parameterType=&quot;com.cy.pj.goods.pojo.Goods&quot;&gt;
        insert into tb_goods
        (id,name,remark,createdTime)
        values
        (#{id},#{name},#{remark},now())
    &lt;/insert&gt;
&lt;/mapper&gt;</code></pre><p>第三步:注册映射文件(mybatis-configs.xml)，在配置文件中添加如下语句：</p>
<pre><code>&lt;mappers&gt;
     &lt;mapper resource=&quot;mapper/GoodsMapper.xml&quot;/&gt;
  &lt;/mappers&gt;\</code></pre><p>第四步:定义单元测试类(TestGoodsDao)及方法进行单元测试</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.test;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSession;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> com.cy.pj.goods.pojo.Goods;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestGoodsDao01</span> <span class="keyword">extends</span> <span class="title">TestBaseWithXml</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testInsertObject</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="comment">//1.创建Goods对象</span></span><br><span class="line">		Goods g=<span class="keyword">new</span> Goods();</span><br><span class="line">		g.setId(<span class="number">14L</span>);</span><br><span class="line">		g.setName(<span class="string">"IO"</span>);</span><br><span class="line">		g.setRemark(<span class="string">"IO..."</span>);</span><br><span class="line">		<span class="comment">//2.将Goods对象写入到数据库</span></span><br><span class="line">		<span class="comment">//2.1获取SqlSession对象</span></span><br><span class="line">		SqlSession session=</span><br><span class="line">		sqlSessionFactory.openSession();</span><br><span class="line">		<span class="comment">//2.2将对象持久化</span></span><br><span class="line">		String statement=<span class="string">"com.cy.pj.goods.dao.GoodsDao.insertObject"</span>;</span><br><span class="line">		<span class="keyword">int</span> rows=session.insert(statement, g);</span><br><span class="line">		System.out.println(<span class="string">"insert.rows=+"</span>+rows);</span><br><span class="line">		<span class="comment">//2.3提交事务</span></span><br><span class="line">		session.commit();</span><br><span class="line">		<span class="comment">//2.4释放资源</span></span><br><span class="line">		session.close();</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>修改业务实现(以修改商品信息为例进行实现)<br/><br>第一步：修改映射文件(mapper/GoodsMapper.xml),添加update元素实现信息修改操作语句的定义.</p>
<pre><code>&lt;update id=&quot;updateObject&quot;&gt;
    update tb_goods
    set name=#{name},
        remark=#{remark}
    where id=#{id}
&lt;/update&gt;</code></pre><p>第二步:修改单元测试类(TestGoodsDao01),添加修改测试方法.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testUpdateObject</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="comment">//1.创建Goods对象</span></span><br><span class="line">		Goods g=<span class="keyword">new</span> Goods();</span><br><span class="line">		g.setId(<span class="number">14L</span>);</span><br><span class="line">		g.setName(<span class="string">"Thread"</span>);</span><br><span class="line">		g.setRemark(<span class="string">"Thread..."</span>);</span><br><span class="line">		<span class="comment">//2.将Goods对象写入到数据库</span></span><br><span class="line">		<span class="comment">//2.1获取SqlSession对象</span></span><br><span class="line">		SqlSession session=</span><br><span class="line">				sqlSessionFactory.openSession();</span><br><span class="line">		<span class="comment">//2.2将对象持久化</span></span><br><span class="line">		String statement=<span class="string">"com.cy.pj.goods.dao.GoodsDao.updateObject"</span>;</span><br><span class="line">		<span class="keyword">int</span> rows=session.update(statement, g);</span><br><span class="line">		System.out.println(<span class="string">"update.rows=+"</span>+rows);</span><br><span class="line">		<span class="comment">//2.3提交事务</span></span><br><span class="line">		session.commit();</span><br><span class="line">		<span class="comment">//2.4释放资源</span></span><br><span class="line">		session.close();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>1)删除业务实现(以删除作者信息为例进行实现)<br/><br>step01:修改映射文件(mapper/GoodsMapper.xml),添加delete元素,实现基于id进行删除操作语句的定义.</p>
<pre><code>&lt;delete id=&quot;deleteById&quot;&gt;
      delete from tb_goods
      where id=#{id}
 &lt;/delete&gt;</code></pre><p>step02:修改单元测试类(TestGoodsDao01),添加删除测试方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDeleteById</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="comment">//1.获取session对象</span></span><br><span class="line">		SqlSession session = </span><br><span class="line">		sqlSessionFactory.openSession();</span><br><span class="line">		<span class="comment">//2.执行删除操作</span></span><br><span class="line">		String statement=</span><br><span class="line">		<span class="string">"com.cy.pj.goods.dao.GoodsDao.deleteById"</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="keyword">int</span> rows=session.delete(statement, <span class="number">10</span>);</span><br><span class="line">		System.out.println(<span class="string">"delete.rows="</span>+rows);</span><br><span class="line">		<span class="comment">//3.提交事务</span></span><br><span class="line">		session.commit();</span><br><span class="line">		<span class="comment">//4.释放资源</span></span><br><span class="line">		&#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">		session.close();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>2)查询业务实现(以查询某个商品信息为例进行实现)<br/><br>step01:修改映射文件(mapper/GoodsMapper.xml),添加select元素,实现基于id查询作者信息语句的定义.</p>
<pre><code>&lt;select id=&quot;selectById&quot;
         resultType=&quot;com.cy.pj.goods.pojo.Goods&quot;&gt;
    select id,name,remark,createdTime
    from tb_goods
    where id=#{id}
 &lt;/select&gt;</code></pre><p>step02:修改单元测试类(TestGoodsDao01),添加基于id执行查询的操作</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSelectById</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="comment">//1.获取session对象</span></span><br><span class="line">		SqlSession session = </span><br><span class="line">				sqlSessionFactory.openSession();</span><br><span class="line">		<span class="comment">//2.执行删除操作</span></span><br><span class="line">		String statement=</span><br><span class="line">				<span class="string">"com.cy.pj.goods.dao.GoodsDao.selectById"</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Goods g=session.selectOne(statement,<span class="number">11</span>);</span><br><span class="line">			System.out.println(g);</span><br><span class="line">			<span class="comment">//3.提交事务</span></span><br><span class="line">			session.commit();</span><br><span class="line">			<span class="comment">//4.释放资源</span></span><br><span class="line">		&#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">			session.close();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>3)分页查询实现(以查询多个商品信息为例进行实现)<br/><br>step01:修改映射文件(mapper/GoodsMapper.xml),添加select元素,实现基于分页条件查询作者信息语句的定义.</p>
<pre><code>&lt;select id=&quot;findPageObjects&quot;
            resultType=&quot;com.cy.pj.goods.pojo.Goods&quot;&gt;
         select *
         from tb_goods
         limit #{startIndex},#{pageSize}
    &lt;/select&gt;</code></pre><p>step02:修改单元测试类(TestGoodsDao01),添加基于分页条件执行查询.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testFindPageObjects</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="comment">//1.获取session对象</span></span><br><span class="line">		SqlSession session = </span><br><span class="line">		sqlSessionFactory.openSession();</span><br><span class="line">		<span class="comment">//2.执行删除操作</span></span><br><span class="line">		String statement=</span><br><span class="line">		<span class="string">"com.cy.pj.goods.dao.GoodsDao.findPageObjects"</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">		Map&lt;String,Object&gt; map=<span class="keyword">new</span> HashMap&lt;String,Object&gt;();</span><br><span class="line">		map.put(<span class="string">"startIndex"</span>, <span class="number">0</span>);</span><br><span class="line">		map.put(<span class="string">"pageSize"</span>, <span class="number">3</span>);</span><br><span class="line">		List&lt;Goods&gt; list=</span><br><span class="line">		session.selectList(statement,map); </span><br><span class="line">		System.out.println(list);</span><br><span class="line">		<span class="comment">//3.提交事务</span></span><br><span class="line">		session.commit();<span class="comment">//connection.commint</span></span><br><span class="line">		<span class="comment">//4.释放资源</span></span><br><span class="line">		&#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">		session.close();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>4)删除多条数据(以删除商品信息为例进行删除,借助动态sql)<br/><br>step01:修改映射文件(mapper/GoodsMapper.xml),添加delete元素,实现基于多个ID删除作者信息的语句的定义.</p>
<pre><code>&lt;delete id=&quot;deleteObjects&quot;&gt;
    delete from tb_goods
    &lt;where&gt; 
      &lt;!-- foreach元素用于迭代一个数组或集合 --&gt;
      &lt;foreach collection=&quot;array&quot;
             item=&quot;id&quot;&gt;
           or id=#{id}
      &lt;/foreach&gt;
    &lt;/where&gt;
 &lt;/delete&gt;</code></pre><p>step02:修改单元测试类(TestGoodsDao01),添加基于多个ID执行删除的操作.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDeleteObjects</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="comment">//1.获取session对象</span></span><br><span class="line">		SqlSession session = </span><br><span class="line">		sqlSessionFactory.openSession();</span><br><span class="line">		<span class="comment">//2.执行删除操作</span></span><br><span class="line">		String statement=</span><br><span class="line">		<span class="string">"com.cy.pj.goods.dao.GoodsDao.deleteObjects"</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="keyword">int</span> rows=session.delete(statement, <span class="keyword">new</span> Object[] &#123;<span class="number">13</span>,<span class="number">3</span>&#125;);</span><br><span class="line">		System.out.println(<span class="string">"delete.rows="</span>+rows);</span><br><span class="line">		<span class="comment">//3.提交事务</span></span><br><span class="line">		session.commit();<span class="comment">//connection.commint</span></span><br><span class="line">		<span class="comment">//4.释放资源</span></span><br><span class="line">		&#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">		session.close();</span><br><span class="line">		&#125;&#125;</span><br></pre></td></tr></table></figure>

<h4 id="1-3-2-基本业务进阶实现"><a href="#1-3-2-基本业务进阶实现" class="headerlink" title="1.3.2.基本业务进阶实现"></a>1.3.2.基本业务进阶实现</h4><p>基于接口方式实现数据访问操作<br/><br>1)分页查询实现(以查询多个作者信息为例进行实现)<br/><br>第一步: 创建一个接口GoodsDao 定一个分页查询方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cy.pj.goods.dao;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Param;</span><br><span class="line"><span class="keyword">import</span> com.cy.pj.goods.pojo.Goods;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">GoodsDao</span> </span>&#123;</span><br><span class="line">	 <span class="comment">/**</span></span><br><span class="line"><span class="comment">	    * 执行数据的删除操作</span></span><br><span class="line"><span class="comment">	  * <span class="doctag">@param</span> ids</span></span><br><span class="line"><span class="comment">	  * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	  */</span></span><br><span class="line">	 <span class="function"><span class="keyword">int</span> <span class="title">deleteObjects</span><span class="params">(<span class="keyword">int</span>... ids)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第二步: 创建一个单元测试类TestGoodsDao02对分页查询进行单元测试</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestGoodsDao02</span> <span class="keyword">extends</span> <span class="title">TestBaseWithXml</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDeleteObjects</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="comment">//1.获取session对象</span></span><br><span class="line">		SqlSession session = </span><br><span class="line">		sqlSessionFactory.openSession();</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="comment">//2.执行删除操作</span></span><br><span class="line">		GoodsDao gDao=</span><br><span class="line">		session.getMapper(GoodsDao<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		<span class="keyword">int</span> rows=gDao.deleteObjects(<span class="number">11</span>,<span class="number">12</span>);</span><br><span class="line">		System.out.println(<span class="string">"delete.rows="</span>+rows);</span><br><span class="line">		<span class="comment">//3.提交事务</span></span><br><span class="line">		<span class="comment">//session.commit();//connection.commint</span></span><br><span class="line">		<span class="comment">//4.释放资源</span></span><br><span class="line">		&#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">		session.close();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>2)基于多个id进行删除 (以删除作者信息为例进行实现)<br/><br>第一步：修改GoodsDao接口,添加deleteObjects方法</p>
<pre><code>int deleteObjects(int... ids);</code></pre><p>第二步: 修改单元测试类,添加testDeleteObjects方法实现单元测试.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDeleteObjects</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		<span class="comment">//1.获取session对象</span></span><br><span class="line">		SqlSession session = </span><br><span class="line">		sqlSessionFactory.openSession();</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="comment">//2.执行删除操作</span></span><br><span class="line">		GoodsDao gDao=</span><br><span class="line">		session.getMapper(GoodsDao<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		<span class="keyword">int</span> rows=gDao.deleteObjects(<span class="number">11</span>,<span class="number">12</span>);</span><br><span class="line">		System.out.println(<span class="string">"delete.rows="</span>+rows);</span><br><span class="line">		<span class="comment">//3.提交事务</span></span><br><span class="line">		<span class="comment">//session.commit();//connection.commint</span></span><br><span class="line">		<span class="comment">//4.释放资源</span></span><br><span class="line">		&#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">		session.close();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>基于注解(Annotation)方式做业务实现?<br/><br>第一步：在GoodsDao接口中添加统计记录行数的方法：getRowCount()<br/></p>
<pre><code>int getRowCount();&lt;br/&gt;</code></pre><p>第二步：在GoodsDao接口的统计记录方法上添加@Select注解，定义查询语句。<br/></p>
<pre><code>@Select(&quot;select count(*) from tb_goods&quot;)
int getRowCount();</code></pre><p>第三步：在TestGoodsDao02测试类中添加测试方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testGetRowCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		SqlSession session=</span><br><span class="line">		sqlSessionFactory.openSession();</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">		GoodsDao dao=</span><br><span class="line">		session.getMapper(GoodsDao<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		<span class="keyword">int</span> rowCount=dao.getRowCount();</span><br><span class="line">		System.out.println(rowCount);</span><br><span class="line">		session.commit();</span><br><span class="line">		&#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">		session.close();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<h4 id="1-3-3-会话工厂对象创建增强-了解"><a href="#1-3-3-会话工厂对象创建增强-了解" class="headerlink" title="1.3.3.会话工厂对象创建增强(了解)"></a>1.3.3.会话工厂对象创建增强(了解)</h4><hr>
<p>基于非XMl方式构建SqlSessionFactory对象?</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.test;</span><br><span class="line"><span class="keyword">import</span> com.cy.pj.goods.dao.GoodsDao;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Building SqlSessionFactory without XML</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestBaseWithJava</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> SqlSessionFactory sqlSessionFactory;</span><br><span class="line">	<span class="meta">@Before</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="comment">//1.构建数据源对象</span></span><br><span class="line">		PooledDataSource dataSource=<span class="keyword">new</span> PooledDataSource();</span><br><span class="line">		dataSource.setDriver(<span class="string">"com.mysql.cj.jdbc.Driver"</span>);</span><br><span class="line">	dataSource.setUrl(<span class="string">"jdbc:mysql:///dbgoods?serverTimezone=GMT&amp;characterEncoding=utf8"</span>);</span><br><span class="line">		dataSource.setUsername(<span class="string">"root"</span>);</span><br><span class="line">		dataSource.setPassword(<span class="string">"root"</span>);</span><br><span class="line">		<span class="comment">//2.创建事务管理工厂</span></span><br><span class="line">		JdbcTransactionFactory transactionFactory=</span><br><span class="line">		<span class="keyword">new</span> JdbcTransactionFactory();</span><br><span class="line">		<span class="comment">//3.创建一个环境对象</span></span><br><span class="line">		Environment env= <span class="keyword">new</span> Environment(<span class="string">"development"</span>,</span><br><span class="line">		transactionFactory, dataSource);</span><br><span class="line">		<span class="comment">//4.创建配置对象</span></span><br><span class="line">		Configuration config=</span><br><span class="line">		<span class="keyword">new</span> Configuration(env);</span><br><span class="line">		config.addMapper(GoodsDao<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		<span class="comment">//5.创建sqlSessionFactory对象</span></span><br><span class="line">		sqlSessionFactory=</span><br><span class="line">        <span class="keyword">new</span> SqlSessionFactoryBuilder()</span><br><span class="line">		.build(config);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testConnection</span><span class="params">()</span></span>&#123;</span><br><span class="line">		Connection conn=</span><br><span class="line">		sqlSessionFactory.openSession()</span><br><span class="line">		.getConnection();</span><br><span class="line">		System.out.println(conn);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试实现</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.test;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSession;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> com.cy.pj.goods.dao.GoodsDao;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 	基于接口方式进行测试实现</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestGoodsDao03</span> </span></span><br><span class="line"><span class="class">     <span class="keyword">extends</span> <span class="title">TestBaseWithJava</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testGetRowCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		SqlSession session=</span><br><span class="line">		sqlSessionFactory.openSession();</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">		GoodsDao dao=</span><br><span class="line">		session.getMapper(GoodsDao<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">		<span class="keyword">int</span> rowCount=dao.getRowCount();</span><br><span class="line">		System.out.println(rowCount);</span><br><span class="line">		session.commit();</span><br><span class="line">		&#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">		session.close();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-4-MYBATIS-应用原理进阶分析"><a href="#1-4-MYBATIS-应用原理进阶分析" class="headerlink" title="1.4.MYBATIS 应用原理进阶分析"></a>1.4.MYBATIS 应用原理进阶分析</h3><h4 id="1-4-1-会话工厂创建分析-了解"><a href="#1-4-1-会话工厂创建分析-了解" class="headerlink" title="1.4.1.会话工厂创建分析(了解)"></a>1.4.1.会话工厂创建分析(了解)</h4><hr>
<p>会话工厂(SqlSessionFactory)创建过程分析:基于xml方式</p>
<hr>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-454b49d31ee043ceb7e67d1cc5848800.png" alt="image.png"><br>1.通过IO读取配置文件<br/><br>2.解析IO数据并进行封装(所有信息都会存储到Configuration对象)<br/><br>3.基于配置对象创建SqlSessionFactory对象<br/></p>
<p>会话工厂(SqlSessionFactory)创建过程分析:不基基于xml方式</p>
<hr>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-b3af8a61276444e7a1313cb634862e86.png" alt="image.png"></p>
<h3 id="1-4-2-会话对象应用分析-了解"><a href="#1-4-2-会话对象应用分析-了解" class="headerlink" title="1.4.2.会话对象应用分析 (了解)"></a>1.4.2.会话对象应用分析 (了解)</h3><hr>
<p>说说mybatis对jdbc的封装过程（了解）？（SqlSession应用增强分析）</p>
<hr>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-9eeb8dbe5a1e42fea794fcc251a9b054.png" alt="image.png"><br>封装了连接获取过程？（Executor-&gt;JDBCTransactionConnection）<br/><br>2)封装了Statement对象创建过程？(connection)<br/><br>3)封装了sql的发送过程，参数的处理过程，结果的映射过程。<br/></p>
<h3 id="1-4-3-基于Mapper接口会话-了解"><a href="#1-4-3-基于Mapper接口会话-了解" class="headerlink" title="1.4.3.基于Mapper接口会话(了解)"></a>1.4.3.基于Mapper接口会话(了解)</h3><p>例如：XxxMapper xm=session.getMapper(XxxDao.class);<br/><br>当获取到mapper接口对应的实现类对象以后可以基于实现类底层执行sql操作。<br/></p>
<hr>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-2bf3be2cf81f4e3b9866452880e67a14.png" alt="image.png"><br>FAQ?<br/><br>1)不同通过getMapper方式获取指定接口实现类是否可以基于mybatis实现数据访问操作?(可以)<br/><br>2)基于Mapper接口访问数据库库的优势,劣势?(解耦,可读性好但是性能相对较差,相对于直接通过sqlsession的selectList,update方法而言).<br/></p>
<h4 id="1-4-4-缓存应用实现过程分析-掌握"><a href="#1-4-4-缓存应用实现过程分析-掌握" class="headerlink" title="1.4.4.缓存应用实现过程分析(掌握)"></a>1.4.4.缓存应用实现过程分析(掌握)</h4><p>Mybatis 框架提供一种缓存机制，通过缓存的应用来提高查询性能,但可能会有一定的不一致(脏读)问题。Mybatis中的缓存提供一级缓存和二级缓存的实现,默认都是开启状态（可参考官网）。<br/><br>1.Mybatis 一级缓存<br/><br>Mybatis中的一级缓存有时又称为SqlSession级缓存，SqlSession关闭时一级缓存失效。在同一个SqlSession内部多次执行同一个查询，后续的查询会从此缓存取数据.一级缓存结构分析如下:<br/><br>一级缓存基本架构应用分析:<br/></p>
<hr>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-994fdc20ec8f406b90944ffe8583ca93.png" alt="image.png"><br>一级缓存代码架构分析:</p>
<hr>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-6e8c3b268e9b4227948e747aa9e19071.png" alt="image.png"><br>说明：一级缓存的实现可查看BaseExecutor类中的localCache属性。</p>
<p>2.MyBatis二级缓存<br/></p>
<p>Mybatis中的二级缓存有时又称跨session缓存，可在多个SqlSession间共享数据,假如要使用二级缓存，可在对应的mapper文件中借助cache元素进行配置(可参考官方映射文件配置),二级缓存架构分析如下:<br/></p>
<p>二级缓存基本应用架构:<br/></p>
<hr>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-320d1aa0f9a14514867317e697c88ae1.png" alt="image.png"><br>二级缓存代码结构分析:<br/></p>
<hr>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-15ee6b13b3c24b4e8fbb1b42b07b7651.png" alt="image.png"><br>说明：<br/><br>1)二级缓存的实现可查看CachingExecutor类中的query方法.<br/><br>2)二级缓存底层采用装饰模式进行设计,例如:<br/><br>new SynchronizedCache (new LoggingCache(…));<br/><br>3)二级缓存中可以存储序列化对象(readWrite属性值为false时)<br/><br>4)使用二级缓存可在映射文件中借助<Cache/>标签进行声明,也可在接口中借助注解@CacheNamespace对接口进行描述.<br/><br>5)当映射配置有注解方式,也有xml方式时可通过缓存引用进行配置,例如.<br>@CacheNamespaceRef(name=”com.cy.pj.googs.dao.GoodsDao “)<br/></p>
]]></content>
      <categories>
        <category>后端</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>mybatis</tag>
      </tags>
  </entry>
  <entry>
    <title>Nginx相关知识</title>
    <url>/2020/04/16/Nginx%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><h2 id="1-nginx-介绍"><a href="#1-nginx-介绍" class="headerlink" title="1.nginx 介绍"></a>1.nginx 介绍</h2><p>Nginx (engine x) 是一个高性能的HTTP和反向代理web服务器，同时也提供了IMAP/POP3/SMTP服务。Nginx是由伊戈尔·赛索耶夫为俄罗斯访问量第二的Rambler.ru站点（俄文：Рамблер）开发的，第一个公开版本0.1.0发布于2004年10月4日。<br>其将源代码以类BSD许可证的形式发布，因它的稳定性、丰富的功能集、示例配置文件和低系统资源的消耗而闻名。2011年6月1日，nginx 1.0.4发布。<br>Nginx是一款轻量级的Web 服务器/反向代理服务器及电子邮件（IMAP/POP3）代理服务器，在BSD-like 协议下发行。其特点是占有内存少，并发能力强，事实上nginx的并发能力在同类型的网页服务器中表现较好，中国大陆使用nginx网站用户有：百度、京东、新浪、网易、腾讯、淘宝等。</p>
<h2 id="2-安装nginx"><a href="#2-安装nginx" class="headerlink" title="2.安装nginx"></a>2.安装nginx</h2><p>安装nginx</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo yum install epel-release</span><br><span class="line">sudo yum install nginx</span><br></pre></td></tr></table></figure>

<p>让nginx随系统启动而启动</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo systemctl enable nginx</span><br></pre></td></tr></table></figure>
<p>/etc/nginx</p>
<h2 id="3-nginx-负载均衡"><a href="#3-nginx-负载均衡" class="headerlink" title="3.nginx 负载均衡"></a>3.nginx 负载均衡</h2><p>Nginx通过反向代理可以实现服务的负载均衡，避免了服务器单节点故障，把请求按照一定的策略转发到不同的服务器上，达到负载的效果。<br>1、轮询<br>将请求按顺序轮流地分配到后端服务器上，它均衡地对待后端的每一台服务器，而不关心服务器实际的连接数和当前的系统负载。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http &#123;</span><br><span class="line"></span><br><span class="line">    upstream myapp1 &#123;</span><br><span class="line"></span><br><span class="line">        server 192.168.1.103:8080;</span><br><span class="line"></span><br><span class="line">        server 192.168.1.104:8080;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ……略</span><br><span class="line"></span><br><span class="line">   server &#123;</span><br><span class="line"></span><br><span class="line">        listen 80;</span><br><span class="line"></span><br><span class="line">        server_name  localhost;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">        ……略</span><br><span class="line"></span><br><span class="line">        location &#x2F;webautotest&#x2F; &#123;</span><br><span class="line"></span><br><span class="line">            proxy_buffering off;</span><br><span class="line"></span><br><span class="line">            proxy_pass http:&#x2F;&#x2F;myapp1;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、加权轮询<br>不同的后端服务器可能机器的配置和当前系统的负载并不相同，因此它们的抗压能力也不相同。</p>
<p>给配置高、负载低的机器配置更高的权重，让其处理更多的请；而配置低、负载高的机器，给其分配较低的权重，降低其系统负载，加权轮询能很好地处理这一问题，并将请求顺序且按照权重分配到后端。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">upstream myapp1 &#123;</span><br><span class="line"></span><br><span class="line">       server srv1.example.com weight&#x3D;3;</span><br><span class="line"></span><br><span class="line">       server srv2.example.com;</span><br><span class="line"></span><br><span class="line">       server srv3.example.com;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>3、ip_hash（源地址哈希法）<br>根据获取客户端的IP地址，通过哈希函数计算得到一个数值，用该数值对服务器列表的大小进行取模运算，得到的结果便是客户端要访问服务器的序号。</p>
<p>采用源地址哈希法进行负载均衡，同一IP地址的客户端，当后端服务器列表不变时，它每次都会映射到同一台后端服务器进行访问。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">upstream myapp1 &#123;</span><br><span class="line"></span><br><span class="line">    ip_hash;</span><br><span class="line"></span><br><span class="line">    server srv1.example.com;</span><br><span class="line"></span><br><span class="line">    server srv2.example.com;</span><br><span class="line"></span><br><span class="line">    server srv3.example.com;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4、least_conn（最小连接数法）<br>由于后端服务器的配置不尽相同，对于请求的处理有快有慢，最小连接数法根据后端服务器当前的连接情况，动态地选取其中当前积压连接数最少的一台服务器来处理当前的请求，尽可能地提高后端服务的利用效率，将负责合理地分流到每一台服务器。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">upstream myapp1 &#123;</span><br><span class="line"></span><br><span class="line">        least_conn;</span><br><span class="line"></span><br><span class="line">        server srv1.example.com;</span><br><span class="line"></span><br><span class="line">        server srv2.example.com;</span><br><span class="line"></span><br><span class="line">        server srv3.example.com;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>5、随机</p>
<h2 id="4-nginx-反向代理"><a href="#4-nginx-反向代理" class="headerlink" title="4.nginx 反向代理"></a>4.nginx 反向代理</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vim Nginx.conf</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">	# 监听80端口，一般不用改</span><br><span class="line">    listen 80;</span><br><span class="line">	# 将这里的example换成自己的域名</span><br><span class="line">    server_name example.com www.example.com;</span><br><span class="line"></span><br><span class="line">    location &#x2F; &#123;</span><br><span class="line">        proxy_set_header HOST $host;</span><br><span class="line">        proxy_set_header X-Forwarded-Proto $scheme;</span><br><span class="line">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">		# 这里的http后面的url就是你访问你上方的域名代理的地址</span><br><span class="line">        proxy_pass http:&#x2F;&#x2F;127.0.0.1:8090&#x2F;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>重启</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">nginx -s reload</span><br></pre></td></tr></table></figure>
<h2 id="5-配置SSL证书"><a href="#5-配置SSL证书" class="headerlink" title="5.配置SSL证书"></a>5.配置SSL证书</h2><p>1.下载证书上传<br>在阿里云购买免费版本的SSL证书后，下载SSL证书到本地，选择Nginx版本。<br>下载的证书共有两个文件，分别是：</p>
<p>xxxxxxxx.pem<br>xxxxxxxx.key</p>
<p>在服务上/root路径下新建ssl文件夹，并将下载到本地的证书文件上传至该文件夹。</p>
<p>可使用rz命令或者Xftp来上传,也可以使用filezilla上传。<br>2.配置<br>在/etc/nginx/conf.d/路径下新建文件nginx.conf</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vim &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;nginx.conf</span><br></pre></td></tr></table></figure>
<p>输入</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">server</span><br><span class="line">&#123;</span><br><span class="line">listen 443 ssl;</span><br><span class="line">server_name yuzho.cn www.yuzho.cn;</span><br><span class="line">ssl_certificate &#x2F;root&#x2F;ssl&#x2F;xxxxxxxx.pem;</span><br><span class="line">ssl_certificate_key &#x2F;root&#x2F;ssl&#x2F;xxxxxxxx.key;</span><br><span class="line">ssl_session_timeout 5m;</span><br><span class="line">ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;</span><br><span class="line">ssl_protocols TLSv1 TLSv1.1 TLSv1.2;</span><br><span class="line">ssl_prefer_server_ciphers on;</span><br><span class="line">location &#x2F; &#123;</span><br><span class="line">proxy_buffer_size 128k;</span><br><span class="line">proxy_buffers 32 32k;</span><br><span class="line">proxy_busy_buffers_size 128k;</span><br><span class="line">proxy_pass http:&#x2F;&#x2F;127.0.0.1:8090;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">server</span><br><span class="line">&#123;</span><br><span class="line">listen 80;</span><br><span class="line">server_name yuzho.cn www.yuzho.cn;</span><br><span class="line">rewrite ^(.*)$ https:&#x2F;&#x2F;host1 permanent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将其中的 yuzho.cn, <a href="http://www.yuzho.cn换成你自己的域名；/root/ssl/xxxxxxxx.pem，/root/ssl/xxxxxxxx.key换成你自己在上一步中所上传的证书的绝对路径；将8090换成你所需要代理的端口。" target="_blank" rel="noopener">www.yuzho.cn换成你自己的域名；/root/ssl/xxxxxxxx.pem，/root/ssl/xxxxxxxx.key换成你自己在上一步中所上传的证书的绝对路径；将8090换成你所需要代理的端口。</a><br>3.重新加载nginx<br>使用nginx -t命令来检查语法错误，使用nginx -s reload命令来重新加载nginx。<br>如nginx -t正确，而nginx -s reload命令出现错误提示：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">nginx: [error] invalid PID number &quot;&quot; in &quot;&#x2F;run&#x2F;nginx.pid&quot;</span><br></pre></td></tr></table></figure>
<p>执行</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">nginx -c &#x2F;etc&#x2F;nginx&#x2F;nginx.conf</span><br><span class="line">sudo nginx -s reload</span><br></pre></td></tr></table></figure>
<p>引用 <a href="https://www.cnblogs.com/liulun/p/11518252.html" target="_blank" rel="noopener">https://www.cnblogs.com/liulun/p/11518252.html</a></p>
<h2 id="6"><a href="#6" class="headerlink" title="6."></a>6.</h2><p>Nginx中文文档 ：      <a href="https://www.nginx.cn/doc/" target="_blank" rel="noopener">https://www.nginx.cn/doc/</a><br>官网 ： <a href="https://www.nginx.com/" target="_blank" rel="noopener">https://www.nginx.com/</a></p>
]]></content>
      <categories>
        <category>工具</category>
      </categories>
      <tags>
        <tag>nginx</tag>
      </tags>
  </entry>
  <entry>
    <title>Redis</title>
    <url>/2020/03/24/Redis/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><h1 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h1><h2 id="1、什么是Redis？"><a href="#1、什么是Redis？" class="headerlink" title="1、什么是Redis？"></a>1、什么是Redis？</h2><p>Redis本质上是一个Key-Value类型的内存数据库，很像memcached，整个数据库统统加载在内存当中进行操作，定期通过异步操作把数据库数据flush到硬盘上进行保存。因为是纯内存操作，Redis的性能非常出色，每秒可以处理超过 10万次读写操作，是已知性能最快的Key-Value DB。 Redis的出色之处不仅仅是性能，Redis最大的魅力是支持保存多种数据结构，此外单个value的最大限制是1GB，不像 memcached只能保存1MB的数据，因此Redis可以用来实现很多有用的功能，比方说用他的List来做FIFO双向链表，实现一个轻量级的高性 能消息队列服务，用他的Set可以做高性能的tag系统等等。另外Redis也可以对存入的Key-Value设置expire时间，因此也可以被当作一 个功能加强版的memcached来用。 Redis的主要缺点是数据库容量受到物理内存的限制，不能用作海量数据的高性能读写，因此Redis适合的场景主要局限在较小数据量的高性能操作和运算上。</p>
<h2 id="2、Redis相比memcached有哪些优势？"><a href="#2、Redis相比memcached有哪些优势？" class="headerlink" title="2、Redis相比memcached有哪些优势？"></a>2、Redis相比memcached有哪些优势？</h2><p>(1) memcached所有的值均是简单的字符串，redis作为其替代者，支持更为丰富的数据类型</p>
<p>(2) redis的速度比memcached快很多</p>
<p>(3) redis可以持久化其数据</p>
<h2 id="3、Redis支持哪几种数据类型？"><a href="#3、Redis支持哪几种数据类型？" class="headerlink" title="3、Redis支持哪几种数据类型？"></a>3、Redis支持哪几种数据类型？</h2><p>String、List、Set、Sorted Set、hashes</p>
<h2 id="4、Redis主要消耗什么物理资源？"><a href="#4、Redis主要消耗什么物理资源？" class="headerlink" title="4、Redis主要消耗什么物理资源？"></a>4、Redis主要消耗什么物理资源？</h2><p>内存。</p>
<h2 id="5、Redis的全称是什么？"><a href="#5、Redis的全称是什么？" class="headerlink" title="5、Redis的全称是什么？"></a>5、Redis的全称是什么？</h2><p>Remote Dictionary Server。</p>
<h2 id="6、Redis有哪几种数据淘汰策略？"><a href="#6、Redis有哪几种数据淘汰策略？" class="headerlink" title="6、Redis有哪几种数据淘汰策略？"></a>6、Redis有哪几种数据淘汰策略？</h2><p>noeviction:返回错误当内存限制达到并且客户端尝试执行会让更多内存被使用的命令（大部分的写入指令，但DEL和几个例外）</p>
<p>allkeys-lru: 尝试回收最少使用的键（LRU），使得新添加的数据有空间存放。</p>
<p>volatile-lru: 尝试回收最少使用的键（LRU），但仅限于在过期集合的键,使得新添加的数据有空间存放。</p>
<p>allkeys-random: 回收随机的键使得新添加的数据有空间存放。</p>
<p>volatile-random: 回收随机的键使得新添加的数据有空间存放，但仅限于在过期集合的键。</p>
<p>volatile-ttl: 回收在过期集合的键，并且优先回收存活时间（TTL）较短的键,使得新添加的数据有空间存放。</p>
<h2 id="7、Redis官方为什么不提供Windows版本？"><a href="#7、Redis官方为什么不提供Windows版本？" class="headerlink" title="7、Redis官方为什么不提供Windows版本？"></a>7、Redis官方为什么不提供Windows版本？</h2><p>因为目前Linux版本已经相当稳定，而且用户量很大，无需开发windows版本，反而会带来兼容性等问题。</p>
<h2 id="8、一个字符串类型的值能存储最大容量是多少？"><a href="#8、一个字符串类型的值能存储最大容量是多少？" class="headerlink" title="8、一个字符串类型的值能存储最大容量是多少？"></a>8、一个字符串类型的值能存储最大容量是多少？</h2><p>512M</p>
<h2 id="9、为什么Redis需要把所有数据放到内存中？"><a href="#9、为什么Redis需要把所有数据放到内存中？" class="headerlink" title="9、为什么Redis需要把所有数据放到内存中？"></a>9、为什么Redis需要把所有数据放到内存中？</h2><p>Redis为了达到最快的读写速度将数据都读到内存中，并通过异步的方式将数据写入磁盘。所以redis具有快速和数据持久化的特征。如果不将数据放在内存中，磁盘I/O速度为严重影响redis的性能。在内存越来越便宜的今天，redis将会越来越受欢迎。 如果设置了最大使用的内存，则数据已有记录数达到内存限值后不能继续插入新值。</p>
<h2 id="10、Redis集群方案应该怎么做？都有哪些方案？"><a href="#10、Redis集群方案应该怎么做？都有哪些方案？" class="headerlink" title="10、Redis集群方案应该怎么做？都有哪些方案？"></a>10、Redis集群方案应该怎么做？都有哪些方案？</h2><p>1.twemproxy，大概概念是，它类似于一个代理方式，使用方法和普通redis无任何区别，设置好它下属的多个redis实例后，使用时在本需要连接redis的地方改为连接twemproxy，它会以一个代理的身份接收请求并使用一致性hash算法，将请求转接到具体redis，将结果再返回twemproxy。使用方式简便(相对redis只需修改连接端口)，对旧项目扩展的首选。 问题：twemproxy自身单端口实例的压力，使用一致性hash后，对redis节点数量改变时候的计算值的改变，数据无法自动移动到新的节点。</p>
<p>2.codis，目前用的最多的集群方案，基本和twemproxy一致的效果，但它支持在 节点数量改变情况下，旧节点数据可恢复到新hash节点。</p>
<p>3.redis cluster3.0自带的集群，特点在于他的分布式算法不是一致性hash，而是hash槽的概念，以及自身支持节点设置从节点。具体看官方文档介绍。</p>
<p>4.在业务代码层实现，起几个毫无关联的redis实例，在代码层，对key 进行hash计算，然后去对应的redis实例操作数据。 这种方式对hash层代码要求比较高，考虑部分包括，节点失效后的替代算法方案，数据震荡后的自动脚本恢复，实例的监控，等等。</p>
<h2 id="11、Redis集群方案什么情况下会导致整个集群不可用？"><a href="#11、Redis集群方案什么情况下会导致整个集群不可用？" class="headerlink" title="11、Redis集群方案什么情况下会导致整个集群不可用？"></a>11、Redis集群方案什么情况下会导致整个集群不可用？</h2><p>有A，B，C三个节点的集群,在没有复制模型的情况下,如果节点B失败了，那么整个集群就会以为缺少5501-11000这个范围的槽而不可用。</p>
<h2 id="12、MySQL里有2000w数据，redis中只存20w的数据，如何保证redis中的数据都是热点数据？"><a href="#12、MySQL里有2000w数据，redis中只存20w的数据，如何保证redis中的数据都是热点数据？" class="headerlink" title="12、MySQL里有2000w数据，redis中只存20w的数据，如何保证redis中的数据都是热点数据？"></a>12、MySQL里有2000w数据，redis中只存20w的数据，如何保证redis中的数据都是热点数据？</h2><p>redis内存数据集大小上升到一定大小的时候，就会施行数据淘汰策略。</p>
<h2 id="13、Redis有哪些适合的场景？"><a href="#13、Redis有哪些适合的场景？" class="headerlink" title="13、Redis有哪些适合的场景？"></a>13、Redis有哪些适合的场景？</h2><p>（1）、会话缓存（Session Cache）</p>
<p>最常用的一种使用Redis的情景是会话缓存（session cache）。用Redis缓存会话比其他存储（如Memcached）的优势在于：Redis提供持久化。当维护一个不是严格要求一致性的缓存时，如果用户的购物车信息全部丢失，大部分人都会不高兴的，现在，他们还会这样吗？</p>
<p>幸运的是，随着 Redis 这些年的改进，很容易找到怎么恰当的使用Redis来缓存会话的文档。甚至广为人知的商业平台Magento也提供Redis的插件。</p>
<p>（2）、全页缓存（FPC）</p>
<p>除基本的会话token之外，Redis还提供很简便的FPC平台。回到一致性问题，即使重启了Redis实例，因为有磁盘的持久化，用户也不会看到页面加载速度的下降，这是一个极大改进，类似PHP本地FPC。</p>
<p>再次以Magento为例，Magento提供一个插件来使用Redis作为全页缓存后端。</p>
<p>此外，对WordPress的用户来说，Pantheon有一个非常好的插件 wp-redis，这个插件能帮助你以最快速度加载你曾浏览过的页面。</p>
<p>（3）、队列</p>
<p>Reids在内存存储引擎领域的一大优点是提供 list 和 set 操作，这使得Redis能作为一个很好的消息队列平台来使用。Redis作为队列使用的操作，就类似于本地程序语言（如Python）对 list 的 push/pop 操作。</p>
<p>如果你快速的在Google中搜索“Redis queues”，你马上就能找到大量的开源项目，这些项目的目的就是利用Redis创建非常好的后端工具，以满足各种队列需求。例如，Celery有一个后台就是使用Redis作为broker，你可以从这里去查看。</p>
<p>（4），排行榜/计数器</p>
<p>Redis在内存中对数字进行递增或递减的操作实现的非常好。集合（Set）和有序集合（Sorted Set）也使得我们在执行这些操作的时候变的非常简单，Redis只是正好提供了这两种数据结构。所以，我们要从排序集合中获取到排名最靠前的10个用户–我们称之为“user_scores”，我们只需要像下面一样执行即可：</p>
<p>当然，这是假定你是根据你用户的分数做递增的排序。如果你想返回用户及用户的分数，你需要这样执行：</p>
<p>ZRANGE user_scores 0 10 WITHSCORES</p>
<p>Agora Games就是一个很好的例子，用Ruby实现的，它的排行榜就是使用Redis来存储数据的，你可以在这里看到。</p>
<p>（5）、发布/订阅</p>
<p>最后（但肯定不是最不重要的）是Redis的发布/订阅功能。发布/订阅的使用场景确实非常多。我已看见人们在社交网络连接中使用，还可作为基于发布/订阅的脚本触发器，甚至用Redis的发布/订阅功能来建立聊天系统！（不，这是真的，你可以去核实）。</p>
<h2 id="14、Redis支持的Java客户端都有哪些？官方推荐用哪个？"><a href="#14、Redis支持的Java客户端都有哪些？官方推荐用哪个？" class="headerlink" title="14、Redis支持的Java客户端都有哪些？官方推荐用哪个？"></a>14、Redis支持的Java客户端都有哪些？官方推荐用哪个？</h2><p>Redisson、Jedis、lettuce等等，官方推荐使用Redisson。</p>
<h2 id="15、Redis和Redisson有什么关系？"><a href="#15、Redis和Redisson有什么关系？" class="headerlink" title="15、Redis和Redisson有什么关系？"></a>15、Redis和Redisson有什么关系？</h2><p>Redisson是一个高级的分布式协调Redis客服端，能帮助用户在分布式环境中轻松实现一些Java的对象 (Bloom filter, BitSet, Set, SetMultimap, ScoredSortedSet, SortedSet, Map, ConcurrentMap, List, ListMultimap, Queue, BlockingQueue, Deque, BlockingDeque, Semaphore, Lock, ReadWriteLock, AtomicLong, CountDownLatch, Publish / Subscribe, HyperLogLog)。</p>
<h2 id="16、Jedis与Redisson对比有什么优缺点？"><a href="#16、Jedis与Redisson对比有什么优缺点？" class="headerlink" title="16、Jedis与Redisson对比有什么优缺点？"></a>16、Jedis与Redisson对比有什么优缺点？</h2><p>Jedis是Redis的Java实现的客户端，其API提供了比较全面的Redis命令的支持；Redisson实现了分布式和可扩展的Java数据结构，和Jedis相比，功能较为简单，不支持字符串操作，不支持排序、事务、管道、分区等Redis特性。Redisson的宗旨是促进使用者对Redis的关注分离，从而让使用者能够将精力更集中地放在处理业务逻辑上。</p>
<h2 id="17、Redis如何设置密码及验证密码？"><a href="#17、Redis如何设置密码及验证密码？" class="headerlink" title="17、Redis如何设置密码及验证密码？"></a>17、Redis如何设置密码及验证密码？</h2><p>设置密码：config set requirepass 123456</p>
<p>授权密码：auth 123456</p>
<h2 id="18、说说Redis哈希槽的概念？"><a href="#18、说说Redis哈希槽的概念？" class="headerlink" title="18、说说Redis哈希槽的概念？"></a>18、说说Redis哈希槽的概念？</h2><p>Redis集群没有使用一致性hash,而是引入了哈希槽的概念，Redis集群有16384个哈希槽，每个key通过CRC16校验后对16384取模来决定放置哪个槽，集群的每个节点负责一部分hash槽。</p>
<h2 id="19、Redis集群的主从复制模型是怎样的？"><a href="#19、Redis集群的主从复制模型是怎样的？" class="headerlink" title="19、Redis集群的主从复制模型是怎样的？"></a>19、Redis集群的主从复制模型是怎样的？</h2><p>为了使在部分节点失败或者大部分节点无法通信的情况下集群仍然可用，所以集群使用了主从复制模型,每个节点都会有N-1个复制品.</p>
<h2 id="20、Redis集群会有写操作丢失吗？为什么？"><a href="#20、Redis集群会有写操作丢失吗？为什么？" class="headerlink" title="20、Redis集群会有写操作丢失吗？为什么？"></a>20、Redis集群会有写操作丢失吗？为什么？</h2><p>Redis并不能保证数据的强一致性，这意味这在实际中集群在特定的条件下可能会丢失写操作。</p>
<h2 id="21、Redis集群之间是如何复制的？"><a href="#21、Redis集群之间是如何复制的？" class="headerlink" title="21、Redis集群之间是如何复制的？"></a>21、Redis集群之间是如何复制的？</h2><p>异步复制</p>
<h2 id="22、Redis集群最大节点个数是多少？"><a href="#22、Redis集群最大节点个数是多少？" class="headerlink" title="22、Redis集群最大节点个数是多少？"></a>22、Redis集群最大节点个数是多少？</h2><p>16384个。</p>
<h2 id="23、Redis集群如何选择数据库？"><a href="#23、Redis集群如何选择数据库？" class="headerlink" title="23、Redis集群如何选择数据库？"></a>23、Redis集群如何选择数据库？</h2><p>Redis集群目前无法做数据库选择，默认在0数据库。</p>
<h2 id="24、怎么测试Redis的连通性？"><a href="#24、怎么测试Redis的连通性？" class="headerlink" title="24、怎么测试Redis的连通性？"></a>24、怎么测试Redis的连通性？</h2><p>ping</p>
<h2 id="25、Redis中的管道有什么用？"><a href="#25、Redis中的管道有什么用？" class="headerlink" title="25、Redis中的管道有什么用？"></a>25、Redis中的管道有什么用？</h2><p>一次请求/响应服务器能实现处理新的请求即使旧的请求还未被响应。这样就可以将多个命令发送到服务器，而不用等待回复，最后在一个步骤中读取该答复。</p>
<p>这就是管道（pipelining），是一种几十年来广泛使用的技术。例如许多POP3协议已经实现支持这个功能，大大加快了从服务器下载新邮件的过程。</p>
<h2 id="26、怎么理解Redis事务？"><a href="#26、怎么理解Redis事务？" class="headerlink" title="26、怎么理解Redis事务？"></a>26、怎么理解Redis事务？</h2><p>事务是一个单独的隔离操作：事务中的所有命令都会序列化、按顺序地执行。事务在执行的过程中，不会被其他客户端发送来的命令请求所打断。</p>
<p>事务是一个原子操作：事务中的命令要么全部被执行，要么全部都不执行。</p>
<h2 id="27、Redis事务相关的命令有哪几个？"><a href="#27、Redis事务相关的命令有哪几个？" class="headerlink" title="27、Redis事务相关的命令有哪几个？"></a>27、Redis事务相关的命令有哪几个？</h2><p>MULTI、EXEC、DISCARD、WATCH</p>
<h2 id="28、Redis-key的过期时间和永久有效分别怎么设置？"><a href="#28、Redis-key的过期时间和永久有效分别怎么设置？" class="headerlink" title="28、Redis key的过期时间和永久有效分别怎么设置？"></a>28、Redis key的过期时间和永久有效分别怎么设置？</h2><p>EXPIRE和PERSIST命令。</p>
<h2 id="29、Redis如何做内存优化？"><a href="#29、Redis如何做内存优化？" class="headerlink" title="29、Redis如何做内存优化？"></a>29、Redis如何做内存优化？</h2><p>尽可能使用散列表（hashes），散列表（是说散列表里面存储的数少）使用的内存非常小，所以你应该尽可能的将你的数据模型抽象到一个散列表里面。比如你的web系统中有一个用户对象，不要为这个用户的名称，姓氏，邮箱，密码设置单独的key,而是应该把这个用户的所有信息存储到一张散列表里面.</p>
<h2 id="30、Redis回收进程如何工作的？"><a href="#30、Redis回收进程如何工作的？" class="headerlink" title="30、Redis回收进程如何工作的？"></a>30、Redis回收进程如何工作的？</h2><p>一个客户端运行了新的命令，添加了新的数据。<br>Redi检查内存使用情况，如果大于maxmemory的限制, 则根据设定好的策略进行回收。<br>一个新的命令被执行，等等。<br>所以我们不断地穿越内存限制的边界，通过不断达到边界然后不断地回收回到边界以下。<br>如果一个命令的结果导致大量内存被使用（例如很大的集合的交集保存到一个新的键），不用多久内存限制就会被这个内存使用量超越。</p>
<h2 id="31、Redis回收使用的是什么算法？"><a href="#31、Redis回收使用的是什么算法？" class="headerlink" title="31、Redis回收使用的是什么算法？"></a>31、Redis回收使用的是什么算法？</h2><p>LRU算法</p>
<h2 id="32、Redis如何做大量数据插入？"><a href="#32、Redis如何做大量数据插入？" class="headerlink" title="32、Redis如何做大量数据插入？"></a>32、Redis如何做大量数据插入？</h2><p>Redis2.6开始redis-cli支持一种新的被称之为pipe mode的新模式用于执行大量数据插入工作。</p>
<h2 id="33、为什么要做Redis分区？"><a href="#33、为什么要做Redis分区？" class="headerlink" title="33、为什么要做Redis分区？"></a>33、为什么要做Redis分区？</h2><p>分区可以让Redis管理更大的内存，Redis将可以使用所有机器的内存。如果没有分区，你最多只能使用一台机器的内存。分区使Redis的计算能力通过简单地增加计算机得到成倍提升,Redis的网络带宽也会随着计算机和网卡的增加而成倍增长。</p>
<h2 id="34、你知道有哪些Redis分区实现方案？"><a href="#34、你知道有哪些Redis分区实现方案？" class="headerlink" title="34、你知道有哪些Redis分区实现方案？"></a>34、你知道有哪些Redis分区实现方案？</h2><p>客户端分区就是在客户端就已经决定数据会被存储到哪个redis节点或者从哪个redis节点读取。大多数客户端已经实现了客户端分区。</p>
<p>代理分区 意味着客户端将请求发送给代理，然后代理决定去哪个节点写数据或者读数据。代理根据分区规则决定请求哪些Redis实例，然后根据Redis的响应结果返回给客户端。redis和memcached的一种代理实现就是Twemproxy</p>
<p>查询路由(Query routing) 的意思是客户端随机地请求任意一个redis实例，然后由Redis将请求转发给正确的Redis节点。Redis Cluster实现了一种混合形式的查询路由，但并不是直接将请求从一个redis节点转发到另一个redis节点，而是在客户端的帮助下直接redirected到正确的redis节点。</p>
<h2 id="35、Redis分区有什么缺点？"><a href="#35、Redis分区有什么缺点？" class="headerlink" title="35、Redis分区有什么缺点？"></a>35、Redis分区有什么缺点？</h2><p>涉及多个key的操作通常不会被支持。例如你不能对两个集合求交集，因为他们可能被存储到不同的Redis实例（实际上这种情况也有办法，但是不能直接使用交集指令）。<br>同时操作多个key,则不能使用Redis事务.<br>分区使用的粒度是key，不能使用一个非常长的排序key存储一个数据集（The partitioning granularity is the key, so it is not possible to shard a dataset with a single huge key like a very big sorted set）.<br>当使用分区的时候，数据处理会非常复杂，例如为了备份你必须从不同的Redis实例和主机同时收集RDB / AOF文件。<br>分区时动态扩容或缩容可能非常复杂。Redis集群在运行时增加或者删除Redis节点，能做到最大程度对用户透明地数据再平衡，但其他一些客户端分区或者代理分区方法则不支持这种特性。然而，有一种预分片的技术也可以较好的解决这个问题。</p>
<h2 id="36、Redis持久化数据和缓存怎么做扩容？"><a href="#36、Redis持久化数据和缓存怎么做扩容？" class="headerlink" title="36、Redis持久化数据和缓存怎么做扩容？"></a>36、Redis持久化数据和缓存怎么做扩容？</h2><p>如果Redis被当做缓存使用，使用一致性哈希实现动态扩容缩容。<br>如果Redis被当做一个持久化存储使用，必须使用固定的keys-to-nodes映射关系，节点的数量一旦确定不能变化。否则的话(即Redis节点需要动态变化的情况），必须使用可以在运行时进行数据再平衡的一套系统，而当前只有Redis集群可以做到这样。</p>
<h2 id="37、分布式Redis是前期做还是后期规模上来了再做好？为什么？"><a href="#37、分布式Redis是前期做还是后期规模上来了再做好？为什么？" class="headerlink" title="37、分布式Redis是前期做还是后期规模上来了再做好？为什么？"></a>37、分布式Redis是前期做还是后期规模上来了再做好？为什么？</h2><p>既然Redis是如此的轻量（单实例只使用1M内存）,为防止以后的扩容，最好的办法就是一开始就启动较多实例。即便你只有一台服务器，你也可以一开始就让Redis以分布式的方式运行，使用分区，在同一台服务器上启动多个实例。</p>
<p>一开始就多设置几个Redis实例，例如32或者64个实例，对大多数用户来说这操作起来可能比较麻烦，但是从长久来看做这点牺牲是值得的。</p>
<p>这样的话，当你的数据不断增长，需要更多的Redis服务器时，你需要做的就是仅仅将Redis实例从一台服务迁移到另外一台服务器而已（而不用考虑重新分区的问题）。一旦你添加了另一台服务器，你需要将你一半的Redis实例从第一台机器迁移到第二台机器。</p>
<h2 id="38、Twemproxy是什么？"><a href="#38、Twemproxy是什么？" class="headerlink" title="38、Twemproxy是什么？"></a>38、Twemproxy是什么？</h2><p>Twemproxy是Twitter维护的（缓存）代理系统，代理Memcached的ASCII协议和Redis协议。它是单线程程序，使用c语言编写，运行起来非常快。它是采用Apache 2.0 license的开源软件。 Twemproxy支持自动分区，如果其代理的其中一个Redis节点不可用时，会自动将该节点排除（这将改变原来的keys-instances的映射关系，所以你应该仅在把Redis当缓存时使用Twemproxy)。 Twemproxy本身不存在单点问题，因为你可以启动多个Twemproxy实例，然后让你的客户端去连接任意一个Twemproxy实例。 Twemproxy是Redis客户端和服务器端的一个中间层，由它来处理分区功能应该不算复杂，并且应该算比较可靠的。</p>
<h2 id="39、支持一致性哈希的客户端有哪些？"><a href="#39、支持一致性哈希的客户端有哪些？" class="headerlink" title="39、支持一致性哈希的客户端有哪些？"></a>39、支持一致性哈希的客户端有哪些？</h2><p>Redis-rb、Predis等。</p>
<h2 id="40、Redis与其他key-value存储有什么不同？"><a href="#40、Redis与其他key-value存储有什么不同？" class="headerlink" title="40、Redis与其他key-value存储有什么不同？"></a>40、Redis与其他key-value存储有什么不同？</h2><p>Redis有着更为复杂的数据结构并且提供对他们的原子性操作，这是一个不同于其他数据库的进化路径。Redis的数据类型都是基于基本数据结构的同时对程序员透明，无需进行额外的抽象。<br>Redis运行在内存中但是可以持久化到磁盘，所以在对不同数据集进行高速读写时需要权衡内存，应为数据量不能大于硬件内存。在内存数据库方面的另一个优点是， 相比在磁盘上相同的复杂的数据结构，在内存中操作起来非常简单，这样Redis可以做很多内部复杂性很强的事情。 同时，在磁盘格式方面他们是紧凑的以追加的方式产生的，因为他们并不需要进行随机访问。</p>
<h2 id="41、Redis的内存占用情况怎么样？"><a href="#41、Redis的内存占用情况怎么样？" class="headerlink" title="41、Redis的内存占用情况怎么样？"></a>41、Redis的内存占用情况怎么样？</h2><p>给你举个例子： 100万个键值对（键是0到999999值是字符串“hello world”）在我的32位的Mac笔记本上 用了100MB。同样的数据放到一个key里只需要16MB， 这是因为键值有一个很大的开销。 在Memcached上执行也是类似的结果，但是相对Redis的开销要小一点点，因为Redis会记录类型信息引用计数等等。</p>
<p>当然，大键值对时两者的比例要好很多。</p>
<p>64位的系统比32位的需要更多的内存开销，尤其是键值对都较小时，这是因为64位的系统里指针占用了8个字节。 但是，当然，64位系统支持更大的内存，所以为了运行大型的Redis服务器或多或少的需要使用64位的系统。</p>
<h2 id="42、都有哪些办法可以降低Redis的内存使用情况呢？"><a href="#42、都有哪些办法可以降低Redis的内存使用情况呢？" class="headerlink" title="42、都有哪些办法可以降低Redis的内存使用情况呢？"></a>42、都有哪些办法可以降低Redis的内存使用情况呢？</h2><p>如果你使用的是32位的Redis实例，可以好好利用Hash,list,sorted set,set等集合类型数据，因为通常情况下很多小的Key-Value可以用更紧凑的方式存放到一起。</p>
<h2 id="43、查看Redis使用情况及状态信息用什么命令？"><a href="#43、查看Redis使用情况及状态信息用什么命令？" class="headerlink" title="43、查看Redis使用情况及状态信息用什么命令？"></a>43、查看Redis使用情况及状态信息用什么命令？</h2><p>info</p>
<h2 id="44、Redis的内存用完了会发生什么？"><a href="#44、Redis的内存用完了会发生什么？" class="headerlink" title="44、Redis的内存用完了会发生什么？"></a>44、Redis的内存用完了会发生什么？</h2><p>如果达到设置的上限，Redis的写命令会返回错误信息（但是读命令还可以正常返回。）或者你可以将Redis当缓存来使用配置淘汰机制，当Redis达到内存上限时会冲刷掉旧的内容。</p>
<h2 id="45、Redis是单线程的，如何提高多核CPU的利用率？"><a href="#45、Redis是单线程的，如何提高多核CPU的利用率？" class="headerlink" title="45、Redis是单线程的，如何提高多核CPU的利用率？"></a>45、Redis是单线程的，如何提高多核CPU的利用率？</h2><p>可以在同一个服务器部署多个Redis的实例，并把他们当作不同的服务器来使用，在某些时候，无论如何一个服务器是不够的， 所以，如果你想使用多个CPU，你可以考虑一下分片（shard）。</p>
<h2 id="46、一个Redis实例最多能存放多少的keys？List、Set、Sorted-Set他们最多能存放多少元素？"><a href="#46、一个Redis实例最多能存放多少的keys？List、Set、Sorted-Set他们最多能存放多少元素？" class="headerlink" title="46、一个Redis实例最多能存放多少的keys？List、Set、Sorted Set他们最多能存放多少元素？"></a>46、一个Redis实例最多能存放多少的keys？List、Set、Sorted Set他们最多能存放多少元素？</h2><p>理论上Redis可以处理多达232的keys，并且在实际中进行了测试，每个实例至少存放了2亿5千万的keys。我们正在测试一些较大的值。</p>
<p>任何list、set、和sorted set都可以放232个元素。</p>
<p>换句话说，Redis的存储极限是系统中的可用内存值。</p>
<h2 id="47、Redis常见性能问题和解决方案？"><a href="#47、Redis常见性能问题和解决方案？" class="headerlink" title="47、Redis常见性能问题和解决方案？"></a>47、Redis常见性能问题和解决方案？</h2><p>(1) Master最好不要做任何持久化工作，如RDB内存快照和AOF日志文件</p>
<p>(2) 如果数据比较重要，某个Slave开启AOF备份数据，策略设置为每秒同步一次</p>
<p>(3) 为了主从复制的速度和连接的稳定性，Master和Slave最好在同一个局域网内</p>
<p>(4) 尽量避免在压力很大的主库上增加从库</p>
<p>(5) 主从复制不要用图状结构，用单向链表结构更为稳定，即：Master &lt;- Slave1 &lt;- Slave2 &lt;- Slave3…</p>
<p>这样的结构方便解决单点故障问题，实现Slave对Master的替换。如果Master挂了，可以立刻启用Slave1做Master，其他不变。</p>
<h2 id="48、Redis提供了哪几种持久化方式？"><a href="#48、Redis提供了哪几种持久化方式？" class="headerlink" title="48、Redis提供了哪几种持久化方式？"></a>48、Redis提供了哪几种持久化方式？</h2><p>RDB持久化方式能够在指定的时间间隔能对你的数据进行快照存储.<br>AOF持久化方式记录每次对服务器写的操作,当服务器重启的时候会重新执行这些命令来恢复原始的数据,AOF命令以redis协议追加保存每次写的操作到文件末尾.Redis还能对AOF文件进行后台重写,使得AOF文件的体积不至于过大.<br>如果你只希望你的数据在服务器运行的时候存在,你也可以不使用任何持久化方式.<br>你也可以同时开启两种持久化方式, 在这种情况下, 当redis重启的时候会优先载入AOF文件来恢复原始的数据,因为在通常情况下AOF文件保存的数据集要比RDB文件保存的数据集要完整.<br>最重要的事情是了解RDB和AOF持久化方式的不同,让我们以RDB持久化方式开始。</p>
<h2 id="49、如何选择合适的持久化方式？"><a href="#49、如何选择合适的持久化方式？" class="headerlink" title="49、如何选择合适的持久化方式？"></a>49、如何选择合适的持久化方式？</h2><p>一般来说， 如果想达到足以媲美PostgreSQL的数据安全性， 你应该同时使用两种持久化功能。如果你非常关心你的数据， 但仍然可以承受数分钟以内的数据丢失，那么你可以只使用RDB持久化。</p>
<p>有很多用户都只使用AOF持久化，但并不推荐这种方式：因为定时生成RDB快照（snapshot）非常便于进行数据库备份， 并且 RDB 恢复数据集的速度也要比AOF恢复的速度要快，除此之外， 使用RDB还可以避免之前提到的AOF程序的bug。</p>
<h2 id="50、修改配置不重启Redis会实时生效吗？"><a href="#50、修改配置不重启Redis会实时生效吗？" class="headerlink" title="50、修改配置不重启Redis会实时生效吗？"></a>50、修改配置不重启Redis会实时生效吗？</h2><p>针对运行实例，有许多配置选项可以通过 CONFIG SET 命令进行修改，而无需执行任何形式的重启。 从 Redis 2.2 开始，可以从 AOF 切换到 RDB 的快照持久性或其他方式而不需要重启 Redis。检索 ‘CONFIG GET *’ 命令获取更多信息。</p>
<p>但偶尔重新启动是必须的，如为升级 Redis 程序到新的版本，或者当你需要修改某些目前 CONFIG 命令还不支持的配置参数的时候。</p>
]]></content>
      <categories>
        <category>后端</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>redis</tag>
      </tags>
  </entry>
  <entry>
    <title>Redis集群实现</title>
    <url>/2020/03/26/Redis%E9%9B%86%E7%BE%A4%E5%AE%9E%E7%8E%B0/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><h1 id="1Redis集群实现"><a href="#1Redis集群实现" class="headerlink" title="1Redis集群实现"></a>1Redis集群实现</h1><h2 id="1-1Redis集群"><a href="#1-1Redis集群" class="headerlink" title="1.1Redis集群"></a>1.1Redis集群</h2><h3 id="1-1-1为什么要搭建集群"><a href="#1-1-1为什么要搭建集群" class="headerlink" title="1.1.1为什么要搭建集群"></a>1.1.1为什么要搭建集群</h3><p>通常，为了提高网站响应速度，总是把热点数据保存在内存中而不是直接从后端数据库中读取。<br>Redis是一个很好的Cache工具。大型网站应用，热点数据量往往巨大，几十G上百G是很正常的事儿。<br>由于内存大小的限制，使用一台 Redis 实例显然无法满足需求，这时就需要使用多台 Redis作为缓存数据库。但是如何保证数据存储的一致性呢,这时就需要搭建redis集群.采用合理的机制,保证用户的正常的访问需求.<br>采用redis集群,可以保证数据分散存储,同时保证数据存储的一致性.并且在内部实现高可用的机制.实现了服务故障的自动迁移.</p>
<h3 id="1-1-2集群搭建计划"><a href="#1-1-2集群搭建计划" class="headerlink" title="1.1.2集群搭建计划"></a>1.1.2集群搭建计划</h3><p>主从划分:<br>3台主机 3台从机共6台  端口划分7000-7005</p>
<h2 id="1-2集群搭建"><a href="#1-2集群搭建" class="headerlink" title="1.2集群搭建"></a>1.2集群搭建</h2><h3 id="1-2-1准备集群文件夹"><a href="#1-2-1准备集群文件夹" class="headerlink" title="1.2.1准备集群文件夹"></a>1.2.1准备集群文件夹</h3><p>1.准备集群文件夹<br>Mkdir cluster<br>2.在cluster文件夹中分别创建7000-7005文件夹</p>
<hr>
<h2 id=""><a href="#" class="headerlink" title=""></a><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-834d3a15932b4aa5b957be3c7fa90c74.png" alt="image.png"></h2><h3 id="1-2-2复制配置文件"><a href="#1-2-2复制配置文件" class="headerlink" title="1.2.2复制配置文件"></a>1.2.2复制配置文件</h3><p>说明:<br>将redis根目录中的redis.conf文件复制到cluster/7000/ 并以原名保存<br>cp redis.conf cluster/7000/</p>
<h3 id="1-2-3编辑配置文件"><a href="#1-2-3编辑配置文件" class="headerlink" title="1.2.3编辑配置文件"></a>1.2.3编辑配置文件</h3><p>1.注释本地绑定IP地址</p>
<hr>
<h2 id="-1"><a href="#-1" class="headerlink" title=""></a><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-7b1b777c1e06475da5a6741fdb816604.png" alt="image.png"></h2><p>2.关闭保护模式</p>
<hr>
<h2 id="-2"><a href="#-2" class="headerlink" title=""></a><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-4a784a85961c4a0186bc3b4192a731f9.png" alt="image.png"></h2><p>3.修改端口号</p>
<hr>
<h2 id="-3"><a href="#-3" class="headerlink" title=""></a><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-3fda490b94bc4d34b03a2a214944513d.png" alt="image.png"></h2><p>4.启动后台启动</p>
<hr>
<h2 id="-4"><a href="#-4" class="headerlink" title=""></a><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-d1d236f080d640788e199ce2131b79e8.png" alt="image.png"></h2><p>5.修改pid文件</p>
<hr>
<h2 id="-5"><a href="#-5" class="headerlink" title=""></a><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-c1e1ab0bbc1e4216b4c5d7a173c3dbb6.png" alt="image.png"></h2><p>6.修改持久化文件路径</p>
<hr>
<h2 id="-6"><a href="#-6" class="headerlink" title=""></a><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-59bb9452f2d14b559d9a2b6c089f27a4.png" alt="image.png"></h2><p>7.设定内存优化策略</p>
<hr>
<h2 id="-7"><a href="#-7" class="headerlink" title=""></a><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-05a18d27f9b04f2391a6e742bd14847c.png" alt="image.png"></h2><p>8.关闭AOF模式</p>
<hr>
<h2 id="-8"><a href="#-8" class="headerlink" title=""></a><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-461db8171ae445f794977741b89ec090.png" alt="image.png"></h2><p>9.开启集群配置</p>
<hr>
<h2 id="-9"><a href="#-9" class="headerlink" title=""></a><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-17ac0c2902c04c4184d49be6f315809c.png" alt="image.png"></h2><p>10.开启集群配置文件</p>
<hr>
<h2 id="-10"><a href="#-10" class="headerlink" title=""></a><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-db4a3c20823f4d5daeedb313218988ad.png" alt="image.png"></h2><p>11.修改集群超时时间</p>
<hr>
<h2 id="-11"><a href="#-11" class="headerlink" title=""></a><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-ae735b01dbc44e3b931d947629e4b7ae.png" alt="image.png"></h2><h3 id="1-2-4复制修改后的配置文件"><a href="#1-2-4复制修改后的配置文件" class="headerlink" title="1.2.4复制修改后的配置文件"></a>1.2.4复制修改后的配置文件</h3><p>说明:将7000文件夹下的redis.conf文件分别复制到7001-7005中</p>
<pre><code>[root@localhost cluster]# cp 7000/redis.conf  7001/
[root@localhost cluster]# cp 7000/redis.conf  7002/
[root@localhost cluster]# cp 7000/redis.conf  7003/
[root@localhost cluster]# cp 7000/redis.conf  7004/
[root@localhost cluster]# cp 7000/redis.conf  7005/</code></pre><h3 id="1-2-5批量修改"><a href="#1-2-5批量修改" class="headerlink" title="1.2.5批量修改"></a>1.2.5批量修改</h3><p>说明:分别将7001-7005文件中的7000改为对应的端口号的名称,<br>修改时注意方向键的使用</p>
<hr>
<h2 id="-12"><a href="#-12" class="headerlink" title=""></a><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-07dbc580650e4250b0b5992e0456a178.png" alt="image.png"></h2><h3 id="1-2-6通过脚本编辑启动-关闭指令"><a href="#1-2-6通过脚本编辑启动-关闭指令" class="headerlink" title="1.2.6通过脚本编辑启动/关闭指令"></a>1.2.6通过脚本编辑启动/关闭指令</h3><p>1.创建启动脚本  vim start.sh</p>
<hr>
<h2 id="-13"><a href="#-13" class="headerlink" title=""></a><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-6378e9a704f04028a8c1664eb0228790.png" alt="image.png"></h2><p>2.编辑关闭的脚本    vim  shutdown.sh</p>
<hr>
<h2 id="-14"><a href="#-14" class="headerlink" title=""></a><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-cbea1e4f601a4063b57924a19cfad16f.png" alt="image.png"></h2><p>3.启动redis节点<br>sh start.sh<br>4.检查redis节点启动是否正常</p>
<hr>
<h2 id="-15"><a href="#-15" class="headerlink" title=""></a><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-0453014e3d0a47319482723cce0c4b0f.png" alt="image.png"></h2><h3 id="1-2-7创建redis集群"><a href="#1-2-7创建redis集群" class="headerlink" title="1.2.7创建redis集群"></a>1.2.7创建redis集群</h3><p>#5.0版本执行 使用C语言内部管理集群<br>    redis-cli –cluster create –cluster-replicas 1 192.168.35.130:7000 192.168.35.130:7001 192.168.35.130:7002 192.168.35.130:7003 192.168.35.130:7004 192.168.35.130:7005</p>
<hr>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-5cd699f4926e4fb1b4e982c410bfd4dd.png" alt="image.png"></p>
<hr>
<h2 id="-16"><a href="#-16" class="headerlink" title=""></a><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-66518edf874c42d9af403b2108112c72.png" alt="image.png"></h2><h3 id="1-2-8Redis集群高可用测试"><a href="#1-2-8Redis集群高可用测试" class="headerlink" title="1.2.8Redis集群高可用测试"></a>1.2.8Redis集群高可用测试</h3><p>1.关闭redis主机.检查是否自动实现故障迁移.<br>2.再次启动关闭的主机.检查是否能够实现自动的挂载.<br>一般情况下 能够实现主从挂载<br>个别情况: 宕机后的节点重启,可能挂载到其他主节点中(7001-7002) 正确的</p>
<hr>
<h2 id="-17"><a href="#-17" class="headerlink" title=""></a><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-79b6603ee64a4e238a6d6b6027dd7e28.png" alt="image.png"></h2><h2 id="1-3Redis集群原理"><a href="#1-3Redis集群原理" class="headerlink" title="1.3Redis集群原理"></a>1.3Redis集群原理</h2><h3 id="1-3-1Redis集群高可用推选原理"><a href="#1-3-1Redis集群高可用推选原理" class="headerlink" title="1.3.1Redis集群高可用推选原理"></a>1.3.1Redis集群高可用推选原理</h3><p>如图-24所示</p>
<hr>
<h2 id="-18"><a href="#-18" class="headerlink" title=""></a><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-242074965c474745a343c3ec40c73620.png" alt="image.png"></h2><p>图- 24<br>原理说明:<br>Redis的所有节点都会保存当前redis集群中的全部主从状态信息.并且每个节点都能够相互通信.当一个节点发生宕机现象.则集群中的其他节点通过PING-PONG检测机制检查Redis节点是否宕机.当有半数以上的节点认为宕机.则认为主节点宕机.同时由Redis剩余的主节点进入选举机制.投票选举链接宕机的主节点的从机.实现故障迁移.</p>
<h3 id="1-3-2Redis集群宕机条件"><a href="#1-3-2Redis集群宕机条件" class="headerlink" title="1.3.2Redis集群宕机条件"></a>1.3.2Redis集群宕机条件</h3><p>特点:集群中如果主机宕机,那么从机可以继续提供服务,<br>当主机中没有从机时,则向其它主机借用多余的从机.继续提供服务.如果主机宕机时没有从机可用,则集群崩溃.<br>答案:9个redis节点,节点宕机5-7次时集群才崩溃.<br>如图-25所示:</p>
<hr>
<h2 id="-19"><a href="#-19" class="headerlink" title=""></a><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-1b78823638cc4399958e31d00b0b0878.png" alt="image.png"></h2><p>图- 25</p>
<h3 id="1-3-3Redis-hash槽存储数据原理"><a href="#1-3-3Redis-hash槽存储数据原理" class="headerlink" title="1.3.3Redis hash槽存储数据原理"></a>1.3.3Redis hash槽存储数据原理</h3><p>说明: RedisCluster采用此分区，所有的键根据哈希函数(CRC16[key]&amp;16383)映射到0－16384槽内，共16384个槽位，每个节点维护部分槽及槽所映射的键值数据.根据主节点的个数,均衡划分区间.<br> 算法:哈希函数: Hash()=CRC16[key]&amp;16384按位与<br>如图-26所示</p>
<hr>
<h2 id="-20"><a href="#-20" class="headerlink" title=""></a><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-72a8ed71a5fe4cf5a16091adbd480192.png" alt="image.png"></h2><p>图- 26</p>
<p>当向redis集群中插入数据时,首先将key进行计算.之后将计算结果匹配到具体的某一个槽的区间内,之后再将数据set到管理该槽的节点中.<br>如图-27所示</p>
<hr>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-c21369e67623451ab967a2ff79eb4a9b.png" alt="image.png"><br>图- 27</p>
<p>效率高:<br>            分片效率高:  发生在服务器中   redis只负责存取<br>            Redis集群:  发生在redis内部 效率低</p>
]]></content>
      <categories>
        <category>后端</category>
      </categories>
      <tags>
        <tag>redis</tag>
      </tags>
  </entry>
  <entry>
    <title>Redis 命令</title>
    <url>/2020/03/25/Redis%E5%91%BD%E4%BB%A4/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><h1 id="1-1Redis-命令"><a href="#1-1Redis-命令" class="headerlink" title="1.1Redis 命令"></a>1.1Redis 命令</h1><h3 id="1-1-1String类型"><a href="#1-1-1String类型" class="headerlink" title="1.1.1String类型"></a>1.1.1String类型</h3><table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
<th>案例</th>
</tr>
</thead>
<tbody><tr>
<td>set</td>
<td>添加key-value</td>
<td>set username admin</td>
</tr>
<tr>
<td>get</td>
<td>根据key获取数据</td>
<td>get username</td>
</tr>
<tr>
<td>strlen</td>
<td>获取key的长度</td>
<td>strlen key</td>
</tr>
<tr>
<td>exists</td>
<td>判断key是否存在</td>
<td>exists name 返回1存在  0不存在</td>
</tr>
<tr>
<td>del</td>
<td>删除redis中的key</td>
<td>del key</td>
</tr>
<tr>
<td>Keys</td>
<td>用于查询符合条件的key</td>
<td>keys * 查询redis中全部的keykeys n?me 使用占位符获取数据keys nam* 获取nam开头的数据</td>
</tr>
<tr>
<td>mset</td>
<td>赋值多个key-value</td>
<td>mset key1 value1 key2 value2 key3 value3</td>
</tr>
<tr>
<td>mget</td>
<td>获取多个key的值</td>
<td>mget key1 key2</td>
</tr>
<tr>
<td>append</td>
<td>对某个key的值进行追加</td>
<td>append key value</td>
</tr>
<tr>
<td>type</td>
<td>检查某个key的类型</td>
<td>type key</td>
</tr>
<tr>
<td>select</td>
<td>切换redis数据库</td>
<td>select 0-15 redis中共有16个数据库</td>
</tr>
<tr>
<td>flushdb</td>
<td>清空单个数据库</td>
<td>flushdb</td>
</tr>
<tr>
<td>flushall</td>
<td>清空全部数据库</td>
<td>flushall</td>
</tr>
<tr>
<td>incr</td>
<td>自动加1</td>
<td>incr key</td>
</tr>
<tr>
<td>decr</td>
<td>自动减1</td>
<td>decr key</td>
</tr>
<tr>
<td>incrby</td>
<td>指定数值添加</td>
<td>incrby 10</td>
</tr>
<tr>
<td>decrby</td>
<td>指定数值减</td>
<td>decrby 10</td>
</tr>
<tr>
<td>expire</td>
<td>指定key的生效时间 单位秒</td>
<td>expire key 20 key20秒后失效</td>
</tr>
<tr>
<td>pexpire</td>
<td>指定key的失效时间 单位毫秒</td>
<td>pexpire key 2000key 2000毫秒后失效</td>
</tr>
<tr>
<td>ttl</td>
<td>检查key的剩余存活时间</td>
<td>ttl key</td>
</tr>
<tr>
<td>persist</td>
<td>撤销key的失效时间</td>
<td>persist key</td>
</tr>
</tbody></table>
<h3 id="1-1-1-2Hash类型"><a href="#1-1-1-2Hash类型" class="headerlink" title="1. 1.1.2Hash类型"></a>1. 1.1.2Hash类型</h3><p>说明:可以用散列类型保存对象和属性值</p>
<p>例子:User对象{id:2,name:小明,age:19}</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
<th>案例</th>
</tr>
</thead>
<tbody><tr>
<td>hset</td>
<td>为对象添加数据</td>
<td>hset key field value</td>
</tr>
<tr>
<td>hget</td>
<td>获取对象的属性值</td>
<td>hget key field</td>
</tr>
<tr>
<td>hexists</td>
<td>判断对象的属性是否存在</td>
<td>HEXISTS key field1表示存在  0表示不存在</td>
</tr>
<tr>
<td>hdel</td>
<td>删除hash中的属性</td>
<td>hdel user field [field …]</td>
</tr>
<tr>
<td>hgetall</td>
<td>获取hash全部元素和值</td>
<td>HGETALL key</td>
</tr>
<tr>
<td>hkyes</td>
<td>获取hash中的所有字段</td>
<td>HKEYS key</td>
</tr>
<tr>
<td>hlen</td>
<td>获取hash中所有属性的数量</td>
<td>hlen key</td>
</tr>
<tr>
<td>hmget</td>
<td>获取hash里面指定字段的值</td>
<td>hmget key field [field …]</td>
</tr>
<tr>
<td>hmset</td>
<td>为hash的多个字段设定值</td>
<td>hmset key field value [field value …]</td>
</tr>
<tr>
<td>hsetnx</td>
<td>设置hash的一个字段,只有当这个字段不存在时有效</td>
<td>HSETNX key field value</td>
</tr>
<tr>
<td>hstrlen</td>
<td>获取hash中指定key的长度</td>
<td>HSTRLEN key field</td>
</tr>
<tr>
<td>hvals</td>
<td>获取hash的所有值</td>
<td>HVALS user</td>
</tr>
</tbody></table>
<h3 id="1-1-1-3List类型"><a href="#1-1-1-3List类型" class="headerlink" title="1. 1.1.3List类型"></a>1. 1.1.3List类型</h3><p>说明:Redis中的List集合是双端循环列表,分别可以从左右两个方向插入数据.</p>
<p>List集合可以当做队列使用,也可以当做栈使用</p>
<p>队列:存入数据的方向和获取数据的方向相反</p>
<p>栈:存入数据的方向和获取数据的方向相同</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
<th>案例</th>
</tr>
</thead>
<tbody><tr>
<td>lpush</td>
<td>从队列的左边入队一个或多个元素</td>
<td>LPUSH key value [value …]</td>
</tr>
<tr>
<td>rpush</td>
<td>从队列的右边入队一个或多个元素</td>
<td>RPUSH key value [value …]</td>
</tr>
<tr>
<td>lpop</td>
<td>从队列的左端出队一个元素</td>
<td>LPOP key</td>
</tr>
<tr>
<td>rpop</td>
<td>从队列的右端出队一个元素</td>
<td>RPOP key</td>
</tr>
<tr>
<td>lpushx</td>
<td>当队列存在时从队列的左侧入队一个元素</td>
<td>LPUSHX key value</td>
</tr>
<tr>
<td>rpushx</td>
<td>当队列存在时从队列的右侧入队一个元素</td>
<td>RPUSHx key value</td>
</tr>
<tr>
<td>lrange</td>
<td>从列表中获取指定返回的元素</td>
<td>LRANGE key start stop  Lrange key 0 -1 获取全部队列的数据</td>
</tr>
<tr>
<td>lrem</td>
<td>从存于 key 的列表里移除前 count 次出现的值为 value 的元素。 这个 count 参数通过下面几种方式影响这个操作：</td>
<td></td>
</tr>
<tr>
<td>- count &gt; 0: 从头往尾移除值为 value 的元素。</td>
<td></td>
<td></td>
</tr>
<tr>
<td>- count &lt; 0: 从尾往头移除值为 value 的元素。</td>
<td></td>
<td></td>
</tr>
<tr>
<td>- count = 0: 移除所有值为 value 的元素。</td>
<td></td>
<td></td>
</tr>
<tr>
<td>LREM list -2 “hello” 会从存于 list 的列表里移除最后两个出现的 “hello”。需要注意的是，如果list里没有存在key就会被当作空list处理，所以当 key 不存在的时候，这个命令会返回 0。</td>
<td></td>
<td></td>
</tr>
<tr>
<td>Lset</td>
<td>设置 index 位置的list元素的值为 value</td>
<td>LSET key index value</td>
</tr>
</tbody></table>
<h3 id="1-1-1-4Redis事务命令"><a href="#1-1-1-4Redis事务命令" class="headerlink" title="1.1.1.4Redis事务命令"></a>1.1.1.4Redis事务命令</h3><p>说明:redis中操作可以添加事务的支持.一项任务可以由多个redis命令完成,如果有一个命令失败导致入库失败时.需要实现事务回滚.</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>说明</th>
<th>案例</th>
</tr>
</thead>
<tbody><tr>
<td>multi</td>
<td>标记一个事务开始</td>
<td>127.0.0.1:6379&gt; MULTIOK</td>
</tr>
<tr>
<td>exec</td>
<td>执行所有multi之后发的命令</td>
<td>127.0.0.1:6379&gt; EXEC OK</td>
</tr>
<tr>
<td>discard</td>
<td>丢弃所有multi之后发的命令</td>
<td></td>
</tr>
</tbody></table>
<h1 id="2Redis高级应用"><a href="#2Redis高级应用" class="headerlink" title="2Redis高级应用"></a>2Redis高级应用</h1><h2 id="2-1-Redis入门案例"><a href="#2-1-Redis入门案例" class="headerlink" title="2.1 Redis入门案例"></a>2.1 Redis入门案例</h2><h3 id="2-1-1添加jar包文件"><a href="#2-1-1添加jar包文件" class="headerlink" title="2.1.1添加jar包文件"></a>2.1.1添加jar包文件</h3><p>说明:在JT-PARENT项目中添加jar包文件</p>
<pre><code>&lt;!-- jedis --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;redis.clients&lt;/groupId&gt;
        &lt;artifactId&gt;jedis&lt;/artifactId&gt;
        &lt;version&gt;${jedis.version}&lt;/version&gt;
    &lt;/dependency&gt;

    &lt;!--添加spring-datajar包  --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.data&lt;/groupId&gt;
        &lt;artifactId&gt;spring-data-redis&lt;/artifactId&gt;
        &lt;version&gt;1.4.1.RELEASE&lt;/version&gt;
    &lt;/dependency&gt;</code></pre><p>2.1.2入门案例-String</p>
<pre><code>/**
 * 连接单台redis  
 * 参数介绍:
 *     redisIP地址.
 *  redis:6379
 */
@Test
public void test01(){
    Jedis jedis = new Jedis(&quot;192.168.126.166&quot;,6379);
    jedis.set(&quot;redis&quot;, &quot;redis入门案例&quot;);
    System.out.println
    (&quot;获取redis中的数据:&quot;+jedis.get(&quot;redis&quot;));
    //为数据设定超时时间  单位秒
    jedis.setex(&quot;1804&quot;, 100, &quot;1804班&quot;);
}</code></pre><p>2.1.3入门案例-hash</p>
<pre><code>@Test
public void test01(){
    Jedis jedis = new Jedis(&quot;192.168.126.148&quot;, 6379);
    jedis.hset(&quot;user&quot;, &quot;id&quot;, &quot;1&quot;);
    jedis.hset(&quot;user&quot;, &quot;name&quot;, &quot;tomcat&quot;);
    jedis.hset(&quot;user&quot;, &quot;age&quot;, &quot;18&quot;);
    System.out.println(&quot;操作完成!!!&quot;+jedis.hget(&quot;user&quot;, &quot;id&quot;));
    Map&lt;String,String&gt; map = jedis.hgetAll(&quot;user&quot;);
    System.out.println(map);
}</code></pre><p>结果展现:<br>操作完成!!!1<br>{name=tomcat, age=18, id=1}<br>2.1.4入门案例-List</p>
<pre><code>@Test
public void test02(){
    Jedis jedis = new Jedis(&quot;192.168.126.148&quot;, 6379);
    Long number = jedis.lpush(&quot;list&quot;, &quot;a&quot;,&quot;b&quot;,&quot;c&quot;,&quot;d&quot;,&quot;e&quot;);
    System.out.println(&quot;获取数据&quot;+number);
    List&lt;String&gt; list= jedis.lrange(&quot;list&quot;, 0, -1);
    System.out.println(&quot;获取参数:&quot;+list);
}</code></pre><p>结果展现:<br>获取数据5<br>获取参数:[e, d, c, b, a]</p>
]]></content>
      <categories>
        <category>后端</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>redis</tag>
      </tags>
  </entry>
  <entry>
    <title>SPRING 框架MVC模块进阶</title>
    <url>/2020/03/22/SPRING%E6%A1%86%E6%9E%B6MVC%E6%A8%A1%E5%9D%97%E8%BF%9B%E9%98%B6/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><h1 id="2-SPRING-框架MVC模块进阶"><a href="#2-SPRING-框架MVC模块进阶" class="headerlink" title="2.SPRING 框架MVC模块进阶"></a>2.SPRING 框架MVC模块进阶</h1><h2 id="2-1-Spring-MVC-设计思想"><a href="#2-1-Spring-MVC-设计思想" class="headerlink" title="2.1.Spring MVC 设计思想"></a>2.1.Spring MVC 设计思想</h2><h3 id="2-1-1-Spring-MVC-设计思想分析"><a href="#2-1-1-Spring-MVC-设计思想分析" class="headerlink" title="2.1.1.Spring MVC 设计思想分析"></a>2.1.1.Spring MVC 设计思想分析</h3><p>MVC是一种分层架构设计思想，目的是基于对象职责上的不同，进行分层设计，实现各司其职，各尽所能，以提高代码的可维护性，可扩展性。<br>1)生活中的MVC:正规饭店(菜单,服务员,厨师)<br>2)程序中的MVC:(html,jsp)/servlet/(service,dao))</p>
<hr>
<h2 id=""><a href="#" class="headerlink" title=""></a><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-7a786784d3ca41f4946261f296b671bd.png" alt="image.png"></h2><p>SPRING MVC是Spring 框架中的一个WEB模块, 是基于MVC设思想的一种完美实现。</p>
<h3 id="2-1-2-Spring-MVC-核心对象及流程分析"><a href="#2-1-2-Spring-MVC-核心对象及流程分析" class="headerlink" title="2.1.2.Spring MVC 核心对象及流程分析"></a>2.1.2.Spring MVC 核心对象及流程分析</h3><p>Spring MVC 处理流程及其核心组件对象构成，如下图所示：</p>
<hr>
<h2 id="-1"><a href="#-1" class="headerlink" title=""></a><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-349c5b35210b4a4b9bb0991a02d335bc.png" alt="image.png"></h2><p>FAQ：说说spring MVC中的核心组件？<br>1)DipatcherServlet:前端控制器(web服务器启动时加载)<br>2)HandlerMapping:注册中心(负责存储url到后端控制器的映射)<br>3)HandlerInterceptor:拦截器(请求到handler之间的拦截)<br>4)Handler:后端处理器(又称之为Controller)<br>5)ViewResolver:视图解析器(负责是视图页面进行解析)</p>
<h2 id="2-2-Spring-MVC-快速实践"><a href="#2-2-Spring-MVC-快速实践" class="headerlink" title="2.2.Spring MVC 快速实践"></a>2.2.Spring MVC 快速实践</h2><h3 id="2-2-1-xml方式配置实现-脱离文档"><a href="#2-2-1-xml方式配置实现-脱离文档" class="headerlink" title="2.2.1.xml方式配置实现(脱离文档)"></a>2.2.1.xml方式配置实现(脱离文档)</h3><p>1.创建maven项目</p>
<p>1)项目名称: CGB-SPRINGMVC-01<br>2)组id: com.cy<br>3)打包方式: war包方式</p>
<p>2.配置并初始化项目环境</p>
<p>1)生成web.xml(配置spring mvc 前端控制器)<br>2)设置项目的运行时环境(选择tomcat,提供servlet支持)<br>3)设置项目编码方式 utf-8<br>4)设置统一编译环境 JDK8<br>5)添加项目依赖:spring-webmvc<br>6)添加spring mvc配置文件并进行配置:spring-configs.xml<br>7)web.xml中配置spring mvc前端控制器(DispatcherServlet)<br>8)部署项目,启动tomcat测试 (假如tomcat正常启动,则没问题)</p>
<p>说明:如上配置可参考后面内容中的关键代码分享.</p>
<p>3.Spring MVC基础业务实现 </p>
<p>1)定义Controller类<br>a)包名:com.cy.pj.search.controller<br>b)类名:SearchController</p>
<p>代码如下:</p>
<pre><code>@Controller
@RequestMapping(&quot;/search/&quot;)
public class SearchController {
}</code></pre><p>其中:@RequestMapping修饰类时用于定义请求路径</p>
<p>2)添加Controller方法<br>方法1:此方法用于向客户端返回一个页面</p>
<pre><code>@RequestMapping(&quot;doSearchUI&quot;)
public String doSearchUI() {
return &quot;search&quot;;
}</code></pre><p>其中:对于返回值search需要在/WEB-INF/pages/目录下有对应的<br>search.html页面.</p>
<p>方法2:此方法用于向客户端返回一个json格式的字符串</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"doSearch"</span>)</span><br><span class="line">	<span class="meta">@ResponseBody</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">doSearch</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">		Map&lt;String,Object&gt; map=<span class="keyword">new</span> HashMap&lt;String,Object&gt;();</span><br><span class="line">		map.put(<span class="string">"state"</span>, <span class="number">1</span>);</span><br><span class="line">		map.put(<span class="string">"message"</span>,<span class="string">"hello everyone"</span>);</span><br><span class="line">		<span class="keyword">return</span> map;<span class="comment">//&#123;"state":1,"message":"hello everyone"&#125;</span></span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>其中:<br>a)@ResponseBody修饰方法时,Spring MVC可以将方法的返回值以指定格式进行进行输出,例如JSON格式字符串.<br>b)doSearch方法进行测试时,需要在项目中添加如下依赖:</p>
<pre><code>&lt;dependency&gt;
    &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt;
    &lt;artifactId&gt;jackson-databind&lt;/artifactId&gt;
    &lt;version&gt;2.9.9.3&lt;/version&gt;
&lt;/dependency&gt;</code></pre><p>3)部署并启动服务测试.</p>
<p>4.关键代码分享:</p>
<p>spring-configs.xml</p>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;
    xmlns:mvc=&quot;http://www.springframework.org/schema/mvc&quot;
    xmlns:context=&quot;http://www.springframework.org/schema/context&quot;
    xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
    xsi:schemaLocation=&quot;
        http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/context
        http://www.springframework.org/schema/context/spring-context.xsd
        http://www.springframework.org/schema/mvc
        http://www.springframework.org/schema/mvc/spring-mvc.xsd&quot;&gt;

    &lt;context:component-scan base-package=&quot;com.cy.controller&quot;/&gt;
    &lt;!-- Enable MVC Configuration:启用默认bean对象(注解驱动)  --&gt;
    &lt;mvc:annotation-driven/&gt;
    &lt;!-- 启用 DefaultServletHttpRequestHandler对静态进行处理 --&gt;
    &lt;mvc:default-servlet-handler/&gt;
    &lt;!-- 配置视图解析器(ViewResolver)对象 --&gt;
    &lt;bean id=&quot;viewResolver&quot;  class=&quot;org.springframework.web.servlet.view.InternalResourceViewResolver&quot;&gt;
       &lt;!-- Set DI (默认找对象中的set方法)--&gt;
       &lt;property name=&quot;Prefix&quot; value=&quot;/WEB-INF/pages/&quot;/&gt;
       &lt;property name=&quot;Suffix&quot; value=&quot;.html&quot;/&gt;
    &lt;/bean&gt;
&lt;/beans&gt;</code></pre><p>Web.xml</p>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;web-app xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns=&quot;http://java.sun.com/xml/ns/javaee&quot; xsi:schemaLocation=&quot;http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd&quot; version=&quot;2.5&quot;&gt;
  &lt;display-name&gt;CGB-SPRINGMVC-01&lt;/display-name&gt;
  &lt;!-- 配置前端控制器 --&gt;
  &lt;servlet&gt;
    &lt;servlet-name&gt;frontController&lt;/servlet-name&gt;
    &lt;servlet-class&gt;org.springframework.web.servlet.DispatcherServlet&lt;/servlet-class&gt;
    &lt;init-param&gt;
        &lt;param-name&gt;contextConfigLocation&lt;/param-name&gt;
        &lt;param-value&gt;classpath:spring-configs.xml&lt;/param-value&gt;
    &lt;/init-param&gt;
    &lt;!-- tomcat 启动时则初始化servlet,数字越小优先级越高 --&gt;
    &lt;load-on-startup&gt;1&lt;/load-on-startup&gt;
  &lt;/servlet&gt;
  &lt;servlet-mapping&gt;
     &lt;servlet-name&gt;frontController&lt;/servlet-name&gt;
     &lt;url-pattern&gt;/&lt;/url-pattern&gt;
  &lt;/servlet-mapping&gt;
&lt;/web-app&gt;</code></pre><p>SearchController</p>
<pre><code>package com.cy.pj.search.controller;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.ResponseBody;
@Controller 
@RequestMapping(&quot;/search/&quot;) 
public class SearchController {
    @RequestMapping(&quot;doSearchUI&quot;)
    public String doSearchUI() {
        return &quot;search&quot;;
    }///WEB-INF/pages/search.html

    @RequestMapping(&quot;doSearch&quot;)
    @ResponseBody
    public Object doSearch(String key) {
        Map&lt;String,Object&gt; map=new HashMap&lt;String,Object&gt;();
        map.put(&quot;state&quot;, 1);
        map.put(&quot;message&quot;,&quot;hello everyone&quot;);
        return map;//{&quot;state&quot;:1,&quot;message&quot;:&quot;hello everyone&quot;}
    }
}</code></pre><h3 id="2-2-2-注解方式配置实现（脱离文档）"><a href="#2-2-2-注解方式配置实现（脱离文档）" class="headerlink" title="2.2.2.注解方式配置实现（脱离文档）"></a>2.2.2.注解方式配置实现（脱离文档）</h3><p>Tomcat 启动加载方式:</p>
<hr>
<h2 id="-2"><a href="#-2" class="headerlink" title=""></a><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-20db542cf104453c8a8451787821bda0.png" alt="image.png"></h2><p>1.创建maven项目</p>
<p>1)项目名称: CGB-SPRINGMVC-02<br>2)组id: com.cy<br>3)打包方式: war包方式</p>
<p>2.配置并初始化项目环境(重点对xml方式进行重构)</p>
<p>1)配置maven war包插件(忽略web.xml)<br>2)设置项目的运行时环境(选择tomcat)<br>3)设置项目编码方式 utf-8<br>4)设置统一编译环境 JDK8<br>5)添加项目依赖:spring-webmvc<br>6)添加spring mvc配置类:SpringWebConfig类<br>7)创建WebInitializer类配置spring mvc(例如前端控制器)。<br>8)部署项目,启动tomcat测试 (假如tomcat正常启动,则没问题)</p>
<p>3.Spring MVC基础业务实现 (参考xml方式业务代码实现)</p>
<p>4.Spring mvc 注解方式应用分析:</p>
<hr>
<h2 id="-3"><a href="#-3" class="headerlink" title=""></a><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-de958697c6d948dda4e45ae287c18496.png" alt="image.png"></h2><p>其中META-INF目录可在sping-web.jar中进行查看.</p>
<p>关键代码分析:</p>
<p>SpringWebConfig类</p>
<pre><code>@Configuration 
@ComponentScan(&quot;com.cy.pj.search.controller&quot;)
@EnableWebMvc //&lt;mvc:annotation-driven/&gt;
public class SpringWebConfig implements WebMvcConfigurer{
    //&lt;mvc:default-servlet-handler/&gt;
    @Override
    public void configureDefaultServletHandling(
            DefaultServletHandlerConfigurer configurer) {
        configurer.enable();
    }
    @Override
    public void configureViewResolvers(
        ViewResolverRegistry registry) {
        registry.jsp(&quot;/WEB-INF/pages/&quot;,&quot;.html&quot;);
    }
}</code></pre><p>WebInitializer类</p>
<pre><code>public class WebInitializer extends 
AbstractAnnotationConfigDispatcherServletInitializer {

    //Service,Repository
    @Override
    protected Class&lt;?&gt;[] getRootConfigClasses() {
        System.out.println(&quot;getRootConfigClasses()&quot;);
        return null;
    }
    //View,Controller
    @Override
    protected Class&lt;?&gt;[] getServletConfigClasses() {
        System.out.println(&quot;getServletConfigClasses()&quot;);
        return new Class[] {SpringWebConfig.class};
    }
    @Override
    protected String[] getServletMappings() {
        System.out.println(&quot;getServletMappings()&quot;);
        return new String[] {&quot;/&quot;};
    }
}</code></pre><h2 id="2-3-Spring-MVC-请求响应处理增强分析"><a href="#2-3-Spring-MVC-请求响应处理增强分析" class="headerlink" title="2.3.Spring MVC 请求响应处理增强分析"></a>2.3.Spring MVC 请求响应处理增强分析</h2><p>所有MVC框架的重点都在请求和响应数据的处理上。</p>
<h3 id="2-3-1-请求处理增强分析及实现-重点"><a href="#2-3-1-请求处理增强分析及实现-重点" class="headerlink" title="2.3.1.请求处理增强分析及实现(重点)"></a>2.3.1.请求处理增强分析及实现(重点)</h3><p>Spring MVC请求处理主要从如下几个方面进行考虑：<br>1)请求路径(普通方式，rest方式) ：404<br>2)请求方式(Get请求，Post请求,…):405<br>3)请求参数(直接量，POJO对象，MAP对象):400</p>
<p>代码分析如下：</p>
<pre><code>@Controller
@RequestMapping(&quot;/request/&quot;)
public class RequestHandleController {
     //===请求url定义 
      //普通URL定义实现(多个url可以对应同一个资源)
      @RequestMapping(value={&quot;doHandleUrl&quot;,&quot;doWelcomeUI&quot;})
      public String doHandleUrl() {
         return &quot;welcome&quot;; 
      }
      //REST风格的URL，其url格式为{a}/{b}/{c}
      //假如希望方法参数获取url中{}表达式内部的值
      //可以使用@PathVariable对参数进行修饰
      @RequestMapping(&quot;{module}/{page}&quot;)
      public String doMoudleUrl(
              @PathVariable String module,
              @PathVariable String page) {
         return module+&quot;/&quot;+page;
      }
      //===请求方式定义
      //@RequestMapping(value=&quot;type&quot;,method=RequestMethod.GET)
      @GetMapping(&quot;type&quot;)
      //@PostMapping(&quot;type&quot;)
      @ResponseBody
      public String doRequestType() {
          return &quot;request type&quot;;
      }
      //=====请求参数处理======
      @GetMapping(&quot;param&quot;)
      @ResponseBody
      public String doRequestParam(
             RequestWrapper rw,//pojo
             @RequestParam(required=false) String msg,
             @DateTimeFormat(pattern=&quot;yyyy/MM/dd&quot;)Date begin) {
          return &quot;request parameter handle msg=&quot;+msg+&quot;,begin=&quot;+begin+&quot;,rw=&quot;+rw.toString();
      }
}</code></pre><h3 id="2-3-2-响应处理增强分析实现（重点）"><a href="#2-3-2-响应处理增强分析实现（重点）" class="headerlink" title="2.3.2.响应处理增强分析实现（重点）"></a>2.3.2.响应处理增强分析实现（重点）</h3><p>Spring MVC响应处理主要从如下几个方面进行考虑：<br>1）响应方式(转发forward，重定向redirect)<br>2）响应数据封装(ModelAndView,Model,Map,Pojo)<br>3）响应数据转换（将对象序列化为JSON格式字符串）</p>
<p>代码分析如下：</p>
<pre><code>@Controller
@RequestMapping(&quot;/resp/&quot;)
public class ResponseHandleController {
     @RequestMapping(&quot;doResponseUI&quot;)
     public String doResponseUI() {
         return &quot;response&quot;;
     }
     @RequestMapping(&quot;type&quot;)
     public String doResponseType() {
         //转发(客户端请求一次)
         return &quot;forward:doResponseUI&quot;;//address
         //重定向(客户端两次请求)
         //return &quot;redirect:doResponseUI&quot;;//address
     }

     @RequestMapping(&quot;doDataConvert&quot;)
     @ResponseBody
     public String doDataConvert()throws Exception {
         Map&lt;String,Object&gt; map=new HashMap&lt;String,Object&gt;();
         map.put(&quot;id&quot;, 100);
         map.put(&quot;msg&quot;, &quot;hello jackson&quot;);
         //借助jackson中的API将对象转换json格式的字符串
         ObjectMapper om=new ObjectMapper();
         return om.writeValueAsString(map);
     }
}</code></pre><h1 id="少年易老学难成，一寸光阴不可轻。"><a href="#少年易老学难成，一寸光阴不可轻。" class="headerlink" title="少年易老学难成，一寸光阴不可轻。"></a>少年易老学难成，一寸光阴不可轻。</h1>]]></content>
      <categories>
        <category>后端</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>SPRING 框架核心进阶</title>
    <url>/2020/03/21/SPRING%E6%A1%86%E6%9E%B6%E6%A0%B8%E5%BF%83%E8%BF%9B%E9%98%B6/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><h1 id="1-SPRING-框架核心进阶"><a href="#1-SPRING-框架核心进阶" class="headerlink" title="1.SPRING 框架核心进阶"></a>1.SPRING 框架核心进阶</h1><h2 id="1-1-SPRING-框架架构分析"><a href="#1-1-SPRING-框架架构分析" class="headerlink" title="1.1.SPRING 框架架构分析"></a>1.1.SPRING 框架架构分析</h2><h3 id="1-1-1-Spring-框架应用架构"><a href="#1-1-1-Spring-框架应用架构" class="headerlink" title="1.1.1.Spring 框架应用架构"></a>1.1.1.Spring 框架应用架构</h3><hr>
<p>Spring 官网资源:spring.io/projects<br>Spring 是一个”资源整合”框架,通过spring可将很多资源(例如连接池,<br>mybatis,…)等整合在一起,对外提供相关服务(例如,秒杀服务,支付服务,…)。</p>
<hr>
<h2 id=""><a href="#" class="headerlink" title=""></a><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-d92bfc62abae4b1abbc7a002da599370.png" alt="image.png"></h2><p>说明:spring 框架中一切资源的整合都源于IOC模块，IOC要实现对象生命周期的管理，对象依赖关系的管理。</p>
<h3 id="1-1-2-Spring-框架产品架构"><a href="#1-1-2-Spring-框架产品架构" class="headerlink" title="1.1.2. Spring 框架产品架构"></a>1.1.2. Spring 框架产品架构</h3><hr>
<p>产品架构主要从这个框架对外提供的服务（功能）进行理解.</p>
<hr>
<h2 id="-1"><a href="#-1" class="headerlink" title=""></a><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-9dbc108b167f467ca8b895cd29288f64.png" alt="image.png"></h2><h3 id="1-1-3-Spring-框架技术架构"><a href="#1-1-3-Spring-框架技术架构" class="headerlink" title="1.1.3.Spring 框架技术架构"></a>1.1.3.Spring 框架技术架构</h3><p>IOC API基础架构(Spring 工厂对象分析)</p>
<hr>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-96662d4783ed4306993deb401bac9c8b.png" alt="image.png"><br>IOC(控制反转) 容器初始化过程分析.</p>
<hr>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-92dc43a7d1364ae694bd834ebf80e959.png" alt="image.png"></p>
<h2 id="1-2-SPRING框架快速实践-注解方式-脱离文档"><a href="#1-2-SPRING框架快速实践-注解方式-脱离文档" class="headerlink" title="1.2.SPRING框架快速实践 (注解方式-脱离文档)"></a>1.2.SPRING框架快速实践 (注解方式-脱离文档)</h2><h3 id="1-2-1-Spring项目创建及配置"><a href="#1-2-1-Spring项目创建及配置" class="headerlink" title="1.2.1.Spring项目创建及配置"></a>1.2.1.Spring项目创建及配置</h3><p>1.创建maven项目(jar包项目)<br>1)项目名称 CGB-SPRING-01<br>2)组id:com.cy<br>3)打包方式:jar</p>
<p>2.添加项目依赖(spring-context)</p>
<p>添加spring依赖</p>
<pre><code>&lt;dependency&gt;
 &lt;groupId&gt;org.springframework&lt;/groupId&gt;
 &lt;artifactId&gt;spring-context&lt;/artifactId&gt;
 &lt;version&gt;5.1.9.RELEASE&lt;/version&gt;
&lt;/dependency&gt;</code></pre><p>添加junit依赖</p>
<pre><code>&lt;dependency&gt;
  &lt;groupId&gt;junit&lt;/groupId&gt;
  &lt;artifactId&gt;junit&lt;/artifactId&gt;
  &lt;version&gt;4.12&lt;/version&gt;
&lt;/dependency&gt;</code></pre><h3 id="1-2-2-Spring基本测试环境创建"><a href="#1-2-2-Spring基本测试环境创建" class="headerlink" title="1.2.2.Spring基本测试环境创建"></a>1.2.2.Spring基本测试环境创建</h3><p>添加spring配置类(SpringConfig)</p>
<pre><code>package com.cy.spring.config;
import org.springframework.context.annotation.ComponentScan;
/**
 * @ComponentScan 用于告诉spring容器从
   * 从指定包进行bean的扫描
 */
@ComponentScan(&quot;com.cy.spring.beans&quot;)
public class SpringConfig {//spring-configs.xml

}</code></pre><p>定义测试基类 </p>
<pre><code>package com.spring;
import org.junit.After;
import org.junit.Before;
import org.junit.Test;
import org.springframework.context.annotation.AnnotationConfigApplicationContext;
public class TestBase {
     protected AnnotationConfigApplicationContext ctx;
     @Before
     public void init() {
      ctx=new AnnotationConfigApplicationContext(
                 SpringConfig.class);
     }
     @After
     public void close() {
         ctx.close();
     }
     @Test
     public void testCtx() {
         System.out.println(ctx);
     }
}</code></pre><h3 id="1-2-3-Spring项目基本业务实现"><a href="#1-2-3-Spring项目基本业务实现" class="headerlink" title="1.2.3.Spring项目基本业务实现"></a>1.2.3.Spring项目基本业务实现</h3><p>业务描述,创建一个DefaultCache对象然后将此对象交给Spring容器管理.<br>创建DefaultCache类,并明确此类交给spring管理.</p>
<pre><code>package com.cy.spring.beans;
import javax.annotation.PostConstruct;
import javax.annotation.PreDestroy;
import org.springframework.context.annotation.Lazy;
import org.springframework.context.annotation.Scope;
import org.springframework.stereotype.Component;
/**
@Component 注解用于告诉spring容器
请将这个类交给spring管理.
@Lazy 用于告诉spring容器此对象要延迟加载
@Scope 用于告诉spring容器此bean的作用域
1)singleton (单例作用域-默认,会存储到池中)
2)prototype (多例作用域,每次获取都创建新对象)
 */
@Lazy
@Scope(&quot;singleton&quot;) 
@Component //@Controller,@Service,...
public class DefaultCache {
     public DefaultCache() {
         System.out.println(&quot;DefaultCache()&quot;);
     }
     @PostConstruct //告诉spring 此对象初始化时执行init方法
     public void init() {
         System.out.println(&quot;init()&quot;);
     }
     @PreDestroy//告诉spring 此对象销毁时执行close方法
     public void close() {
         System.out.println(&quot;close()&quot;);
     }
}</code></pre><p>定义测试类,从spring容器中获取bean对象</p>
<pre><code>package com.cy.test;
import org.junit.Assert;
import org.junit.Test;
import com.cy.spring.beans.DefaultCache;
public class TestCache extends TestBase {
    @Test
    public void testDefaultCahce() {
        DefaultCache cache01=
        ctx.getBean(&quot;defaultCache&quot;,DefaultCache.class);
        Assert.assertNotEquals(null, cache01);
        DefaultCache cache02=
        ctx.getBean(&quot;defaultCache&quot;,DefaultCache.class);
        Assert.assertNotEquals(null, cache02);
        System.out.println(cache01==cache02);
    }
}</code></pre><h3 id="1-2-4-Spring项目课堂练习分析及实现"><a href="#1-2-4-Spring项目课堂练习分析及实现" class="headerlink" title="1.2.4.Spring项目课堂练习分析及实现"></a>1.2.4.Spring项目课堂练习分析及实现</h3><p>1.整合第三方连接池DRUID.<br>1)步骤分析:<br>step01:添加依赖(数据库驱动依赖,连接池依赖)<br>step02:对druid连接池进行配置<br>step03:对连接池进行单元测试.<br>2)关键代码实现</p>
<p>添加mysql依赖</p>
<pre><code>&lt;dependency&gt;
    &lt;groupId&gt;mysql&lt;/groupId&gt;
    &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;
    &lt;version&gt;8.0.17&lt;/version&gt;
 &lt;/dependency&gt;</code></pre><p>添加Druid依赖</p>
<pre><code>&lt;dependency&gt;
  &lt;groupId&gt;com.alibaba&lt;/groupId&gt;
  &lt;artifactId&gt;druid&lt;/artifactId&gt;
  &lt;version&gt;1.1.19&lt;/version&gt;
&lt;/dependency&gt;</code></pre><p>定义数据源配置类</p>
<pre><code>package com.cy.spring.beans;
import javax.sql.DataSource;
@Configuration
public class DataSourceConfig {
      @Bean(value=&quot;druid&quot;,initMethod=&quot;init&quot;,destroyMethod=&quot;close&quot;)
      public DataSource newDruid() {
         // System.out.println(&quot;newDruid()&quot;);
          DruidDataSource ds=new DruidDataSource();
          //ds.setDriverClassName(&quot;com.mysql.cj.jdbc.Driver&quot;);
          ds.setUrl(&quot;jdbc:mysql:///test?serverTimezone=GMT&quot;);
          ds.setUsername(&quot;root&quot;);
          ds.setPassword(&quot;root&quot;);
          ds.setMaxWait(10000);
          //....
          return ds;
      }      
}</code></pre><p>创建单元测试类</p>
<pre><code>package com.cy.test;
import javax.sql.DataSource;
import org.junit.Assert;
import org.junit.Test;
import com.zaxxer.hikari.HikariDataSource;
public class TestDataSource extends TestBase{
    @Test
    public void testDruidDataSource()throws Exception {
        DataSource ds=
        ctx.getBean(&quot;druid&quot;,DataSource.class);
        Assert.assertNotEquals(null, ds);
        System.out.println(ds.getConnection());
    }
}</code></pre><h1 id="2-整合第三方连接池HiKariCP连接池-扩展"><a href="#2-整合第三方连接池HiKariCP连接池-扩展" class="headerlink" title="2.整合第三方连接池HiKariCP连接池(扩展)."></a>2.整合第三方连接池HiKariCP连接池(扩展).</h1><h2 id="1-3-SPRING-IOC-应用原理进阶分析"><a href="#1-3-SPRING-IOC-应用原理进阶分析" class="headerlink" title="1.3.SPRING IOC 应用原理进阶分析"></a>1.3.SPRING IOC 应用原理进阶分析</h2><h3 id="1-3-1-Spring-IOC设计思想分析"><a href="#1-3-1-Spring-IOC设计思想分析" class="headerlink" title="1.3.1.Spring IOC设计思想分析"></a>1.3.1.Spring IOC设计思想分析</h3><p>IOC 是一种设计思想，称之为控制反转。基于这种思想实现对象创建，对象的科学管理以及应用时的解耦(借助DI机制实现)。Spring框架核心就是基于这种机制进行了完美实现。<br>说明：<br>1)控制反转探讨的是什么？谁控制谁的问题（spring控制对象的创建管理）<br>2)生活中的IOC的实现？(例如股票操盘手,父母包办婚姻）</p>
<h3 id="1-3-2-Spring-Bean-工厂的初始化"><a href="#1-3-2-Spring-Bean-工厂的初始化" class="headerlink" title="1.3.2.Spring Bean 工厂的初始化"></a>1.3.2.Spring Bean 工厂的初始化</h3><p>基于xml方式实现Spring中Bean工厂的初始化.</p>
<hr>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-630cb3fbad434155b03166a0ec10b184.png" alt="image.png"><br>说明:Spring 中的Bean工厂会基于Bean对象描述,创建bean的实例,并可以有选择性的对实例对象进行管理(例如单例作用域的对象).</p>
<h3 id="1-3-3-Spring-中的两大map对象分析"><a href="#1-3-3-Spring-中的两大map对象分析" class="headerlink" title="1.3.3.Spring 中的两大map对象分析"></a>1.3.3.Spring 中的两大map对象分析</h3><p>1.如何理解Spring中的两大map对象(存储对象的两个容器)？<br>1）一个map用于存储bean的配置信息(工厂的原材料)<br>2）一个map用于存储bean的实例信息(工厂中的成品对象)</p>
<p>基于xml配置文件实现:</p>
<hr>
<h2 id="-2"><a href="#-2" class="headerlink" title=""></a><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-c49b3bb717964a3189411cc5c0387a3f.png" alt="image.png"></h2><p>基于注解配置实现:</p>
<hr>
<h2 id="-3"><a href="#-3" class="headerlink" title=""></a><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-1e18b43a520043d681eea9e4a79a5f7e.png" alt="image.png"></h2><h3 id="1-3-4-Spring-中两大bean对象分析-了解"><a href="#1-3-4-Spring-中两大bean对象分析-了解" class="headerlink" title="1.3.4.Spring 中两大bean对象分析(了解)"></a>1.3.4.Spring 中两大bean对象分析(了解)</h3><p>Bean对象创建<br>1)未实现FactoryBean接口(直接构造方法);<br>2)实现FactoryBean接口（调用FactoryBean对象的getObject方法）</p>
<hr>
<h2 id="-4"><a href="#-4" class="headerlink" title=""></a><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-5bdbf2e837434d1eabb4a2ddc7c838e2.png" alt="image.png"></h2><p>说明：一般在创建一些相对复杂的工厂对象时，通常会写一个工厂bean对象，<br>然后基于工厂bean对象创建具体的工厂对象，例如SqlSessionFactoryBean,<br>ShiroFilterFactoryBean，ProxyFactoryBean等。</p>
<h3 id="1-3-5-Spring-中两大bean对象描述方式"><a href="#1-3-5-Spring-中两大bean对象描述方式" class="headerlink" title="1.3.5.Spring 中两大bean对象描述方式"></a>1.3.5.Spring 中两大bean对象描述方式</h3><p>Bean 对象的描述<br>1)xml方式 (例如<bean id=”factory” class=”com.beans.Factory”>)<br>2)annotation方式（@Service,@Controller，@Configuration，@Bean，..）</p>
<p>Spring 中用于描述这是一个Bean对象的相关注解如下:</p>
<hr>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-ec7bdf52e7324e209438f176a87a0527.png" alt="image.png"><br>说明:无论使用如上图中的哪个注解对Bean进行描述,对Spring而言都认为是一样的Bean.</p>
<h2 id="1-1-Spring-依赖注入实践增强"><a href="#1-1-Spring-依赖注入实践增强" class="headerlink" title="1.1.Spring 依赖注入实践增强"></a>1.1.Spring 依赖注入实践增强</h2><h3 id="1-1-1-Spring-中Bean对象依赖注入分析-重点"><a href="#1-1-1-Spring-中Bean对象依赖注入分析-重点" class="headerlink" title="1.1.1.Spring 中Bean对象依赖注入分析(重点)"></a>1.1.1.Spring 中Bean对象依赖注入分析(重点)</h3><p>依赖注入(DI)是一种设计思想,简单点就是对象通过set或构造方法直接为对象属性赋值,在Spring框架中为这种注入基于反射技术提供一种自动实现方式.例如:</p>
<p>IOC 依赖注入在项目中的应用实现：</p>
<hr>
<h2 id="-5"><a href="#-5" class="headerlink" title=""></a><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-8effc442fbba466fbdf7b27016a7bab9.png" alt="image.png"></h2><p>实际项目中为了解耦和,对象之间通常会通过接口进行通讯,也就是<br>说对象要耦合与接口,例如2</p>
<hr>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-aa073ba90cc446a3ab1018da3c585284.png" alt="image.png"></p>
<p>个人认为：IOC的核心是对象生命周期管理(资源管理)以及<br>依赖注入（资源协同）；</p>
<h3 id="1-1-2-Spring-中Bean对象依赖注入实践"><a href="#1-1-2-Spring-中Bean对象依赖注入实践" class="headerlink" title="1.1.2.Spring 中Bean对象依赖注入实践"></a>1.1.2.Spring 中Bean对象依赖注入实践</h3><p>在1.2小节基础上,基于如下设计,进行代码实践分析及实现。</p>
<hr>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-31a98667ce2d4cd89c0896f59d297459.png" alt="image.png"></p>
<p>核心步骤分析：<br>Step01:创建Cache接口以及对应的实现DefaultCache<br>Step02:创建SearchService接口以及对应的实现类。<br>Step03:将DefaultCache对象注入给DefaultSearchService。<br>Step03:创建SynchronizedCache测试@Autowired注解。</p>
<p>关键代码分析及实现：</p>
<p>Cache接口定义</p>
<pre><code>public interface Cache {

}</code></pre><p>DefaultCache类定义</p>
<pre><code>@Lazy
@Component
public class DefaultCache implements Cache{
    public DefaultCache() {
        System.out.println(&quot;DefaultCache()&quot;);
    }
}</code></pre><p>SynchronizedCache定义</p>
<pre><code>@Component
public class SynchronizedCache implements Cache {

}</code></pre><p>SearchService接口定义</p>
<pre><code>public interface SearchService {

}</code></pre><p>SearchService实现类定义</p>
<pre><code>@Service
public class DefaultSearchService implements SearchService {
    /**@Autowired 可以修饰属性，set方法，构造方法等
     * 默认按照属性类型，方法参数类型为对象属性注入值,
     * 假如相同类型的对象有多个，还会按属性名或方法参
     * 数名等进行查找。
     * @Qualifier 配合@Autowired，用于指定要注入的对
     * 象的名字。
     */
    @Autowired
    @Qualifier(&quot;defaultCache&quot;)
    private Cache cache;
    @Override
    public  String toString() {
        return &quot;DefaultSearchService [cache=&quot; + cache + &quot;]&quot;;
    }
}</code></pre><p>测试实现</p>
<pre><code>public class TestSearchService extends TestBase {
    @Test
    public void testSearchService() {
        DefaultSearchService ds=
        ctx.getBean(&quot;defaultSearchService&quot;,
                DefaultSearchService.class);
        System.out.println(ds);
    }
}</code></pre><h1 id="少年易老学难成，一寸光阴不可轻。"><a href="#少年易老学难成，一寸光阴不可轻。" class="headerlink" title="少年易老学难成，一寸光阴不可轻。"></a>少年易老学难成，一寸光阴不可轻。</h1>]]></content>
      <categories>
        <category>后端</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>SSM框架综合案例实现</title>
    <url>/2020/03/23/SSM%E6%A1%86%E6%9E%B6%E7%BB%BC%E5%90%88%E6%A1%88%E4%BE%8B%E5%AE%9E%E7%8E%B0/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><h1 id="2-SSM框架综合案例实现-注解方式"><a href="#2-SSM框架综合案例实现-注解方式" class="headerlink" title="2.SSM框架综合案例实现(注解方式)"></a>2.SSM框架综合案例实现(注解方式)</h1><h2 id="2-1-业务描述"><a href="#2-1-业务描述" class="headerlink" title="2.1.业务描述"></a>2.1.业务描述</h2><p>通过spring整合mybatis完成商品数据库中数据的查询,并在客户端以json格式对数据进行输出?<br>思路:<br>1)创建maven web项目(打包方式war):CGB-SSM-01<br>2)配置项目?(运行时环境,编码,编译版本)<br>3)添加依赖?(mysql,druid,mybatis,junit,spring-webmvc,..)<br>4)整合资源?(连接池,mybatis,spring mvc..)</p>
<h2 id="2-2-初始化化数据环境"><a href="#2-2-初始化化数据环境" class="headerlink" title="2.2.初始化化数据环境"></a>2.2.初始化化数据环境</h2><p>数据库脚本分析:</p>
<pre><code>drop database if exists dbgoods;
create database dbgoods default character set utf8;
use dbgoods;
create table tb_goods(
   id bigint auto_increment,
   name varchar(200) not null,
   remark text,
   createdTime datetime,
   primary key (id)
)engine=InnoDB;

insert into tb_goods values (null,&apos;A&apos;,&apos;A...&apos;,now());
insert into tb_goods values (null,&apos;B&apos;,&apos;B...&apos;,now());
insert into tb_goods values (null,&apos;C&apos;,&apos;C...&apos;,now());</code></pre><p>说明:可以将如上脚本写到db-goods.sql文件中,然后去执行完成完成初始化.</p>
<h2 id="2-3-项目创建及配置"><a href="#2-3-项目创建及配置" class="headerlink" title="2.3.项目创建及配置"></a>2.3.项目创建及配置</h2><p>1.创建maven web项目:CGB-SSM-01<br>2.在pom.xml添加war包插件,修改其配置(这样项目可以不写web.xml)</p>
<pre><code>&lt;build&gt;
   &lt;plugins&gt;
       &lt;plugin&gt;
           &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
           &lt;artifactId&gt;maven-war-plugin&lt;/artifactId&gt;
           &lt;version&gt;2.6&lt;/version&gt;
           &lt;configuration&gt;
             &lt;failOnMissingWebXml&gt;false&lt;/failOnMissingWebXml&gt;
           &lt;/configuration&gt;
       &lt;/plugin&gt;
   &lt;/plugins&gt;
 &lt;/build&gt;</code></pre><p>3.配置项目(设置运行时环境-tomcat,编译版本JDK1.8)<br>4.添加项目依赖(参考如下图中的依赖)<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-e0e83512c916471aaa3961fc4299d37b.png" alt="image.png"></p>
<h2 id="2-4-项目资源整合实现"><a href="#2-4-项目资源整合实现" class="headerlink" title="2.4.项目资源整合实现"></a>2.4.项目资源整合实现</h2><h3 id="2-4-1-配置架构分析及实现"><a href="#2-4-1-配置架构分析及实现" class="headerlink" title="2.4.1.配置架构分析及实现"></a>2.4.1.配置架构分析及实现</h3><p>配置架构分析:</p>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-b79885d125f24239b23067babe1e3333.png" alt="image.png"></p>
<p>其中:<br>1)SpringRepositoryConfig 负责数据层配置<br>2)SpringServiceConfig负责业务层配置<br>3)SpringWebConfig负责请求处理层配置(Spring MVC中的V,C)<br>4)WebInitializer 负责启动初始化.</p>
<p>基于配置架构,创建配置类:</p>
<p>数据层配置类</p>
<pre><code>package com.cy.pj.common.config;
@Configuration
@MapperScan(&quot;com.cy.pj.goods.dao&quot;)//扫描dao
public class SpringRepositoryConfig {
}</code></pre><p>业务层配置类:<br>package com.cy.pj.common.config;<br>@Configuration<br>@ComponentScan(“com.cy.pj.goods.service”)<br>public class SpringServiceConfig {<br>    //…..<br>}</p>
<p>控制层配置类</p>
<pre><code>package com.cy.pj.common.config;
@ComponentScan(&quot;com.cy.pj.goods.controller&quot;)
@EnableWebMvc
@Configuration 
public class SpringWebConfig implements WebMvcConfigurer{

}</code></pre><p>WebInitializer 启动类配置:</p>
<pre><code>package com.cy.pj.common.config;
//--&gt;web.xml
public class WebInitializer extends 
AbstractAnnotationConfigDispatcherServletInitializer {
    //Service,Repository
    @Override
    protected Class&lt;?&gt;[] getRootConfigClasses() {
        System.out.println(&quot;getRootConfigClasses()&quot;);
        return new Class[] {SpringRepositoryConfig.class,
SpringServiceConfig.class};
    }
    //View,Controller
    @Override
    protected Class&lt;?&gt;[] getServletConfigClasses() {
        System.out.println(&quot;getServletConfigClasses()&quot;);
        return new Class[] {SpringWebConfig.class};
    }
    @Override
    protected String[] getServletMappings() {
        System.out.println(&quot;getServletMappings()&quot;);
        return new String[] {&quot;/&quot;};
    }

}</code></pre><p>整合过程分析:(顺序从右到左)<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-2c8c25e8740f4e56b2b9d96c7e01008a.png" alt="image.png"></p>
<h3 id="2-4-2-整合连接池对象"><a href="#2-4-2-整合连接池对象" class="headerlink" title="2.4.2.整合连接池对象"></a>2.4.2.整合连接池对象</h3><p>在SpringRepositoryConfig 类中添加dataSource()方法,在方法中创建<br>DruidDataSource对象.并将此对象交给spring管理.</p>
<pre><code>@Bean(value=&quot;druid&quot;,initMethod=&quot;init&quot;,destroyMethod=&quot;close&quot;)
public DruidDataSource dataSource() {
    DruidDataSource ds=new DruidDataSource();
    ds.setUrl(&quot;jdbc:mysql:///dbgoods?serverTimezone=GMT%2B8&quot;);
    ds.setUsername(&quot;root&quot;);
    ds.setPassword(&quot;root&quot;);
    return ds;
}</code></pre><p>说明:@Bean注解要配合@Configuration注解使用,@Configuration用于描述类.</p>
<h3 id="2-4-3-整合mybatis框架"><a href="#2-4-3-整合mybatis框架" class="headerlink" title="2.4.3.整合mybatis框架"></a>2.4.3.整合mybatis框架</h3><p>在SpringRepositoryConfig类中添加创建SqlSessionFactory对象创建<br>的方法:</p>
<pre><code>@Bean(&quot;sqlSessionFactory&quot;)
public SqlSessionFactory newSqlSessionFactory(
        DataSource dataSource) 
        throws Exception {
  //构建SqlSessionFactoryBean对象
  SqlSessionFactoryBean factoryBean =
  new SqlSessionFactoryBean();
  factoryBean.setDataSource(dataSource);
  //调用FactoryBean的getObject方法创建SqlSessionFactory
  //底层会使用SqlSessionFactoryBuilder创建
  return factoryBean.getObject();
}</code></pre><p>参考:<a href="http://www.mybatis.org/spring" target="_blank" rel="noopener">www.mybatis.org/spring</a></p>
<h3 id="2-4-4-整合Spring-MVC-模块"><a href="#2-4-4-整合Spring-MVC-模块" class="headerlink" title="2.4.4.整合Spring MVC 模块"></a>2.4.4.整合Spring MVC 模块</h3><p>在Spring MVC配置类中添加视图解析配置,默认servlet处理等配置.</p>
<pre><code>package com.cy.pj.common.config;

@Configuration 
@ComponentScan(&quot;com.cy.pj.goods.controller&quot;)
@EnableWebMvc //&lt;mvc:annotation-driven/&gt;
public class SpringWebConfig implements WebMvcConfigurer{
    //&lt;mvc:default-servlet-handler/&gt;
    @Override
    public void configureDefaultServletHandling(
            DefaultServletHandlerConfigurer configurer) {
        configurer.enable();
    }
    @Override
    public void configureViewResolvers(
        ViewResolverRegistry registry) {
        registry.jsp(&quot;/WEB-INF/pages/&quot;,&quot;.html&quot;);
    }
}</code></pre><h2 id="2-5-业务设计分析及实现"><a href="#2-5-业务设计分析及实现" class="headerlink" title="2.5.业务设计分析及实现"></a>2.5.业务设计分析及实现</h2><h3 id="2-5-1-业务架构"><a href="#2-5-1-业务架构" class="headerlink" title="2.5.1.业务架构"></a>2.5.1.业务架构</h3><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-672453807116433ca5a8bab6a294760f.png" alt="image.png"></p>
<h3 id="2-5-2-POJO实现"><a href="#2-5-2-POJO实现" class="headerlink" title="2.5.2.POJO实现"></a>2.5.2.POJO实现</h3><p>定义pojo对象Goods用于封装数据:</p>
<pre><code>package com.cy.pj.goods.pojo;
import java.io.Serializable;
import java.util.Date;
public class Goods implements Serializable{
    private static final long serialVersionUID = 690138036951052829L;
    private Long id;
    private String name;
    private String remark;
    private Date createdTime;
    public Long getId() {
        return id;
    }
    public void setId(Long id) {
        this.id = id;
    }
    public String getName() {
        return name;
    }
    public void setName(String name) {
        this.name = name;
    }

    public String getRemark() {
        return remark;
    }

    public void setRemark(String remark) {
        this.remark = remark;
    }

    public Date getCreatedTime() {
        return createdTime;
    }

    public void setCreatedTime(Date createdTime) {
        this.createdTime = createdTime;
    }

    @Override
    public String toString() {
        return &quot;Goods [id=&quot; + id + &quot;, name=&quot; + name + &quot;, remark=&quot; + remark + &quot;, createdTime=&quot; + createdTime + &quot;]&quot;;
    }
}</code></pre><h3 id="2-5-3-Dao实现"><a href="#2-5-3-Dao实现" class="headerlink" title="2.5.3.Dao实现"></a>2.5.3.Dao实现</h3><p>定义GoodsDao接口,代码如下:</p>
<pre><code>package com.cy.pj.goods.dao;
import org.apache.ibatis.annotations.Select;
public interface GoodsDao {

@Select(&quot;select * from tb_goods&quot;)
    List&lt;Goods&gt; findGoods();
}</code></pre><p>在SpringRepositoryConfig类上添加@MapperScan注解,实现对指定包下Dao接口的扫描:</p>
<pre><code>@Configuration
@MapperScan(&quot;com.cy.pj.goods.dao&quot;)//扫描dao
public class SpringRepositoryConfig {
  //....
}</code></pre><p>编写单元测试类TestGoodsDao,然后getRowCount方法进行测试</p>
<pre><code>public class TestGoodsDao extends TestBase{
     @Test
     public void testFindGoods() {
           GoodsDao dao=ctx.getBean(&quot;goodsDao&quot;,GoodsDao.class);
           List&lt;Goods&gt; list=dao.findGoods();
           for(Goods g:list) {
            System.out.println(g);
           }
     }
}</code></pre><h3 id="2-5-4-Service实现"><a href="#2-5-4-Service实现" class="headerlink" title="2.5.4.Service实现"></a>2.5.4.Service实现</h3><p>创建GoodsService接口,实现具体业务:</p>
<pre><code>package com.cy.pj.goods.service;
import java.util.List;
import com.cy.pj.goods.pojo.Goods;
public interface GoodsService {
     List&lt;Goods&gt; findGoods();
}</code></pre><p>创建接口实现类:</p>
<pre><code>package com.cy.pj.goods.service.impl;
import java.util.List;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import com.cy.pj.goods.dao.GoodsDao;
import com.cy.pj.goods.pojo.Goods;
import com.cy.pj.goods.service.GoodsService;
@Service
public class GoodsServiceImpl implements GoodsService {
    @Autowired
    private GoodsDao goodsDao;
    @Override
    public List&lt;Goods&gt; findGoods() {
        //...
        List&lt;Goods&gt; list=goodsDao.findGoods();
        //...
        return list;
    }
}</code></pre><p>编写Service配置类(需要在容器启动时加载),对service对象进行扫描</p>
<pre><code>package com.cy.pj.common.config;
import org.springframework.context.annotation.ComponentScan;
import org.springframework.context.annotation.Configuration;
@Configuration
@ComponentScan(&quot;com.cy.pj.goods.service&quot;)
public class SpringServiceConfig {

    //.....
}</code></pre><p>编写测试类执行单元测试:</p>
<pre><code>public class TestGoodsService extends TestBase{
    @Test
    public void testFindGoods() {
        GoodsService gs=
        ctx.getBean(&quot;goodsServiceImpl&quot;, GoodsService.class);
        List&lt;Goods&gt; list=gs.findGoods();
        for(Goods g:list) {
            System.out.println(g);
        }
    }
}</code></pre><p>2.5.5.Controller实现<br>编写controller,用于处理客户端的请求:</p>
<pre><code>package com.cy.pj.goods.controller;

import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.ResponseBody;

import com.cy.pj.goods.pojo.Goods;
import com.cy.pj.goods.service.GoodsService;

@Controller
@RequestMapping(&quot;/goods/&quot;)
public class GoodsController {
    @Autowired
    private GoodsService goodsService;
    @RequestMapping(&quot;doFindGoods&quot;)
    @ResponseBody
    public List&lt;Goods&gt; doFindGoods(){
        return goodsService.findGoods();
    }//json 串:spring mvc 启动API将对象转换为JSON串
}</code></pre><p>2.6.项目部署及运行分析<br>项目部署到tomcat,然后启动进行访问测试.</p>
<p><a href="http://localhost/CGB-SSM-01/goods/doFindGoods" target="_blank" rel="noopener">http://localhost/CGB-SSM-01/goods/doFindGoods</a></p>
<h1 id="少年易老学难成，一寸光阴不可轻。"><a href="#少年易老学难成，一寸光阴不可轻。" class="headerlink" title="少年易老学难成，一寸光阴不可轻。"></a>少年易老学难成，一寸光阴不可轻。</h1>]]></content>
      <categories>
        <category>后端</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot系列 - Redis数据库</title>
    <url>/2020/06/08/SpringBoot%E7%B3%BB%E5%88%97-Redis%E6%95%B0%E6%8D%AE%E5%BA%93/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><h1 id="SpringBoot系列-Redis数据库"><a href="#SpringBoot系列-Redis数据库" class="headerlink" title="SpringBoot系列 - Redis数据库"></a>SpringBoot系列 - Redis数据库</h1><p>在互联网场景下，尤其 2C 端大流量场景下，需要将一些经常展现和不会频繁变更的数据，存放在存取速率更快的地方。 缓存就是一个存储器，在技术选型中，常用 Redis 作为缓存数据库。缓存主要是在获取资源方便性能优化的关键方面。</p>
<p>如果使用Redis缓存技术，SpringBoot中有两种方式实现缓存，一个是上一篇中通过CacheManager实现， 不过这个是对于简单的缓存场景，而更为强大的是通过<code>RedisTemplate</code>来直接操作Redis数据库实现缓存。</p>
<p>Redis 是一个高性能的 key-value 数据库。GitHub 地址：<a href="https://github.com/antirez/redis" target="_blank" rel="noopener">https://github.com/antirez/redis</a> 。</p>
<p>Github 是这么描述的：</p>
<p>Redis is an in-memory database that persists on disk. The data model is key-value, but many different kind of values are supported: Strings, Lists, Sets, Sorted Sets, Hashes, HyperLogLogs, Bitmaps.</p>
<p>缓存的应用场景有哪些呢？</p>
<p>比如常见的电商场景，根据商品 ID 获取商品信息时，店铺信息和商品详情信息就可以缓存在 Redis，直接从 Redis 获取。 减少了去数据库查询的次数。但会出现新的问题，就是如何对缓存进行更新？这就是下面要讲的。</p>
<h2 id="缓存更新策略"><a href="#缓存更新策略" class="headerlink" title="缓存更新策略"></a>缓存更新策略</h2><p>参考<a href="http://coolshell.cn/articles/17416.html" target="_blank" rel="noopener">《缓存更新的套路》</a> ，缓存更新的模式有四种：</p>
<ol>
<li>Cache aside</li>
<li>Read through</li>
<li>Write through</li>
<li>Write behind caching</li>
</ol>
<p>这里我们使用的是 Cache Aside 策略，从三个维度：</p>
<ul>
<li>失效：应用程序先从cache取数据，没有得到，则从数据库中取数据，成功后，放到缓存中。</li>
<li>命中：应用程序从cache中取数据，取到后返回。</li>
<li>更新：先把数据存到数据库中，成功后，再让缓存失效。</li>
</ul>
<p>大致流程如下：</p>
<p>获取商品详情举例</p>
<ol>
<li>从商品 Cache 中获取商品详情，如果存在，则返回获取 Cache 数据返回。</li>
<li>如果不存在，则从商品 DB 中获取。获取成功后，将数据存到 Cache 中。则下次获取商品详情，就可以从 Cache 就可以得到商品详情数据。</li>
<li>从商品 DB 中更新或者删除商品详情成功后，则从缓存中删除对应商品的详情缓存</li>
</ol>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="assets/1591544110-b3d7bc67537ad6ee8a56babe2402340c.png" alt=""></p>
<h2 id="添加maven依赖"><a href="#添加maven依赖" class="headerlink" title="添加maven依赖"></a>添加maven依赖</h2><p>这里仍然是MyBatis做数据库DAO操作，Redis做缓存操作。</p>
<p>SpringBoot 2开始默认的Redis客户端实现是Lettuce，同时你需要添加commons-pool2的依赖。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-pool2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;jackson-databind-version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;jackson-databind-version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-annotations<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;jackson-databind-version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.vaadin.external.google<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>android-json<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;mysql-connector.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;druid.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- MyBatis plus增强和springboot的集成--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;mybatis-plus.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatisplus-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;mybatisplus-spring-boot-starter.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>注意上面我添加了Jackson的依赖，后面要用到。</p>
<h3 id="配置application-yml"><a href="#配置application-yml" class="headerlink" title="配置application.yml"></a>配置application.yml</h3><p>增加 Redis 相关配置</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cache:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">REDIS</span></span><br><span class="line">    <span class="attr">redis:</span></span><br><span class="line">      <span class="attr">cache-null-values:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">time-to-live:</span> <span class="string">600000ms</span></span><br><span class="line">      <span class="attr">use-key-prefix:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">cache-names:</span> <span class="string">userCache,allUsersCache</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">    <span class="attr">database:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">lettuce:</span></span><br><span class="line">      <span class="attr">shutdown-timeout:</span> <span class="string">200ms</span></span><br><span class="line">      <span class="attr">pool:</span></span><br><span class="line">        <span class="attr">max-active:</span> <span class="number">7</span></span><br><span class="line">        <span class="attr">max-idle:</span> <span class="number">7</span></span><br><span class="line">        <span class="attr">min-idle:</span> <span class="number">2</span></span><br><span class="line">        <span class="attr">max-wait:</span> <span class="string">-1ms</span></span><br></pre></td></tr></table></figure>

<p>对应的配置类：</p>
<p><code>org.springframework.boot.autoconfigure.data.redis.RedisProperties</code></p>
<h2 id="添加配置类"><a href="#添加配置类" class="headerlink" title="添加配置类"></a>添加配置类</h2><p>这里自定义RedisTemplate的配置类，主要是想使用Jackson替换默认的序列化机制：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisConfig</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * redisTemplate 默认使用JDK的序列化机制, 存储二进制字节码, 所以自定义序列化类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> redisConnectionFactory redis连接工厂类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> RedisTemplate</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedisTemplate&lt;Object, Object&gt; <span class="title">redisTemplate</span><span class="params">(RedisConnectionFactory redisConnectionFactory)</span> </span>&#123;</span><br><span class="line">        RedisTemplate&lt;Object, Object&gt; redisTemplate = <span class="keyword">new</span> RedisTemplate&lt;&gt;();</span><br><span class="line">        redisTemplate.setConnectionFactory(redisConnectionFactory);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使用Jackson2JsonRedisSerialize 替换默认序列化</span></span><br><span class="line">        Jackson2JsonRedisSerializer jackson2JsonRedisSerializer = <span class="keyword">new</span> Jackson2JsonRedisSerializer(Object<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">        ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">        objectMapper.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);</span><br><span class="line">        objectMapper.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);</span><br><span class="line"></span><br><span class="line">        jackson2JsonRedisSerializer.setObjectMapper(objectMapper);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置value的序列化规则和 key的序列化规则</span></span><br><span class="line">        redisTemplate.setKeySerializer(<span class="keyword">new</span> StringRedisSerializer());</span><br><span class="line">        redisTemplate.setValueSerializer(jackson2JsonRedisSerializer);</span><br><span class="line">        redisTemplate.afterPropertiesSet();</span><br><span class="line">        <span class="keyword">return</span> redisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="使用演示"><a href="#使用演示" class="headerlink" title="使用演示"></a>使用演示</h2><p>MyBatis实现的DAO层，以及User实体类我就不贴在这里了，只贴Service核心增删改查操作：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String, User&gt; redisTemplate;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建用户</span></span><br><span class="line"><span class="comment">     * 不会对缓存做任何操作</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createUser</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"创建用户start..."</span>);</span><br><span class="line">        userMapper.insert(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取用户信息</span></span><br><span class="line"><span class="comment">     * 如果缓存存在，从缓存中获取城市信息</span></span><br><span class="line"><span class="comment">     * 如果缓存不存在，从 DB 中获取城市信息，然后插入缓存</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 用户ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 用户</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">getById</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"获取用户start..."</span>);</span><br><span class="line">        <span class="comment">// 从缓存中获取用户信息</span></span><br><span class="line">        String key = <span class="string">"user_"</span> + id;</span><br><span class="line">        ValueOperations&lt;String, User&gt; operations = redisTemplate.opsForValue();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 缓存存在</span></span><br><span class="line">        <span class="keyword">boolean</span> hasKey = redisTemplate.hasKey(key);</span><br><span class="line">        <span class="keyword">if</span> (hasKey) &#123;</span><br><span class="line">            User user = operations.get(key);</span><br><span class="line">            logger.info(<span class="string">"从缓存中获取了用户 id = "</span> + id);</span><br><span class="line">            <span class="keyword">return</span> user;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 缓存不存在，从 DB 中获取</span></span><br><span class="line">        User user = userMapper.selectById(id);</span><br><span class="line">        <span class="comment">// 插入缓存</span></span><br><span class="line">        operations.set(key, user, <span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 更新用户</span></span><br><span class="line"><span class="comment">     * 如果缓存存在，删除</span></span><br><span class="line"><span class="comment">     * 如果缓存不存在，不操作</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> user 用户</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateUser</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"更新用户start..."</span>);</span><br><span class="line">        userMapper.updateById(user);</span><br><span class="line">        <span class="keyword">int</span> userId = user.getId();</span><br><span class="line">        <span class="comment">// 缓存存在，删除缓存</span></span><br><span class="line">        String key = <span class="string">"user_"</span> + userId;</span><br><span class="line">        <span class="keyword">boolean</span> hasKey = redisTemplate.hasKey(key);</span><br><span class="line">        <span class="keyword">if</span> (hasKey) &#123;</span><br><span class="line">            redisTemplate.delete(key);</span><br><span class="line">            logger.info(<span class="string">"更新用户时候，从缓存中删除用户 &gt;&gt; "</span> + userId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除用户</span></span><br><span class="line"><span class="comment">     * 如果缓存中存在，删除</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteById</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"删除用户start..."</span>);</span><br><span class="line">        userMapper.deleteById(id);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 缓存存在，删除缓存</span></span><br><span class="line">        String key = <span class="string">"user_"</span> + id;</span><br><span class="line">        <span class="keyword">boolean</span> hasKey = redisTemplate.hasKey(key);</span><br><span class="line">        <span class="keyword">if</span> (hasKey) &#123;</span><br><span class="line">            redisTemplate.delete(key);</span><br><span class="line">            logger.info(<span class="string">"删除用户时候，从缓存中删除用户 &gt;&gt; "</span> + id);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>RedisTemplate 封装了 RedisConnection，具有连接管理，序列化和 Redis 操作等功能。 还有专门针对 String 的模板对象 StringRedisTemplate。</p>
<p>Redis 操作视图接口类用的是 ValueOperations，对应的是 Redis String/Value 操作。</p>
<p>还有其他的操作视图，ListOperations、SetOperations、ZSetOperations 和 HashOperations 。 ValueOperations 插入缓存是可以设置失效时间，这里设置的失效时间是 10 s。</p>
<p>然后写个测试类测试运行看看效果：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">SpringBootTest</span>(<span class="title">classes</span> </span>= Application<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">Transactional</span></span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">UserServiceTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testCache</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> id = <span class="keyword">new</span> Random().nextInt(<span class="number">1000</span>);</span><br><span class="line">        User user = <span class="keyword">new</span> User(id, <span class="string">"admin"</span>, <span class="string">"admin"</span>);</span><br><span class="line">        userService.createUser(user);</span><br><span class="line">        User user1 = userService.getById(id); <span class="comment">// 第1次访问</span></span><br><span class="line">        assertEquals(user1.getPassword(), <span class="string">"admin"</span>);</span><br><span class="line">        User user2 = userService.getById(id); <span class="comment">// 第2次访问</span></span><br><span class="line">        assertEquals(user2.getPassword(), <span class="string">"admin"</span>);</span><br><span class="line">        user.setPassword(<span class="string">"123456"</span>);</span><br><span class="line">        userService.updateUser(user);</span><br><span class="line">        User user3 = userService.getById(id); <span class="comment">// 第3次访问</span></span><br><span class="line">        assertEquals(user3.getPassword(), <span class="string">"123456"</span>);</span><br><span class="line">        userService.deleteById(id);</span><br><span class="line">        assertNull(userService.getById(id));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行SpringBoot集成测试，查看日志如下：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">创建用户start...</span><br><span class="line">==&gt;  Preparing: <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_user ( <span class="keyword">id</span>, username, <span class="string">`password`</span> ) <span class="keyword">VALUES</span> ( ?, ?, ? )</span><br><span class="line">==&gt; <span class="keyword">Parameters</span>: <span class="number">89</span>(<span class="built_in">Integer</span>), <span class="keyword">admin</span>(<span class="keyword">String</span>), <span class="keyword">admin</span>(<span class="keyword">String</span>)</span><br><span class="line">&lt;==    Updates: <span class="number">1</span></span><br><span class="line">获取用户start...</span><br><span class="line"><span class="keyword">Starting</span> <span class="keyword">without</span> optional epoll <span class="keyword">library</span></span><br><span class="line"><span class="keyword">Starting</span> <span class="keyword">without</span> optional kqueue <span class="keyword">library</span></span><br><span class="line">==&gt;  Preparing: <span class="keyword">SELECT</span> <span class="keyword">id</span> <span class="keyword">AS</span> <span class="keyword">id</span>,username,<span class="string">`password`</span> <span class="keyword">FROM</span> t_user <span class="keyword">WHERE</span> <span class="keyword">id</span>=?</span><br><span class="line">==&gt; <span class="keyword">Parameters</span>: <span class="number">89</span>(<span class="built_in">Integer</span>)</span><br><span class="line">&lt;==      Total: <span class="number">1</span></span><br><span class="line">获取用户start...</span><br><span class="line">从缓存中获取了用户 <span class="keyword">id</span> = <span class="number">89</span></span><br><span class="line">更新用户start...</span><br><span class="line">==&gt;  Preparing: <span class="keyword">UPDATE</span> t_user <span class="keyword">SET</span> username=?, <span class="string">`password`</span>=? <span class="keyword">WHERE</span> <span class="keyword">id</span>=?</span><br><span class="line">==&gt; <span class="keyword">Parameters</span>: <span class="keyword">admin</span>(<span class="keyword">String</span>), <span class="number">123456</span>(<span class="keyword">String</span>), <span class="number">89</span>(<span class="built_in">Integer</span>)</span><br><span class="line">&lt;==    Updates: <span class="number">1</span></span><br><span class="line">更新用户时候，从缓存中删除用户 &gt;&gt; <span class="number">89</span></span><br><span class="line">获取用户start...</span><br><span class="line">==&gt;  Preparing: <span class="keyword">SELECT</span> <span class="keyword">id</span> <span class="keyword">AS</span> <span class="keyword">id</span>,username,<span class="string">`password`</span> <span class="keyword">FROM</span> t_user <span class="keyword">WHERE</span> <span class="keyword">id</span>=?</span><br><span class="line">==&gt; <span class="keyword">Parameters</span>: <span class="number">89</span>(<span class="built_in">Integer</span>)</span><br><span class="line">&lt;==      Total: <span class="number">1</span></span><br><span class="line">删除用户start...</span><br><span class="line">==&gt;  Preparing: <span class="keyword">DELETE</span> <span class="keyword">FROM</span> t_user <span class="keyword">WHERE</span> <span class="keyword">id</span>=?</span><br><span class="line">==&gt; <span class="keyword">Parameters</span>: <span class="number">89</span>(<span class="built_in">Integer</span>)</span><br><span class="line">&lt;==    Updates: <span class="number">1</span></span><br><span class="line">更新用户时候，从缓存中删除用户 &gt;&gt; <span class="number">89</span></span><br><span class="line">获取用户start...</span><br><span class="line">==&gt;  Preparing: <span class="keyword">SELECT</span> <span class="keyword">id</span> <span class="keyword">AS</span> <span class="keyword">id</span>,username,<span class="string">`password`</span> <span class="keyword">FROM</span> t_user <span class="keyword">WHERE</span> <span class="keyword">id</span>=?</span><br><span class="line">==&gt; <span class="keyword">Parameters</span>: <span class="number">89</span>(<span class="built_in">Integer</span>)</span><br><span class="line">&lt;==      Total: <span class="number">0</span></span><br><span class="line">Rolled back <span class="keyword">transaction</span> <span class="keyword">for</span> <span class="keyword">test</span>: [DefaultTestContext@<span class="number">6e20</span>b53a testClass = UserServiceTest</span><br><span class="line">Closing org.springframework.context.annotation.AnnotationConfigApplicationContext@<span class="number">503</span>f91c3</span><br><span class="line">&#123;dataSource<span class="number">-1</span>&#125; closed</span><br></pre></td></tr></table></figure>

<p>可以看出第一次取的时候，缓存未命中，会从DB中取数据，而第2次取的时候缓存命中直接从缓存中取出来。 后面不管是更新和删除，都会从缓存中删除。再去取的时候缓存未命中，从DB中取最新的。</p>
<h2 id="GitHub源码"><a href="#GitHub源码" class="headerlink" title="GitHub源码"></a>GitHub源码</h2><p><a href="https://github.com/yidao620c/SpringBootBucket/tree/master/springboot-redis" target="_blank" rel="noopener">springboot-redis</a>   —已测试</p>
<h2 id="来源"><a href="#来源" class="headerlink" title="来源"></a>来源</h2><p><a href="https://www.xncoding.com/" target="_blank" rel="noopener">https://www.xncoding.com/</a></p>
]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>redis</tag>
        <tag>springboot</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot系列 - cxf实现WebService</title>
    <url>/2020/06/08/SpringBoot%E7%B3%BB%E5%88%97-cxf%E5%AE%9E%E7%8E%B0WebService/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><h1 id="SpringBoot系列-cxf实现WebService"><a href="#SpringBoot系列-cxf实现WebService" class="headerlink" title="SpringBoot系列 - cxf实现WebService"></a>SpringBoot系列 - cxf实现WebService</h1><p>说起web service最近几年restful大行其道，大有取代传统soap web service的趋势， 但是一些特有或相对老旧的系统依然使用了传统的soap web service，例如银行、航空公司的机票查询接口等。 本篇主要讲解spring boot整合cxf发布webservice服务和spring boot整合cxf客户端调用webservice服务。</p>
<h2 id="maven依赖"><a href="#maven依赖" class="headerlink" title="maven依赖"></a>maven依赖</h2><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-tomcat<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jetty<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- CXF webservice --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.cxf<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cxf-spring-boot-starter-jaxws<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- CXF webservice --&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.hamcrest<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hamcrest-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="服务接口"><a href="#服务接口" class="headerlink" title="服务接口"></a>服务接口</h2><p>先定义一个简单的用户类User：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xncoding.webservice.model;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">User</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">User</span><span class="params">(Long id, String name, Integer age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// getter and setter</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意，上面的包名是下面接口定义的targetNamespace的倒序。</p>
<p>创建一个简单的服务接口，定义了两个方法，一个返回字符串，一个返回一个实体类User：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xncoding.webservice.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xncoding.webservice.model.User;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.jws.WebMethod;</span><br><span class="line"><span class="keyword">import</span> javax.jws.WebParam;</span><br><span class="line"><span class="keyword">import</span> javax.jws.WebService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@WebService</span>(name = <span class="string">"CommonService"</span>, <span class="comment">// 暴露服务名称</span></span><br><span class="line">        targetNamespace = <span class="string">"http://model.webservice.xncoding.com/"</span><span class="comment">// 命名空间,一般是接口的包名倒序</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ICommonService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@WebMethod</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">(@WebParam(name = <span class="string">"userName"</span>)</span> String name)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@WebMethod</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">getUser</span><span class="params">(@WebParam(name = <span class="string">"userName"</span>)</span> String name)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="接口实现"><a href="#接口实现" class="headerlink" title="接口实现"></a>接口实现</h2><p>接下来实现这个接口，编写相应的业务逻辑：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xncoding.webservice.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xncoding.webservice.model.User;</span><br><span class="line"><span class="keyword">import</span> com.xncoding.webservice.service.ICommonService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.jws.WebService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@WebService</span>(serviceName = <span class="string">"CommonService"</span>, <span class="comment">// 与接口中指定的name一致</span></span><br><span class="line">        targetNamespace = <span class="string">"http://model.webservice.xncoding.com/"</span>, <span class="comment">// 与接口中的命名空间一致,一般是接口的包名倒</span></span><br><span class="line">        endpointInterface = <span class="string">"com.xncoding.webservice.service.ICommonService"</span><span class="comment">// 接口地址</span></span><br><span class="line">)</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CommonServiceImpl</span> <span class="keyword">implements</span> <span class="title">ICommonService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Hello ,"</span> + name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">getUser</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> User(<span class="number">1000L</span>, name, <span class="number">23</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="配置类"><a href="#配置类" class="headerlink" title="配置类"></a>配置类</h2><p>接下来编写cxf的配置类：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CxfConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Bus bus;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    ICommonService commonService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * JAX-WS</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Endpoint <span class="title">endpoint</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        EndpointImpl endpoint = <span class="keyword">new</span> EndpointImpl(bus, commonService);</span><br><span class="line">        endpoint.publish(<span class="string">"/CommonService"</span>);</span><br><span class="line">        <span class="keyword">return</span> endpoint;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里把<code>Commonservice</code>接口发布在了路径<code>/services/CommonService</code>下，wsdl文档路径为<code>http://localhost:{port}/services/CommonService?wsdl</code></p>
<p>如果你想自定义wsdl的访问url，那么可以在application.yml中自定义：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">cxf:</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">/services</span>  <span class="comment"># 替换默认的/services路径</span></span><br></pre></td></tr></table></figure>

<h2 id="客户端访问"><a href="#客户端访问" class="headerlink" title="客户端访问"></a>客户端访问</h2><p>直接客户端去访问有两种方式</p>
<h3 id="代理类工厂的方式"><a href="#代理类工厂的方式" class="headerlink" title="代理类工厂的方式"></a>代理类工厂的方式</h3><p>这种方式需要拿到对方的接口</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cl1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 接口地址</span></span><br><span class="line">        <span class="comment">// 代理工厂</span></span><br><span class="line">        JaxWsProxyFactoryBean jaxWsProxyFactoryBean = <span class="keyword">new</span> JaxWsProxyFactoryBean();</span><br><span class="line">        <span class="comment">// 设置代理地址</span></span><br><span class="line">        jaxWsProxyFactoryBean.setAddress(wsdlAddress);</span><br><span class="line">        <span class="comment">// 设置接口类型</span></span><br><span class="line">        jaxWsProxyFactoryBean.setServiceClass(ICommonService<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="comment">// 创建一个代理接口实现</span></span><br><span class="line">        ICommonService cs = (ICommonService) jaxWsProxyFactoryBean.create();</span><br><span class="line">        <span class="comment">// 数据准备</span></span><br><span class="line">        String userName = <span class="string">"Leftso"</span>;</span><br><span class="line">        <span class="comment">// 调用代理接口的方法调用并返回结果</span></span><br><span class="line">        String result = cs.sayHello(userName);</span><br><span class="line">        System.out.println(<span class="string">"返回结果:"</span> + result);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="动态调用方式"><a href="#动态调用方式" class="headerlink" title="动态调用方式"></a>动态调用方式</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cl2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 创建动态客户端</span></span><br><span class="line">    JaxWsDynamicClientFactory dcf = JaxWsDynamicClientFactory.newInstance();</span><br><span class="line">    Client client = dcf.createClient(wsdlAddress);</span><br><span class="line">    <span class="comment">// 需要密码的情况需要加上用户名和密码</span></span><br><span class="line">    <span class="comment">// client.getOutInterceptors().add(new ClientLoginInterceptor(USER_NAME, PASS_WORD));</span></span><br><span class="line">    Object[] objects;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// invoke("方法名",参数1,参数2,参数3....);</span></span><br><span class="line">        objects = client.invoke(<span class="string">"sayHello"</span>, <span class="string">"Leftso"</span>);</span><br><span class="line">        System.out.println(<span class="string">"返回类型："</span> + objects[<span class="number">0</span>].getClass());</span><br><span class="line">        System.out.println(<span class="string">"返回数据:"</span> + objects[<span class="number">0</span>]);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (java.lang.Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cl3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 创建动态客户端</span></span><br><span class="line">    JaxWsDynamicClientFactory dcf = JaxWsDynamicClientFactory.newInstance();</span><br><span class="line">    Client client = dcf.createClient(wsdlAddress);</span><br><span class="line">    Object[] objects;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// invoke("方法名",参数1,参数2,参数3....);</span></span><br><span class="line">        objects = client.invoke(<span class="string">"getUser"</span>, <span class="string">"张三"</span>);</span><br><span class="line">        System.out.println(<span class="string">"返回类型："</span> + objects[<span class="number">0</span>].getClass());</span><br><span class="line">        System.out.println(<span class="string">"返回数据:"</span> + objects[<span class="number">0</span>]);</span><br><span class="line">        User user = (User) objects[<span class="number">0</span>];</span><br><span class="line">        System.out.println(<span class="string">"返回对象User.name="</span> + user.getName());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (java.lang.Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意到如果方法返回对象的话，那么对象所在的包一定是targetNamespace的倒序。</p>
<h2 id="生成客户端代码"><a href="#生成客户端代码" class="headerlink" title="生成客户端代码"></a>生成客户端代码</h2><p>这是推荐做法，就是根据wsdl的访问路径来生成客户端代码。这里有两种生成方式</p>
<h3 id="Apache的wsdl2java工具"><a href="#Apache的wsdl2java工具" class="headerlink" title="Apache的wsdl2java工具"></a>Apache的wsdl2java工具</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">wsdl2java -autoNameResolution http:&#x2F;&#x2F;xxx?wsdl</span><br></pre></td></tr></table></figure>

<h3 id="JDK自带的工具（推荐）"><a href="#JDK自带的工具（推荐）" class="headerlink" title="JDK自带的工具（推荐）"></a>JDK自带的工具（推荐）</h3><p>JDK自己内置了一个wsimport工具，这个是推荐的生成方式。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">wsimport -encoding utf-8 -p com.xncoding.webservice.client -keep http:&#x2F;&#x2F;xxx?wsdl -s d:&#x2F;ws -B-XautoNameResolution</span><br></pre></td></tr></table></figure>

<p>其中：</p>
<figure class="highlight haml"><table><tr><td class="code"><pre><span class="line">-<span class="ruby">encoding ：指定编码格式（此处是utf-<span class="number">8</span>的指定格式）</span></span><br><span class="line"><span class="ruby">-keep：是否生成Java源文件</span></span><br><span class="line"><span class="ruby">-s：指定.java文件的输出目录</span></span><br><span class="line"><span class="ruby">-d：指定<span class="class">.<span class="keyword">class</span>文件的输出目录</span></span></span><br><span class="line"><span class="ruby">-p：定义生成类的包名，不定义的话有默认包名</span></span><br><span class="line"><span class="ruby">-verbose：在控制台显示输出信息</span></span><br><span class="line"><span class="ruby">-b：指定jaxws/jaxb绑定文件或额外的schemas</span></span><br><span class="line"><span class="ruby">-extension：使用扩展来支持SOAP1.<span class="number">2</span></span></span><br></pre></td></tr></table></figure>

<p>上面的命令会在<code>d:/ws</code>目录下面生成相应的客户端代码。</p>
<p>客户端使用例子：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">CommonService_Service c = <span class="keyword">new</span> CommonService_Service();</span><br><span class="line">com.xncoding.webservice.client.User user = c.getCommonServiceImplPort().getUser(<span class="string">"Tom"</span>);</span><br><span class="line">assertThat(user.getName(), is(<span class="string">"Tom"</span>));</span><br></pre></td></tr></table></figure>

<h2 id="GitHub源码"><a href="#GitHub源码" class="headerlink" title="GitHub源码"></a>GitHub源码</h2><p><a href="https://github.com/yidao620c/SpringBootBucket/tree/master/springboot-cxf" target="_blank" rel="noopener">springboot-cxf</a>    —已测试</p>
<h2 id="来源"><a href="#来源" class="headerlink" title="来源"></a>来源</h2><p><a href="https://www.xncoding.com/" target="_blank" rel="noopener">https://www.xncoding.com/</a></p>
]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>springboot</tag>
        <tag>crf</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot系列 - 使用AOP</title>
    <url>/2020/06/08/SpringBoot%E7%B3%BB%E5%88%97-%E4%BD%BF%E7%94%A8AOP/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><h1 id="SpringBoot系列-使用AOP"><a href="#SpringBoot系列-使用AOP" class="headerlink" title="SpringBoot系列 - 使用AOP"></a>SpringBoot系列 - 使用AOP</h1><p>AOP（面向切面编程）是Spring的两大核心功能之一，功能非常强大，为解耦提供了非常优秀的解决方案。 现在就以springboot中aop的使用来了解一下如何使用aop。 写几个简单的Spring RESTful服务接口方法，实现方法前面或后面打印日志。</p>
<h2 id="AOP术语定义"><a href="#AOP术语定义" class="headerlink" title="AOP术语定义"></a>AOP术语定义</h2><p>Spring的AOP中有几个重要概念搞清楚就行</p>
<ul>
<li>执行点（Executepoint） - 类初始化，方法调用。</li>
<li>连接点（Joinpoint） - 执行点+方位的组合，可确定Joinpoint，比如类开始初始化前，类初始化后，方法调用前，方法调用后。</li>
<li>切点（Pointcut） - 在众多执行点中，定位感兴趣的执行点。Executepoint相当于数据库表中的记录，而Pointcut相当于查询条件。</li>
<li>增强（Advice） - 织入到目标类连接点上的一段程序代码。除了一段程序代码外，还拥有执行点的方位信息。</li>
<li>目标对象（Target） - 增强逻辑的织入目标类</li>
<li>引介（Introduction） - 一种特殊的增强（advice），它为类添加一些额外的属性和方法，动态为业务类添加其他接口的实现逻辑，让业务类成为这个接口的实现类。</li>
<li>代理（Proxy） - 一个类被AOP织入后，产生一个结果类，它便是融合了原类和增强逻辑的代理类。</li>
<li>切面（Aspect） - 切面由切点（Pointcut）和增强（Advice/Introduction）组成，既包括横切逻辑定义，也包括连接点定义。</li>
</ul>
<p>AOP工作重点：</p>
<ol>
<li>如何通过切点（Pointcut）和增强（Advice）定位到连接点（Jointpoint）上；</li>
<li>如何在增强（Advice）中编写切面的代码。</li>
</ol>
<h2 id="添加maven依赖"><a href="#添加maven依赖" class="headerlink" title="添加maven依赖"></a>添加maven依赖</h2><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.4.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-tomcat<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jetty<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="配置application-yml"><a href="#配置application-yml" class="headerlink" title="配置application.yml"></a>配置application.yml</h2><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server.port:</span> <span class="number">8092</span></span><br></pre></td></tr></table></figure>

<h2 id="创建Controller"><a href="#创建Controller" class="headerlink" title="创建Controller"></a>创建Controller</h2><p>没有结果返回的示例：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Description:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/first"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">first</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"first controller"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/doError"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">error</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span> / <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="创建切面类"><a href="#创建切面类" class="headerlink" title="创建切面类"></a>创建切面类</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 日志切面</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LogAspect</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Pointcut</span>(<span class="string">"execution(public * com.xncoding.aop.controller.*.*(..))"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">webLog</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span>(<span class="string">"webLog()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deBefore</span><span class="params">(JoinPoint joinPoint)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="comment">// 接收到请求，记录请求内容</span></span><br><span class="line">        ServletRequestAttributes attributes = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();</span><br><span class="line">        HttpServletRequest request = attributes.getRequest();</span><br><span class="line">        <span class="comment">// 记录下请求内容</span></span><br><span class="line">        System.out.println(<span class="string">"URL : "</span> + request.getRequestURL().toString());</span><br><span class="line">        System.out.println(<span class="string">"HTTP_METHOD : "</span> + request.getMethod());</span><br><span class="line">        System.out.println(<span class="string">"IP : "</span> + request.getRemoteAddr());</span><br><span class="line">        System.out.println(<span class="string">"CLASS_METHOD : "</span> + joinPoint.getSignature().getDeclaringTypeName() + <span class="string">"."</span> + joinPoint.getSignature().getName());</span><br><span class="line">        System.out.println(<span class="string">"ARGS : "</span> + Arrays.toString(joinPoint.getArgs()));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterReturning</span>(returning = <span class="string">"ret"</span>, pointcut = <span class="string">"webLog()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doAfterReturning</span><span class="params">(Object ret)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="comment">// 处理完请求，返回内容</span></span><br><span class="line">        System.out.println(<span class="string">"方法的返回值 : "</span> + ret);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//后置异常通知</span></span><br><span class="line">    <span class="meta">@AfterThrowing</span>(<span class="string">"webLog()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">throwss</span><span class="params">(JoinPoint jp)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"方法异常时执行....."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//后置最终通知,final增强，不管是抛出异常或者正常退出都会执行</span></span><br><span class="line">    <span class="meta">@After</span>(<span class="string">"webLog()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">(JoinPoint jp)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"方法最后执行....."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//环绕通知,环绕增强，相当于MethodInterceptor</span></span><br><span class="line">    <span class="meta">@Around</span>(<span class="string">"webLog()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">arround</span><span class="params">(ProceedingJoinPoint pjp)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"方法环绕start....."</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Object o =  pjp.proceed();</span><br><span class="line">            System.out.println(<span class="string">"方法环绕proceed，结果是 :"</span> + o);</span><br><span class="line">            <span class="keyword">return</span> o;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="测试效果"><a href="#测试效果" class="headerlink" title="测试效果"></a>测试效果</h2><p>启动项目，执行如下mvn命令：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mvn spring-boot:run</span><br></pre></td></tr></table></figure>

<p>模拟正常执行的情况，访问<code>http://localhost:8092/first</code>，看控制台结果：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">方法环绕start.....</span><br><span class="line">URL : http:&#x2F;&#x2F;localhost:8092&#x2F;first</span><br><span class="line">HTTP_METHOD : GET</span><br><span class="line">IP : 0:0:0:0:0:0:0:1</span><br><span class="line">CLASS_METHOD : com.xncoding.aop.controller.UserController.first</span><br><span class="line">ARGS : []</span><br><span class="line">方法环绕proceed，结果是 :first controller</span><br><span class="line">方法最后执行.....</span><br><span class="line">方法的返回值 : first controller</span><br></pre></td></tr></table></figure>

<p>模拟出现异常时的情况，访问<code>http://localhost:8092/doError</code>，看控制台结果：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">方法环绕start.....</span><br><span class="line">URL : http:&#x2F;&#x2F;localhost:8092&#x2F;doError</span><br><span class="line">HTTP_METHOD : GET</span><br><span class="line">IP : 0:0:0:0:0:0:0:1</span><br><span class="line">CLASS_METHOD : com.xncoding.aop.controller.UserController.error</span><br><span class="line">ARGS : []</span><br><span class="line">java.lang.ArithmeticException: &#x2F; by zero</span><br><span class="line"></span><br><span class="line">...中间省略...</span><br><span class="line"></span><br><span class="line">方法最后执行.....</span><br><span class="line">方法的返回值 : null</span><br></pre></td></tr></table></figure>

<p>通过上面的简单的例子，可以看到aop的执行顺序。知道了顺序后，就可以在相应的位置做切面处理了。</p>
<h2 id="切面注解说明"><a href="#切面注解说明" class="headerlink" title="切面注解说明"></a>切面注解说明</h2><ul>
<li>@Aspect 作用是把当前类标识为一个切面供容器读取</li>
<li>@Pointcut 定义切点，切点方法不用任何代码，返回值是void，重要的是条件表达式</li>
<li>@Before 标识一个前置增强方法，相当于BeforeAdvice的功能</li>
<li>@AfterReturning 后置增强，相当于AfterReturningAdvice，方法退出时执行</li>
<li>@AfterThrowing 异常抛出增强，相当于ThrowsAdvice</li>
<li>@After final增强，不管是抛出异常或者正常退出都会执行</li>
<li>@Around 环绕增强，相当于MethodInterceptor</li>
</ul>
<p>方法参数说明：</p>
<p>除了@Around外，每个方法里都可以加或者不加参数JoinPoint。</p>
<p>JoinPoint里包含了类名、被切面的方法名，参数等属性，可供读取使用。</p>
<p>@Around参数必须为ProceedingJoinPoint，pjp.proceed相应于执行被切面的方法。</p>
<p>@AfterReturning方法里，可以加returning = “xxx”，xxx即为在controller里方法的返回值，本例中的返回值是“first controller”。</p>
<p>@AfterThrowing方法里，可以加throwing = “XXX”，读取异常信息，如本例中可以改为：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//后置异常通知</span></span><br><span class="line"><span class="meta">@AfterThrowing</span>(throwing = <span class="string">"ex"</span>, pointcut = <span class="string">"webLog()"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">throwss</span><span class="params">(JoinPoint jp, Exception ex)</span></span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"方法异常时执行....."</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>一般常用的有before和afterReturn组合，或者单独使用Around，即可获取方法开始前和结束后的切面。</p>
<h2 id="关于切点PointCut"><a href="#关于切点PointCut" class="headerlink" title="关于切点PointCut"></a>关于切点PointCut</h2><p>execution函数用于匹配方法执行的连接点，语法为：</p>
<figure class="highlight lisp"><table><tr><td class="code"><pre><span class="line">execution(方法修饰符(可选)  返回类型  方法名  参数  异常模式(可选))</span><br></pre></td></tr></table></figure>

<p>参数部分允许使用通配符：</p>
<ol>
<li><ul>
<li>匹配任意字符，但只能匹配一个元素</li>
</ul>
</li>
<li>.. 匹配任意字符，可以匹配任意多个元素，表示类时，必须和*联合使用</li>
<li><ul>
<li>必须跟在类名后面，如Horseman+，表示类本身和继承或扩展指定类的所有类</li>
</ul>
</li>
</ol>
<p>除了execution()，Spring中还支持其他多个函数，这里列出名称和简单介绍</p>
<ol>
<li>@annotation() 表示标注了指定注解的目标类方法</li>
<li>args() 通过目标类方法的参数类型指定切点</li>
<li>@args() 通过目标类参数的对象类型是否标注了指定注解指定切点</li>
<li>within() 通过类名指定，它将匹配指定类型</li>
<li>target() 通过类名指定，同时包含所有子类</li>
<li>@within() 匹配标注了指定注解的类及其子类，必须是在目标对象上声明这个注解，在接口上声明的对它不起作用</li>
<li>@target() 匹配标注了指定注解的类，必须是在目标对象上声明这个注解，在接口上声明的对它不起作用</li>
</ol>
<p>逻辑运算符</p>
<p>表达式可由多个切点函数通过逻辑运算组成，与(&amp;&amp;)、 或(||)、 非(!)</p>
<p>比如<code>execution(* chop(..)) &amp;&amp; target(Horseman) 表示Horseman及其子类的chop方法</code></p>
<h2 id="自定义注解"><a href="#自定义注解" class="headerlink" title="自定义注解"></a>自定义注解</h2><p>一般多用于某些特定的功能，我们来自定义一个注解：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Target</span>(&#123;ElementType.METHOD, ElementType.TYPE&#125;)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> UserAccess &#123;</span><br><span class="line">    <span class="function">String <span class="title">desc</span><span class="params">()</span> <span class="keyword">default</span> "无信息"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在Controller里加个方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/second"</span>)</span><br><span class="line"><span class="meta">@UserAccess</span>(desc = <span class="string">"second"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">second</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"second controller"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建一个新的切面类：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.JoinPoint;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.ProceedingJoinPoint;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserAccessAspect</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Pointcut</span>(value = <span class="string">"@annotation(com.xncoding.aop.aspect.UserAccess)"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">access</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span>(<span class="string">"access()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deBefore</span><span class="params">(JoinPoint joinPoint)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"second before"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Around</span>(<span class="string">"@annotation(userAccess)"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">around</span><span class="params">(ProceedingJoinPoint pjp, UserAccess userAccess)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//获取注解里的值</span></span><br><span class="line">        System.out.println(<span class="string">"second around:"</span> + userAccess.desc());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> pjp.proceed();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">            throwable.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>主要看一下@Around注解这里，如果需要获取在controller注解中赋给UserAccess的desc里的值，就需要这种写法，这样UserAccess参数就有值了。</p>
<p>执行：<code>mvn spring-boot:run</code></p>
<p>启动项目，访问<code>http://localhost:8092/second</code>，看控制台：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">方法环绕start.....</span><br><span class="line">URL : http:&#x2F;&#x2F;localhost:8092&#x2F;second</span><br><span class="line">HTTP_METHOD : GET</span><br><span class="line">IP : 0:0:0:0:0:0:0:1</span><br><span class="line">CLASS_METHOD : com.xncoding.aop.controller.UserController.second</span><br><span class="line">ARGS : []</span><br><span class="line">second around:second</span><br><span class="line">second before</span><br><span class="line">方法环绕proceed，结果是 :second controller</span><br><span class="line">方法最后执行.....</span><br><span class="line">方法的返回值 : second controller</span><br></pre></td></tr></table></figure>

<p>通知结果可以看到，两个aop切面类都工作了，顺序呢就是下面的</p>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="assets/1591543646-c24a8d72523ce63c315ba2010e0a1207.png" alt=""></p>
<p>spring aop就是一个同心圆，要执行的方法为圆心，最外层的order最小。从最外层按照AOP1、AOP2的顺序依次执行doAround方法，doBefore方法。然后执行method方法，最后按照AOP2、AOP1的顺序依次执行doAfter、doAfterReturn方法。也就是说对多个AOP来说，先before的，一定后after。</p>
<p>对于上面的例子就是，先外层的就是对所有controller的切面，内层就是自定义注解的。 那不同的切面，顺序怎么决定呢，尤其是同格式的切面处理，譬如两个execution的情况，那spring就是随机决定哪个在外哪个在内了。</p>
<p>所以大部分情况下，我们需要指定顺序，最简单的方式就是在Aspect切面类上加上@Order(1)注解即可，order越小最先执行，也就是位于最外层。像一些全局处理的就可以把order设小一点，具体到某个细节的就设大一点。</p>
<h2 id="GitHub源码"><a href="#GitHub源码" class="headerlink" title="GitHub源码"></a>GitHub源码</h2><p><a href="https://github.com/yidao620c/SpringBootBucket/tree/master/springboot-aop" target="_blank" rel="noopener">springboot-aop</a>   —已测试</p>
<h2 id="来源"><a href="#来源" class="headerlink" title="来源"></a>来源</h2><p><a href="https://www.xncoding.com/" target="_blank" rel="noopener">https://www.xncoding.com/</a></p>
]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>springboot</tag>
        <tag>aop</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot系列 - 使用RestTemplate</title>
    <url>/2020/06/08/SpringBoot%E7%B3%BB%E5%88%97-%E4%BD%BF%E7%94%A8RestTemplate/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><h1 id="SpringBoot系列-使用RestTemplate"><a href="#SpringBoot系列-使用RestTemplate" class="headerlink" title="SpringBoot系列 - 使用RestTemplate"></a>SpringBoot系列 - 使用RestTemplate</h1><p>spring框架提供的RestTemplate类可用于在应用中调用rest服务，它简化了与http服务的通信方式，统一了RESTful的标准，封装了http链接， 我们只需要传入url及返回值类型即可。相较于之前常用的HttpClient，RestTemplate是一种更优雅的调用RESTful服务的方式。</p>
<p>RestTemplate默认依赖JDK提供http连接的能力（HttpURLConnection），如果有需要的话也可以通过setRequestFactory方法替换为例如 Apache HttpComponents、Netty或OkHttp等其它HTTP library。</p>
<p>本篇介绍如何使用RestTemplate，以及在SpringBoot里面的配置和注入。</p>
<h2 id="实现逻辑"><a href="#实现逻辑" class="headerlink" title="实现逻辑"></a>实现逻辑</h2><p>RestTemplate包含以下几个部分：</p>
<ul>
<li>HttpMessageConverter 对象转换器</li>
<li>ClientHttpRequestFactory 默认是JDK的HttpURLConnection</li>
<li>ResponseErrorHandler 异常处理</li>
<li>ClientHttpRequestInterceptor 请求拦截器</li>
</ul>
<p>用一张图可以很直观的理解：</p>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="assets/1591541739-db62a5cdf220fad877b16009e6f23c61.png" alt=""></p>
<p>直接使用方式很简单：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RestTemplateTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        RestTemplate restT = <span class="keyword">new</span> RestTemplate();</span><br><span class="line">        <span class="comment">//通过Jackson JSON processing library直接将返回值绑定到对象</span></span><br><span class="line">        Quote quote = restT.getForObject(<span class="string">"http://gturnquist-quoters.cfapps.io/api/random"</span>, Quote<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        String quoteString = restT.getForObject(<span class="string">"http://gturnquist-quoters.cfapps.io/api/random"</span>, String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        System.out.println(quoteString);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="发送GET请求"><a href="#发送GET请求" class="headerlink" title="发送GET请求"></a>发送GET请求</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 1-getForObject()</span></span><br><span class="line">User user1 = <span class="keyword">this</span>.restTemplate.getForObject(uri, User<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2-getForEntity()</span></span><br><span class="line">ResponseEntity&lt;User&gt; responseEntity1 = <span class="keyword">this</span>.restTemplate.getForEntity(uri, User<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">HttpStatus statusCode = responseEntity1.getStatusCode();</span><br><span class="line">HttpHeaders header = responseEntity1.getHeaders();</span><br><span class="line">User user2 = responseEntity1.getBody();</span><br><span class="line">  </span><br><span class="line"><span class="comment">// 3-exchange()</span></span><br><span class="line">RequestEntity requestEntity = RequestEntity.get(<span class="keyword">new</span> URI(uri)).build();</span><br><span class="line">ResponseEntity&lt;User&gt; responseEntity2 = <span class="keyword">this</span>.restTemplate.exchange(requestEntity, User<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">User user3 = responseEntity2.getBody();</span><br></pre></td></tr></table></figure>

<h2 id="发送POST请求"><a href="#发送POST请求" class="headerlink" title="发送POST请求"></a>发送POST请求</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 1-postForObject()</span></span><br><span class="line">User user1 = <span class="keyword">this</span>.restTemplate.postForObject(uri, user, User<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2-postForEntity()</span></span><br><span class="line">ResponseEntity&lt;User&gt; responseEntity1 = <span class="keyword">this</span>.restTemplate.postForEntity(uri, user, User<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3-exchange()</span></span><br><span class="line">RequestEntity&lt;User&gt; requestEntity = RequestEntity.post(<span class="keyword">new</span> URI(uri)).body(user);</span><br><span class="line">ResponseEntity&lt;User&gt; responseEntity2 = <span class="keyword">this</span>.restTemplate.exchange(requestEntity, User<span class="class">.<span class="keyword">class</span>)</span>;</span><br></pre></td></tr></table></figure>

<h2 id="设置HTTP-Header"><a href="#设置HTTP-Header" class="headerlink" title="设置HTTP Header"></a>设置HTTP Header</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 1-Content-Type</span></span><br><span class="line">RequestEntity&lt;User&gt; requestEntity = RequestEntity</span><br><span class="line">        .post(<span class="keyword">new</span> URI(uri))</span><br><span class="line">        .contentType(MediaType.APPLICATION_JSON)</span><br><span class="line">        .body(user);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2-Accept</span></span><br><span class="line">RequestEntity&lt;User&gt; requestEntity = RequestEntity</span><br><span class="line">        .post(<span class="keyword">new</span> URI(uri))</span><br><span class="line">        .accept(MediaType.APPLICATION_JSON)</span><br><span class="line">        .body(user);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3-Other</span></span><br><span class="line">RequestEntity&lt;User&gt; requestEntity = RequestEntity</span><br><span class="line">        .post(<span class="keyword">new</span> URI(uri))</span><br><span class="line">        .header(<span class="string">"Authorization"</span>, <span class="string">"Basic "</span> + base64Credentials)</span><br><span class="line">        .body(user);</span><br></pre></td></tr></table></figure>

<h2 id="捕获异常"><a href="#捕获异常" class="headerlink" title="捕获异常"></a>捕获异常</h2><p>捕获<code>HttpServerErrorException</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    responseEntity = restTemplate.exchange(requestEntity, String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">&#125; <span class="keyword">catch</span> (HttpServerErrorException e) &#123;</span><br><span class="line">    <span class="comment">// log error</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="自定义异常处理器"><a href="#自定义异常处理器" class="headerlink" title="自定义异常处理器"></a>自定义异常处理器</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomErrorHandler</span> <span class="keyword">extends</span> <span class="title">DefaultResponseErrorHandler</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleError</span><span class="params">(ClientHttpResponse response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// todo</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后设置下异常处理器：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RestClientConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">restTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        RestTemplate restTemplate = <span class="keyword">new</span> RestTemplate();</span><br><span class="line">        restTemplate.setErrorHandler(<span class="keyword">new</span> CustomErrorHandler());</span><br><span class="line">        <span class="keyword">return</span> restTemplate;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="配置类"><a href="#配置类" class="headerlink" title="配置类"></a>配置类</h2><p>创建<code>HttpClientConfig</code>类，设置连接池大小、超时时间、重试机制等。配置如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * - Supports both HTTP and HTTPS</span></span><br><span class="line"><span class="comment"> * - Uses a connection pool to re-use connections and save overhead of creating connections.</span></span><br><span class="line"><span class="comment"> * - Has a custom connection keep-alive strategy (to apply a default keep-alive if one isn't specified)</span></span><br><span class="line"><span class="comment"> * - Starts an idle connection monitor to continuously clean up stale connections.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> XiongNeng</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2018/7/5</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableScheduling</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpClientConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(HttpClientConfig<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> HttpClientProperties p;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PoolingHttpClientConnectionManager <span class="title">poolingConnectionManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        SSLContextBuilder builder = <span class="keyword">new</span> SSLContextBuilder();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            builder.loadTrustMaterial(<span class="keyword">null</span>, <span class="keyword">new</span> TrustStrategy() &#123;</span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isTrusted</span><span class="params">(X509Certificate[] arg0, String arg1)</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchAlgorithmException | KeyStoreException e) &#123;</span><br><span class="line">            LOGGER.error(<span class="string">"Pooling Connection Manager Initialisation failure because of "</span> + e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        SSLConnectionSocketFactory sslsf = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            sslsf = <span class="keyword">new</span> SSLConnectionSocketFactory(builder.build());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (KeyManagementException | NoSuchAlgorithmException e) &#123;</span><br><span class="line">            LOGGER.error(<span class="string">"Pooling Connection Manager Initialisation failure because of "</span> + e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Registry&lt;ConnectionSocketFactory&gt; socketFactoryRegistry = RegistryBuilder</span><br><span class="line">                .&lt;ConnectionSocketFactory&gt;create()</span><br><span class="line">                .register(<span class="string">"https"</span>, sslsf)</span><br><span class="line">                .register(<span class="string">"http"</span>, <span class="keyword">new</span> PlainConnectionSocketFactory())</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        PoolingHttpClientConnectionManager poolingConnectionManager = <span class="keyword">new</span> PoolingHttpClientConnectionManager(socketFactoryRegistry);</span><br><span class="line">        poolingConnectionManager.setMaxTotal(p.getMaxTotalConnections());  <span class="comment">//最大连接数</span></span><br><span class="line">        poolingConnectionManager.setDefaultMaxPerRoute(p.getDefaultMaxPerRoute());  <span class="comment">//同路由并发数</span></span><br><span class="line">        <span class="keyword">return</span> poolingConnectionManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ConnectionKeepAliveStrategy <span class="title">connectionKeepAliveStrategy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ConnectionKeepAliveStrategy() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getKeepAliveDuration</span><span class="params">(HttpResponse response, HttpContext httpContext)</span> </span>&#123;</span><br><span class="line">                HeaderElementIterator it = <span class="keyword">new</span> BasicHeaderElementIterator</span><br><span class="line">                        (response.headerIterator(HTTP.CONN_KEEP_ALIVE));</span><br><span class="line">                <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">                    HeaderElement he = it.nextElement();</span><br><span class="line">                    String param = he.getName();</span><br><span class="line">                    String value = he.getValue();</span><br><span class="line">                    <span class="keyword">if</span> (value != <span class="keyword">null</span> &amp;&amp; param.equalsIgnoreCase(<span class="string">"timeout"</span>)) &#123;</span><br><span class="line">                        <span class="keyword">return</span> Long.parseLong(value) * <span class="number">1000</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> p.getDefaultKeepAliveTimeMillis();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CloseableHttpClient <span class="title">httpClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        RequestConfig requestConfig = RequestConfig.custom()</span><br><span class="line">                .setConnectionRequestTimeout(p.getRequestTimeout())</span><br><span class="line">                .setConnectTimeout(p.getConnectTimeout())</span><br><span class="line">                .setSocketTimeout(p.getSocketTimeout()).build();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> HttpClients.custom()</span><br><span class="line">                .setDefaultRequestConfig(requestConfig)</span><br><span class="line">                .setConnectionManager(poolingConnectionManager())</span><br><span class="line">                .setKeepAliveStrategy(connectionKeepAliveStrategy())</span><br><span class="line">                .setRetryHandler(<span class="keyword">new</span> DefaultHttpRequestRetryHandler(<span class="number">3</span>, <span class="keyword">true</span>))  <span class="comment">// 重试次数</span></span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Runnable <span class="title">idleConnectionMonitor</span><span class="params">(<span class="keyword">final</span> PoolingHttpClientConnectionManager connectionManager)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="meta">@Scheduled</span>(fixedDelay = <span class="number">10000</span>)</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (connectionManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        LOGGER.trace(<span class="string">"run IdleConnectionMonitor - Closing expired and idle connections..."</span>);</span><br><span class="line">                        connectionManager.closeExpiredConnections();</span><br><span class="line">                        connectionManager.closeIdleConnections(p.getCloseIdleConnectionWaitTimeSecs(), TimeUnit.SECONDS);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        LOGGER.trace(<span class="string">"run IdleConnectionMonitor - Http Client Connection manager is not initialised"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    LOGGER.error(<span class="string">"run IdleConnectionMonitor - Exception occurred. msg=&#123;&#125;, e=&#123;&#125;"</span>, e.getMessage(), e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TaskScheduler <span class="title">taskScheduler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ThreadPoolTaskScheduler scheduler = <span class="keyword">new</span> ThreadPoolTaskScheduler();</span><br><span class="line">        scheduler.setThreadNamePrefix(<span class="string">"poolScheduler"</span>);</span><br><span class="line">        scheduler.setPoolSize(<span class="number">50</span>);</span><br><span class="line">        <span class="keyword">return</span> scheduler;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后再配置RestTemplateConfig类，使用之前配置好的CloseableHttpClient类注入，同时配置一些默认的消息转换器：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * RestTemplate客户端连接池配置</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> XiongNeng</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2018/1/24</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAspectJAutoProxy</span>(proxyTargetClass = <span class="keyword">true</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RestTemplateConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> CloseableHttpClient httpClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">restTemplate</span><span class="params">(MappingJackson2HttpMessageConverter jackson2HttpMessageConverter)</span> </span>&#123;</span><br><span class="line">        RestTemplate restTemplate = <span class="keyword">new</span> RestTemplate(clientHttpRequestFactory());</span><br><span class="line"></span><br><span class="line">        List&lt;HttpMessageConverter&lt;?&gt;&gt; messageConverters = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        StringHttpMessageConverter stringHttpMessageConverter = <span class="keyword">new</span> StringHttpMessageConverter(Charset.forName(<span class="string">"utf-8"</span>));</span><br><span class="line">        messageConverters.add(stringHttpMessageConverter);</span><br><span class="line">        messageConverters.add(jackson2HttpMessageConverter);</span><br><span class="line">        restTemplate.setMessageConverters(messageConverters);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> restTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> HttpComponentsClientHttpRequestFactory <span class="title">clientHttpRequestFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        HttpComponentsClientHttpRequestFactory rf = <span class="keyword">new</span> HttpComponentsClientHttpRequestFactory();</span><br><span class="line">        rf.setHttpClient(httpClient);</span><br><span class="line">        <span class="keyword">return</span> rf;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意，如果没有apache的HttpClient类，需要在pom文件中添加：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.httpcomponents<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>httpclient<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.5.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="发送文件"><a href="#发送文件" class="headerlink" title="发送文件"></a>发送文件</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">MultiValueMap&lt;String, Object&gt; multiPartBody = <span class="keyword">new</span> LinkedMultiValueMap&lt;&gt;();</span><br><span class="line">multiPartBody.add(<span class="string">"file"</span>, <span class="keyword">new</span> ClassPathResource(<span class="string">"/tmp/user.txt"</span>));</span><br><span class="line">RequestEntity&lt;MultiValueMap&lt;String, Object&gt;&gt; requestEntity = RequestEntity</span><br><span class="line">        .post(uri)</span><br><span class="line">        .contentType(MediaType.MULTIPART_FORM_DATA)</span><br><span class="line">        .body(multiPartBody);</span><br></pre></td></tr></table></figure>

<h2 id="下载文件"><a href="#下载文件" class="headerlink" title="下载文件"></a>下载文件</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 小文件</span></span><br><span class="line">RequestEntity requestEntity = RequestEntity.get(uri).build();</span><br><span class="line">ResponseEntity&lt;<span class="keyword">byte</span>[]&gt; responseEntity = restTemplate.exchange(requestEntity, <span class="keyword">byte</span>[]<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"><span class="keyword">byte</span>[] downloadContent = responseEntity.getBody();</span><br><span class="line">  </span><br><span class="line"><span class="comment">// 大文件  </span></span><br><span class="line">ResponseExtractor&lt;ResponseEntity&lt;File&gt;&gt; responseExtractor = <span class="keyword">new</span> ResponseExtractor&lt;ResponseEntity&lt;File&gt;&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity&lt;File&gt; <span class="title">extractData</span><span class="params">(ClientHttpResponse response)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        File rcvFile = File.createTempFile(<span class="string">"rcvFile"</span>, <span class="string">"zip"</span>);</span><br><span class="line">        FileCopyUtils.copy(response.getBody(), <span class="keyword">new</span> FileOutputStream(rcvFile));</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.status(response.getStatusCode()).headers(response.getHeaders()).body(rcvFile);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">File getFile = <span class="keyword">this</span>.restTemplate.execute(targetUri, HttpMethod.GET, <span class="keyword">null</span>, responseExtractor);</span><br></pre></td></tr></table></figure>

<h2 id="Service注入"><a href="#Service注入" class="headerlink" title="Service注入"></a>Service注入</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DeviceService</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(DeviceService<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="实际使用例子"><a href="#实际使用例子" class="headerlink" title="实际使用例子"></a>实际使用例子</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 开始推送消息</span></span><br><span class="line">logger.info(<span class="string">"解绑成功后推送消息给对应的POS机"</span>);</span><br><span class="line">LoginParam loginParam = <span class="keyword">new</span> LoginParam();</span><br><span class="line">loginParam.setUsername(managerInfo.getUsername());</span><br><span class="line">loginParam.setPassword(managerInfo.getPassword());</span><br><span class="line">HttpBaseResponse r = restTemplate.postForObject(</span><br><span class="line">        p.getPosapiUrlPrefix() + <span class="string">"/notifyLogin"</span>, loginParam, HttpBaseResponse<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"><span class="keyword">if</span> (r.isSuccess()) &#123;</span><br><span class="line">    logger.info(<span class="string">"推送消息登录认证成功"</span>);</span><br><span class="line">    String token = (String) r.getData();</span><br><span class="line">    UnbindParam unbindParam = <span class="keyword">new</span> UnbindParam();</span><br><span class="line">    unbindParam.setImei(pos.getImei());</span><br><span class="line">    unbindParam.setLocation(location);</span><br><span class="line">    <span class="comment">// 设置HTTP Header信息</span></span><br><span class="line">    URI uri;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        uri = <span class="keyword">new</span> URI(p.getPosapiUrlPrefix() + <span class="string">"/notify/unbind"</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (URISyntaxException e) &#123;</span><br><span class="line">        logger.error(<span class="string">"URI构建失败"</span>, e);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    RequestEntity&lt;UnbindParam&gt; requestEntity = RequestEntity</span><br><span class="line">            .post(uri)</span><br><span class="line">            .contentType(MediaType.APPLICATION_JSON)</span><br><span class="line">            .accept(MediaType.APPLICATION_JSON)</span><br><span class="line">            .header(<span class="string">"Authorization"</span>, token)</span><br><span class="line">            .body(unbindParam);</span><br><span class="line">    ResponseEntity&lt;HttpBaseResponse&gt; responseEntity = restTemplate.exchange(requestEntity, HttpBaseResponse<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    HttpBaseResponse r2 = responseEntity.getBody();</span><br><span class="line">    <span class="keyword">if</span> (r2.isSuccess()) &#123;</span><br><span class="line">        logger.info(<span class="string">"推送消息解绑网点成功"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        logger.error(<span class="string">"推送消息解绑网点失败，errmsg = "</span> + r2.getMsg());</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    logger.error(<span class="string">"推送消息登录认证失败"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="GitHub源码"><a href="#GitHub源码" class="headerlink" title="GitHub源码"></a>GitHub源码</h2><p><a href="https://github.com/yidao620c/SpringBootBucket/tree/master/springboot-resttemplate" target="_blank" rel="noopener">springboot-resttemplate</a>    —已测试</p>
<h2 id="来源"><a href="#来源" class="headerlink" title="来源"></a>来源</h2><p><a href="https://www.xncoding.com/" target="_blank" rel="noopener">https://www.xncoding.com/</a></p>
]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>springboot</tag>
        <tag>resttemplate</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot系列 - 使用消息队列RabbitMQ</title>
    <url>/2020/06/08/SpringBoot%E7%B3%BB%E5%88%97-%E4%BD%BF%E7%94%A8%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97RabbitMQ/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><h1 id="SpringBoot系列-使用消息队列RabbitMQ"><a href="#SpringBoot系列-使用消息队列RabbitMQ" class="headerlink" title="SpringBoot系列 - 使用消息队列RabbitMQ"></a>SpringBoot系列 - 使用消息队列RabbitMQ</h1><p>RabbitMQ 即一个消息队列，主要是用来实现应用程序的异步和解耦，同时也能起到消息缓冲，消息分发的作用。</p>
<p>RabbitMQ是实现AMQP（高级消息队列协议）的消息中间件的一种，AMQP，即Advanced Message Queuing Protocol， 高级消息队列协议，是应用层协议的一个开放标准，为面向消息的中间件设计。</p>
<p>在项目中，将一些无需即时返回且耗时的操作提取出来，进行了异步处理，而这种异步处理的方式大大的节省了服务器的请求响应时间， 提高了系统的吞吐量。</p>
<p>本篇将详细介绍RabbitMQ以及如何在SpringBoot中使用。</p>
<h2 id="简单概念"><a href="#简单概念" class="headerlink" title="简单概念"></a>简单概念</h2><p>关于消息中间件RabbitMQ的详细介绍可以参考我的博客系列教程：<a href="https://www.xncoding.com/tags/rabbitmq/" target="_blank" rel="noopener">RabbitMQ简易教程</a></p>
<p>这里我只对一些最核心的概念拿出来讲一下，不理解这些就根本无法理解下面的代码。</p>
<p>几个名词术语：</p>
<ul>
<li>Broker - 简单来说就是消息队列服务器的实体。</li>
<li>Exchange - 消息路由器，转发消息到绑定的队列上，指定消息按什么规则，路由到哪个队列。</li>
<li>Queue - 消息队列，用来存储消息，每个消息都会被投入到一个或多个队列。</li>
<li>Binding - 绑定，它的作用就是把 Exchange 和 Queue 按照路由规则绑定起来。</li>
<li>RoutingKey - 路由关键字，Exchange 根据这个关键字进行消息投递。</li>
<li>Producter - 消息生产者，产生消息的程序。</li>
<li>Consumer - 消息消费者，接收消息的程序。</li>
<li>Channel - 消息通道，在客户端的每个连接里可建立多个Channel，每个channel代表一个会话。</li>
</ul>
<p>一般消息队列都是生产者将消息发送到队列，消费者监听队列进行消费。rabbitmq中一个虚拟主机（默认 /）持有一个或者多个交换机（Exchange）。 用户只能在虚拟主机的粒度进行权限控制，交换机根据一定的策略（RoutingKey）绑定(Binding)到队列(Queue)上， 这样生产者和队列就没有直接联系，而是将消息发送的交换机，交换机再把消息转发到对应绑定的队列上。</p>
<p>上面说了交换机（Exchange）作为rabbitmq的一个独特的重要的概念，单独拿出来讲一下。我们用到的最常见的是4中类型：</p>
<ol>
<li>Direct: 先匹配, 再投送。即在绑定时设定一个routing_key, 消息的routing_key匹配时, 才会被交换器投送到绑定的队列中去. 交换机跟队列必须是精确的对应关系，这种最为简单。</li>
<li>Topic: 转发消息主要是根据通配符。在这种交换机下，队列和交换机的绑定会定义一种路由模式，那么，通配符就要在这种路由模式和路由键之间匹配后交换机才能转发消息 这种可以认为是Direct 的灵活版</li>
<li>Headers: 也是根据规则匹配, 相较于 direct 和 topic 固定地使用 routingkey , headers则是一个自定义匹配规则的类型， 在队列与交换器绑定时会设定一组键值对规则，消息中也包括一组键值对( headers属性)，当这些键值对有一对或全部匹配时，消息被投送到对应队列</li>
<li>Fanout : 消息广播模式，不管路由键或者是路由模式，会把消息发给绑定给它的全部队列，如果配置了routingkey会被忽略</li>
</ol>
<p>理解交换机如何投送消息的原理后，后面的就比较简单了。</p>
<h2 id="Ack机制"><a href="#Ack机制" class="headerlink" title="Ack机制"></a>Ack机制</h2><p>在RabbitMQ的消息队列编程中，有个非常重要的概率叫消息确认机制，也就是Ack机制，这里我需要单独讲一下。</p>
<p>每个Consumer可能需要一段时间才能处理完收到的数据。如果在这个过程中，Consumer出错了或者异常退出了，而数据还没有处理完成，那么非常不幸，这段数据就丢失了。</p>
<p>因为我们采用no-ack的方式进行确认，也就是说，每次Consumer接到数据后，而不管是否处理完成，RabbitMQ Server会立即把这个Message标记为完成，然后从queue中删除了。 如果一个Consumer异常退出了，它处理的数据能够被另外的Consumer处理，这样数据在这种情况下就不会丢失了（注意是这种情况下）。</p>
<p>为了保证数据不被丢失，RabbitMQ支持消息确认机制，即acknowledgments。为了保证数据能被正确处理而不仅仅是被Consumer收到，那么我们不能采用no-ack。而应该是在处理完数据后发送ack。 在处理数据后发送的ack，就是告诉RabbitMQ数据已经被接收，处理完成，RabbitMQ可以去安全的删除它了。</p>
<p>如果Consumer退出了但是没有发送ack，那么RabbitMQ就会把这个Message发送到下一个Consumer。这样就保证了在Consumer异常退出的情况下数据也不会丢失。</p>
<p>这里并没有用到超时机制。RabbitMQ仅仅通过Consumer的连接中断来确认该Message并没有被正确处理。也就是说，RabbitMQ给了Consumer足够长的时间来做数据处理。 这样即使你通过Ctr-C中断了Recieve.cs，那么Message也不会丢失了，它会被分发到下一个Consumer。</p>
<p>如果忘记了ack，那么后果很严重。当Consumer退出时，Message会重新分发。然后RabbitMQ会占用越来越多的内存，由于RabbitMQ会长时间运行，因此这个“内存泄漏”是致命的。</p>
<p>下面的例子中我会使用手动Ack模式。</p>
<h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><p>RabbitMQ需要安装erlang和RabbitMQ Server， 安装教程请参考：<a href="https://www.xncoding.com/2017/05/06/mq/rabbitmq-tutorial01.html" target="_blank" rel="noopener">RabbitMQ简易教程 - 安装</a></p>
<p>请先按照教程安装好RabbitMQ后，添加一个用户spring/123456，后面配置要用到。</p>
<h2 id="SpringBoot中集成"><a href="#SpringBoot中集成" class="headerlink" title="SpringBoot中集成"></a>SpringBoot中集成</h2><p>接下来正式开始讲解如何在SpringBoot中集成了。</p>
<h3 id="maven依赖"><a href="#maven依赖" class="headerlink" title="maven依赖"></a>maven依赖</h3><p>第一版当然是先添加maven依赖了，有官方现成的starter依赖，如下：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.vaadin.external.google<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>android-json<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><p>在application.yml中添加rabbitmq相关配置：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">spring</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">publisher-confirms:</span> <span class="literal">true</span> <span class="comment">#支持发布确认</span></span><br><span class="line">    <span class="attr">publisher-returns:</span> <span class="literal">true</span>  <span class="comment">#支持发布返回</span></span><br><span class="line">    <span class="attr">listener:</span></span><br><span class="line">      <span class="attr">simple:</span></span><br><span class="line">        <span class="attr">acknowledge-mode:</span> <span class="string">manual</span> <span class="comment">#采用手动应答</span></span><br><span class="line">        <span class="attr">concurrency:</span> <span class="number">1</span> <span class="comment">#指定最小的消费者数量</span></span><br><span class="line">        <span class="attr">max-concurrency:</span> <span class="number">1</span> <span class="comment">#指定最大的消费者数量</span></span><br><span class="line">        <span class="attr">retry:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment">#是否支持重试</span></span><br></pre></td></tr></table></figure>

<h3 id="配置类"><a href="#配置类" class="headerlink" title="配置类"></a>配置类</h3><p>最核心的类就是RabbitMQ的配置类，在里面定制模版类、声明交换机、队列、绑定交换机到队列。</p>
<p>这里我声明了一个Direct类型的交换机，并通过路由键绑定到一个队列中来测试Direct模式， 另外还声明了Fanout类型的交换机，并绑定到2个队列来测试广播模式。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RabbitConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 定制化amqp模版      可根据需要定制多个</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * 此处为模版类定义 Jackson消息转换器</span></span><br><span class="line"><span class="comment">     * ConfirmCallback接口用于实现消息发送到RabbitMQ交换器后接收ack回调   即消息发送到exchange  ack</span></span><br><span class="line"><span class="comment">     * ReturnCallback接口用于实现消息发送到RabbitMQ 交换器，但无相应队列与交换器绑定时的回调  即消息发送不到任何一个队列中  ack</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the amqp template</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// @Primary</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AmqpTemplate <span class="title">amqpTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Logger log = LoggerFactory.getLogger(RabbitTemplate<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="comment">// 使用jackson 消息转换器</span></span><br><span class="line">        rabbitTemplate.setMessageConverter(<span class="keyword">new</span> Jackson2JsonMessageConverter());</span><br><span class="line">        rabbitTemplate.setEncoding(<span class="string">"UTF-8"</span>);</span><br><span class="line">        <span class="comment">// 消息发送失败返回到队列中，yml需要配置 publisher-returns: true</span></span><br><span class="line">        rabbitTemplate.setMandatory(<span class="keyword">true</span>);</span><br><span class="line">        rabbitTemplate.setReturnCallback((message, replyCode, replyText, exchange, routingKey) -&gt; &#123;</span><br><span class="line">            String correlationId = message.getMessageProperties().getCorrelationIdString();</span><br><span class="line">            log.debug(<span class="string">"消息：&#123;&#125; 发送失败, 应答码：&#123;&#125; 原因：&#123;&#125; 交换机: &#123;&#125;  路由键: &#123;&#125;"</span>, correlationId, replyCode, replyText, exchange, routingKey);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 消息确认，yml需要配置 publisher-confirms: true</span></span><br><span class="line">        rabbitTemplate.setConfirmCallback((correlationData, ack, cause) -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (ack) &#123;</span><br><span class="line">                log.debug(<span class="string">"消息发送到exchange成功,id: &#123;&#125;"</span>, correlationData.getId());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                log.debug(<span class="string">"消息发送到exchange失败,原因: &#123;&#125;"</span>, cause);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> rabbitTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* ----------------------------------------------------------------------------Direct exchange test--------------------------------------------------------------------------- */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 声明Direct交换机 支持持久化.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the exchange</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span>(<span class="string">"directExchange"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Exchange <span class="title">directExchange</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ExchangeBuilder.directExchange(<span class="string">"DIRECT_EXCHANGE"</span>).durable(<span class="keyword">true</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 声明一个队列 支持持久化.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the queue</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span>(<span class="string">"directQueue"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Queue <span class="title">directQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(<span class="string">"DIRECT_QUEUE"</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过绑定键 将指定队列绑定到一个指定的交换机 .</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> queue    the queue</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> exchange the exchange</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the binding</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Binding <span class="title">directBinding</span><span class="params">(@Qualifier(<span class="string">"directQueue"</span>)</span> Queue queue,</span></span><br><span class="line"><span class="function">                                 @<span class="title">Qualifier</span><span class="params">(<span class="string">"directExchange"</span>)</span> Exchange exchange) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(<span class="string">"DIRECT_ROUTING_KEY"</span>).noargs();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* ----------------------------------------------------------------------------Fanout exchange test--------------------------------------------------------------------------- */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 声明 fanout 交换机.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the exchange</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span>(<span class="string">"fanoutExchange"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> FanoutExchange <span class="title">fanoutExchange</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (FanoutExchange) ExchangeBuilder.fanoutExchange(<span class="string">"FANOUT_EXCHANGE"</span>).durable(<span class="keyword">true</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Fanout queue A.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the queue</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span>(<span class="string">"fanoutQueueA"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Queue <span class="title">fanoutQueueA</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(<span class="string">"FANOUT_QUEUE_A"</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Fanout queue B .</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the queue</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span>(<span class="string">"fanoutQueueB"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Queue <span class="title">fanoutQueueB</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> QueueBuilder.durable(<span class="string">"FANOUT_QUEUE_B"</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 绑定队列A 到Fanout 交换机.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> queue          the queue</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fanoutExchange the fanout exchange</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the binding</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Binding <span class="title">bindingA</span><span class="params">(@Qualifier(<span class="string">"fanoutQueueA"</span>)</span> Queue queue,</span></span><br><span class="line"><span class="function">                            @<span class="title">Qualifier</span><span class="params">(<span class="string">"fanoutExchange"</span>)</span> FanoutExchange fanoutExchange) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(fanoutExchange);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 绑定队列B 到Fanout 交换机.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> queue          the queue</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> fanoutExchange the fanout exchange</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the binding</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Binding <span class="title">bindingB</span><span class="params">(@Qualifier(<span class="string">"fanoutQueueB"</span>)</span> Queue queue,</span></span><br><span class="line"><span class="function">                            @<span class="title">Qualifier</span><span class="params">(<span class="string">"fanoutExchange"</span>)</span> FanoutExchange fanoutExchange) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(fanoutExchange);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="监听器"><a href="#监听器" class="headerlink" title="监听器"></a>监听器</h3><p>接下来编写消息队列的监听器类，监听队列消息并做相应的处理，并通过Ack机制确认处理完成：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 消息监听器</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> XiongNeng</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Receiver</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(Receiver<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * FANOUT广播队列监听一.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message the message</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> channel the channel</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException the io exception  这里异常需要处理</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RabbitListener</span>(queues = &#123;<span class="string">"FANOUT_QUEUE_A"</span>&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">on</span><span class="params">(Message message, Channel channel)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="keyword">true</span>);</span><br><span class="line">        log.debug(<span class="string">"FANOUT_QUEUE_A "</span> + <span class="keyword">new</span> String(message.getBody()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * FANOUT广播队列监听二.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message the message</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> channel the channel</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException the io exception   这里异常需要处理</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RabbitListener</span>(queues = &#123;<span class="string">"FANOUT_QUEUE_B"</span>&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">t</span><span class="params">(Message message, Channel channel)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="keyword">true</span>);</span><br><span class="line">        log.debug(<span class="string">"FANOUT_QUEUE_B "</span> + <span class="keyword">new</span> String(message.getBody()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * DIRECT模式.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message the message</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> channel the channel</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException the io exception  这里异常需要处理</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RabbitListener</span>(queues = &#123;<span class="string">"DIRECT_QUEUE"</span>&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">message</span><span class="params">(Message message, Channel channel)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        channel.basicAck(message.getMessageProperties().getDeliveryTag(), <span class="keyword">true</span>);</span><br><span class="line">        log.debug(<span class="string">"DIRECT "</span> + <span class="keyword">new</span> String(message.getBody()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="消息发送者"><a href="#消息发送者" class="headerlink" title="消息发送者"></a>消息发送者</h3><p>再写一个消息发送服务，用来向交换机发送消息：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 消息发送服务</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SenderService</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 测试广播模式.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> p the p</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the response entity</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">broadcast</span><span class="params">(String p)</span> </span>&#123;</span><br><span class="line">        CorrelationData correlationData = <span class="keyword">new</span> CorrelationData(UUID.randomUUID().toString());</span><br><span class="line">        rabbitTemplate.convertAndSend(<span class="string">"FANOUT_EXCHANGE"</span>, <span class="string">""</span>, p, correlationData);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 测试Direct模式.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> p the p</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the response entity</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">direct</span><span class="params">(String p)</span> </span>&#123;</span><br><span class="line">        CorrelationData correlationData = <span class="keyword">new</span> CorrelationData(UUID.randomUUID().toString());</span><br><span class="line">        rabbitTemplate.convertAndSend(<span class="string">"DIRECT_EXCHANGE"</span>, <span class="string">"DIRECT_ROUTING_KEY"</span>, p, correlationData);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="运行测试"><a href="#运行测试" class="headerlink" title="运行测试"></a>运行测试</h2><p>代码写完后当然要写个测试用例测一下嘛。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * SenderServiceTest</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> XiongNeng</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RunWith</span>(SpringRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">SpringBootTest</span>(<span class="title">classes</span> </span>= Application<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">SenderServiceTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SenderService senderService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testCache</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 测试广播模式</span></span><br><span class="line">        senderService.broadcast(<span class="string">"同学们集合啦！"</span>);</span><br><span class="line">        <span class="comment">// 测试Direct模式</span></span><br><span class="line">        senderService.direct(<span class="string">"定点消息"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-attr">[cTaskExecutor-1]</span> <span class="selector-tag">com</span><span class="selector-class">.xncoding</span><span class="selector-class">.pos</span><span class="selector-class">.mq</span><span class="selector-class">.Receiver</span>             : <span class="selector-tag">FANOUT_QUEUE_A</span> "同学们集合啦！"</span><br><span class="line"><span class="selector-attr">[cTaskExecutor-1]</span> <span class="selector-tag">com</span><span class="selector-class">.xncoding</span><span class="selector-class">.pos</span><span class="selector-class">.mq</span><span class="selector-class">.Receiver</span>             : <span class="selector-tag">DIRECT</span> "定点消息"</span><br><span class="line"><span class="selector-attr">[cTaskExecutor-1]</span> <span class="selector-tag">com</span><span class="selector-class">.xncoding</span><span class="selector-class">.pos</span><span class="selector-class">.mq</span><span class="selector-class">.Receiver</span>             : <span class="selector-tag">FANOUT_QUEUE_B</span> "同学们集合啦！"</span><br></pre></td></tr></table></figure>

<p>可以看到，广播消息被两个队列收到了，Direct消息只有一个收到。完美！</p>
<h2 id="GitHub源码"><a href="#GitHub源码" class="headerlink" title="GitHub源码"></a>GitHub源码</h2><p><a href="https://github.com/yidao620c/SpringBootBucket/tree/master/springboot-rabbitmq" target="_blank" rel="noopener">springboot-rabbitmq</a>   —已测试</p>
<h2 id="来源"><a href="#来源" class="headerlink" title="来源"></a>来源</h2><p><a href="https://www.xncoding.com/" target="_blank" rel="noopener">https://www.xncoding.com/</a></p>
]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>springboot</tag>
        <tag>rabbitmq</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot系列 - 声明式事务</title>
    <url>/2020/06/08/SpringBoot%E7%B3%BB%E5%88%97-%E5%A3%B0%E6%98%8E%E5%BC%8F%E4%BA%8B%E5%8A%A1/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><h1 id="SpringBoot系列-声明式事务"><a href="#SpringBoot系列-声明式事务" class="headerlink" title="SpringBoot系列 - 声明式事务"></a>SpringBoot系列 - 声明式事务</h1><p>所有数据访问技术都有事务机制，这些技术提供了API来开启事务、提交事务完成数据操作，或者在发生错误的时候回滚数据。</p>
<p>Spring采用统一的机制来处理不同的数据访问技术的事务， Spring的事务提供一个<code>PlatformTransactionManager</code>的接口，不同的数据访问技术使用不同的接口实现。</p>
<table>
<thead>
<tr>
<th>Data Tech</th>
<th>实现</th>
</tr>
</thead>
<tbody><tr>
<td>JDBC</td>
<td>DataSourceTransactionManager</td>
</tr>
<tr>
<td>JPA</td>
<td>JPATransactionManager</td>
</tr>
<tr>
<td>Hibernate</td>
<td>HibernateTransactionManager</td>
</tr>
<tr>
<td>JDO</td>
<td>JDOTransactionManager</td>
</tr>
<tr>
<td>分布式事务</td>
<td>JtaTransactionManager</td>
</tr>
</tbody></table>
<p>而得益于SpringBoot的自动配置机制，为我们自动开启了声明式事务支持， 我们无需添加注解<code>@EnableTransactionManagement</code></p>
<h2 id="事务基础"><a href="#事务基础" class="headerlink" title="事务基础"></a>事务基础</h2><p>Spring提供一个@EnableTransactionManagement注解在配置类上开启声明式事务支持， 自动扫描加了@Transactional注解的类和方法，加入事务支持。</p>
<p>这里重点讲下@Transactional注解的几个属性</p>
<p><strong>propagation</strong></p>
<p>事务的传播机制，主要有以下几种，默认是REQUIRED：</p>
<ol>
<li>REQUIRED - 方法A调用时候没有事务新建一个事务，在方法A中调用方法B，将使用相同的事务，如果方法B发生异常需要回滚，整个事务回滚。</li>
<li>REQUIRES_NEW - 方法A调用方法B时，无论是否存在事务都开启一个新事务，这样B方法异常不会导致A的数据回滚。</li>
<li>NESTED - 和REQUIRES_NEW类似，但是只支持JDBC，不支持JPA或Hibernate</li>
<li>SUPPORTS - 方法调用时有事务就用事务，没事务就不用事务</li>
<li>NOT_SUPPORTED - 强制方法不在事务中执行，若有事务，在方法调用到结束阶段先挂起事务。</li>
<li>NEVER - 强制不能有事务，若有事务就抛出异常</li>
<li>MANDATORY - 强制必须有事务，如果没有事务就抛出异常</li>
</ol>
<p><strong>isolation</strong></p>
<p>事务的隔离级别，决定了事务的完整性，主要一下几种，默认是DEFAULT：</p>
<ol>
<li>READ_UNCOMMITTED - A事务修改记录但没提交，B事务可读取到修改后的值。可导致脏读、不可重复读、幻读。</li>
<li>READ_COMMITTED - A事务修改并提交后，B事务才能读取到修改后的值，阻止了脏读，但可能导致不可重复读和幻读。</li>
<li>REPEATABLE_READ - A事务读取了一条记录，B事务将不能修改这条记录，阻止脏读和不可重复读，但是可能出现幻读。</li>
<li>SERIALIZABLE - 事务是顺序执行的，可避免所有缺陷，但是开销很大。</li>
<li>DEFAULT - 使用当前数据库默认隔离级别，入Oracle、SQL Server是READ_COMMITTED，MySQL是REPEATABLE_READ</li>
</ol>
<p><strong>timeout</strong></p>
<p>事务过期时间，默认是当前数据库默认事务过期时间。</p>
<p><strong>readOnly</strong></p>
<p>指定是否为只读事务，默认是false</p>
<p>如果你一次执行单条查询语句，则没有必要启用事务支持，数据库默认支持SQL执行期间的读一致性；</p>
<p>如果你一次执行多条查询语句，例如统计查询，报表查询，在这种场景下，多条查询SQL必须保证整体的读一致性， 否则，在前条SQL查询之后，后条SQL查询之前，数据被其他用户改变，则该次整体的统计查询将会出现读数据不一致的状态， 此时，应该启用只读事务支持。</p>
<p>只读事务与读写事务区别：</p>
<p>对于只读查询，可以指定事务类型为readonly，即只读事务。由于只读事务不存在数据的修改， 因此数据库将会为只读事务提供一些优化手段，例如Oracle对于只读事务，不启动回滚段，不记录回滚log。</p>
<p><strong>rollbackFor</strong></p>
<p>指定哪些异常可以导致事务回滚，默认是Throwable的子类</p>
<p><strong>noRollbackFor</strong></p>
<p>执行哪些异常不可用引起事务回滚，默认是Throwable的子类</p>
<h2 id="实战篇"><a href="#实战篇" class="headerlink" title="实战篇"></a>实战篇</h2><p>实际项目中，使用SpringBoot的默认配置就已经足够满足我们的需求了。 本篇将通过几个例子来演示如何使用@Transactional注解，在出现异常时候回滚或不回滚数据。</p>
<p>使用我最喜欢的DAO技术就是MyBatis进行数据访问，使用druid数据库连接池， 另外配合mybatis-plus，实现数据访问层。</p>
<p>引入依赖：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;mysql-connector.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;druid.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- MyBatis plus增强和springboot的集成--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;mybatis-plus.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatisplus-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;mybatisplus-spring-boot-starter.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>配置数据库连接：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment">###################  spring配置  ###################</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://123.207.66.156:3306/test?useSSL=false&amp;autoReconnect=true&amp;tinyInt1isBit=false&amp;useUnicode=true&amp;characterEncoding=utf8</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">xxxxx</span></span><br></pre></td></tr></table></figure>

<p>然后增加mybatis个性化配置：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment">###################  mybatis-plus配置  ###################</span></span><br><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">mapper-locations:</span> <span class="string">classpath*:com/xncoding/trans/dao/repository/mapping/*.xml</span></span><br><span class="line">  <span class="attr">typeAliasesPackage:</span> <span class="string">&gt;</span></span><br><span class="line">    <span class="string">com.xncoding.trans.dao.entity</span></span><br><span class="line">  <span class="attr">global-config:</span></span><br><span class="line">    <span class="attr">id-type:</span> <span class="number">0</span>  <span class="comment"># 0:数据库ID自增   1:用户输入id  2:全局唯一id(IdWorker)  3:全局唯一ID(uuid)</span></span><br><span class="line">    <span class="attr">db-column-underline:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">refresh-mapper:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">configuration:</span></span><br><span class="line">    <span class="attr">map-underscore-to-camel-case:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">cache-enabled:</span> <span class="literal">true</span> <span class="comment">#配置的缓存的全局开关</span></span><br><span class="line">    <span class="attr">lazyLoadingEnabled:</span> <span class="literal">true</span> <span class="comment">#延时加载的开关</span></span><br><span class="line">    <span class="attr">multipleResultSetsEnabled:</span> <span class="literal">true</span> <span class="comment">#开启的话，延时加载一个属性时会加载该对象全部属性，否则按需加载属性</span></span><br></pre></td></tr></table></figure>

<p>增加实体类User：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@TableName</span>(value = <span class="string">"t_user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span>&lt;<span class="title">User</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 主键ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@TableId</span>(value=<span class="string">"id"</span>, type= IdType.AUTO)</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUsername</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUsername</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.username = username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPassword</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPassword</span><span class="params">(String password)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.password = password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Serializable <span class="title">pkVal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.id;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>增加UserMapper类：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserMapper</span> <span class="keyword">extends</span> <span class="title">BaseMapper</span>&lt;<span class="title">User</span>&gt; </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>增加Mybatis配置类：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span>(order = <span class="number">2</span>)</span><br><span class="line"><span class="meta">@MapperScan</span>(basePackages = &#123;<span class="string">"com.xncoding.trans.dao.repository"</span>&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MybatisPlusConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> DruidProperties druidProperties;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 单数据源连接池配置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DruidDataSource <span class="title">singleDatasource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        DruidDataSource dataSource = <span class="keyword">new</span> DruidDataSource();</span><br><span class="line">        druidProperties.config(dataSource);</span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>定义Service，并注入UserMapper：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>增加Controller，注入Service，定义几个url来做测试用：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到此为止项目初始化完成，可以在Service中添加方法进行声明式事务测试了。</p>
<h2 id="异常回滚"><a href="#异常回滚" class="headerlink" title="异常回滚"></a>异常回滚</h2><p>@Transactional注解可以放到类也可以放到方法上，如果放到类上面会对所有public方法添加注解， 不过你仍然可以在方法上面加这个注解，会覆盖类上面声明的事务注解。</p>
<p>先实验一个抛出异常会回滚的方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 增删改要写 ReadOnly=false 为可写</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> user 用户</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Transactional</span>(readOnly = <span class="keyword">false</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateUserError</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">    userMapper.updateById(user);</span><br><span class="line">    errMethod(); <span class="comment">// 执行一个会抛出异常的方法</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">errMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"error"</span>);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"runtime"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后在Controller里面添加一个url调用此方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/errorUpdate"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">first</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        user.setId(<span class="number">1</span>);</span><br><span class="line">        user.setUsername(<span class="string">"admin"</span>);</span><br><span class="line">        user.setPassword(<span class="string">"admin"</span>);</span><br><span class="line">        userService.updateUserError(user);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"first controller"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>数据库里面先插入一条数据：<code>1|admin|123</code></p>
<p>启动应用后访问地址：<code>http://localhost:8092/errorUpdate</code></p>
<p>控制台打印异常：</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">Caused</span> <span class="selector-tag">by</span>: <span class="selector-tag">java</span><span class="selector-class">.lang</span><span class="selector-class">.RuntimeException</span>: <span class="selector-tag">runtime</span></span><br><span class="line">    <span class="selector-tag">at</span> <span class="selector-tag">com</span><span class="selector-class">.xncoding</span><span class="selector-class">.trans</span><span class="selector-class">.service</span><span class="selector-class">.UserService</span><span class="selector-class">.errMethod</span>(<span class="selector-tag">UserService</span><span class="selector-class">.java</span><span class="selector-pseudo">:32)</span> ~<span class="selector-attr">[classes/:na]</span></span><br><span class="line">    <span class="selector-tag">at</span> <span class="selector-tag">com</span><span class="selector-class">.xncoding</span><span class="selector-class">.trans</span><span class="selector-class">.service</span><span class="selector-class">.UserService</span><span class="selector-class">.updateUserError</span>(<span class="selector-tag">UserService</span><span class="selector-class">.java</span><span class="selector-pseudo">:27)</span> ~<span class="selector-attr">[classes/:na]</span></span><br></pre></td></tr></table></figure>

<p>查看数据库中记录：<code>1|admin|123</code>，没有变动，说明回滚成功。</p>
<h2 id="异常不会滚"><a href="#异常不会滚" class="headerlink" title="异常不会滚"></a>异常不会滚</h2><p>你还可以指定特定异常不回滚，比如自定义一个MyException，抛出这个异常不回滚。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyException</span> <span class="keyword">extends</span> <span class="title">RuntimeException</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyException</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyException</span><span class="params">(String runtime)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(runtime);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后通过指定这个异常不回滚：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Transactional</span>(readOnly = <span class="keyword">false</span>, noRollbackFor = &#123;MyException<span class="class">.<span class="keyword">class</span>&#125;)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">void</span> <span class="title">updateUserError2</span>(<span class="title">User</span> <span class="title">user</span>) </span>&#123;</span><br><span class="line">    userMapper.updateById(user);</span><br><span class="line">    errMethod2(); <span class="comment">// 执行一个会抛出自定义异常的方法</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">errMethod2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"error"</span>);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> MyException(<span class="string">"runtime"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后再定义一个url来验证：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/errorUpdate2"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">second</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    User user = <span class="keyword">new</span> User();</span><br><span class="line">    user.setId(<span class="number">1</span>);</span><br><span class="line">    user.setUsername(<span class="string">"admin"</span>);</span><br><span class="line">    user.setPassword(<span class="string">"admin"</span>);</span><br><span class="line">    userService.updateUserError(user);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"second controller"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重启服务器，访问地址：<code>http://localhost:8092/errorUpdate2</code></p>
<p>控制台仍然报异常：</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">Caused</span> <span class="selector-tag">by</span>: <span class="selector-tag">com</span><span class="selector-class">.xncoding</span><span class="selector-class">.trans</span><span class="selector-class">.exception</span><span class="selector-class">.MyException</span>: <span class="selector-tag">runtime</span></span><br><span class="line">    <span class="selector-tag">at</span> <span class="selector-tag">com</span><span class="selector-class">.xncoding</span><span class="selector-class">.trans</span><span class="selector-class">.service</span><span class="selector-class">.UserService</span><span class="selector-class">.errMethod2</span>(<span class="selector-tag">UserService</span><span class="selector-class">.java</span><span class="selector-pseudo">:43)</span> ~<span class="selector-attr">[classes/:na]</span></span><br><span class="line">    <span class="selector-tag">at</span> <span class="selector-tag">com</span><span class="selector-class">.xncoding</span><span class="selector-class">.trans</span><span class="selector-class">.service</span><span class="selector-class">.UserService</span><span class="selector-class">.updateUserError2</span>(<span class="selector-tag">UserService</span><span class="selector-class">.java</span><span class="selector-pseudo">:34)</span> ~<span class="selector-attr">[classes/:na]</span></span><br></pre></td></tr></table></figure>

<p>看看数据库中记录：<code>1|admin|admin</code>，更改成功，说明抛出这个MyException异常后并不会回滚。</p>
<h2 id="GitHub源码"><a href="#GitHub源码" class="headerlink" title="GitHub源码"></a>GitHub源码</h2><p><a href="https://github.com/yidao620c/SpringBootBucket/tree/master/springboot-transaction" target="_blank" rel="noopener">springboot-transaction</a>   —已测试</p>
<h2 id="来源"><a href="#来源" class="headerlink" title="来源"></a>来源</h2><p><a href="https://www.xncoding.com/" target="_blank" rel="noopener">https://www.xncoding.com/</a></p>
]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>springboot</tag>
        <tag>transaction</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot系列 - 定时任务</title>
    <url>/2020/06/08/SpringBoot%E7%B3%BB%E5%88%97-%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><h1 id="SpringBoot系列-定时任务"><a href="#SpringBoot系列-定时任务" class="headerlink" title="SpringBoot系列 - 定时任务"></a>SpringBoot系列 - 定时任务</h1><p>很多时候，我们需要在每天的某个固定时间或者每隔一段时间让应用去执行某一个任务。 为了实现这个需求，通常我们会通过多线程来实现这个功能，但是这样我们需要自己做一些比较麻烦的工作。 接下来，让我们看看如何使用Spring scheduling task简化定时任务功能的实现。</p>
<p>默认，springboot已经支持了定时任务Schedule模块，所以一般情况已经完全能够满足我们的实际需求， 一般来说，没有必要再加入Quartz2了，不过你要是有更高级需求也可以整合Quartz2进来。</p>
<h2 id="定时任务架构"><a href="#定时任务架构" class="headerlink" title="定时任务架构"></a>定时任务架构</h2><p>一般来说，实际项目中，为了提高服务的响应能力，我们一般会通过负载均衡的方式，或者反向代理多个节点的方式来进行。 如果我们将定时任务写在我们的项目中，那么在同一个时间点，定时任务会一起执行，也就是会执行多次，这样很可能会导致我们的业务出现错误。</p>
<p>建议使用逻辑分离的方式来解决这个问题。就是我们将真正要定时任务处理的逻辑，写成rest或者rpc服务， 然后我们可以新建一个单独的定时任务项目，这个项目应该是没有任何的业务代码的，他纯粹只有定时任务功能， 几点启动，或者每隔多少时间启动。启动后，通过rest或者rpc的方式，调用真正处理逻辑的服务。</p>
<h2 id="添加依赖"><a href="#添加依赖" class="headerlink" title="添加依赖"></a>添加依赖</h2><p>实际上只要添加最基础的start依赖即可支持定时任务：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.4.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="添加注解配置类"><a href="#添加注解配置类" class="headerlink" title="添加注解配置类"></a>添加注解配置类</h2><p>如果有多个耗时任务，最好使用线程池来执行，添加一个配置类专门用来配置定时任务执行的线程池：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableScheduling</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ScheduleConfig</span> <span class="keyword">implements</span> <span class="title">SchedulingConfigurer</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configureTasks</span><span class="params">(ScheduledTaskRegistrar taskRegistrar)</span> </span>&#123;</span><br><span class="line">        taskRegistrar.setScheduler(taskExecutor());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(destroyMethod=<span class="string">"shutdown"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ExecutorService <span class="title">taskExecutor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Executors.newScheduledThreadPool(<span class="number">20</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="添加执行任务类"><a href="#添加执行任务类" class="headerlink" title="添加执行任务类"></a>添加执行任务类</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyJob</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(MyJob<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">long</span> ONE_Minute =  <span class="number">10</span> * <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Scheduled</span>(fixedDelay=ONE_Minute)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fixedDelayJob</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        logger.info(DateTimeKit.formatDateTime(<span class="keyword">new</span> Date())+<span class="string">" &gt;&gt;fixedDelay执行.... start"</span>);</span><br><span class="line">        Thread.sleep(<span class="number">5000L</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Scheduled</span>(fixedRate=ONE_Minute)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fixedRateJob</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        logger.info(DateTimeKit.formatDateTime(<span class="keyword">new</span> Date())+<span class="string">" &gt;&gt;fixedRate执行...."</span>);</span><br><span class="line">        Thread.sleep(<span class="number">8000L</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 第一位，表示秒，取值0-59</span></span><br><span class="line"><span class="comment">     * 第二位，表示分，取值0-59</span></span><br><span class="line"><span class="comment">     * 第三位，表示小时，取值0-23</span></span><br><span class="line"><span class="comment">     * 第四位，日期天/日，取值1-31</span></span><br><span class="line"><span class="comment">     * 第五位，日期月份，取值1-12</span></span><br><span class="line"><span class="comment">     * 第六位，星期，取值1-7，1表示星期天，2表示星期一</span></span><br><span class="line"><span class="comment">     * 第七位，年份，可以留空，取值1970-2099</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Scheduled</span>(cron=<span class="string">"0 40 19 * * ?"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cronJob</span><span class="params">()</span></span>&#123;</span><br><span class="line">        logger.info(DateTimeKit.formatDateTime(<span class="keyword">new</span> Date())+<span class="string">" &gt;&gt;cron执行...."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="三种定时任务类型"><a href="#三种定时任务类型" class="headerlink" title="三种定时任务类型"></a>三种定时任务类型</h2><p>上面的例子中有三种典型的定时任务，先将前面最简单的两种，单位都是毫秒，比如1分钟=60秒×1000：</p>
<ol>
<li>fixedDelay：当任务执行完毕后x毫秒后再执行下一个任务</li>
<li>fixedRate： 每隔x毫秒执行一次，不论你业务执行花费了多少时间</li>
</ol>
<p>而还有一类定时任务，比如是每天的3点15分执行，那么我们就需要用另外一种方式：cron表达式</p>
<h2 id="cron表达式"><a href="#cron表达式" class="headerlink" title="cron表达式"></a>cron表达式</h2><p>cron表达式，有专门的语法，而且感觉有点绕人，不过简单来说，大家记住一些常用的用法即可，特殊的语法可以单独去查。</p>
<p>cron一共有7位，但是最后一位是年，可以留空，所以我们可以写6位：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">* 第一位，秒，取值0-59</span><br><span class="line">* 第二位，分，取值0-59</span><br><span class="line">* 第三位，时，取值0-23</span><br><span class="line">* 第四位，日，取值1-31</span><br><span class="line">* 第五位，月，取值1-12</span><br><span class="line">* 第六位，星期，取值1-7，1表示星期天，2表示星期一</span><br><span class="line">* 第七位，年份，可以留空，取值1970-2099</span><br></pre></td></tr></table></figure>

<p>cron中，还有一些特殊的符号，含义如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(*)星号：可以理解为每的意思，每秒，每分，每时，每日，每月，每星期，每年...</span><br><span class="line">(?)问号：问号只能出现在日和星期这两个位置，表示这个位置的值不确定，每天3点执行，所以第六位星期的位置，</span><br><span class="line">我们是不需要关注的，就是不确定的值。同时：日和星期是两个相互排斥的元素，通过问号来表明不指定值。</span><br><span class="line">比如，1月10日，比如是星期1，如果在星期的位置是另指定星期二，就前后冲突矛盾了。</span><br><span class="line">(-)减号：表达一个范围，如在小时字段中使用“10-12”，则表示从10到12点，即10,11,12</span><br><span class="line">(,)逗号：表达一个列表值，如在星期字段中使用“1,2,4”，则表示星期一，星期二，星期四</span><br><span class="line">(&#x2F;)斜杠：如：x&#x2F;y，x是开始值，y是步长，比如在第一位（秒） 0&#x2F;15就是，从0秒开始，每15秒，最后就是0，15，30，45，60 另：*&#x2F;y，等同于0&#x2F;y</span><br><span class="line">(L)字符：用在日表示一个月中的最后一天，用在周表示该月最后一个星期X</span><br><span class="line">(W)字符：指定离给定日期最近的工作日(周一到周五)</span><br><span class="line">(#)字符：表示该月第几个周X。6#3表示该月第3个周五</span><br></pre></td></tr></table></figure>

<p>下面列举几个例子供大家来验证：</p>
<figure class="highlight basic"><table><tr><td class="code"><pre><span class="line"><span class="symbol">0 </span><span class="number">0</span> <span class="number">3</span> * * ?     每天<span class="number">3</span>点执行</span><br><span class="line"><span class="symbol">0 </span><span class="number">5</span> <span class="number">3</span> * * ?     每天<span class="number">3</span>点<span class="number">5</span>分执行</span><br><span class="line"><span class="symbol">0 </span><span class="number">5</span> <span class="number">3</span> ? * *     每天<span class="number">3</span>点<span class="number">5</span>分执行，与上面作用相同</span><br><span class="line"><span class="symbol">0 </span><span class="number">5</span>/<span class="number">10</span> <span class="number">3</span> * * ?  每天<span class="number">3</span>点的 <span class="number">5</span>分，<span class="number">15</span>分，<span class="number">25</span>分，<span class="number">35</span>分，<span class="number">45</span>分，<span class="number">55</span>分这几个时间点执行</span><br><span class="line"><span class="symbol">0 </span><span class="number">10</span> <span class="number">3</span> ? * <span class="number">1</span>    每周星期天，<span class="number">3</span>点<span class="number">10</span>分 执行，注：<span class="number">1</span>表示星期天    </span><br><span class="line"><span class="symbol">0 </span><span class="number">10</span> <span class="number">3</span> ? * <span class="number">1#</span><span class="number">3</span>  每个月的第三个星期，星期天执行，#号只能出现在星期的位置</span><br></pre></td></tr></table></figure>

<h2 id="GitHub源码"><a href="#GitHub源码" class="headerlink" title="GitHub源码"></a>GitHub源码</h2><p><a href="https://github.com/yidao620c/SpringBootBucket/tree/master/springboot-schedule" target="_blank" rel="noopener">springboot-schedule</a>    —已测试</p>
<h2 id="来源"><a href="#来源" class="headerlink" title="来源"></a>来源</h2><p><a href="https://www.xncoding.com/" target="_blank" rel="noopener">https://www.xncoding.com/</a></p>
]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>springboot</tag>
        <tag>schedule</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot系列 - 多数据源配置</title>
    <url>/2020/06/08/SpringBoot%E7%B3%BB%E5%88%97-%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90%E9%85%8D%E7%BD%AE/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><h1 id="SpringBoot系列-多数据源配置"><a href="#SpringBoot系列-多数据源配置" class="headerlink" title="SpringBoot系列 - 多数据源配置"></a>SpringBoot系列 - 多数据源配置</h1><p>项目中经常会出现需要同时连接两个数据源的情况，这里还是演示基于MyBatis来配置两个数据源，并演示如何切换不同的数据源。</p>
<p>网上的一些例子都写的有点冗余，这里我通过自定义注解+AOP的方式，来简化这种数据源的切换操作。</p>
<h2 id="maven依赖"><a href="#maven依赖" class="headerlink" title="maven依赖"></a>maven依赖</h2><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.reporting.outputEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">druid.version</span>&gt;</span>1.1.2<span class="tag">&lt;/<span class="name">druid.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mysql-connector.version</span>&gt;</span>8.0.7-dmr<span class="tag">&lt;/<span class="name">mysql-connector.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mybatis-plus.version</span>&gt;</span>2.1.8<span class="tag">&lt;/<span class="name">mybatis-plus.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mybatisplus-spring-boot-starter.version</span>&gt;</span>1.0.5<span class="tag">&lt;/<span class="name">mybatisplus-spring-boot-starter.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;mysql-connector.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;druid.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- MyBatis plus增强和springboot的集成--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;mybatis-plus.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatisplus-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;mybatisplus-spring-boot-starter.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.hamcrest<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hamcrest-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="初始化数据库"><a href="#初始化数据库" class="headerlink" title="初始化数据库"></a>初始化数据库</h2><p>这里我们需要创建两个数据库，初始化脚本如下：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -------------------------------------以下是pos业务库开始-------------------------------------------</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> pos <span class="keyword">default</span> <span class="keyword">charset</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci;</span><br><span class="line"><span class="keyword">SET</span> FOREIGN_KEY_CHECKS=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">USE</span> pos;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 后台管理用户表</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`t_user`</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`t_user`</span> (</span><br><span class="line">  <span class="string">`id`</span>                        <span class="built_in">INT</span>(<span class="number">11</span>) PRIMARY <span class="keyword">KEY</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'主键ID'</span>,</span><br><span class="line">  <span class="string">`username`</span>                  <span class="built_in">VARCHAR</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'账号'</span>,</span><br><span class="line">  <span class="string">`name`</span>                      <span class="built_in">VARCHAR</span>(<span class="number">16</span>) <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'名字'</span>,</span><br><span class="line">  <span class="string">`password`</span>                  <span class="built_in">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'密码'</span>,</span><br><span class="line">  <span class="string">`salt`</span>                      <span class="built_in">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'md5密码盐'</span>,</span><br><span class="line">  <span class="string">`phone`</span>                     <span class="built_in">VARCHAR</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'联系电话'</span>,</span><br><span class="line">  <span class="string">`tips`</span>                      <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">COMMENT</span> <span class="string">'备注'</span>,</span><br><span class="line">  <span class="string">`state`</span>                     <span class="built_in">TINYINT</span>(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="number">1</span> <span class="keyword">COMMENT</span> <span class="string">'状态 1:正常 2:禁用'</span>,</span><br><span class="line">  <span class="string">`created_time`</span>              DATETIME <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,</span><br><span class="line">  <span class="string">`updated_time`</span>              DATETIME <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="keyword">CURRENT_TIMESTAMP</span> <span class="keyword">COMMENT</span> <span class="string">'更新时间'</span></span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">1</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 <span class="keyword">COMMENT</span>=<span class="string">'后台管理用户表'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下面是pos数据库中的插入数据</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`t_user`</span> <span class="keyword">VALUES</span> (<span class="number">1</span>,<span class="string">'admin'</span>,<span class="string">'系统管理员'</span>,<span class="string">'123456'</span>,<span class="string">'www'</span>, <span class="string">'17890908889'</span>, <span class="string">'系统管理员'</span>, <span class="number">1</span>, <span class="string">'2017-12-12 09:46:12'</span>, <span class="string">'2017-12-12 09:46:12'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`t_user`</span> <span class="keyword">VALUES</span> (<span class="number">2</span>,<span class="string">'aix'</span>,<span class="string">'张三'</span>,<span class="string">'123456'</span>,<span class="string">'eee'</span>, <span class="string">'17859569358'</span>, <span class="string">''</span>, <span class="number">1</span>, <span class="string">'2017-12-12 09:46:12'</span>, <span class="string">'2017-12-12 09:46:12'</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># -------------------------------------以下biz业务库开始-------------------------------------------</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> pos <span class="keyword">default</span> <span class="keyword">charset</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci;</span><br><span class="line"><span class="keyword">SET</span> FOREIGN_KEY_CHECKS=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">USE</span> biz;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 后台管理用户表</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`t_user`</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`t_user`</span> (</span><br><span class="line">  <span class="string">`id`</span>                        <span class="built_in">INT</span>(<span class="number">11</span>) PRIMARY <span class="keyword">KEY</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'主键ID'</span>,</span><br><span class="line">  <span class="string">`username`</span>                  <span class="built_in">VARCHAR</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'账号'</span>,</span><br><span class="line">  <span class="string">`name`</span>                      <span class="built_in">VARCHAR</span>(<span class="number">16</span>) <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'名字'</span>,</span><br><span class="line">  <span class="string">`password`</span>                  <span class="built_in">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'密码'</span>,</span><br><span class="line">  <span class="string">`salt`</span>                      <span class="built_in">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'md5密码盐'</span>,</span><br><span class="line">  <span class="string">`phone`</span>                     <span class="built_in">VARCHAR</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'联系电话'</span>,</span><br><span class="line">  <span class="string">`tips`</span>                      <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">COMMENT</span> <span class="string">'备注'</span>,</span><br><span class="line">  <span class="string">`state`</span>                     <span class="built_in">TINYINT</span>(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="number">1</span> <span class="keyword">COMMENT</span> <span class="string">'状态 1:正常 2:禁用'</span>,</span><br><span class="line">  <span class="string">`created_time`</span>              DATETIME <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,</span><br><span class="line">  <span class="string">`updated_time`</span>              DATETIME <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="keyword">CURRENT_TIMESTAMP</span> <span class="keyword">COMMENT</span> <span class="string">'更新时间'</span></span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">1</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 <span class="keyword">COMMENT</span>=<span class="string">'后台管理用户表'</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 下面是biz数据库中的插入数据</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`t_user`</span> <span class="keyword">VALUES</span> (<span class="number">1</span>,<span class="string">'admin1'</span>,<span class="string">'系统管理员'</span>,<span class="string">'123456'</span>,<span class="string">'www'</span>, <span class="string">'17890908889'</span>, <span class="string">'系统管理员'</span>, <span class="number">1</span>, <span class="string">'2017-12-12 09:46:12'</span>, <span class="string">'2017-12-12 09:46:12'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`t_user`</span> <span class="keyword">VALUES</span> (<span class="number">2</span>,<span class="string">'aix1'</span>,<span class="string">'张三'</span>,<span class="string">'123456'</span>,<span class="string">'eee'</span>, <span class="string">'17859569358'</span>, <span class="string">''</span>, <span class="number">1</span>, <span class="string">'2017-12-12 09:46:12'</span>, <span class="string">'2017-12-12 09:46:12'</span>);</span><br></pre></td></tr></table></figure>

<p>可以看到我创建了两个数据库pos和biz，同时还初始化了用户表，并分别插入两条初始数据。注意用户名数据不相同。</p>
<h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><p>接下来修改application.yml配置文件，如下：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment">###################  自定义配置  ###################</span></span><br><span class="line"><span class="attr">xncoding:</span></span><br><span class="line">  <span class="attr">muti-datasource-open:</span> <span class="literal">true</span> <span class="comment">#是否开启多数据源(true/false)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">###################  mybatis-plus配置  ###################</span></span><br><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">mapper-locations:</span> <span class="string">classpath*:com/xncoding/pos/common/dao/repository/mapping/*.xml</span></span><br><span class="line">  <span class="attr">typeAliasesPackage:</span> <span class="string">&gt;</span></span><br><span class="line">    <span class="string">com.xncoding.pos.common.dao.entity</span></span><br><span class="line">  <span class="attr">global-config:</span></span><br><span class="line">    <span class="attr">id-type:</span> <span class="number">0</span>  <span class="comment"># 0:数据库ID自增   1:用户输入id  2:全局唯一id(IdWorker)  3:全局唯一ID(uuid)</span></span><br><span class="line">    <span class="attr">db-column-underline:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">refresh-mapper:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">configuration:</span></span><br><span class="line">    <span class="attr">map-underscore-to-camel-case:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">cache-enabled:</span> <span class="literal">true</span> <span class="comment">#配置的缓存的全局开关</span></span><br><span class="line">    <span class="attr">lazyLoadingEnabled:</span> <span class="literal">true</span> <span class="comment">#延时加载的开关</span></span><br><span class="line">    <span class="attr">multipleResultSetsEnabled:</span> <span class="literal">true</span> <span class="comment">#开启的话，延时加载一个属性时会加载该对象全部属性，否则按需加载属性</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#默认数据源</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/pos?useSSL=false&amp;autoReconnect=true&amp;tinyInt1isBit=false&amp;useUnicode=true&amp;characterEncoding=utf8</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#多数据源</span></span><br><span class="line"><span class="attr">biz:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/biz?useSSL=false&amp;autoReconnect=true&amp;tinyInt1isBit=false&amp;useUnicode=true&amp;characterEncoding=utf8</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br></pre></td></tr></table></figure>

<p>解释一下：</p>
<p>这里我添加了一个自定义配置项<code>muti-datasource-open</code>，用来控制是否开启多数据源支持。这个配置项后面我会用到。 接下来定义MyBatis的配置，最后定义了两个MySQL数据库的连接信息，一个是pos库，一个是biz库。</p>
<h2 id="动态切换数据源"><a href="#动态切换数据源" class="headerlink" title="动态切换数据源"></a>动态切换数据源</h2><p>这里通过Spring的AOP技术实现数据源的动态切换。</p>
<p>多数据源的常量类：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DSEnum</span> </span>&#123;</span><br><span class="line">    String DATA_SOURCE_CORE = <span class="string">"dataSourceCore"</span>;         <span class="comment">//核心数据源</span></span><br><span class="line">    String DATA_SOURCE_BIZ = <span class="string">"dataSourceBiz"</span>;            <span class="comment">//其他业务的数据源</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>datasource的上下文，用来存储当前线程的数据源类型：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSourceContextHolder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;String&gt; contextHolder = <span class="keyword">new</span> ThreadLocal&lt;String&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dataSourceType 数据库类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span>: 设置数据源类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setDataSourceType</span><span class="params">(String dataSourceType)</span> </span>&#123;</span><br><span class="line">        contextHolder.set(dataSourceType);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span>: 获取数据源类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getDataSourceType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> contextHolder.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span>: 清除数据源类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">clearDataSourceType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        contextHolder.remove();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>定义动态数据源，继承<code>AbstractRoutingDataSource</code> ：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DynamicDataSource</span> <span class="keyword">extends</span> <span class="title">AbstractRoutingDataSource</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Object <span class="title">determineCurrentLookupKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> DataSourceContextHolder.getDataSourceType();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来自定义一个注解，用来在Service方法上面注解使用哪个数据源：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 多数据源标识</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> xiongneng</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Target</span>(&#123;ElementType.METHOD&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> DataSource &#123;</span><br><span class="line">    <span class="function">String <span class="title">name</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后，最核心的AOP类定义：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 多数据源切换的aop</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> xiongneng</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConditionalOnProperty</span>(prefix = <span class="string">"xncoding"</span>, name = <span class="string">"muti-datasource-open"</span>, havingValue = <span class="string">"true"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MultiSourceExAop</span> <span class="keyword">implements</span> <span class="title">Ordered</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Logger log = Logger.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Pointcut</span>(value = <span class="string">"@annotation(com.xncoding.pos.common.annotion.DataSource)"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cut</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Around</span>(<span class="string">"cut()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">around</span><span class="params">(ProceedingJoinPoint point)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line"></span><br><span class="line">        Signature signature = point.getSignature();</span><br><span class="line">        MethodSignature methodSignature = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (!(signature <span class="keyword">instanceof</span> MethodSignature)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"该注解只能用于方法"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        methodSignature = (MethodSignature) signature;</span><br><span class="line"></span><br><span class="line">        Object target = point.getTarget();</span><br><span class="line">        Method currentMethod = target.getClass().getMethod(methodSignature.getName(), methodSignature.getParameterTypes());</span><br><span class="line"></span><br><span class="line">        DataSource datasource = currentMethod.getAnnotation(DataSource<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">if</span> (datasource != <span class="keyword">null</span>) &#123;</span><br><span class="line">            DataSourceContextHolder.setDataSourceType(datasource.name());</span><br><span class="line">            log.debug(<span class="string">"设置数据源为："</span> + datasource.name());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            DataSourceContextHolder.setDataSourceType(DSEnum.DATA_SOURCE_CORE);</span><br><span class="line">            log.debug(<span class="string">"设置数据源为：dataSourceCore"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> point.proceed();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            log.debug(<span class="string">"清空数据源信息！"</span>);</span><br><span class="line">            DataSourceContextHolder.clearDataSourceType();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * aop的顺序要早于spring的事务</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里使用到了注解@ConditionalOnProperty，只有当我的配置文件中muti-datasource-open=true的时候注解才会生效。</p>
<p>另外还有一个要注意的地方，就是order，aop的顺序一定要早于spring的事务，这里我将它设置成1，后面你会看到我将spring事务顺序设置成2。</p>
<h2 id="配置类"><a href="#配置类" class="headerlink" title="配置类"></a>配置类</h2><p>首先有两个属性类：</p>
<ol>
<li><code>DruidProperties</code> 连接池的属性类</li>
<li><code>MutiDataSourceProperties</code> biz数据源的属性类</li>
</ol>
<p>然后定义配置类：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span>(order = <span class="number">2</span>)</span><br><span class="line"><span class="meta">@MapperScan</span>(basePackages = &#123;<span class="string">"com.xncoding.pos.common.dao.repository"</span>&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MybatisPlusConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    DruidProperties druidProperties;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    MutiDataSourceProperties mutiDataSourceProperties;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 核心数据源</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> DruidDataSource <span class="title">coreDataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        DruidDataSource dataSource = <span class="keyword">new</span> DruidDataSource();</span><br><span class="line">        druidProperties.config(dataSource);</span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 另一个数据源</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> DruidDataSource <span class="title">bizDataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        DruidDataSource dataSource = <span class="keyword">new</span> DruidDataSource();</span><br><span class="line">        druidProperties.config(dataSource);</span><br><span class="line">        mutiDataSourceProperties.config(dataSource);</span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 单数据源连接池配置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnProperty</span>(prefix = <span class="string">"xncoding"</span>, name = <span class="string">"muti-datasource-open"</span>, havingValue = <span class="string">"false"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> DruidDataSource <span class="title">singleDatasource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> coreDataSource();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 多数据源连接池配置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnProperty</span>(prefix = <span class="string">"xncoding"</span>, name = <span class="string">"muti-datasource-open"</span>, havingValue = <span class="string">"true"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> DynamicDataSource <span class="title">mutiDataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        DruidDataSource coreDataSource = coreDataSource();</span><br><span class="line">        DruidDataSource bizDataSource = bizDataSource();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            coreDataSource.init();</span><br><span class="line">            bizDataSource.init();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException sql) &#123;</span><br><span class="line">            sql.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        DynamicDataSource dynamicDataSource = <span class="keyword">new</span> DynamicDataSource();</span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        hashMap.put(DSEnum.DATA_SOURCE_CORE, coreDataSource);</span><br><span class="line">        hashMap.put(DSEnum.DATA_SOURCE_BIZ, bizDataSource);</span><br><span class="line">        dynamicDataSource.setTargetDataSources(hashMap);</span><br><span class="line">        dynamicDataSource.setDefaultTargetDataSource(coreDataSource);</span><br><span class="line">        <span class="keyword">return</span> dynamicDataSource;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>代码其实很好理解，我就不再多做解释了。</p>
<p>然后步骤跟普通的集成MyBatis是一样的，我简单的过一遍。</p>
<h2 id="实体类"><a href="#实体类" class="headerlink" title="实体类"></a>实体类</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@TableName</span>(value = <span class="string">"t_user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span>&lt;<span class="title">User</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 主键ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@TableId</span>(value=<span class="string">"id"</span>, type= IdType.AUTO)</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 账号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 名字</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 密码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * md5密码盐</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String salt;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 联系电话</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String phone;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 备注</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String tips;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 状态 1:正常 2:禁用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer state;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Date createdTime;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 更新时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Date updatedTime;</span><br><span class="line">    <span class="comment">// 省略getter/setter方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="定义DAO"><a href="#定义DAO" class="headerlink" title="定义DAO"></a>定义DAO</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserMapper</span> <span class="keyword">extends</span> <span class="title">BaseMapper</span>&lt;<span class="title">User</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="定义Service"><a href="#定义Service" class="headerlink" title="定义Service"></a>定义Service</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过ID查找用户</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">findById</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userMapper.selectById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过ID查找用户</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@DataSource</span>(name = DSEnum.DATA_SOURCE_BIZ)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">findById1</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userMapper.selectById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增用户</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> user</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertUser</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        userMapper.insert(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 修改用户</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> user</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateUser</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        userMapper.updateById(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除用户</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteUser</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line">        userMapper.deleteById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里唯一要说明的就是我在方法<code>findById1()</code>上面增加了注解<code>@DataSource(name = DSEnum.DATA_SOURCE_BIZ)</code>，这样这个方法就会访问biz数据库。</p>
<p>注意，不加注解就会访问默认数据库pos。</p>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>最后编写一个简单的测试，我只测试<code>findById()</code>方法和<code>findById1()</code>方法，看它们是否访问的是不同的数据源。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">SpringBootTest</span></span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">ApplicationTests</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(ApplicationTests<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 测试增删改查</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 核心数据库中的用户id=1</span></span><br><span class="line">        User user = userService.findById(<span class="number">1</span>);</span><br><span class="line">        assertThat(user.getUsername(), is(<span class="string">"admin"</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// biz数据库中的用户id=1</span></span><br><span class="line">        User user1 = userService.findById1(<span class="number">1</span>);</span><br><span class="line">        assertThat(user1.getUsername(), is(<span class="string">"admin1"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行测试，结果显示为green bar，成功！</p>
<h2 id="GitHub源码"><a href="#GitHub源码" class="headerlink" title="GitHub源码"></a>GitHub源码</h2><p><a href="https://github.com/yidao620c/SpringBootBucket/tree/master/springboot-multisource" target="_blank" rel="noopener">springboot-multisource</a>    —已测试</p>
<h2 id="来源"><a href="#来源" class="headerlink" title="来源"></a>来源</h2><p><a href="https://www.xncoding.com/" target="_blank" rel="noopener">https://www.xncoding.com/</a></p>
]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>springboot</tag>
        <tag>datasource</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot系列 - 实现RESTful接口</title>
    <url>/2020/06/08/SpringBoot%E7%B3%BB%E5%88%97-%E5%AE%9E%E7%8E%B0RESTful%E6%8E%A5%E5%8F%A3/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><h1 id="SpringBoot系列-实现RESTful接口"><a href="#SpringBoot系列-实现RESTful接口" class="headerlink" title="SpringBoot系列 - 实现RESTful接口"></a>SpringBoot系列 - 实现RESTful接口</h1><p>REST，即Representational State Transfer的缩写，对这个词组的翻译是<code>表现层状态转化</code>。</p>
<p>RESTful是一种软件设计风格，就是目前最流行的一种互联网软件架构。它结构清晰、符合标准、易于理解、扩展方便，所以正得到越来越多网站的采用。</p>
<p>SpringMVC对RESTful风格的接口有着天然的支持，本篇将讲述如何在SpringBoot中怎样写。</p>
<h2 id="几个注解"><a href="#几个注解" class="headerlink" title="几个注解"></a>几个注解</h2><p>在讲述使用之前，想要理解SpringMVC的几个常用注解：</p>
<ol>
<li>@Controller：修饰class，用来创建处理http请求的对象</li>
<li>@RestController：Spring4之后加入的注解，原来在@Controller中返回json需要@ResponseBody来配合，如果直接用@RestController替代@Controller就不需要再配置@ResponseBody，默认返回json格式。</li>
<li>@RequestMapping：配置url映射</li>
<li>@PostMapping: 这个是@RequestMapping+POST方法的简写</li>
<li>@RequestHeader: 请求Header参数</li>
<li>@PathVariable: URL路径参数，比如/user/{id}中的id参数</li>
<li>@RequestParam: URL请求参数，比如/user?id=1中的id参数</li>
<li>@RequestBody: 请求Body参数</li>
</ol>
<p>下面我们尝试使用Spring MVC来实现一组对User对象操作的RESTful API，配合注释详细说明在Spring MVC中如何映射HTTP请求、如何传参、如何编写单元测试。</p>
<h2 id="API设计"><a href="#API设计" class="headerlink" title="API设计"></a>API设计</h2><p>RESTful API具体设计如下：</p>
<table>
<thead>
<tr>
<th>请求类型</th>
<th>URL</th>
<th>功能说明</th>
</tr>
</thead>
<tbody><tr>
<td>GET</td>
<td>/users</td>
<td>查询用户列表</td>
</tr>
<tr>
<td>POST</td>
<td>/users</td>
<td>创建一个用户</td>
</tr>
<tr>
<td>GET</td>
<td>/users/{id}</td>
<td>根据id查询用户</td>
</tr>
<tr>
<td>PUT</td>
<td>/users/{id}</td>
<td>根据id更新用户</td>
</tr>
<tr>
<td>DELTE</td>
<td>/users/{id}</td>
<td>更加id删除用户</td>
</tr>
</tbody></table>
<p>RESTful架构有一些典型的设计误区，就是URI包含动词。因为”资源”表示一种实体，所以应该是名词，URI不应该有动词，动词应该放在HTTP协议中。 上面设计的API的URI中都是名词。</p>
<h2 id="实体定义"><a href="#实体定义" class="headerlink" title="实体定义"></a>实体定义</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="comment">// 下面省略getter/setter</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Controller实现"><a href="#Controller实现" class="headerlink" title="Controller实现"></a>Controller实现</h2><p>接下来就可以编写RestController了，这里为了演示，会将数据保存到内存Map中，实际使用肯定是保存到数据库中。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 接口类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/users"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger _logger = LoggerFactory.getLogger(UserController<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建线程安全的Map</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;Long, User&gt; users = Collections.synchronizedMap(<span class="keyword">new</span> HashMap&lt;Long, User&gt;());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/"</span>, method = RequestMethod.GET)</span><br><span class="line">    <span class="keyword">public</span> BaseResponse&lt;List&lt;User&gt;&gt; getUserList() &#123;</span><br><span class="line">        <span class="comment">// 处理"/users/"的GET请求，用来获取用户列表</span></span><br><span class="line">        <span class="comment">// 还可以通过@RequestParam从页面中传递参数来进行查询条件或者翻页信息的传递</span></span><br><span class="line">        List&lt;User&gt; r = <span class="keyword">new</span> ArrayList&lt;&gt;(users.values());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BaseResponse&lt;&gt;(<span class="keyword">true</span>, <span class="string">"查询列表成功"</span>, r);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/"</span>, method = RequestMethod.POST)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> BaseResponse&lt;String&gt; <span class="title">postUser</span><span class="params">(@ModelAttribute User user)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 处理"/users/"的POST请求，用来创建User</span></span><br><span class="line">        <span class="comment">// 除了@ModelAttribute绑定参数之外，还可以通过@RequestParam从页面中传递参数</span></span><br><span class="line">        users.put(user.getId(), user);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BaseResponse&lt;&gt;(<span class="keyword">true</span>, <span class="string">"新增成功"</span>, <span class="string">""</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/&#123;id&#125;"</span>, method = RequestMethod.GET)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> BaseResponse&lt;User&gt; <span class="title">getUser</span><span class="params">(@PathVariable Long id)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 处理"/users/&#123;id&#125;"的GET请求，用来获取url中id值的User信息</span></span><br><span class="line">        <span class="comment">// url中的id可通过@PathVariable绑定到函数的参数中</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BaseResponse&lt;&gt;(<span class="keyword">true</span>, <span class="string">"查询成功"</span>, users.get(id));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/&#123;id&#125;"</span>, method = RequestMethod.PUT)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> BaseResponse&lt;String&gt; <span class="title">putUser</span><span class="params">(@PathVariable Long id, @ModelAttribute User user)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 处理"/users/&#123;id&#125;"的PUT请求，用来更新User信息</span></span><br><span class="line">        User u = users.get(id);</span><br><span class="line">        u.setName(user.getName());</span><br><span class="line">        u.setAge(user.getAge());</span><br><span class="line">        users.put(id, u);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BaseResponse&lt;&gt;(<span class="keyword">true</span>, <span class="string">"更新成功"</span>, <span class="string">""</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/&#123;id&#125;"</span>, method = RequestMethod.DELETE)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> BaseResponse&lt;String&gt; <span class="title">deleteUser</span><span class="params">(@PathVariable Long id)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 处理"/users/&#123;id&#125;"的DELETE请求，用来删除User</span></span><br><span class="line">        users.remove(id);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BaseResponse&lt;&gt;(<span class="keyword">true</span>, <span class="string">"删除成功"</span>, <span class="string">""</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>接下来就是写一个测试来测一下，SpringMVC的内置测试支持非常方便。</p>
<p>先写一个json和对象之间相互转化的工具类，使用Jackson库：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JacksonUtil</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ObjectMapper mapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">bean2Json</span><span class="params">(Object obj)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> mapper.writeValueAsString(obj);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JsonProcessingException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">json2Bean</span><span class="params">(String jsonStr, TypeReference&lt;T&gt; typeReference)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> mapper.readValue(jsonStr, typeReference);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后再编写单元测试：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@AutoConfigureMockMvc</span></span><br><span class="line"><span class="meta">@RunWith</span>(SpringRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">SpringBootTest</span>(<span class="title">classes</span> </span>= Application<span class="class">.<span class="keyword">class</span>, <span class="title">webEnvironment</span> </span>= SpringBootTest.WebEnvironment.RANDOM_PORT)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationTests</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MockMvc mvc;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testUserController</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 测试UserController</span></span><br><span class="line">        RequestBuilder request;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1、get查一下user列表，应该为空</span></span><br><span class="line">        request = get(<span class="string">"/users/"</span>);</span><br><span class="line">        MvcResult result = mvc.perform(request)</span><br><span class="line">                .andExpect(status().isOk())</span><br><span class="line">                .andReturn();</span><br><span class="line">        String content = result.getResponse().getContentAsString();</span><br><span class="line">        BaseResponse&lt;List&lt;User&gt;&gt; response = JacksonUtil.json2Bean(content, <span class="keyword">new</span> TypeReference&lt;BaseResponse&lt;List&lt;User&gt;&gt;&gt;() &#123;&#125;);</span><br><span class="line">        assertThat(response.isSuccess(), is(<span class="keyword">true</span>));</span><br><span class="line">        assertThat(response.getMsg(), is(<span class="string">"查询列表成功"</span>));</span><br><span class="line">        assertThat(((List) response.getData()).size(), is(<span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2、post提交一个user</span></span><br><span class="line">        request = post(<span class="string">"/users/"</span>)</span><br><span class="line">                .param(<span class="string">"id"</span>, <span class="string">"1"</span>)</span><br><span class="line">                .param(<span class="string">"name"</span>, <span class="string">"测试大师"</span>)</span><br><span class="line">                .param(<span class="string">"age"</span>, <span class="string">"20"</span>);</span><br><span class="line">        result = mvc.perform(request)</span><br><span class="line">                .andExpect(status().isOk())</span><br><span class="line">                .andReturn();</span><br><span class="line">        content = result.getResponse().getContentAsString();</span><br><span class="line">        BaseResponse&lt;String&gt; response1 = JacksonUtil.json2Bean(content, <span class="keyword">new</span> TypeReference&lt;BaseResponse&lt;String&gt;&gt;() &#123;&#125;);</span><br><span class="line">        assertThat(response1.isSuccess(), is(<span class="keyword">true</span>));</span><br><span class="line">        assertThat(response1.getMsg(), is(<span class="string">"新增成功"</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3、get获取user列表，应该有刚才插入的数据</span></span><br><span class="line">        request = get(<span class="string">"/users/"</span>);</span><br><span class="line">        result = mvc.perform(request)</span><br><span class="line">                .andExpect(status().isOk())</span><br><span class="line">                .andReturn();</span><br><span class="line">        content = result.getResponse().getContentAsString();</span><br><span class="line">        BaseResponse&lt;List&lt;User&gt;&gt; response2 = JacksonUtil.json2Bean(content, <span class="keyword">new</span> TypeReference&lt;BaseResponse&lt;List&lt;User&gt;&gt;&gt;() &#123;&#125;);</span><br><span class="line">        assertThat(response2.isSuccess(), is(<span class="keyword">true</span>));</span><br><span class="line">        assertThat(response2.getMsg(), is(<span class="string">"查询列表成功"</span>));</span><br><span class="line">        assertThat((response2.getData()).size(), is(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4、put修改id为1的user</span></span><br><span class="line">        request = put(<span class="string">"/users/1"</span>)</span><br><span class="line">                .param(<span class="string">"name"</span>, <span class="string">"测试终极大师"</span>)</span><br><span class="line">                .param(<span class="string">"age"</span>, <span class="string">"30"</span>);</span><br><span class="line">        result = mvc.perform(request)</span><br><span class="line">                .andExpect(status().isOk())</span><br><span class="line">                .andReturn();</span><br><span class="line">        content = result.getResponse().getContentAsString();</span><br><span class="line">        BaseResponse&lt;String&gt; response3 = JacksonUtil.json2Bean(content, <span class="keyword">new</span> TypeReference&lt;BaseResponse&lt;String&gt;&gt;() &#123;&#125;);</span><br><span class="line">        assertThat(response3.isSuccess(), is(<span class="keyword">true</span>));</span><br><span class="line">        assertThat(response3.getMsg(), is(<span class="string">"更新成功"</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5、get一个id为1的user</span></span><br><span class="line">        request = get(<span class="string">"/users/1"</span>);</span><br><span class="line">        result = mvc.perform(request)</span><br><span class="line">                .andExpect(status().isOk())</span><br><span class="line">                .andReturn();</span><br><span class="line">        content = result.getResponse().getContentAsString();</span><br><span class="line">        BaseResponse&lt;User&gt; response4 = JacksonUtil.json2Bean(content, <span class="keyword">new</span> TypeReference&lt;BaseResponse&lt;User&gt;&gt;() &#123;&#125;);</span><br><span class="line">        assertThat(response4.isSuccess(), is(<span class="keyword">true</span>));</span><br><span class="line">        assertThat(response4.getMsg(), is(<span class="string">"查询成功"</span>));</span><br><span class="line">        User user = response4.getData();</span><br><span class="line">        assertThat(user.getId(), is(<span class="number">1L</span>));</span><br><span class="line">        assertThat(user.getName(), is(<span class="string">"测试终极大师"</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6、del删除id为1的user</span></span><br><span class="line">        request = delete(<span class="string">"/users/1"</span>);</span><br><span class="line">        result = mvc.perform(request)</span><br><span class="line">                .andExpect(status().isOk())</span><br><span class="line">                .andReturn();</span><br><span class="line">        content = result.getResponse().getContentAsString();</span><br><span class="line">        BaseResponse&lt;String&gt; response5 = JacksonUtil.json2Bean(content, <span class="keyword">new</span> TypeReference&lt;BaseResponse&lt;String&gt;&gt;() &#123;&#125;);</span><br><span class="line">        assertThat(response5.isSuccess(), is(<span class="keyword">true</span>));</span><br><span class="line">        assertThat(response5.getMsg(), is(<span class="string">"删除成功"</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7、get查一下user列表，应该为空</span></span><br><span class="line">        request = get(<span class="string">"/users/"</span>);</span><br><span class="line">        result = mvc.perform(request)</span><br><span class="line">                .andExpect(status().isOk())</span><br><span class="line">                .andReturn();</span><br><span class="line">        content = result.getResponse().getContentAsString();</span><br><span class="line">        BaseResponse&lt;List&lt;User&gt;&gt; response6 = JacksonUtil.json2Bean(content, <span class="keyword">new</span> TypeReference&lt;BaseResponse&lt;List&lt;User&gt;&gt;&gt;() &#123;&#125;);</span><br><span class="line">        assertThat(response6.isSuccess(), is(<span class="keyword">true</span>));</span><br><span class="line">        assertThat(response6.getMsg(), is(<span class="string">"查询列表成功"</span>));</span><br><span class="line">        assertThat((response6.getData()).size(), is(<span class="number">0</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行测试，结果为green bar，测试通过。</p>
<h2 id="GitHub源码"><a href="#GitHub源码" class="headerlink" title="GitHub源码"></a>GitHub源码</h2><p><a href="https://github.com/yidao620c/SpringBootBucket/tree/master/springboot-restful" target="_blank" rel="noopener">springboot-restful</a>   —已测试</p>
<h2 id="来源"><a href="#来源" class="headerlink" title="来源"></a>来源</h2><p><a href="https://www.xncoding.com/" target="_blank" rel="noopener">https://www.xncoding.com/</a></p>
]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>springboot</tag>
        <tag>restful</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot系列 - 批处理</title>
    <url>/2020/06/08/SpringBoot%E7%B3%BB%E5%88%97-%E6%89%B9%E5%A4%84%E7%90%86/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><h1 id="SpringBoot系列-批处理"><a href="#SpringBoot系列-批处理" class="headerlink" title="SpringBoot系列 - 批处理"></a>SpringBoot系列 - 批处理</h1><p>Spring Batch是一个轻量级的框架,完全面向Spring的批处理框架,用于企业级大量的数据读写处理系统。以POJO和Spring 框架为基础， 包括日志记录/跟踪，事务管理、 作业处理统计工作重新启动、跳过、资源管理等功能。</p>
<p>Spring Batch官网是这样介绍的自己：一款轻量的、全面的批处理框架，用于开发强大的日常运营的企业级批处理应用程序。</p>
<p>框架主要有以下功能：</p>
<ul>
<li>Transaction management（事务管理）</li>
<li>Chunk based processing（基于块的处理）</li>
<li>Declarative I/O（声明式的输入输出）</li>
<li>Start/Stop/Restart（启动/停止/再启动）</li>
<li>Retry/Skip（重试/跳过）</li>
</ul>
<p>如果你的批处理程序需要使用上面的功能，那就大胆地使用它吧。</p>
<h2 id="框架介绍"><a href="#框架介绍" class="headerlink" title="框架介绍"></a>框架介绍</h2><p>先用一个图让你有一个大概印象，这个东西是什么：</p>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="assets/1591544341-a776ee194e582070b8185676b40dc425.png" alt=""></p>
<p>框架一共有5个主要角色：</p>
<ol>
<li>JobRepository是用户注册Job的容器，就是存储数据的地方，可以看做是一个数据库的接口，在任务执行的时候需要通过它来记录任务状态等等信息。</li>
<li>JobLauncher是任务启动器，通过它来启动任务，可以看做是程序的入口。</li>
<li>Job代表着一个具体的任务。</li>
<li>Step代表着一个具体的步骤，一个Job可以包含多个Step（想象把大象放进冰箱这个任务需要多少个步骤你就明白了）。</li>
<li>Item就是输出-&gt;处理-&gt;输出，一个完整Step流程。</li>
</ol>
<p>下面简要的介绍一下这5个角色</p>
<h3 id="JobRepository"><a href="#JobRepository" class="headerlink" title="JobRepository"></a>JobRepository</h3><p>JobRepository用于存储任务执行的状态信息，比如什么时间点执行了什么任务、任务执行结果如何等等。 框架提供了2种实现，一种是通过Map形式保存在内存中，当Java程序重启后任务信息也就丢失了， 并且在分布式下无法获取其他节点的任务执行情况；另一种是保存在数据库中，并且将数据保存在下面6张表里：</p>
<ul>
<li>BATCH_JOB_INSTANCE</li>
<li>BATCH_JOB_EXECUTION_PARAMS</li>
<li>BATCH_JOB_EXECUTION</li>
<li>BATCH_STEP_EXECUTION</li>
<li>BATCH_JOB_EXECUTION_CONTEXT</li>
<li>BATCH_STEP_EXECUTION_CONTEXT</li>
</ul>
<p>Spring Batch框架的JobRepository支持主流的数据库：DB2、Derby、H2、HSQLDB、MySQL、Oracle、PostgreSQL、SQLServer、Sybase。</p>
<h3 id="JobLauncher"><a href="#JobLauncher" class="headerlink" title="JobLauncher"></a>JobLauncher</h3><p>JobLauncher是任务启动器，该接口只有一个run方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">JobLauncher</span> </span>&#123;</span><br><span class="line">    <span class="function">JobExecution <span class="title">run</span><span class="params">(Job job, JobParameters jobParameters)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>除了传入Job对象之外，还需要传入JobParameters对象，后续讲到Job再解释为什么要多传一个JobParameters。 通过JobLauncher可以在Java程序中调用批处理任务，也可以通过命令行或者其他框架 （如定时调度框架Quartz、Web后台框架Spring MVC）中调用批处理任务。 Spring Batch框架提供了一个JobLauncher的实现类SimpleJobLauncher。</p>
<h3 id="Job"><a href="#Job" class="headerlink" title="Job"></a>Job</h3><p>Job代表着一个任务，一个Job与一个或者多个JobInstance相关联，而一个JobInstance又与一个或者多个JobExecution相关联：</p>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="assets/1591544341-f1831bc0d4a68903ca1e0ae13a161461.png" alt=""></p>
<p>考虑到任务可能不是只执行一次就再也不执行了，更多的情况可能是定时任务，如每天执行一次，每个星期执行一次等等， 那么为了区分每次执行的任务，框架使用了JobInstance。如上图所示，Job是一个EndOfDay（每天最后时刻执行的任务）， 那么其中一个JobInstance就代表着2007年5月5日那天执行的任务实例。 框架通过在执行JobLauncher.run(Job, JobParameters)方法时传入的JobParameters来区分是哪一天的任务。</p>
<p>由于2007年5月5日那天执行的任务可能不会一次就执行完成，比如中途被停止，或者出现异常导致中断， 需要多执行几次才能完成，所以框架使用了JobExecution来表示每次执行的任务。</p>
<h3 id="Step"><a href="#Step" class="headerlink" title="Step"></a>Step</h3><p>一个Job任务可以分为几个Step步骤，与JobExection相同，每次执行Step的时候使用StepExecution来表示执行的步骤。 每一个Step还包含着一个ItemReader、ItemProcessor、ItemWriter，下面分别介绍这三者。</p>
<p><strong>ItemReader</strong></p>
<p>ItemReader代表着读操作，其接口如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ItemReader</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function">T <span class="title">read</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>框架已经提供了多种ItemReader接口的实现类，包括对文本文件、CSV文件、XML文件、数据库、JMS消息等读的处理，当然我们也可以自己实现该接口。</p>
<p><strong>ItemProcessor</strong></p>
<p>ItemReader代表着处理操作，其接口如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ItemProcessor</span>&lt;<span class="title">I</span>, <span class="title">O</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function">O <span class="title">process</span><span class="params">(I item)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>process方法的形参传入I类型的对象，通过处理后返回O型的对象。开发者可以实现自己的业务代码来对数据进行处理。</p>
<p><strong>ItemWriter</strong></p>
<p>ItemReader代表着写操作，其接口如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ItemWriter</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">write</span><span class="params">(List&lt;? extends T&gt; items)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>框架已经提供了多种ItemWriter接口的实现类，包括对文本文件、CSV文件、XML文件、数据库、JMS消息等写的处理，当然我们也可以自己实现该接口。</p>
<h3 id="Job监听器"><a href="#Job监听器" class="headerlink" title="Job监听器"></a>Job监听器</h3><p>还可以自定义任务监听器，在任务启动和完成之后进行相应的通知和响应。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 监听器实现JobExecutionListener接口，并重写其beforeJob，afterJob方法即可</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyJobListener</span> <span class="keyword">implements</span> <span class="title">JobExecutionListener</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeJob</span><span class="params">(JobExecution jobExecution)</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterJob</span><span class="params">(JobExecution jobExecution)</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="数据校验"><a href="#数据校验" class="headerlink" title="数据校验"></a>数据校验</h3><p>我们可以JSR-303(主要实现由hibernate-validator)的注解，来校验ItemReader读取到的数据是否满足要求。</p>
<p>首先让我们的ItemProcessor实现ValidatingItemProcessor接口：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyItemProcessor</span> <span class="keyword">extends</span> <span class="title">ValidatingItemProcessor</span>&lt;<span class="title">User</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">process</span><span class="params">(User item)</span> <span class="keyword">throws</span> ValidationException </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.process(item);</span><br><span class="line">        <span class="keyword">return</span> item;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后定义自己的校验器，实现的Validator接口来自于Spring，我们将使用JSR-303的Validator来校验：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBeanValidator</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Validator</span>&lt;<span class="title">T</span>&gt;,<span class="title">InitializingBean</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Validator validator;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">validate</span><span class="params">(T value)</span><span class="keyword">throws</span> ValidationException</span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在定义我们的MyItemProcessor时必须将MyBeanValidator设置进去，代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ItemProcessor&lt;User,User&gt; <span class="title">processor</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">//新建ItemProcessor接口的实现类返回</span></span><br><span class="line">    MyItemProcessor processor = <span class="keyword">new</span> MyItemProcessor();</span><br><span class="line">    processor.setValidator(myBeanValidator());</span><br><span class="line">    <span class="keyword">return</span> processor;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Validator&lt;User&gt; <span class="title">myBeanValidator</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> MyBeanValidator&lt;User&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="SpringBoot集成实例"><a href="#SpringBoot集成实例" class="headerlink" title="SpringBoot集成实例"></a>SpringBoot集成实例</h2><p>Spring Boot对Spring Batch支持的源码位于<code>org.springframework.boot.autoconfigure.batch</code>下。</p>
<p>Spring Boot为我们自动初始化了Spring Batch存储批处理记录的数据库，且当我们程序启动时， 会自动执行我们定义的Job的Bean，不过我们可以通过配置定时器或手动触发方式启动。</p>
<p>Spring Boot提供如下属性来定制Spring Batch：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#启动时要执行的job，默认执行全部job</span><br><span class="line">spring.batch.job.name&#x3D;job1,job2</span><br><span class="line">#是否自动执行定义的job，默认是</span><br><span class="line">spring.batch.job.enabled&#x3D;true</span><br><span class="line">#是否初始化Spring Batch的数据库，默认为是</span><br><span class="line">spring.batch.initializer.enabled&#x3D;true</span><br><span class="line">spring.batch.schema&#x3D;</span><br><span class="line">#设置Spring Batch的数据库表的前缀</span><br><span class="line">spring.batch.table-prefix&#x3D;</span><br></pre></td></tr></table></figure>

<p>下面通过一个真实的例子，需要将客户导过来的csv文件导入到我们的业务Oracle数据库中，来说明怎样在SpringBoot中使用批处理框架。</p>
<h3 id="添加maven依赖"><a href="#添加maven依赖" class="headerlink" title="添加maven依赖"></a>添加maven依赖</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-batch<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.hsqldb<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hsqldb<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--添加hibernate-validator依赖，作为数据校验使用--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.hibernate.validator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hibernate-validator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.0.7.Final<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.validation<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>validation-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.1.Final<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.el<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.el-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.1-b04<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.glassfish.web<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.el<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--添加hibernate-validator依赖 END--&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- Oracle驱动包 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.oracle<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ojdbc6<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>11.2.0.4.0-atlassian-hosted<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="配置application-yml"><a href="#配置application-yml" class="headerlink" title="配置application.yml"></a>配置application.yml</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment">###################  spring配置  ###################</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">batch:</span></span><br><span class="line">    <span class="attr">job:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">oracle.jdbc.driver.OracleDriver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:oracle:thin:@xxx.xxx.xxx.xxx:1521:orcl11g</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">adm_real</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">adm_real</span></span><br></pre></td></tr></table></figure>

<p>真实csv数据，位于<code>src/main/resources/NT_BSC_BUDGETVTOLL.csv</code>中</p>
<p>表定义如下：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">"ADM_REAL"</span>.<span class="string">"NT_BSC_BUDGETVTOLL"</span> (</span><br><span class="line">    <span class="string">"F_ID"</span> <span class="built_in">VARCHAR2</span>(<span class="number">100</span> <span class="keyword">BYTE</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> ,</span><br><span class="line">    <span class="string">"F_YEAR"</span> <span class="built_in">VARCHAR2</span>(<span class="number">4</span> <span class="keyword">BYTE</span>) <span class="literal">NULL</span> ,</span><br><span class="line">    <span class="string">"F_TOLLID"</span> <span class="built_in">VARCHAR2</span>(<span class="number">50</span> <span class="keyword">BYTE</span>) <span class="literal">NULL</span> ,</span><br><span class="line">    <span class="string">"F_BUDGETID"</span> <span class="built_in">VARCHAR2</span>(<span class="number">50</span> <span class="keyword">BYTE</span>) <span class="literal">NULL</span> ,</span><br><span class="line">    <span class="string">"F_CBUDGETID"</span> <span class="built_in">VARCHAR2</span>(<span class="number">50</span> <span class="keyword">BYTE</span>) <span class="literal">NULL</span> ,</span><br><span class="line">    <span class="string">"F_VERSION"</span> <span class="built_in">VARCHAR2</span>(<span class="number">1</span> <span class="keyword">BYTE</span>) <span class="keyword">DEFAULT</span> <span class="string">'1'</span>  <span class="literal">NULL</span> ,</span><br><span class="line">    <span class="string">"F_AUDITMSG"</span> <span class="built_in">VARCHAR2</span>(<span class="number">100</span> <span class="keyword">BYTE</span>) <span class="literal">NULL</span> ,</span><br><span class="line">    <span class="string">"F_TRIALSTATUS"</span> <span class="built_in">VARCHAR2</span>(<span class="number">1</span> <span class="keyword">BYTE</span>) <span class="keyword">DEFAULT</span> <span class="string">'0'</span>  <span class="literal">NULL</span> ,</span><br><span class="line">    <span class="string">"F_FIRAUDITER"</span> <span class="built_in">VARCHAR2</span>(<span class="number">50</span> <span class="keyword">BYTE</span>) <span class="literal">NULL</span> ,</span><br><span class="line">    <span class="string">"F_FIRAUDITTIME"</span> <span class="built_in">VARCHAR2</span>(<span class="number">20</span> <span class="keyword">BYTE</span>) <span class="literal">NULL</span> ,</span><br><span class="line">    <span class="string">"F_FINAUDITER"</span> <span class="built_in">VARCHAR2</span>(<span class="number">50</span> <span class="keyword">BYTE</span>) <span class="literal">NULL</span> ,</span><br><span class="line">    <span class="string">"F_FINAUDITTIME"</span> <span class="built_in">VARCHAR2</span>(<span class="number">64</span> <span class="keyword">BYTE</span>) <span class="literal">NULL</span> ,</span><br><span class="line">    <span class="string">"F_EDITTIME"</span> <span class="built_in">VARCHAR2</span>(<span class="number">64</span> <span class="keyword">BYTE</span>) <span class="literal">NULL</span> ,</span><br><span class="line">    <span class="string">"F_STARTDATE"</span> <span class="built_in">VARCHAR2</span>(<span class="number">8</span> <span class="keyword">BYTE</span>) <span class="literal">NULL</span> ,</span><br><span class="line">    <span class="string">"F_ENDDATE"</span> <span class="built_in">VARCHAR2</span>(<span class="number">8</span> <span class="keyword">BYTE</span>) <span class="literal">NULL</span> ,</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h3 id="领域模型类"><a href="#领域模型类" class="headerlink" title="领域模型类"></a>领域模型类</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BudgetVtoll</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="keyword">private</span> String year;</span><br><span class="line">    <span class="keyword">private</span> String tollid;</span><br><span class="line">    <span class="keyword">private</span> String budgetid;</span><br><span class="line">    <span class="keyword">private</span> String cbudgetid;</span><br><span class="line">    <span class="keyword">private</span> String version;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 使用JSR-303注解来校验数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Size</span>(max = <span class="number">100</span>)</span><br><span class="line">    <span class="keyword">private</span> String auditmsg;</span><br><span class="line">    <span class="keyword">private</span> String trialstatus;</span><br><span class="line">    <span class="keyword">private</span> String firauditer;</span><br><span class="line">    <span class="keyword">private</span> String firaudittime;</span><br><span class="line">    <span class="keyword">private</span> String finauditer;</span><br><span class="line">    <span class="keyword">private</span> String finaudittime;</span><br><span class="line">    <span class="keyword">private</span> String edittime;</span><br><span class="line">    <span class="keyword">private</span> String startdate;</span><br><span class="line">    <span class="keyword">private</span> String enddate;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 下面省略get/set方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="数据处理及校验"><a href="#数据处理及校验" class="headerlink" title="数据处理及校验"></a>数据处理及校验</h3><p>定义处理器</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CsvItemProcessor</span> <span class="keyword">extends</span> <span class="title">ValidatingItemProcessor</span>&lt;<span class="title">BudgetVtoll</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> BudgetVtoll <span class="title">process</span><span class="params">(BudgetVtoll item)</span> <span class="keyword">throws</span> ValidationException </span>&#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 需要执行super.process(item)才会调用自定义校验器</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">super</span>.process(item);</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 对数据进行简单的处理和转换 todo</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">return</span> item;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>校验器定义：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CsvBeanValidator</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Validator</span>&lt;<span class="title">T</span>&gt;, <span class="title">InitializingBean</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> javax.validation.Validator validator;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">validate</span><span class="params">(T value)</span> <span class="keyword">throws</span> ValidationException </span>&#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 使用Validator的validate方法校验数据</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Set&lt;ConstraintViolation&lt;T&gt;&gt; constraintViolations = validator.validate(value);</span><br><span class="line">        <span class="keyword">if</span> (constraintViolations.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            StringBuilder message = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">            <span class="keyword">for</span> (ConstraintViolation&lt;T&gt; constraintViolation : constraintViolations) &#123;</span><br><span class="line">                message.append(constraintViolation.getMessage()).append(<span class="string">"\n"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ValidationException(message.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 使用JSR-303的Validator来校验我们的数据，在此进行JSR-303的Validator的初始化</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ValidatorFactory validatorFactory = Validation.buildDefaultValidatorFactory();</span><br><span class="line">        validator = validatorFactory.usingContext().getValidator();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="任务监听器"><a href="#任务监听器" class="headerlink" title="任务监听器"></a>任务监听器</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CsvJobListener</span> <span class="keyword">implements</span> <span class="title">JobExecutionListener</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> startTime;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> endTime;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeJob</span><span class="params">(JobExecution jobExecution)</span> </span>&#123;</span><br><span class="line">        startTime = System.currentTimeMillis();</span><br><span class="line">        logger.info(<span class="string">"任务处理开始"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterJob</span><span class="params">(JobExecution jobExecution)</span> </span>&#123;</span><br><span class="line">        endTime = System.currentTimeMillis();</span><br><span class="line">        logger.info(<span class="string">"任务处理结束，总耗时="</span> + (endTime - startTime) + <span class="string">"ms"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="配置类"><a href="#配置类" class="headerlink" title="配置类"></a>配置类</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableBatchProcessing</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CsvBatchConfig</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ItemReader定义,用来读取数据</span></span><br><span class="line"><span class="comment">     * 1，使用FlatFileItemReader读取文件</span></span><br><span class="line"><span class="comment">     * 2，使用FlatFileItemReader的setResource方法设置csv文件的路径</span></span><br><span class="line"><span class="comment">     * 3，对此对cvs文件的数据和领域模型类做对应映射</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> FlatFileItemReader</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@StepScope</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FlatFileItemReader&lt;BudgetVtoll&gt; <span class="title">reader</span><span class="params">(@Value(<span class="string">"#&#123;jobParameters['input.file.name']&#125;"</span>)</span> String pathToFile) </span>&#123;</span><br><span class="line">        FlatFileItemReader&lt;BudgetVtoll&gt; reader = <span class="keyword">new</span> FlatFileItemReader&lt;&gt;();</span><br><span class="line">        <span class="comment">// reader.setResource(new ClassPathResource(pathToFile));</span></span><br><span class="line">        reader.setResource(<span class="keyword">new</span> FileSystemResource(pathToFile));</span><br><span class="line">        reader.setLineMapper(<span class="keyword">new</span> DefaultLineMapper&lt;BudgetVtoll&gt;() &#123;</span><br><span class="line">            &#123;</span><br><span class="line">                setLineTokenizer(<span class="keyword">new</span> DelimitedLineTokenizer(<span class="string">","</span>) &#123;</span><br><span class="line">                    &#123;</span><br><span class="line">                        setNames(<span class="keyword">new</span> String[]&#123;</span><br><span class="line">                                <span class="string">"id"</span>,<span class="string">"year"</span>,<span class="string">"tollid"</span>,<span class="string">"budgetid"</span>, <span class="string">"cbudgetid"</span>, <span class="string">"version"</span>, <span class="string">"auditmsg"</span>, <span class="string">"trialstatus"</span>,</span><br><span class="line">                                <span class="string">"firauditer"</span>, <span class="string">"firaudittime"</span>, <span class="string">"finauditer"</span>, <span class="string">"finaudittime"</span>, <span class="string">"edittime"</span>, <span class="string">"startdate"</span>, <span class="string">"enddate"</span></span><br><span class="line">                        &#125;);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">                setFieldSetMapper(<span class="keyword">new</span> BeanWrapperFieldSetMapper&lt;BudgetVtoll&gt;() &#123;</span><br><span class="line">                    &#123;</span><br><span class="line">                        setTargetType(BudgetVtoll<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> reader;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ItemProcessor定义，用来处理数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ItemProcessor&lt;BudgetVtoll, BudgetVtoll&gt; <span class="title">processor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//使用我们自定义的ItemProcessor的实现CsvItemProcessor</span></span><br><span class="line">        CsvItemProcessor processor = <span class="keyword">new</span> CsvItemProcessor();</span><br><span class="line">        <span class="comment">//为processor指定校验器为CsvBeanValidator()</span></span><br><span class="line">        processor.setValidator(csvBeanValidator());</span><br><span class="line">        <span class="keyword">return</span> processor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ItemWriter定义，用来输出数据</span></span><br><span class="line"><span class="comment">     * spring能让容器中已有的Bean以参数的形式注入，Spring Boot已经为我们定义了dataSource</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dataSource</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ItemWriter&lt;BudgetVtoll&gt; <span class="title">writer</span><span class="params">(DruidDataSource dataSource)</span> </span>&#123;</span><br><span class="line">        JdbcBatchItemWriter&lt;BudgetVtoll&gt; writer = <span class="keyword">new</span> JdbcBatchItemWriter&lt;&gt;();</span><br><span class="line">        <span class="comment">//我们使用JDBC批处理的JdbcBatchItemWriter来写数据到数据库</span></span><br><span class="line">        writer.setItemSqlParameterSourceProvider(<span class="keyword">new</span> BeanPropertyItemSqlParameterSourceProvider&lt;&gt;());</span><br><span class="line"></span><br><span class="line">        String sql = <span class="string">"insert into BudgetVtoll "</span> + <span class="string">" (f_id,f_year,f_tollid,f_budgetid,f_cbudgetid,f_version,f_auditmsg,f_trialstatus,f_firauditer,f_firaudittime,f_finauditer,f_finaudittime,f_edittime,f_startdate,f_enddate) "</span></span><br><span class="line">                + <span class="string">" values(:id,:year,:tollid,:budgetid,:cbudgetid,:version,:auditmsg,:trialstatus,:firauditer,:firaudittime,:finauditer,:finaudittime,:edittime,:startdate,:enddate)"</span>;</span><br><span class="line">        <span class="comment">//在此设置要执行批处理的SQL语句</span></span><br><span class="line">        writer.setSql(sql);</span><br><span class="line">        writer.setDataSource(dataSource);</span><br><span class="line">        <span class="keyword">return</span> writer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * JobRepository，用来注册Job的容器</span></span><br><span class="line"><span class="comment">     * jobRepositor的定义需要dataSource和transactionManager，Spring Boot已为我们自动配置了</span></span><br><span class="line"><span class="comment">     * 这两个类，Spring可通过方法注入已有的Bean</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dataSource</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> transactionManager</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JobRepository <span class="title">jobRepository</span><span class="params">(DruidDataSource dataSource, PlatformTransactionManager transactionManager)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        JobRepositoryFactoryBean jobRepositoryFactoryBean = <span class="keyword">new</span> JobRepositoryFactoryBean();</span><br><span class="line">        jobRepositoryFactoryBean.setDataSource(dataSource);</span><br><span class="line">        jobRepositoryFactoryBean.setTransactionManager(transactionManager);</span><br><span class="line">        jobRepositoryFactoryBean.setDatabaseType(String.valueOf(DatabaseType.ORACLE));</span><br><span class="line">        <span class="comment">// 下面事务隔离级别的配置是针对Oracle的</span></span><br><span class="line">        jobRepositoryFactoryBean.setIsolationLevelForCreate(<span class="string">"ISOLATION_READ_COMMITTED"</span>);</span><br><span class="line">        jobRepositoryFactoryBean.afterPropertiesSet();</span><br><span class="line">        <span class="keyword">return</span> jobRepositoryFactoryBean.getObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * JobLauncher定义，用来启动Job的接口</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dataSource</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> transactionManager</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SimpleJobLauncher <span class="title">jobLauncher</span><span class="params">(DruidDataSource dataSource, PlatformTransactionManager transactionManager)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        SimpleJobLauncher jobLauncher = <span class="keyword">new</span> SimpleJobLauncher();</span><br><span class="line">        jobLauncher.setJobRepository(jobRepository(dataSource, transactionManager));</span><br><span class="line">        <span class="keyword">return</span> jobLauncher;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Job定义，我们要实际执行的任务，包含一个或多个Step</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jobBuilderFactory</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> s1</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Job <span class="title">importJob</span><span class="params">(JobBuilderFactory jobBuilderFactory, Step s1)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> jobBuilderFactory.get(<span class="string">"importJob"</span>)</span><br><span class="line">                .incrementer(<span class="keyword">new</span> RunIdIncrementer())</span><br><span class="line">                .flow(s1)<span class="comment">//为Job指定Step</span></span><br><span class="line">                .end()</span><br><span class="line">                .listener(csvJobListener())<span class="comment">//绑定监听器csvJobListener</span></span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * step步骤，包含ItemReader，ItemProcessor和ItemWriter</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> stepBuilderFactory</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> reader</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> writer</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> processor</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Step <span class="title">step1</span><span class="params">(StepBuilderFactory stepBuilderFactory, ItemReader&lt;BudgetVtoll&gt; reader, ItemWriter&lt;BudgetVtoll&gt; writer,</span></span></span><br><span class="line"><span class="function"><span class="params">                      ItemProcessor&lt;BudgetVtoll, BudgetVtoll&gt; processor)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> stepBuilderFactory</span><br><span class="line">                .get(<span class="string">"step1"</span>)</span><br><span class="line">                .&lt;BudgetVtoll, BudgetVtoll&gt;chunk(<span class="number">65000</span>)<span class="comment">//批处理每次提交65000条数据</span></span><br><span class="line">                .reader(reader)<span class="comment">//给step绑定reader</span></span><br><span class="line">                .processor(processor)<span class="comment">//给step绑定processor</span></span><br><span class="line">                .writer(writer)<span class="comment">//给step绑定writer</span></span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CsvJobListener <span class="title">csvJobListener</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CsvJobListener();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Validator&lt;BudgetVtoll&gt; <span class="title">csvBeanValidator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MyBeanValidator&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意，在定义Job的时候，我通过<code>@StepScope</code>注解，可以通过传递参数的方式将csv文件路径传进去。</p>
<h3 id="测试类"><a href="#测试类" class="headerlink" title="测试类"></a>测试类</h3><p>最后再让我们写个测试类看看能不能成功：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">SpringBootTest</span>(<span class="title">classes</span> </span>= Application<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">BatchServiceTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JobLauncher jobLauncher;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Job importJob;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testBatch1</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        JobParameters jobParameters = <span class="keyword">new</span> JobParametersBuilder()</span><br><span class="line">                .addLong(<span class="string">"time"</span>, System.currentTimeMillis())</span><br><span class="line">                .addString(<span class="string">"input.file.name"</span>, <span class="string">"E:\\NT_BSC_BUDGETVTOLL.csv"</span>)</span><br><span class="line">                .toJobParameters();</span><br><span class="line">        jobLauncher.run(importJob, jobParameters);</span><br><span class="line">        logger.info(<span class="string">"testBatch1执行完成"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>把csv文件放入resources/目录下面，然后执行测试。看看输出结果：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">: Job: [FlowJob: [name&#x3D;importJob]] launched with the following parameters: [&#123;time&#x3D;1517654976174, input.file.name&#x3D;E:\NT_BSC_BUDGETVTOLL.csv&#125;]</span><br><span class="line">: 任务处理开始</span><br><span class="line">: Executing step: [step1]</span><br><span class="line">: 任务处理结束，总耗时&#x3D;810ms</span><br><span class="line">: Job: [FlowJob: [name&#x3D;importJob]] completed with the following parameters: [&#123;time&#x3D;1517654976174, input.file.name&#x3D;E:\NT_BSC_BUDGETVTOLL.csv&#125;] and the following status: [COMPLETED]</span><br><span class="line">: testBatch1执行完成</span><br></pre></td></tr></table></figure>

<p>再去查看数据库里面的数据，已经正常写入了。</p>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="assets/1591544341-fad499fdc2f2364e7ef7a66409492f41.png" alt=""></p>
<h2 id="并发执行多个Job"><a href="#并发执行多个Job" class="headerlink" title="并发执行多个Job"></a>并发执行多个Job</h2><p>SpringBatch批处理框架默认使用单线程完成所有任务的执行，官方推荐配置任务执行器来并发执行， 提高批处理的效率。</p>
<p>Spring Core 为我们提供了多种执行器实现（包括多种异步执行器），我们可以根据实际情况灵活选择使用。</p>
<table>
<thead>
<tr>
<th>类名</th>
<th>描述</th>
<th>是否异步</th>
</tr>
</thead>
<tbody><tr>
<td>SyncTaskExecutor</td>
<td>简单同步执行器</td>
<td>否</td>
</tr>
<tr>
<td>SimpleAsyncTaskExecutor</td>
<td>简单异步执行器，提供最基本的异步实现</td>
<td>是</td>
</tr>
<tr>
<td>WorkManagerTaskExecutor</td>
<td>该类作为通过 JCA 规范进行任务执行的实现</td>
<td>是</td>
</tr>
<tr>
<td>ThreadPoolTaskExecutor</td>
<td>线程池任务执行器</td>
<td>是</td>
</tr>
</tbody></table>
<p>配置线程池执行Job：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ThreadPoolTaskExecutor <span class="title">taskExecutor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ThreadPoolTaskExecutor taskExecutor = <span class="keyword">new</span> ThreadPoolTaskExecutor();</span><br><span class="line">    taskExecutor.setCorePoolSize(<span class="number">5</span>);</span><br><span class="line">    taskExecutor.setMaxPoolSize(<span class="number">10</span>);</span><br><span class="line">    taskExecutor.setQueueCapacity(<span class="number">200</span>);</span><br><span class="line">    <span class="keyword">return</span> taskExecutor;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> SimpleJobLauncher <span class="title">jobLauncher</span><span class="params">(ThreadPoolTaskExecutor taskExecutor, DruidDataSource dataSource,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     PlatformTransactionManager transactionManager)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    SimpleJobLauncher jobLauncher = <span class="keyword">new</span> SimpleJobLauncher();</span><br><span class="line">    jobLauncher.setTaskExecutor(taskExecutor);</span><br><span class="line">    jobLauncher.setJobRepository(jobRepository(dataSource, transactionManager));</span><br><span class="line">    <span class="keyword">return</span> jobLauncher;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重点是上面的那句<code>jobLauncher.setTaskExecutor(taskExecutor);</code></p>
<p>这里的并发表示的是执行不同的Job使用线程池，每个Job实例会分配一个线程去执行。这个是最推荐的做法。</p>
<p>如果你还想对单个Job执行逻辑采用多线程，可以再Step配置中加入线程池支持，不过需要保证你所有的Step都是线程安全的：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">return</span> stepBuilderFactory</span><br><span class="line">    .get(<span class="string">"logStep1"</span>)</span><br><span class="line">    <span class="comment">//设置每个Job通过并发方式执行，一般来讲一个Job就让它串行完成的好</span></span><br><span class="line">    .taskExecutor(<span class="keyword">new</span> SimpleAsyncTaskExecutor())</span><br><span class="line">    <span class="comment">//并发任务数为 10,默认为4</span></span><br><span class="line">    .throttleLimit(<span class="number">10</span>)</span><br><span class="line">    .build();</span><br></pre></td></tr></table></figure>

<p>这里我通过一个实际例子展示如何编写多个Job并发执行。</p>
<p>还是跟上面例子一样，将csv文件导入到表中，但是这个时候有两个csv文件，我要导入到两张表。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> Z_TEST_APP (</span><br><span class="line">    appid <span class="built_in">INT</span>,</span><br><span class="line">    zname <span class="built_in">VARCHAR2</span> (<span class="number">20</span>),</span><br><span class="line">    flag <span class="built_in">VARCHAR2</span> (<span class="number">2</span>),</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> app_pk PRIMARY <span class="keyword">KEY</span> (appid)</span><br><span class="line"> );</span><br><span class="line"></span><br><span class="line"> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> Z_TEST_LOG (</span><br><span class="line">    logid <span class="built_in">INT</span>,</span><br><span class="line">    msg <span class="built_in">VARCHAR2</span> (<span class="number">20</span>),</span><br><span class="line">    logtime <span class="built_in">VARCHAR2</span> (<span class="number">8</span>),</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> log_pk PRIMARY <span class="keyword">KEY</span> (logid)</span><br><span class="line"> );</span><br></pre></td></tr></table></figure>

<p>每个类型任务单独创建一个package，然后里面放两个类。以APP为例：</p>
<p>创建一个App类：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> appid;</span><br><span class="line">    <span class="keyword">private</span> String zname;</span><br><span class="line">    <span class="keyword">private</span> String flag;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后创建一个AppConfig类配置任务：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppConfig</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ItemReader定义,用来读取数据</span></span><br><span class="line"><span class="comment">     * 1，使用FlatFileItemReader读取文件</span></span><br><span class="line"><span class="comment">     * 2，使用FlatFileItemReader的setResource方法设置csv文件的路径</span></span><br><span class="line"><span class="comment">     * 3，对此对cvs文件的数据和领域模型类做对应映射</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> FlatFileItemReader</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"appReader"</span>)</span><br><span class="line">    <span class="meta">@StepScope</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FlatFileItemReader&lt;App&gt; <span class="title">reader</span><span class="params">(@Value(<span class="string">"#&#123;jobParameters['input.file.name']&#125;"</span>)</span> String pathToFile) </span>&#123;</span><br><span class="line">        FlatFileItemReader&lt;App&gt; reader = <span class="keyword">new</span> FlatFileItemReader&lt;&gt;();</span><br><span class="line">        reader.setResource(<span class="keyword">new</span> FileSystemResource(pathToFile));</span><br><span class="line">        reader.setLineMapper(<span class="keyword">new</span> DefaultLineMapper&lt;App&gt;() &#123;</span><br><span class="line">            &#123;</span><br><span class="line">                setLineTokenizer(<span class="keyword">new</span> DelimitedLineTokenizer(<span class="string">"|"</span>) &#123;</span><br><span class="line">                    &#123;</span><br><span class="line">                        setNames(<span class="keyword">new</span> String[]&#123;</span><br><span class="line">                                <span class="string">"appid"</span>, <span class="string">"zname"</span>, <span class="string">"flag"</span></span><br><span class="line">                        &#125;);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">                setFieldSetMapper(<span class="keyword">new</span> BeanWrapperFieldSetMapper&lt;App&gt;() &#123;</span><br><span class="line">                    &#123;</span><br><span class="line">                        setTargetType(App<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> reader;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ....后面省略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意，每个Bean配置都加一个name属性，然后自动注入里面需要通过@Qualifier注解来指定当前类中的Bean， 因为如果不指定name，Spring默认只会初始化一个Bean实例。</p>
<p>比如定义Job：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span>(name = <span class="string">"zappJob"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Job <span class="title">zappJob</span><span class="params">(JobBuilderFactory jobBuilderFactory, @Qualifier(<span class="string">"zappStep1"</span>)</span> Step s1) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> jobBuilderFactory.get(<span class="string">"zappJob"</span>)</span><br><span class="line">            .incrementer(<span class="keyword">new</span> RunIdIncrementer())</span><br><span class="line">            .flow(s1)<span class="comment">//为Job指定Step</span></span><br><span class="line">            .end()</span><br><span class="line">            .listener(<span class="keyword">new</span> MyJobListener(<span class="string">"App"</span>))<span class="comment">//绑定监听器csvJobListener</span></span><br><span class="line">            .build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>另外一个LOG任务的配置也是同样。</p>
<p>好了，定义完成之后开始写测试方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testTwoJobs</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    JobParameters jobParameters1 = <span class="keyword">new</span> JobParametersBuilder()</span><br><span class="line">            .addLong(<span class="string">"time"</span>, System.currentTimeMillis())</span><br><span class="line">            .addString(<span class="string">"input.file.name"</span>, p.getCsvApp())</span><br><span class="line">            .toJobParameters();</span><br><span class="line">    jobLauncher.run(zappJob, jobParameters1);</span><br><span class="line"></span><br><span class="line">    JobParameters jobParameters2 = <span class="keyword">new</span> JobParametersBuilder()</span><br><span class="line">            .addLong(<span class="string">"time"</span>, System.currentTimeMillis())</span><br><span class="line">            .addString(<span class="string">"input.file.name"</span>, p.getCsvLog())</span><br><span class="line">            .toJobParameters();</span><br><span class="line">    jobLauncher.run(zlogJob, jobParameters2);</span><br><span class="line"></span><br><span class="line">    logger.info(<span class="string">"main线程完成"</span>);</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">        Thread.sleep(<span class="number">2000000L</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个是运行日志:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[ taskExecutor-1] o.s.b.c.l.support.SimpleJobLauncher      : Job: [FlowJob: [name&#x3D;zappJob]] launched with t</span><br><span class="line">[ taskExecutor-1] com.xncoding.trans.modules.MyJobListener  : 任务-App处理开始</span><br><span class="line">[           main] com.xncoding.service.BatchServiceTest     : main线程完成</span><br><span class="line">[ taskExecutor-2] o.s.b.c.l.support.SimpleJobLauncher      : Job: [FlowJob: [name&#x3D;zlogJob]] launched with t</span><br><span class="line">[ taskExecutor-2] com.xncoding.trans.modules.MyJobListener  : 任务-Log处理开始</span><br><span class="line">[ taskExecutor-1] o.s.batch.core.job.SimpleStepHandler     : Executing step: [zappStep1]</span><br><span class="line">[ taskExecutor-2] o.s.batch.core.job.SimpleStepHandler     : Executing step: [logStep1]</span><br><span class="line">[ taskExecutor-2] com.xncoding.trans.modules.MyJobListener  : 任务-Log处理结束，总耗时&#x3D;495ms</span><br><span class="line">[ taskExecutor-1] com.xncoding.trans.modules.MyJobListener  : 任务-App处理结束，总耗时&#x3D;585ms</span><br><span class="line">[ taskExecutor-2] o.s.b.c.l.support.SimpleJobLauncher      : Job: [FlowJob: [name&#x3D;zlogJob]] completed with </span><br><span class="line">[ taskExecutor-1] o.s.b.c.l.support.SimpleJobLauncher      : Job: [FlowJob: [name&#x3D;zappJob]] completed with</span><br></pre></td></tr></table></figure>

<h2 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h2><p>默认情况下，Spring Batch遇到异常的时候会终止处理，比如遇到csv文件中解析错误就会终止异常。如果我想忽略掉这些异常继续处理， 可以配置在Reader中忽略异常。</p>
<p>这个在Step的定义中配置：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">return</span> stepBuilderFactory</span><br><span class="line">    .get(<span class="string">"logStep1"</span>)</span><br><span class="line">    .&lt;Log, Log&gt;chunk(<span class="number">5000</span>)<span class="comment">//批处理每次提交5000条数据</span></span><br><span class="line">    .reader(reader)<span class="comment">//给step绑定reader</span></span><br><span class="line">    .processor(processor)<span class="comment">//给step绑定processor</span></span><br><span class="line">    .writer(writer)<span class="comment">//给step绑定writer</span></span><br><span class="line">    .faultTolerant()</span><br><span class="line">    .retry(Exception<span class="class">.<span class="keyword">class</span>)   // 重试</span></span><br><span class="line"><span class="class">    .<span class="title">noRetry</span>(<span class="title">ParseException</span>.<span class="title">class</span>)</span></span><br><span class="line"><span class="class">    .<span class="title">retryLimit</span>(1)           //每条记录重试一次</span></span><br><span class="line"><span class="class">    .<span class="title">skip</span>(<span class="title">Exception</span>.<span class="title">class</span>)</span></span><br><span class="line"><span class="class">    .<span class="title">skipLimit</span>(200)         //一共允许跳过200次异常</span></span><br><span class="line"><span class="class">//                .<span class="title">taskExecutor</span>(<span class="title">new</span> <span class="title">SimpleAsyncTaskExecutor</span>()) //设置每个<span class="title">Job</span>通过并发方式执行，一般来讲一个<span class="title">Job</span>就让它串行完成的好</span></span><br><span class="line"><span class="class">//                .<span class="title">throttleLimit</span>(10)        //并发任务数为 10,默认为4</span></span><br><span class="line"><span class="class">    .<span class="title">build</span>()</span>;</span><br></pre></td></tr></table></figure>

<p>上面定义了使用可容忍异常模式，遇到Exception异常就重试1次，对于ParseException异常不重试，所有异常都会忽略掉，不会导致程序终止。 但是最大允许跳过200次异常，超过这个数字就终止执行了。</p>
<p>然后改一下csv文件，把某个字段改大点，超过数据库中定义长度：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1|等哈哈哈|01</span><br><span class="line">2|等哈哈哈|02</span><br><span class="line">3|等哈哈哈|025555</span><br><span class="line">4|等哈哈哈|02</span><br><span class="line">5|等哈哈哈|02</span><br></pre></td></tr></table></figure>

<p>重新执行发现正常执行完成，数据库中只插入了4条数据，id为3的没有。</p>
<h2 id="通用配置"><a href="#通用配置" class="headerlink" title="通用配置"></a>通用配置</h2><p>更进一步，如果有多个CSV文件需要导入，那么安装上面的写法。每次都要定义一个新的Config类，一个新的Bean类，代码重复率很高。</p>
<p>实际上可以定义一个通用配置，去掉里面的显示Bean类，通过Java反射机制，还有@StepScope注解， 实现每次运行时候根据JobParameters初始化不同的Job。</p>
<p>如果有一个新的CSV文件需要导入，只需要新建一个Bean，定义好相应的列，然后将Bean的属性列表、插入SQL语句作为参数传入即可。</p>
<p>测试代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试一个配置类，可同时运行多个任务</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception 异常</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testCommonJobs</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    JobParameters jobParameters1 = <span class="keyword">new</span> JobParametersBuilder()</span><br><span class="line">            .addLong(<span class="string">"time"</span>,System.currentTimeMillis())</span><br><span class="line">            .addString(KEY_JOB_NAME, <span class="string">"App"</span>)</span><br><span class="line">            .addString(KEY_FILE_NAME, p.getCsvApp())</span><br><span class="line">            .addString(KEY_VO_NAME, <span class="string">"com.xncoding.trans.modules.zapp.App"</span>)</span><br><span class="line">            .addString(KEY_COLUMNS, String.join(<span class="string">","</span>, <span class="keyword">new</span> String[]&#123;</span><br><span class="line">                    <span class="string">"appid"</span>, <span class="string">"zname"</span>, <span class="string">"flag"</span></span><br><span class="line">            &#125;))</span><br><span class="line">            .addString(KEY_SQL, <span class="string">"insert into z_test_App (appid, zname, flag) values(:appid, :zname, :flag)"</span>)</span><br><span class="line">            .toJobParameters();</span><br><span class="line">    jobLauncher.run(commonJob, jobParameters1);</span><br><span class="line"></span><br><span class="line">    JobParameters jobParameters2 = <span class="keyword">new</span> JobParametersBuilder()</span><br><span class="line">            .addLong(<span class="string">"time"</span>,System.currentTimeMillis())</span><br><span class="line">            .addString(KEY_JOB_NAME, <span class="string">"Log"</span>)</span><br><span class="line">            .addString(KEY_FILE_NAME, p.getCsvLog())</span><br><span class="line">            .addString(KEY_VO_NAME, <span class="string">"com.xncoding.trans.modules.zlog.Log"</span>)</span><br><span class="line">            .addString(KEY_COLUMNS, String.join(<span class="string">","</span>, <span class="keyword">new</span> String[]&#123;</span><br><span class="line">                    <span class="string">"logid"</span>, <span class="string">"msg"</span>, <span class="string">"logtime"</span></span><br><span class="line">            &#125;))</span><br><span class="line">            .addString(KEY_SQL, <span class="string">"insert into z_test_Log (logid, msg, logtime) values(:logid, :msg, :logtime)"</span>)</span><br><span class="line">            .toJobParameters();</span><br><span class="line">    jobLauncher.run(commonJob, jobParameters2);</span><br><span class="line"></span><br><span class="line">    logger.info(<span class="string">"Main线程执行完成"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">        Thread.sleep(<span class="number">2000000L</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h2><p>在进行Oracle操作的时候报一个错误：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ORA-08177: 无法连续访问此事务处理</span><br></pre></td></tr></table></figure>

<p>原因：Spring Batch 默认是 <code>ISOLATION_SERIALIZABLE</code></p>
<p>官方文档说明：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">The default is ISOLATION_SERIALIZABLE, which prevents accidental concurrent execution of the same job (ISOLATION_REPEATABLE_READ would work as well).</span><br></pre></td></tr></table></figure>

<p>而Oracle默认的事务隔离级别是ISOLATION_READ_COMMITTED</p>
<p>解决方案就是修改<code>JobRepositoryFactoryBean</code>的定义，加一个配置：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">jobRepositoryFactoryBean.setIsolationLevelForCreate(<span class="string">"ISOLATION_READ_COMMITTED"</span>);</span><br></pre></td></tr></table></figure>

<h2 id="GitHub源码"><a href="#GitHub源码" class="headerlink" title="GitHub源码"></a>GitHub源码</h2><p><a href="https://github.com/yidao620c/SpringBootBucket/tree/master/springboot-batch" target="_blank" rel="noopener">springboot-batch</a>   —已测试</p>
<h2 id="来源"><a href="#来源" class="headerlink" title="来源"></a>来源</h2><p><a href="https://www.xncoding.com/" target="_blank" rel="noopener">https://www.xncoding.com/</a></p>
]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>springboot</tag>
        <tag>batch</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot系列 - 异步线程池</title>
    <url>/2020/06/08/SpringBoot%E7%B3%BB%E5%88%97-%E5%BC%82%E6%AD%A5%E7%BA%BF%E7%A8%8B%E6%B1%A0/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><h1 id="SpringBoot系列-异步线程池"><a href="#SpringBoot系列-异步线程池" class="headerlink" title="SpringBoot系列 - 异步线程池"></a>SpringBoot系列 - 异步线程池</h1><p>在项目中，当访问其他人的接口较慢或者做耗时任务时，不想程序一直卡在耗时任务上，想程序能够并行执行， 我们可以使用多线程来并行的处理任务，也可以使用spring提供的异步处理方式@Async。</p>
<p>Spring异步线程池的接口类，其实质是<code>java.util.concurrent.Executor</code>。</p>
<p>Spring 已经实现的异常线程池：</p>
<ol>
<li><code>SimpleAsyncTaskExecutor</code>：不是真的线程池，这个类不重用线程，每次调用都会创建一个新的线程。</li>
<li><code>SyncTaskExecutor</code>：这个类没有实现异步调用，只是一个同步操作，只适用于不需要多线程的地方</li>
<li><code>ConcurrentTaskExecutor</code>：Executor的适配类，不推荐使用。如果<code>ThreadPoolTaskExecutor</code>不满足要求时，才用考虑使用这个类</li>
<li><code>SimpleThreadPoolTaskExecutor</code>：是Quartz的<code>SimpleThreadPool</code>的类。线程池同时被quartz和非quartz使用，才需要使用此类</li>
<li><code>ThreadPoolTaskExecutor</code>：最常使用，推荐。其实质是对<code>java.util.concurrent.ThreadPoolExecutor</code>的包装</li>
</ol>
<p>在异步处理的方法上添加注解<code>@Async</code>，就会启动一个新的线程去执行。</p>
<h2 id="开启异步配置"><a href="#开启异步配置" class="headerlink" title="开启异步配置"></a>开启异步配置</h2><p>SpringBoot中开启异步支持非常简单，只需要在配置类上面加上注解<code>@EnableAsync</code>，同时定义自己的线程池即可。 也可以不定义自己的线程池，则使用系统默认的线程池。这个注解可以放在Application启动类上，但是更推荐放在配置类上面。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAsync</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncConfig</span> <span class="keyword">implements</span> <span class="title">AsyncConfigurer</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 省略...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>异步处理方法分为不返回结果和返回结果，这两者的处理是有区别的。</p>
<h2 id="返回void"><a href="#返回void" class="headerlink" title="返回void"></a>返回void</h2><p>没有结果返回的示例：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncTask</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Async</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dealNoReturnTask</span><span class="params">()</span></span>&#123;</span><br><span class="line">        log.info(<span class="string">"返回值为void的异步调用开始"</span> + Thread.currentThread().getName());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">"返回值为void的异步调用结束"</span> + Thread.currentThread().getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="返回Future"><a href="#返回Future" class="headerlink" title="返回Future"></a>返回Future</h2><p>异步调用返回数据，Future表示在未来某个点获取执行结果，返回数据类型可以自定义</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Async</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Future&lt;String&gt; <span class="title">dealHaveReturnTask</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">    log.info(<span class="string">"asyncInvokeReturnFuture, parementer="</span> + i);</span><br><span class="line">    Future&lt;String&gt; future;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Thread.sleep(<span class="number">1000</span> * i);</span><br><span class="line">        future = <span class="keyword">new</span> AsyncResult&lt;String&gt;(<span class="string">"success:"</span> + i);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        future = <span class="keyword">new</span> AsyncResult&lt;String&gt;(<span class="string">"error"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> future;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上的异步方法和普通的方法调用相同：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Future&lt;String&gt; future = asyncDemo.asyncInvokeReturnFuture(<span class="number">100</span>);</span><br><span class="line">System.out.println(future.get());</span><br></pre></td></tr></table></figure>

<h2 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h2><p>我们可以实现<code>AsyncConfigurer</code>接口，也可以继承<code>AsyncConfigurerSupport</code>类来实现。</p>
<p>在方法getAsyncExecutor()中创建线程池的时候，必须使用 <code>executor.initialize()</code>，不然在调用时会报线程池未初始化的异常。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAsync</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncConfig</span> <span class="keyword">implements</span> <span class="title">AsyncConfigurer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Executor <span class="title">getAsyncExecutor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ThreadPoolTaskExecutor executor = <span class="keyword">new</span> ThreadPoolTaskExecutor();</span><br><span class="line">        executor.setCorePoolSize(<span class="number">10</span>);</span><br><span class="line">        executor.setMaxPoolSize(<span class="number">100</span>);</span><br><span class="line">        executor.setQueueCapacity(<span class="number">100</span>);</span><br><span class="line">        executor.setWaitForTasksToCompleteOnShutdown(<span class="keyword">true</span>);</span><br><span class="line">        executor.setAwaitTerminationSeconds(<span class="number">60</span> * <span class="number">10</span>);</span><br><span class="line">        executor.setThreadNamePrefix(<span class="string">"AsyncThread-"</span>);</span><br><span class="line">        executor.initialize(); <span class="comment">//如果不初始化，导致找到不到执行器</span></span><br><span class="line">        <span class="keyword">return</span> executor;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AsyncUncaughtExceptionHandler <span class="title">getAsyncUncaughtExceptionHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AsyncExceptionHandler();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>异步异常处理类：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncExceptionHandler</span> <span class="keyword">implements</span> <span class="title">AsyncUncaughtExceptionHandler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(AsyncExceptionHandler<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleUncaughtException</span><span class="params">(Throwable ex, Method method, Object... params)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">"Async method has uncaught exception, params: "</span> + params);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> AsyncException) &#123;</span><br><span class="line">            AsyncException asyncException = (AsyncException) ex;</span><br><span class="line">            log.info(<span class="string">"asyncException:"</span>  + asyncException.getMsg());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        log.error(<span class="string">"Exception :"</span>, ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>异步处理异常类：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncException</span> <span class="keyword">extends</span> <span class="title">Exception</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> code;</span><br><span class="line">    <span class="keyword">private</span> String msg;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCode</span><span class="params">(<span class="keyword">int</span> code)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.code = code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getMsg</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> msg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMsg</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.msg = msg;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在调用方法时，可能出现方法中抛出异常的情况。Spring对于2种异步方法的异常处理机制如下：</p>
<ol>
<li>对于方法返回值是Futrue的异步方法: a) 在调用future的get时捕获异常; b) 在异常方法中直接捕获异常</li>
<li>对于返回值是void的异步方法：通过<code>AsyncUncaughtExceptionHandler</code>处理异常</li>
</ol>
<h2 id="测试代码"><a href="#测试代码" class="headerlink" title="测试代码"></a>测试代码</h2><p>最后写个测试代码看看是否跟预期一致：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试异步任务</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RunWith</span>(SpringRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">SpringBootTest</span></span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">ApplicationTests</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(ApplicationTests<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AsyncTask asyncTask;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testAsync</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, ExecutionException </span>&#123;</span><br><span class="line">        asyncTask.dealNoReturnTask();</span><br><span class="line">        Future&lt;String&gt; f = asyncTask.dealHaveReturnTask(<span class="number">5</span>);</span><br><span class="line">        log.info(<span class="string">"主线程执行finished"</span>);</span><br><span class="line">        log.info(f.get());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行日志如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">INFO 4180 --- [           main] com.xncoding.pos.ApplicationTests         : 主线程执行finished</span><br><span class="line">INFO 4180 --- [  AsyncThread-2] com.xncoding.pos.async.AsyncTask          : asyncInvokeReturnFuture, parementer&#x3D;5</span><br><span class="line">INFO 4180 --- [  AsyncThread-1] com.xncoding.pos.async.AsyncTask          : 返回值为void的异步调用开始AsyncThread-1</span><br><span class="line">INFO 4180 --- [  AsyncThread-1] com.xncoding.pos.async.AsyncTask          : 返回值为void的异步调用结束AsyncThread-1</span><br><span class="line">INFO 4180 --- [           main] com.xncoding.pos.ApplicationTests         : success:5</span><br><span class="line">INFO 4180 --- [       Thread-4] o.s.w.c.s.GenericWebApplicationContext   : Closing ....</span><br><span class="line">INFO 4180 --- [       Thread-4] com.alibaba.druid.pool.DruidDataSource   : &#123;dataSource-1&#125; closed</span><br></pre></td></tr></table></figure>

<p>根据日志的线程名称很清楚的看出，每个异步方法在线程池的不同线程中执行。</p>
<h2 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h2><p>实际运行中，还出现过一个问题，一个Service中的方法调用自己的另一个方法，然后我将这个方法加上@Async注解，然而并不起作用。 异步方法都应该放到单独的异步任务Bean里面去，然后将这个Bean注入到Service中即可。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DeviceService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> AsyncTask asyncTask;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">unbind</span><span class="params">(Integer id, ManagerInfo managerInfo)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 前面省略...</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 开始异步推送消息</span></span><br><span class="line">        asyncTask.pushUnbindMsg(managerInfo, pos, location);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="GitHub源码"><a href="#GitHub源码" class="headerlink" title="GitHub源码"></a>GitHub源码</h2><p><a href="https://github.com/yidao620c/SpringBootBucket/tree/master/springboot-async" target="_blank" rel="noopener">springboot-async</a>   —已测试</p>
<h2 id="来源"><a href="#来源" class="headerlink" title="来源"></a>来源</h2><p><a href="https://www.xncoding.com/" target="_blank" rel="noopener">https://www.xncoding.com/</a></p>
]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>springboot</tag>
        <tag>async</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot系列 - 缓存</title>
    <url>/2020/06/08/SpringBoot%E7%B3%BB%E5%88%97-%E7%BC%93%E5%AD%98/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><h1 id="SpringBoot系列-缓存"><a href="#SpringBoot系列-缓存" class="headerlink" title="SpringBoot系列 - 缓存"></a>SpringBoot系列 - 缓存</h1><p>内存的速度远远大于硬盘的速度，当我们需要重复获取相同的数据的时候，一次又一次的请求数据库或远程服务， 导致大量时间都消耗在数据库查询或远程方法调用上面，性能下降，这时候就需要使用到缓存技术了。</p>
<p>本文介绍SpringBoot 如何使用redis做缓存，如何对redis缓存进行定制化配置(如key的有效期)以及初始化redis做缓存。 使用具体的代码介绍了<code>@Cacheable</code>，<code>@CacheEvict</code>，<code>@CachePut</code>，<code>@CacheConfig</code>等注解及其属性的用法。</p>
<h2 id="Spring缓存支持"><a href="#Spring缓存支持" class="headerlink" title="Spring缓存支持"></a>Spring缓存支持</h2><p>Spring定义了<code>org.springframework.cache.CacheManager</code> 和 <code>org.springframework.cache.Cache</code> 接口来统一不同缓存技术。 其中CacheManager是Spring提供的各种缓存技术抽象接口，内部使用Cache接口进行缓存的增删改查操作，我们一般不会直接和Cache打交道。</p>
<p>针对不同的缓存技术，Spring有不同的CacheManager实现类，定义如下表：</p>
<table>
<thead>
<tr>
<th>CacheManager</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>SimpleCacheManager</td>
<td>使用简单的Collection存储缓存数据，用来做测试用</td>
</tr>
<tr>
<td>ConcurrentMapCacheManager</td>
<td>使用ConcurrentMap存储缓存数据</td>
</tr>
<tr>
<td>EhCacheCacheManager</td>
<td>使用EhCache作为缓存技术</td>
</tr>
<tr>
<td>GuavaCacheManager</td>
<td>使用Google Guava的GuavaCache作为缓存技术</td>
</tr>
<tr>
<td>JCacheCacheManager</td>
<td>使用JCache(JSR-107)标准的实现作为缓存技术，比如Apache Commons JCS</td>
</tr>
<tr>
<td>RedisCacheManager</td>
<td>使用Redis作为缓存技术</td>
</tr>
</tbody></table>
<p>在我们使用任意一个实现的CacheManager的时候，需要注册实现Bean：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * EhCache的配置</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> EhCacheCacheManager <span class="title">cacheManager</span><span class="params">(CacheManager cacheManager)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> EhCacheCacheManager(cacheManager);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当然，各种缓存技术都有很多其他配置，但是配置cacheManager是必不可少的。</p>
<h2 id="声明式缓存注解"><a href="#声明式缓存注解" class="headerlink" title="声明式缓存注解"></a>声明式缓存注解</h2><p>Spring提供4个注解来声明缓存规则，如下表所示：</p>
<table>
<thead>
<tr>
<th>注解</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>@Cacheable</td>
<td>方法执行前先看缓存中是否有数据，如果有直接返回。如果没有就调用方法，并将方法返回值放入缓存</td>
</tr>
<tr>
<td>@CachePut</td>
<td>无论怎样都会执行方法，并将方法返回值放入缓存</td>
</tr>
<tr>
<td>@CacheEvict</td>
<td>将数据从缓存中删除</td>
</tr>
<tr>
<td>@Caching</td>
<td>可通过此注解组合多个注解策略在一个方法上面</td>
</tr>
</tbody></table>
<p>@Cacheable 、@CachePut 、@CacheEvict都有value属性，指定要使用的缓存名称，而key属性指定缓存中存储的键。</p>
<h2 id="集成Redis缓存"><a href="#集成Redis缓存" class="headerlink" title="集成Redis缓存"></a>集成Redis缓存</h2><p>接下来将讲解如何集成redis来实现缓存，现在使用的是最新的SpringBoot 2，改动还是比较大的。</p>
<h3 id="安装redis"><a href="#安装redis" class="headerlink" title="安装redis"></a>安装redis</h3><p>安装和配置redis服务器网上很多教程，这里就不多讲了。在linux服务器上面安装一个redis，启动后端口号为默认的6379。</p>
<h3 id="添加maven依赖"><a href="#添加maven依赖" class="headerlink" title="添加maven依赖"></a>添加maven依赖</h3><p>SpringBoot 2开始默认的Redis客户端实现是Lettuce，同时你需要添加commons-pool2的依赖。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-pool2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="配置application-yml"><a href="#配置application-yml" class="headerlink" title="配置application.yml"></a>配置application.yml</h3><ul>
<li>指定缓存的类型</li>
<li>配置redis的服务器信息</li>
<li>配置lettuce连接池信息</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">cache:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">REDIS</span></span><br><span class="line">    <span class="attr">redis:</span></span><br><span class="line">      <span class="attr">cache-null-values:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">time-to-live:</span> <span class="string">600000ms</span></span><br><span class="line">      <span class="attr">use-key-prefix:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">cache-names:</span> <span class="string">userCache,allUsersCache</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">    <span class="attr">database:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">lettuce:</span></span><br><span class="line">      <span class="attr">shutdown-timeout:</span> <span class="string">200ms</span></span><br><span class="line">      <span class="attr">pool:</span></span><br><span class="line">        <span class="attr">max-active:</span> <span class="number">7</span></span><br><span class="line">        <span class="attr">max-idle:</span> <span class="number">7</span></span><br><span class="line">        <span class="attr">min-idle:</span> <span class="number">2</span></span><br><span class="line">        <span class="attr">max-wait:</span> <span class="string">-1ms</span></span><br></pre></td></tr></table></figure>

<p>这里我还指定了缓存名称列表：userCache,allUsersCache</p>
<h3 id="缓存配置类"><a href="#缓存配置类" class="headerlink" title="缓存配置类"></a>缓存配置类</h3><p>重新配置<code>RedisCacheManager</code>，使用新的自定义配置值：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableCaching</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisCacheConfig</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Environment env;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LettuceConnectionFactory <span class="title">redisConnectionFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        RedisStandaloneConfiguration redisConf = <span class="keyword">new</span> RedisStandaloneConfiguration();</span><br><span class="line">        redisConf.setHostName(env.getProperty(<span class="string">"spring.redis.host"</span>));</span><br><span class="line">        redisConf.setPort(Integer.parseInt(env.getProperty(<span class="string">"spring.redis.port"</span>)));</span><br><span class="line">        redisConf.setPassword(RedisPassword.of(env.getProperty(<span class="string">"spring.redis.password"</span>)));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LettuceConnectionFactory(redisConf);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedisCacheConfiguration <span class="title">cacheConfiguration</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        RedisCacheConfiguration cacheConfig = RedisCacheConfiguration.defaultCacheConfig()</span><br><span class="line">                .entryTtl(Duration.ofSeconds(<span class="number">600</span>))</span><br><span class="line">                .disableCachingNullValues();</span><br><span class="line">        <span class="keyword">return</span> cacheConfig;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedisCacheManager <span class="title">cacheManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        RedisCacheManager rcm = RedisCacheManager.builder(redisConnectionFactory())</span><br><span class="line">                .cacheDefaults(cacheConfiguration())</span><br><span class="line">                .transactionAware()</span><br><span class="line">                .build();</span><br><span class="line">        <span class="keyword">return</span> rcm;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="keyGenerator"><a href="#keyGenerator" class="headerlink" title="keyGenerator"></a>keyGenerator</h3><p>一般来讲我们使用key属性就可以满足大部分要求，但是如果你还想更好的自定义key，可以实现keyGenerator。</p>
<p>这个属性为定义key生成的类，和key属性不能同时存在。</p>
<p>在<code>RedisCacheConfig</code>配置类中添加我自定义的KeyGenerator：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义缓存key的生成类实现</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Bean</span>(name = <span class="string">"myKeyGenerator"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> KeyGenerator <span class="title">myKeyGenerator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> KeyGenerator() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">generate</span><span class="params">(Object o, Method method, Object... params)</span> </span>&#123;</span><br><span class="line">            logger.info(<span class="string">"自定义缓存，使用第一参数作为缓存key，params = "</span> + Arrays.toString(params));</span><br><span class="line">            <span class="comment">// 仅仅用于测试，实际不可能这么写</span></span><br><span class="line">            <span class="keyword">return</span> params[<span class="number">0</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>经过以上配置后，redis缓存管理对象已经生成，下面简单介绍如何使用。</p>
<h2 id="缓存注解"><a href="#缓存注解" class="headerlink" title="缓存注解"></a>缓存注解</h2><p>缓存是通过注解实现的，这里详细讲解一下这几个缓存注解，以及注解参数含义。</p>
<h3 id="Cacheable"><a href="#Cacheable" class="headerlink" title="@Cacheable"></a>@Cacheable</h3><p>这个注解含义是方法结果会被放入缓存，并且一旦缓存后，下一次调用此方法，会通过key去查找缓存是否存在，如果存在就直接取缓存值，不再执行方法。</p>
<p>这个注解有几个参数值，定义如下</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>解释</th>
</tr>
</thead>
<tbody><tr>
<td>cacheNames</td>
<td>缓存名称</td>
</tr>
<tr>
<td>value</td>
<td>缓存名称的别名</td>
</tr>
<tr>
<td>condition</td>
<td>Spring SpEL 表达式，用来确定是否缓存</td>
</tr>
<tr>
<td>key</td>
<td>SpEL 表达式，用来动态计算key</td>
</tr>
<tr>
<td>keyGenerator</td>
<td>Bean 名字，用来自定义key生成算法，跟key不能同时用</td>
</tr>
<tr>
<td>unless</td>
<td>SpEL 表达式，用来否决缓存，作用跟condition相反</td>
</tr>
<tr>
<td>sync</td>
<td>多线程同时访问时候进行同步</td>
</tr>
</tbody></table>
<p>在计算key、condition或者unless的值得时候，可以使用到以下的特有的SpEL表达式</p>
<table>
<thead>
<tr>
<th>表达式</th>
<th>解释</th>
</tr>
</thead>
<tbody><tr>
<td>#result</td>
<td>表示方法的返回结果</td>
</tr>
<tr>
<td>#root.method</td>
<td>当前方法</td>
</tr>
<tr>
<td>#root.target</td>
<td>目标对象</td>
</tr>
<tr>
<td>#root.caches</td>
<td>被影响到的缓存列表</td>
</tr>
<tr>
<td>#root.methodName</td>
<td>方法名称简称</td>
</tr>
<tr>
<td>#root.targetClass</td>
<td>目标类</td>
</tr>
<tr>
<td>#root.args[x]</td>
<td>方法的第x个参数</td>
</tr>
</tbody></table>
<h3 id="CachePut"><a href="#CachePut" class="headerlink" title="@CachePut"></a>@CachePut</h3><p>该注解在执行完方法后会触发一次缓存put操作，参数跟@Cacheable一致</p>
<h3 id="CacheEvict"><a href="#CacheEvict" class="headerlink" title="@CacheEvict"></a>@CacheEvict</h3><p>该注解在执行完方法后会触发一次缓存evict操作，参数除了@Cacheable里的外，还有个特殊的<code>allEntries</code>， 表示将清空缓存中所有的值。</p>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>在service中定义增删改的几个常见方法，通过注解实现缓存：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * cacheNames 设置缓存的值</span></span><br><span class="line"><span class="comment">     * key：指定缓存的key，这是指参数id值。key可以使用spEl表达式</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Cacheable</span>(value = <span class="string">"userCache"</span>, key = <span class="string">"#id"</span>, unless=<span class="string">"#result == null"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">getById</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"获取用户start..."</span>);</span><br><span class="line">        <span class="keyword">return</span> userMapper.selectById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Cacheable</span>(value = <span class="string">"allUsersCache"</span>, unless = <span class="string">"#result.size() == 0"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">getAllUsers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"获取所有用户列表"</span>);</span><br><span class="line">        <span class="keyword">return</span> userMapper.selectList(<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建用户，同时使用新的返回值的替换缓存中的值</span></span><br><span class="line"><span class="comment">     * 创建用户后会将allUsersCache缓存全部清空</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Caching</span>(</span><br><span class="line">            put = &#123;<span class="meta">@CachePut</span>(value = <span class="string">"userCache"</span>, key = <span class="string">"#user.id"</span>)&#125;,</span><br><span class="line">            evict = &#123;<span class="meta">@CacheEvict</span>(value = <span class="string">"allUsersCache"</span>, allEntries = <span class="keyword">true</span>)&#125;</span><br><span class="line">    )</span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">createUser</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"创建用户start..., user.id="</span> + user.getId());</span><br><span class="line">        userMapper.insert(user);</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 更新用户，同时使用新的返回值的替换缓存中的值</span></span><br><span class="line"><span class="comment">     * 更新用户后会将allUsersCache缓存全部清空</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Caching</span>(</span><br><span class="line">            put = &#123;<span class="meta">@CachePut</span>(value = <span class="string">"userCache"</span>, key = <span class="string">"#user.id"</span>)&#125;,</span><br><span class="line">            evict = &#123;<span class="meta">@CacheEvict</span>(value = <span class="string">"allUsersCache"</span>, allEntries = <span class="keyword">true</span>)&#125;</span><br><span class="line">    )</span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">updateUser</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"更新用户start..."</span>);</span><br><span class="line">        userMapper.updateById(user);</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 对符合key条件的记录从缓存中移除</span></span><br><span class="line"><span class="comment">     * 删除用户后会将allUsersCache缓存全部清空</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Caching</span>(</span><br><span class="line">            evict = &#123;</span><br><span class="line">                    <span class="meta">@CacheEvict</span>(value = <span class="string">"userCache"</span>, key = <span class="string">"#id"</span>),</span><br><span class="line">                    <span class="meta">@CacheEvict</span>(value = <span class="string">"allUsersCache"</span>, allEntries = <span class="keyword">true</span>)</span><br><span class="line">            &#125;</span><br><span class="line">    )</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteById</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"删除用户start..."</span>);</span><br><span class="line">        userMapper.deleteById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后写个测试类：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">SpringBootTest</span>(<span class="title">classes</span> </span>= Application<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">Transactional</span></span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">UserServiceTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testCache</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 创建一个用户admin</span></span><br><span class="line">        <span class="keyword">int</span> id = <span class="keyword">new</span> Random().nextInt(<span class="number">1000</span>);</span><br><span class="line">        User user = <span class="keyword">new</span> User(id, <span class="string">"admin"</span>, <span class="string">"admin"</span>);</span><br><span class="line">        userService.createUser(user);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 再创建一个用户xiong</span></span><br><span class="line">        <span class="keyword">int</span> id2 = <span class="keyword">new</span> Random().nextInt(<span class="number">1000</span>);</span><br><span class="line">        User user2 = <span class="keyword">new</span> User(id2, <span class="string">"xiong"</span>, <span class="string">"neng"</span>);</span><br><span class="line">        userService.createUser(user2);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 查询所有用户列表</span></span><br><span class="line">        List&lt;User&gt; list = userService.getAllUsers();</span><br><span class="line">        assertEquals(list.size(), <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 两次访问看看缓存命中情况</span></span><br><span class="line">        User user3 = userService.getById(id); <span class="comment">// 第1次访问</span></span><br><span class="line">        assertEquals(user3.getPassword(), <span class="string">"admin"</span>);</span><br><span class="line">        User user4 = userService.getById(id); <span class="comment">// 第2次访问</span></span><br><span class="line">        assertEquals(user4.getPassword(), <span class="string">"admin"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 更新用户密码</span></span><br><span class="line">        user4.setPassword(<span class="string">"123456"</span>);</span><br><span class="line">        userService.updateUser(user4);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 更新完成后再次访问用户</span></span><br><span class="line">        User user5 = userService.getById(id); <span class="comment">// 第4次访问</span></span><br><span class="line">        assertEquals(user5.getPassword(), <span class="string">"123456"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 删除用户admin</span></span><br><span class="line">        userService.deleteById(id);</span><br><span class="line">        assertNull(userService.getById(id));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面是测试的打印日志一部分：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">创建用户start..., user.id=<span class="number">444</span></span><br><span class="line">==&gt;  Preparing: <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_user ( <span class="keyword">id</span>, username, <span class="string">`password`</span> ) <span class="keyword">VALUES</span> ( ?, ?, ? )</span><br><span class="line">==&gt; <span class="keyword">Parameters</span>: <span class="number">444</span>(<span class="built_in">Integer</span>), <span class="keyword">admin</span>(<span class="keyword">String</span>), <span class="keyword">admin</span>(<span class="keyword">String</span>)</span><br><span class="line">&lt;==    Updates: <span class="number">1</span></span><br><span class="line">创建用户start..., user.id=<span class="number">895</span></span><br><span class="line">==&gt;  Preparing: <span class="keyword">INSERT</span> <span class="keyword">INTO</span> t_user ( <span class="keyword">id</span>, username, <span class="string">`password`</span> ) <span class="keyword">VALUES</span> ( ?, ?, ? )</span><br><span class="line">==&gt; <span class="keyword">Parameters</span>: <span class="number">895</span>(<span class="built_in">Integer</span>), xiong(<span class="keyword">String</span>), neng(<span class="keyword">String</span>)</span><br><span class="line">&lt;==    Updates: <span class="number">1</span></span><br><span class="line"><span class="keyword">Starting</span> <span class="keyword">without</span> optional epoll <span class="keyword">library</span></span><br><span class="line"><span class="keyword">Starting</span> <span class="keyword">without</span> optional kqueue <span class="keyword">library</span></span><br><span class="line">获取所有用户列表</span><br><span class="line">==&gt;  Preparing: <span class="keyword">SELECT</span> <span class="keyword">id</span> <span class="keyword">AS</span> <span class="keyword">id</span>,username,<span class="string">`password`</span> <span class="keyword">FROM</span> t_user</span><br><span class="line">==&gt; <span class="keyword">Parameters</span>:</span><br><span class="line">&lt;==      Total: <span class="number">2</span></span><br><span class="line">获取用户start...</span><br><span class="line">==&gt;  Preparing: <span class="keyword">SELECT</span> <span class="keyword">id</span> <span class="keyword">AS</span> <span class="keyword">id</span>,username,<span class="string">`password`</span> <span class="keyword">FROM</span> t_user <span class="keyword">WHERE</span> <span class="keyword">id</span>=?</span><br><span class="line">==&gt; <span class="keyword">Parameters</span>: <span class="number">444</span>(<span class="built_in">Integer</span>)</span><br><span class="line">&lt;==      Total: <span class="number">1</span></span><br><span class="line">获取用户start...</span><br><span class="line">更新用户start...</span><br><span class="line">==&gt;  Preparing: <span class="keyword">UPDATE</span> t_user <span class="keyword">SET</span> username=?, <span class="string">`password`</span>=? <span class="keyword">WHERE</span> <span class="keyword">id</span>=?</span><br><span class="line">==&gt; <span class="keyword">Parameters</span>: <span class="keyword">admin</span>(<span class="keyword">String</span>), <span class="number">123456</span>(<span class="keyword">String</span>), <span class="number">444</span>(<span class="built_in">Integer</span>)</span><br><span class="line">&lt;==    Updates: <span class="number">1</span></span><br><span class="line">获取用户start...</span><br><span class="line">==&gt;  Preparing: <span class="keyword">SELECT</span> <span class="keyword">id</span> <span class="keyword">AS</span> <span class="keyword">id</span>,username,<span class="string">`password`</span> <span class="keyword">FROM</span> t_user <span class="keyword">WHERE</span> <span class="keyword">id</span>=?</span><br><span class="line">==&gt; <span class="keyword">Parameters</span>: <span class="number">444</span>(<span class="built_in">Integer</span>)</span><br><span class="line">&lt;==      Total: <span class="number">1</span></span><br><span class="line">删除用户start...</span><br><span class="line">==&gt;  Preparing: <span class="keyword">DELETE</span> <span class="keyword">FROM</span> t_user <span class="keyword">WHERE</span> <span class="keyword">id</span>=?</span><br><span class="line">==&gt; <span class="keyword">Parameters</span>: <span class="number">444</span>(<span class="built_in">Integer</span>)</span><br><span class="line">&lt;==    Updates: <span class="number">1</span></span><br><span class="line">获取用户start...</span><br><span class="line">==&gt;  Preparing: <span class="keyword">SELECT</span> <span class="keyword">id</span> <span class="keyword">AS</span> <span class="keyword">id</span>,username,<span class="string">`password`</span> <span class="keyword">FROM</span> t_user <span class="keyword">WHERE</span> <span class="keyword">id</span>=?</span><br><span class="line">==&gt; <span class="keyword">Parameters</span>: <span class="number">444</span>(<span class="built_in">Integer</span>)</span><br><span class="line">&lt;==      Total: <span class="number">0</span></span><br><span class="line">Rolled back <span class="keyword">transaction</span> <span class="keyword">for</span> <span class="keyword">test</span>: [DefaultTestContext@<span class="number">44</span>ebcd03 testClass = UserServiceTest,</span><br><span class="line">Closing org.springframework.context.annotation.AnnotationConfigApplicationContext@<span class="number">1</span>a5a4e19:</span><br><span class="line">&#123;dataSource<span class="number">-1</span>&#125; closed</span><br></pre></td></tr></table></figure>

<p>可以看到，第2次、第3次获取的时候并没有执行方法，说明缓存生效了。后面更新会同时更新缓存，取出来的也是更新后的数据。</p>
<h2 id="切换缓存技术"><a href="#切换缓存技术" class="headerlink" title="切换缓存技术"></a>切换缓存技术</h2><p>得益于SpringBoot的自动配置机制，切换缓存技术除了替换相关maven依赖包和配置Bean外，使用方式和实例中一样， 不需要修改业务代码。如果你要切换到其他缓存技术非常简单。</p>
<p><strong>EhCache</strong></p>
<p>当我们需要使用EhCache作为缓存技术的时候，只需要在pom.xml中添加EhCache的依赖：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>net.sf.ehcache<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ehcahe<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>EhCache的配置文件ehcache.xml只需要放到类路径下面，SpringBoot会自动扫描，例如：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ehcache</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:noNamespaceSchemaLocation</span>=<span class="string">"http://ehcache.org/ehcache.xsd"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">updateCheck</span>=<span class="string">"false"</span> <span class="attr">monitoring</span>=<span class="string">"autodetect"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">dynamicConfig</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">diskStore</span> <span class="attr">path</span>=<span class="string">"java.io.tmpdir/ehcache"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">defaultCache</span></span></span><br><span class="line"><span class="tag">            <span class="attr">maxElementsInMemory</span>=<span class="string">"50000"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">eternal</span>=<span class="string">"false"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">timeToIdleSeconds</span>=<span class="string">"3600"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">timeToLiveSeconds</span>=<span class="string">"3600"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">overflowToDisk</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">diskPersistent</span>=<span class="string">"false"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">diskExpiryThreadIntervalSeconds</span>=<span class="string">"120"</span></span></span><br><span class="line"><span class="tag">    /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">cache</span> <span class="attr">name</span>=<span class="string">"authorizationCache"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">maxEntriesLocalHeap</span>=<span class="string">"2000"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">eternal</span>=<span class="string">"false"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">timeToIdleSeconds</span>=<span class="string">"3600"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">timeToLiveSeconds</span>=<span class="string">"3600"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">overflowToDisk</span>=<span class="string">"false"</span></span></span><br><span class="line"><span class="tag">           <span class="attr">statistics</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">cache</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ehcache</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>SpringBoot会为我们自动配置<code>EhCacheCacheManager</code>这个Bean，不过你也可以自己定义。</p>
<p><strong>Guava</strong></p>
<p>当我们需要Guava作为缓存技术的时候，只需要在pom.xml中增加Guava的依赖即可：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.guava<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>guava<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>18.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>SpringBoot会为我们自动配置<code>GuavaCacheManager</code>这个Bean。</p>
<p><strong>Redis</strong></p>
<p>最后还提一点，本篇采用Redis作为缓存技术，添加了依赖：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>SpringBoot会为我们自动配置<code>RedisCacheManager</code>这个Bean，同时还会配置<code>RedisTemplate</code>这个Bean。 后面这个Bean就是下一篇要讲解的操作Redis数据库用，这个就比单纯注解缓存强大和灵活的多了。</p>
<h2 id="GitHub源码"><a href="#GitHub源码" class="headerlink" title="GitHub源码"></a>GitHub源码</h2><p><a href="https://github.com/yidao620c/SpringBootBucket/tree/master/springboot-cache" target="_blank" rel="noopener">springboot-cache</a>   —已测试</p>
<h2 id="来源"><a href="#来源" class="headerlink" title="来源"></a>来源</h2><p><a href="https://www.xncoding.com/" target="_blank" rel="noopener">https://www.xncoding.com/</a></p>
]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>springboot</tag>
        <tag>cache</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot系列 - 自己写starter</title>
    <url>/2020/06/08/SpringBoot%E7%B3%BB%E5%88%97-%E8%87%AA%E5%B7%B1%E5%86%99starter/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><h1 id="SpringBoot系列-自己写starter"><a href="#SpringBoot系列-自己写starter" class="headerlink" title="SpringBoot系列 - 自己写starter"></a>SpringBoot系列 - 自己写starter</h1><p>Spring Boot由众多Starter组成，随着版本的推移Starter家族成员也与日俱增。在传统Maven项目中通常将一些层、组件拆分为模块来管理， 以便相互依赖复用，在Spring Boot项目中我们则可以创建自定义Spring Boot Starter来达成该目的。</p>
<p>可以认为starter是一种服务——使得使用某个功能的开发者不需要关注各种依赖库的处理，不需要具体的配置信息， 由Spring Boot自动通过classpath路径下的类发现需要的Bean，并织入相应的Bean。举个栗子，spring-boot-starter-jdbc这个starter的存在， 使得我们只需要在BookPubApplication下用@Autowired引入DataSource的bean就可以，Spring Boot会自动创建DataSource的实例。</p>
<p>本篇将通过一个简单的例子来演示如何编写自己的starter。</p>
<p>这里讲一下我们的Starter要实现的功能，很简单，提供一个Service，包含一个能够将字符串加上前后缀的方法String wrap(String word)。 而具体的前缀和后缀是通过读取SpringBoot配置文件<code>application.yml</code>而获取的。</p>
<h2 id="添加maven依赖"><a href="#添加maven依赖" class="headerlink" title="添加maven依赖"></a>添加maven依赖</h2><p>第一步当然是创建一个maven工程，添加SpringBoot的自动配置的依赖：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xncoding<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>simple-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>simple-spring-boot-starter<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>一个简单的自定义starter<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.apache.org<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.4.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- @ConfigurationProperties annotation processing (metadata for IDEs)</span></span><br><span class="line"><span class="comment">                 生成spring-configuration-metadata.json类，需要引入此类--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-autoconfigure<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>注意其中 <code>spring-boot-configuration-processor</code> 的作用是编译时生成<code>spring-configuration-metadata.json</code>， 此文件主要给IDE使用，用于提示使用。如在intellij idea中，当配置此jar相关配置属性在<code>application.yml</code>， 你可以用ctlr+鼠标左键，IDE会跳转到你配置此属性的类中。</p>
<p>这里说下artifactId的命名问题，Spring 官方 Starter通常命名为<code>spring-boot-starter-{name}</code> 如 <code>spring-boot-starter-web</code>。</p>
<p>Spring官方建议非官方Starter命名应遵循<code>{name}-spring-boot-starter</code>的格式。</p>
<h2 id="编写Service"><a href="#编写Service" class="headerlink" title="编写Service"></a>编写Service</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExampleService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String prefix;</span><br><span class="line">    <span class="keyword">private</span> String suffix;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ExampleService</span><span class="params">(String prefix, String suffix)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.prefix = prefix;</span><br><span class="line">        <span class="keyword">this</span>.suffix = suffix;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">wrap</span><span class="params">(String word)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> prefix + word + suffix;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="编写属性类"><a href="#编写属性类" class="headerlink" title="编写属性类"></a>编写属性类</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ConfigurationProperties</span>(<span class="string">"example.service"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExampleServiceProperties</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String prefix;</span><br><span class="line">    <span class="keyword">private</span> String suffix;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPrefix</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> prefix;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPrefix</span><span class="params">(String prefix)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.prefix = prefix;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getSuffix</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> suffix;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSuffix</span><span class="params">(String suffix)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.suffix = suffix;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="编写自动配置类"><a href="#编写自动配置类" class="headerlink" title="编写自动配置类"></a>编写自动配置类</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnClass</span>(ExampleService<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">EnableConfigurationProperties</span>(<span class="title">ExampleServiceProperties</span>.<span class="title">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">ExampleAutoConfigure</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ExampleServiceProperties properties;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ExampleAutoConfigure</span><span class="params">(ExampleServiceProperties properties)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.properties = properties;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    <span class="meta">@ConditionalOnProperty</span>(prefix = <span class="string">"example.service"</span>, value = <span class="string">"enabled"</span>,havingValue = <span class="string">"true"</span>)</span><br><span class="line">    <span class="function">ExampleService <span class="title">exampleService</span> <span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span>  <span class="keyword">new</span> ExampleService(properties.getPrefix(),properties.getSuffix());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>解释下用到的几个和Starter相关的注解：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1. @ConditionalOnClass，当classpath下发现该类的情况下进行自动配置。</span><br><span class="line">2. @ConditionalOnMissingBean，当Spring Context中不存在该Bean时。</span><br><span class="line">3. @ConditionalOnProperty(prefix &#x3D; &quot;example.service&quot;,value &#x3D; &quot;enabled&quot;,havingValue &#x3D; &quot;true&quot;)，当配置文件中example.service.enabled&#x3D;true时。</span><br></pre></td></tr></table></figure>

<h2 id="添加spring-factories"><a href="#添加spring-factories" class="headerlink" title="添加spring.factories"></a>添加spring.factories</h2><p>最后一步，在<code>resources/META-INF/</code>下创建<code>spring.factories</code>文件，内容供参考下面：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">org.springframework.boot.autoconfigure.EnableAutoConfiguration&#x3D;\</span><br><span class="line">com.xncoding.starter.config.ExampleAutoConfigure</span><br></pre></td></tr></table></figure>

<p>如果有多个自动配置类，用逗号分隔换行即可。</p>
<p>OK，完事，运行 <code>mvn:install</code> 打包安装，一个Spring Boot Starter便开发完成了。</p>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>打包好了当然要测试一下看看了。另外创建一个SpringBoot工程，在maven中引入这个starter依赖， 然后在单元测试中引入这个Service看看效果。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xncoding<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>simple-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>修改<code>application.yml</code>配置文件，添加如下内容：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">example.service:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">prefix:</span> <span class="string">ppp</span></span><br><span class="line">  <span class="attr">suffix:</span> <span class="string">sss</span></span><br></pre></td></tr></table></figure>

<p>测试类：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">SpringBootTest</span></span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">ApplicationTests</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ExampleService exampleService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testStarter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(exampleService.wrap(<span class="string">"hello"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ppphellosss</span><br></pre></td></tr></table></figure>

<p>完美！</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>总结下Starter的工作原理:</p>
<ol>
<li>Spring Boot在启动时扫描项目所依赖的JAR包，寻找包含<code>spring.factories</code>文件的JAR包</li>
<li>根据<code>spring.factories</code>配置加载AutoConfigure类</li>
<li>根据 <code>@Conditional</code> 注解的条件，进行自动配置并将Bean注入Spring Context</li>
</ol>
<h2 id="GitHub源码"><a href="#GitHub源码" class="headerlink" title="GitHub源码"></a>GitHub源码</h2><p><a href="https://github.com/yidao620c/SpringBootBucket/tree/master/springboot-starter" target="_blank" rel="noopener">springboot-starter</a>    —已测试</p>
<h2 id="来源"><a href="#来源" class="headerlink" title="来源"></a>来源</h2><p><a href="https://www.xncoding.com/" target="_blank" rel="noopener">https://www.xncoding.com/</a></p>
]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>springboot</tag>
        <tag>starter</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot系列 - 集成Hibernate</title>
    <url>/2020/06/08/SpringBoot%E7%B3%BB%E5%88%97-%E9%9B%86%E6%88%90Hibernate/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><h1 id="SpringBoot系列-集成Hibernate"><a href="#SpringBoot系列-集成Hibernate" class="headerlink" title="SpringBoot系列 - 集成Hibernate"></a>SpringBoot系列 - 集成Hibernate</h1><p>Hibernate与MyBatis都是流行的持久层开发框架，前一遍介绍了怎样在SpringBoot中集成MyBatis，本篇来介绍如何集成Hibernate作为DAO层。</p>
<p>Hibernate 是一个高性能的对象/关系映射（ORM）持久化存储和查询的服务，不仅负责从Java类到数据库表的映射 （还包括从Java数据类型到SQL数据类型的映射），还提供了面向对象的数据查询检索机制，从而极大地缩短了手动处理SQL和JDBC上的开发时间。 同时，Hibernate还实现了JPA规范，在SpringBoot中，JPA的默认实现就是使用的Hibernate。</p>
<h2 id="JPA和Hibernate"><a href="#JPA和Hibernate" class="headerlink" title="JPA和Hibernate"></a>JPA和Hibernate</h2><p>在讲解如何在SpringBoot中使用Hibernate框架之前，先要弄清几个基本概念以及它们之间的关系。</p>
<ol>
<li>JPA</li>
<li>Hibernate</li>
<li>Spring Data</li>
<li>Spring Data JPA</li>
</ol>
<h3 id="JPA"><a href="#JPA" class="headerlink" title="JPA"></a>JPA</h3><p>JPA(Java Persistence API)是Sun官方提出的Java持久化规范，它为Java开发人员提供了一种对象/关系映射工具来管理Java应用中的关系数据。</p>
<p>上面已经描述很清楚了，JPA是一种规范和标准，也就是类似于Java中的接口，由Sun公司官方定义，但是并没有指定谁来实现。</p>
<p>现在几个主要的JPA实现技术有Hibernate、EclipseLink、OpenJPA等。</p>
<h3 id="Hibernate"><a href="#Hibernate" class="headerlink" title="Hibernate"></a>Hibernate</h3><p>Hibernate是一个开放源代码的对象关系映射框架，它对JDBC进行了非常轻量级的对象封装，它将POJO与数据库表建立映射关系，是一个全自动的ORM框架。 Hibernate可以自动生成SQL语句、自动执行，从而使得Java程序员可以随心所欲的使用对象编程思维来操纵数据库。</p>
<p>实际上，JPA规范制定过程中就是借鉴了Hibernate等这些开源的持久框架，也就是说Hibernate的出现比JPA还要早些。</p>
<p>在Hibernate中使用的注解就是JPA注解，Hibernate实现了JPA规范。</p>
<h3 id="Spring-Data"><a href="#Spring-Data" class="headerlink" title="Spring Data"></a>Spring Data</h3><p>Spring Data是一个用于简化数据库访问，并支持云服务的开源框架。其主要目标是使得数据库的访问变得方便快捷， 并支持map-reduce框架和云计算数据服务。此外，它还支持基于关系型数据库的数据服务，如Oracle RAC等。</p>
<p>所以Spring Data本身就是一个开源的框架。</p>
<h3 id="Spring-Data-JPA"><a href="#Spring-Data-JPA" class="headerlink" title="Spring Data JPA"></a>Spring Data JPA</h3><p>上面说过Spring Data是一个开源框架，在这个框架中Spring Data JPA只是这个框架中的一个模块。</p>
<p>它可以极大的简化JPA的写法，可以在几乎不用写实现的情况下，实现对数据的访问和操作。除了CRUD外，还包括如分页、排序等一些常用的功能。</p>
<p>好了，现在你应该对这些概念有一个基本认识了，接下来进入正题，演示如何在SpringBoot中使用Hibernate。</p>
<h2 id="maven依赖"><a href="#maven依赖" class="headerlink" title="maven依赖"></a>maven依赖</h2><p>第一步添加maven依赖：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;mysql-connector.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;druid.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>注意，使用mysql数据库来演示的话还要添加数据库驱动包，另外还添加了druid连接池。</p>
<h2 id="准备数据库"><a href="#准备数据库" class="headerlink" title="准备数据库"></a>准备数据库</h2><p>如何安装mysql，配置用户名和密码之类我就不在这里讲了，请自行google。</p>
<p>下面是我的schema.sql文件，创建一个pos数据库，并创建一个article表，插入几条初始数据：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- Dumping database structure for concretepage</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="string">`pos`</span> <span class="keyword">default</span> <span class="keyword">charset</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci;</span><br><span class="line"><span class="keyword">SET</span> FOREIGN_KEY_CHECKS=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">USE</span> <span class="string">`pos`</span>;</span><br><span class="line"><span class="comment">-- Dumping structure for table concretepage.articles</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="string">`articles`</span> (</span><br><span class="line">  <span class="string">`article_id`</span> <span class="built_in">int</span>(<span class="number">5</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`title`</span> <span class="built_in">varchar</span>(<span class="number">200</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`category`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`article_id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">1</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 <span class="keyword">COMMENT</span>=<span class="string">'文章表'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Dumping data for table concretepage.articles: ~3 rows (approximately)</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`articles`</span> (<span class="string">`article_id`</span>, <span class="string">`title`</span>, <span class="string">`category`</span>) <span class="keyword">VALUES</span></span><br><span class="line">    (<span class="number">1</span>, <span class="string">'Java Concurrency'</span>, <span class="string">'Java'</span>),</span><br><span class="line">    (<span class="number">2</span>, <span class="string">'Hibernate HQL '</span>, <span class="string">'Hibernate'</span>),</span><br><span class="line">    (<span class="number">3</span>, <span class="string">'Spring MVC with Hibernate'</span>, <span class="string">'Spring'</span>);</span><br></pre></td></tr></table></figure>

<p>注意，Hibernate可以根据实体类自动创建表，本篇我不介绍这个功能，还是手动创建表结构。</p>
<h2 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h2><p>数据库创建好后，修改application.yml配置文件，新增如下数据库连接配置：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment">###################  spring配置  ###################</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">jpa:</span></span><br><span class="line">    <span class="attr">properties:</span></span><br><span class="line">      <span class="attr">hibernate:</span></span><br><span class="line">        <span class="attr">dialect:</span> <span class="string">org.hibernate.dialect.MySQLDialect</span></span><br><span class="line">        <span class="attr">new_generator_mappings:</span> <span class="literal">false</span></span><br><span class="line">        <span class="attr">format_sql:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/pos?serverTimezone=UTC&amp;useSSL=false&amp;autoReconnect=true&amp;tinyInt1isBit=false&amp;useUnicode=true&amp;characterEncoding=utf8</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">      <span class="attr">password:</span> <span class="number">123456</span></span><br></pre></td></tr></table></figure>

<h2 id="实体类"><a href="#实体类" class="headerlink" title="实体类"></a>实体类</h2><p>article表对应的实体类如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Table</span>(name = <span class="string">"articles"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Article</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue</span>(strategy = GenerationType.AUTO)</span><br><span class="line">    <span class="meta">@Column</span>(name = <span class="string">"article_id"</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> articleId;</span><br><span class="line">    <span class="meta">@Column</span>(name = <span class="string">"title"</span>)</span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line">    <span class="meta">@Column</span>(name = <span class="string">"category"</span>)</span><br><span class="line">    <span class="keyword">private</span> String category;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 省略getter/setter</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="DAO设计"><a href="#DAO设计" class="headerlink" title="DAO设计"></a>DAO设计</h2><p>先创建一个DAO的接口类：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IArticleDAO</span> </span>&#123;</span><br><span class="line">    <span class="function">List&lt;Article&gt; <span class="title">getAllArticles</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Article <span class="title">getArticleById</span><span class="params">(<span class="keyword">int</span> articleId)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addArticle</span><span class="params">(Article article)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">updateArticle</span><span class="params">(Article article)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">deleteArticle</span><span class="params">(<span class="keyword">int</span> articleId)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">articleExists</span><span class="params">(String title, String category)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后写一个实现类，在这类中注入<code>EntityManager</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArticleDAO</span> <span class="keyword">implements</span> <span class="title">IArticleDAO</span> </span>&#123;</span><br><span class="line">    <span class="meta">@PersistenceContext</span></span><br><span class="line">    <span class="keyword">private</span> EntityManager entityManager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Article <span class="title">getArticleById</span><span class="params">(<span class="keyword">int</span> articleId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> entityManager.find(Article<span class="class">.<span class="keyword">class</span>, <span class="title">articleId</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Article&gt; <span class="title">getAllArticles</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String hql = <span class="string">"FROM Article as atcl ORDER BY atcl.articleId"</span>;</span><br><span class="line">        <span class="keyword">return</span> (List&lt;Article&gt;) entityManager.createQuery(hql).getResultList();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addArticle</span><span class="params">(Article article)</span> </span>&#123;</span><br><span class="line">        entityManager.persist(article);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateArticle</span><span class="params">(Article article)</span> </span>&#123;</span><br><span class="line">        Article artcl = getArticleById(article.getArticleId());</span><br><span class="line">        artcl.setTitle(article.getTitle());</span><br><span class="line">        artcl.setCategory(article.getCategory());</span><br><span class="line">        entityManager.flush();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteArticle</span><span class="params">(<span class="keyword">int</span> articleId)</span> </span>&#123;</span><br><span class="line">        entityManager.remove(getArticleById(articleId));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">articleExists</span><span class="params">(String title, String category)</span> </span>&#123;</span><br><span class="line">        String hql = <span class="string">"FROM Article as atcl WHERE atcl.title = ? and atcl.category = ?"</span>;</span><br><span class="line">        <span class="keyword">int</span> count = entityManager.createQuery(hql).setParameter(<span class="number">0</span>, title)</span><br><span class="line">                .setParameter(<span class="number">1</span>, category).getResultList().size();</span><br><span class="line">        <span class="keyword">return</span> count &gt; <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="业务Service"><a href="#业务Service" class="headerlink" title="业务Service"></a>业务Service</h2><p>编写业务逻辑Service类，注入DAO类：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArticleService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> IArticleDAO articleDAO;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Article <span class="title">getArticleById</span><span class="params">(<span class="keyword">int</span> articleId)</span> </span>&#123;</span><br><span class="line">        Article obj = articleDAO.getArticleById(articleId);</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Article&gt; <span class="title">getAllArticles</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> articleDAO.getAllArticles();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">boolean</span> <span class="title">addArticle</span><span class="params">(Article article)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (articleDAO.articleExists(article.getTitle(), article.getCategory())) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            articleDAO.addArticle(article);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateArticle</span><span class="params">(Article article)</span> </span>&#123;</span><br><span class="line">        articleDAO.updateArticle(article);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteArticle</span><span class="params">(<span class="keyword">int</span> articleId)</span> </span>&#123;</span><br><span class="line">        articleDAO.deleteArticle(articleId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="编写测试用例"><a href="#编写测试用例" class="headerlink" title="编写测试用例"></a>编写测试用例</h2><p>OK，一切写完后，就来编写我们的测试用例：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">SpringBootTest</span></span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">ApplicationTests</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(ApplicationTests<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ArticleService articleService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 测试增删改查</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Article article = articleService.getArticleById(<span class="number">1</span>);</span><br><span class="line">        assertThat(article.getTitle(), is(<span class="string">"Java Concurrency"</span>));</span><br><span class="line"></span><br><span class="line">        List&lt;Article&gt; list = articleService.getAllArticles();</span><br><span class="line">        assertThat(list, notNullValue());</span><br><span class="line">        assertThat(list.size(), is(<span class="number">3</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> flag = articleService.addArticle(article);</span><br><span class="line">        assertThat(flag, is(<span class="keyword">false</span>));</span><br><span class="line"></span><br><span class="line">        article.setTitle(<span class="string">"Python Concurrency"</span>);</span><br><span class="line">        articleService.updateArticle(article);</span><br><span class="line">        Article article1 = articleService.getArticleById(<span class="number">1</span>);</span><br><span class="line">        assertThat(article1.getTitle(), is(<span class="string">"Python Concurrency"</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        articleService.deleteArticle(<span class="number">1</span>);</span><br><span class="line">        Article article2 = articleService.getArticleById(<span class="number">1</span>);</span><br><span class="line">        assertThat(article2, nullValue());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面先查询id=1的文章，看看标题是否为<code>Java Concurrency</code>，然后查询所有文章列表，之后更新文章标题后再次查询看看是否更新成功。 最后删除这篇文章，再次查询结果为null。</p>
<p>运行结果green bar，测试通过。</p>
<p>更多Hibernate相关文档，请参考 <a href="http://hibernate.org/" target="_blank" rel="noopener">官网</a> 。</p>
<h2 id="GitHub源码"><a href="#GitHub源码" class="headerlink" title="GitHub源码"></a>GitHub源码</h2><p><a href="https://github.com/yidao620c/SpringBootBucket/tree/master/springboot-hibernate" target="_blank" rel="noopener">springboot-hibernate</a></p>
<h2 id="来源"><a href="#来源" class="headerlink" title="来源"></a>来源</h2><p><a href="https://www.xncoding.com/" target="_blank" rel="noopener">https://www.xncoding.com/</a></p>
]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>springboot</tag>
        <tag>hibernate</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot系列 - 集成Echarts导出图片</title>
    <url>/2020/06/08/SpringBoot%E7%B3%BB%E5%88%97-%E9%9B%86%E6%88%90Echarts%E5%AF%BC%E5%87%BA%E5%9B%BE%E7%89%87/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><h1 id="SpringBoot系列-集成Echarts导出图片"><a href="#SpringBoot系列-集成Echarts导出图片" class="headerlink" title="SpringBoot系列 - 集成Echarts导出图片"></a>SpringBoot系列 - 集成Echarts导出图片</h1><p>Echarts是百度一款开源可视化图表库，基于html5 Canvas的。能够快速让你看到漂亮的效果。也是百度开源产品中的良心之作。</p>
<p>有时候在Java程序中也需要导出好看的图表，比如我经常会基于JMH做各种微基准测试，想将测试结果可视化导出为图表形式。 试用了一下JFreeChart，跟Echarts导出的图比起来还是弱了不少。但是Echarts是基于js的，只能在浏览器中解析和导出图片，怎么办呢？</p>
<p>后来我想到一个方法，就是基于WebSocket技术，服务器将图表数据推送到页面，然后页面再触发导出动作。 本篇将介绍如何通过SpringBoot、SocketIO、Echarts技术来实现这个图表导出功能。</p>
<p>大致步骤是这样的：</p>
<ol>
<li>编写一个RESTful API接口，用来接收生成图表需要的数据，然后向页面推送<code>导出图片</code>的消息请求。</li>
<li>编写一个WebSocket接口，接收Base64格式的图片编码，然后将其转换为图片保存到磁盘上</li>
<li>启动应用后打开websocket服务端，并监听页面发送的<code>Echarts图片导出</code>消息</li>
<li>打开页面，自动连接上websocket服务器，并监听<code>导出图片</code>的消息请求，收到消息后发送<code>Echarts图片导出</code>消息</li>
<li>后面就可以调用这个RESTful API接口来讲数据可视化为Echarts图片并保存了。</li>
</ol>
<p>我曾经尝试过，Java程序通过phantomjs启动浏览器打开页面，最后导出来的图片有1.5M，而直接用浏览器打开后导出大小只有50K， 所以放弃了phantomjs方案。</p>
<h2 id="maven依赖"><a href="#maven依赖" class="headerlink" title="maven依赖"></a>maven依赖</h2><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.reporting.outputEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">netty.version</span>&gt;</span>4.1.19.Final<span class="tag">&lt;/<span class="name">netty.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">thymeleaf.version</span>&gt;</span>3.0.7.RELEASE<span class="tag">&lt;/<span class="name">thymeleaf.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">thymeleaf-layout-dialect.version</span>&gt;</span>2.2.2<span class="tag">&lt;/<span class="name">thymeleaf-layout-dialect.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">jmh.version</span>&gt;</span>1.20<span class="tag">&lt;/<span class="name">jmh.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-tomcat<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jetty<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-lang3<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.7<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-io<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-codec<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-codec<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.11<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.hamcrest<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hamcrest-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- netty-socketio--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.corundumstudio.socketio<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>netty-socketio<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.13<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.netty<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>netty-buffer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;netty.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.netty<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>netty-codec<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;netty.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.netty<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>netty-codec-http<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;netty.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.netty<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>netty-common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;netty.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.netty<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>netty-handler<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;netty.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.netty<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>netty-resolver<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;netty.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.netty<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>netty-transport<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;netty.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.netty<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>netty-transport-native-epoll<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;netty.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.netty<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>netty-transport-native-unix-common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;netty.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.socket<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>socket.io-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><p>修改application.yml，配置web端口、socket服务端口、图片保存路径等：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment">###################  自定义项目配置 ###################</span></span><br><span class="line"><span class="attr">xncoding:</span></span><br><span class="line">  <span class="attr">socket-port:</span> <span class="number">9076</span>    <span class="comment">#socket端口</span></span><br><span class="line">  <span class="attr">ping-interval:</span> <span class="number">60000</span> <span class="comment">#Ping消息间隔（毫秒）</span></span><br><span class="line">  <span class="attr">ping-timeout:</span> <span class="number">180000</span> <span class="comment">#Ping消息超时时间（毫秒）</span></span><br><span class="line">  <span class="attr">image-dir:</span> <span class="string">E:/pics/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">###################  项目启动端口  ###################</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9075</span></span><br><span class="line">  <span class="attr">jetty:</span></span><br><span class="line">    <span class="attr">max-http-post-size:</span> <span class="number">20000000</span></span><br></pre></td></tr></table></figure>

<h2 id="WebSocket服务"><a href="#WebSocket服务" class="headerlink" title="WebSocket服务"></a>WebSocket服务</h2><p>基于Socket.IO来实现WebSocket服务，关于这个我专门写了一篇博客：<a href="https://www.xncoding.com/2017/07/16/spring/sb-socketio.html" target="_blank" rel="noopener">集成SocketIO实时通信</a></p>
<p>这里我不再多讲怎么集成，我只贴一下监听方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 保存客户端传来的图片数据</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> client     客户端</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ackRequest 回执消息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> imgData    Base64的图形数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@OnEvent</span>(value = <span class="string">"savePic"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSavePic</span><span class="params">(SocketIOClient client, AckRequest ackRequest, String imgData)</span> </span>&#123;</span><br><span class="line">    logger.info(<span class="string">"保存客户端传来的图片数据 start, sessionId="</span> + client.getSessionId().toString());</span><br><span class="line">    String r = apiService.saveBase64Pic(imgData);</span><br><span class="line">    logger.info(<span class="string">"保存客户端传来的图片 = &#123;&#125;"</span>, r);</span><br><span class="line">    ackRequest.sendAckData(<span class="string">"图片保存结果="</span> + r);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里WebSocket服务器会监听消息<code>savePic</code>，参数为Base64的图形数据，然后将其保存到磁盘上面。</p>
<h2 id="Echarts配置类"><a href="#Echarts配置类" class="headerlink" title="Echarts配置类"></a>Echarts配置类</h2><p>Echarts可以到处非常多类型的图表，每个图表初始化需要一个特定json对象，里面的配置不一样。我使用了其中的一种用来显示性能测试对比的纵向柱状图。 然后需要编写这个配置对象，包括各个内嵌对象，具体我就不贴出来了，参考最后面的github源码。</p>
<h2 id="图片导出接口"><a href="#图片导出接口" class="headerlink" title="图片导出接口"></a>图片导出接口</h2><p>接下来编写对外开放的图片导出RESTful API接口：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 对外API接口类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/api/v1"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PublicController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ApiService apiService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger _logger = LoggerFactory.getLogger(PublicController<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/data"</span>, method = RequestMethod.POST)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity&lt;BaseResponse&gt; <span class="title">doJoin</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        _logger.info(<span class="string">"数据上传消息push接口 start...."</span>);</span><br><span class="line">        String jsonBody = IOUtils.toString(request.getInputStream(), Charset.forName(<span class="string">"UTF-8"</span>));</span><br><span class="line">        EchartsData echartsData = <span class="keyword">new</span> EchartsData(<span class="string">""</span>, jsonBody);</span><br><span class="line">        String jsonString = <span class="keyword">new</span> ObjectMapper().writeValueAsString(echartsData);</span><br><span class="line">        apiService.pushMsg(<span class="string">"notify"</span>, jsonString);</span><br><span class="line">        BaseResponse result = <span class="keyword">new</span> BaseResponse&lt;&gt;(<span class="keyword">true</span>, <span class="string">"数据上传消息push成功"</span>, <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResponseEntity&lt;&gt;(result, HttpStatus.OK);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的pushMsg方法定义：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 服务器主动推送消息</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> msgType 消息类型</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> jsonData echarts图表数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pushMsg</span><span class="params">(String msgType, String jsonData)</span> </span>&#123;</span><br><span class="line">    SocketIOClient targetClient = <span class="keyword">this</span>.server.getClient(UUID.fromString(sessionId));</span><br><span class="line">    <span class="keyword">if</span> (targetClient == <span class="keyword">null</span>) &#123;</span><br><span class="line">        logger.error(<span class="string">"sessionId="</span> + sessionId + <span class="string">"在server中获取不到client"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        targetClient.sendEvent(msgType, jsonData);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务器将数据转换成echarts的配置json字符串后，就给浏览器推送一个<code>notify</code>的消息。</p>
<h2 id="页面客户端"><a href="#页面客户端" class="headerlink" title="页面客户端"></a>页面客户端</h2><p>接下来编写js客户端来连接WebSocket服务，并监听<code>notify</code>的消息，在页面上生成Echarts图表后， 再给服务器发送一个<code>savePic</code>的消息，并把图表的Base64编码数据传过去。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">xmlns</span>=<span class="string">"http://www.w3.org/1999/xhtml"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">xmlns:th</span>=<span class="string">"http://www.thymeleaf.org"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"renderer"</span> <span class="attr">content</span>=<span class="string">"webkit"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Echarts Demo<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"shortcut icon"</span> <span class="attr">th:href</span>=<span class="string">"@&#123;/favicon.ico&#125;"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">th:href</span>=<span class="string">"@&#123;/static/css/bootstrap.css&#125;"</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line">        body &#123;</span><br><span class="line">            padding: 20px;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-id">#console</span> &#123;</span></span><br><span class="line">            height: 100px;</span><br><span class="line">            overflow: auto;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.connect-msg</span> &#123;</span></span><br><span class="line">            color: green;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.disconnect-msg</span> &#123;</span></span><br><span class="line">            color: red;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.send-msg</span> &#123;</span></span><br><span class="line"><span class="css">            <span class="selector-tag">color</span>: <span class="selector-id">#888</span></span></span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Netty-socketio Demo Chat<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"console"</span> <span class="attr">class</span>=<span class="string">"well"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 为 ECharts 准备一个具备大小（宽高）的 DOM --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"main"</span> <span class="attr">style</span>=<span class="string">"width:860px; height:470px;"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">class</span>=<span class="string">"well form-inline"</span> <span class="attr">onsubmit</span>=<span class="string">"return false;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"msg"</span> <span class="attr">class</span>=<span class="string">"input-xlarge"</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">placeholder</span>=<span class="string">"Type something..."</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">onClick</span>=<span class="string">"sendDisconnect()"</span> <span class="attr">class</span>=<span class="string">"btn"</span>&gt;</span>Disconnect<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">onClick</span>=<span class="string">"sendSavePic()"</span> <span class="attr">class</span>=<span class="string">"btn"</span>&gt;</span>Save Picture<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">th:src</span>=<span class="string">"@&#123;/static/js/jquery-1.10.1.min.js&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">th:src</span>=<span class="string">"@&#123;/static/js/socket.io.js&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">th:src</span>=<span class="string">"@&#123;/static/js/moment.min.js&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">th:src</span>=<span class="string">"@&#123;/static/js/echarts.common.min.js&#125;"</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">var</span> socket;</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">var</span> myChart;</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">sendDisconnect</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line">        socket.disconnect();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">output</span><span class="params">(message)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> currentTime = <span class="string">"&lt;span class='time'&gt;"</span> + moment().format(<span class="string">'HH:mm:ss.SSS'</span>) + <span class="string">"&lt;/span&gt;"</span>;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> element = $(<span class="string">"&lt;div&gt;"</span> + currentTime + <span class="string">" "</span> + message + <span class="string">"&lt;/div&gt;"</span>);</span></span><br><span class="line"><span class="javascript">        $(<span class="string">'#console'</span>).prepend(element);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">sendSavePic</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">        socket.emit(<span class="string">'savePic'</span>, myChart.getDataURL(), <span class="function"><span class="keyword">function</span> <span class="params">(result)</span> </span>&#123;</span></span><br><span class="line"><span class="handlebars"><span class="xml">            output('<span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"connect-msg"</span>&gt;</span>' + result + '<span class="tag">&lt;/<span class="name">span</span>&gt;</span>');</span></span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">initPage</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(<span class="string">'this is index.html log...'</span>);</span></span><br><span class="line"></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> userName = <span class="string">'user'</span> + <span class="built_in">Math</span>.floor((<span class="built_in">Math</span>.random() * <span class="number">1000</span>) + <span class="number">1</span>);</span></span><br><span class="line"><span class="actionscript">        socket = io.connect(<span class="string">'http://localhost:9076'</span>);</span></span><br><span class="line"></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(<span class="string">'socket = '</span> + socket);</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">        socket.on(<span class="string">'connect'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(<span class="string">'connect successful'</span>);</span></span><br><span class="line"><span class="handlebars"><span class="xml">            output('<span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"connect-msg"</span>&gt;</span>Client has connected to the server!<span class="tag">&lt;/<span class="name">span</span>&gt;</span>');</span></span></span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line"><span class="actionscript">        socket.on(<span class="string">'disconnect'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(<span class="string">'disconnect successful'</span>);</span></span><br><span class="line"><span class="handlebars"><span class="xml">            output('<span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"disconnect-msg"</span>&gt;</span>The client has disconnected!<span class="tag">&lt;/<span class="name">span</span>&gt;</span>');</span></span></span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line"><span class="actionscript">        socket.on(<span class="string">'notify'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(jsonBody)</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(<span class="string">'get notify message from server...'</span>);</span></span><br><span class="line"><span class="javascript">            <span class="keyword">var</span> msg = <span class="built_in">JSON</span>.parse(jsonBody);</span></span><br><span class="line"><span class="handlebars"><span class="xml">            output('<span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"connect-msg"</span>&gt;</span>接收到notify消息, 去给我保存图片<span class="tag">&lt;/<span class="name">span</span>&gt;</span>');</span></span></span><br><span class="line"><span class="actionscript">            <span class="keyword">var</span> option = msg.option;</span></span><br><span class="line"><span class="actionscript">            <span class="comment">// 使用刚指定的配置项和数据显示图表。</span></span></span><br><span class="line"><span class="javascript">            myChart.setOption(<span class="built_in">JSON</span>.parse(option));</span></span><br><span class="line"><span class="actionscript">            <span class="comment">// 渲染完成之后再给服务器发送保存图片消息</span></span></span><br><span class="line">            sendSavePic();</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line"><span class="actionscript">        <span class="comment">/**************************************分割线***********************************/</span></span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 基于准备好的dom，初始化echarts实例</span></span></span><br><span class="line"><span class="javascript">        myChart = echarts.init(<span class="built_in">document</span>.getElementById(<span class="string">'main'</span>));</span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(<span class="string">'index initPage finished!'</span>)</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="javascript">    $(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span></span><br><span class="line">        initPage();</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>编写测试类：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationTests</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testOption</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String titleStr = <span class="string">"对象序列化为JSON字符串"</span>;</span><br><span class="line">        <span class="comment">// 几个测试对象</span></span><br><span class="line">        List&lt;String&gt; objects = Arrays.asList(<span class="string">"FastJson"</span>, <span class="string">"Jackson"</span>, <span class="string">"Gson"</span>, <span class="string">"Json-lib"</span>);</span><br><span class="line">        <span class="comment">// 测试维度，输入值n</span></span><br><span class="line">        List&lt;String&gt; dimensions = Arrays.asList(<span class="string">"10000次"</span>, <span class="string">"100000次"</span>, <span class="string">"1000000次"</span>);</span><br><span class="line">        <span class="comment">// 有几个测试对象，就有几组测试数据，每组测试数据中对应几个维度的结果</span></span><br><span class="line">        List&lt;List&lt;Double&gt;&gt; allData = <span class="keyword">new</span> ArrayList&lt;List&lt;Double&gt;&gt;()&#123;</span><br><span class="line">            &#123;</span><br><span class="line">               add(Arrays.asList(<span class="number">2.17</span>, <span class="number">9.10</span>, <span class="number">21.70</span>));</span><br><span class="line">               add(Arrays.asList(<span class="number">1.94</span>, <span class="number">8.94</span>, <span class="number">19.43</span>));</span><br><span class="line">               add(Arrays.asList(<span class="number">4.88</span>, <span class="number">22.88</span>, <span class="number">48.89</span>));</span><br><span class="line">               add(Arrays.asList(<span class="number">9.11</span>, <span class="number">58.14</span>, <span class="number">108.44</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        String optionStr = generateOption(titleStr, objects, dimensions, allData, <span class="string">"秒"</span>);</span><br><span class="line">        <span class="comment">// POST到接口上</span></span><br><span class="line">        postOption(optionStr, <span class="string">"http://localhost:9075/api/v1/data"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>一切准备就绪后，就可以开始测试了，步骤如下：</p>
<ol>
<li>启动应用</li>
<li>打开首页 <a href="http://localhost:9075/" target="_blank" rel="noopener">http://localhost:9075/</a></li>
<li>运行测试类<code>ApplicationTests.java</code></li>
</ol>
<p>结果首页显示如下：</p>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="assets/1591544602-086fbf54631f3fd9a592d984fdb20482.png" alt=""></p>
<p>同时去<code>E:/pics/</code>目录去看看，图片也成功保存。</p>
<h2 id="GitHub源码"><a href="#GitHub源码" class="headerlink" title="GitHub源码"></a>GitHub源码</h2><p><a href="https://github.com/yidao620c/SpringBootBucket/tree/master/springboot-echarts" target="_blank" rel="noopener">springboot-echarts</a>   –已测试</p>
<h2 id="来源"><a href="#来源" class="headerlink" title="来源"></a>来源</h2><p><a href="https://www.xncoding.com/" target="_blank" rel="noopener">https://www.xncoding.com/</a></p>
]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>springboot</tag>
        <tag>echarts</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot系列 - 集成JWT实现接口权限认证</title>
    <url>/2020/06/08/SpringBoot%E7%B3%BB%E5%88%97-%E9%9B%86%E6%88%90JWT%E5%AE%9E%E7%8E%B0%E6%8E%A5%E5%8F%A3%E6%9D%83%E9%99%90%E8%AE%A4%E8%AF%81/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><h1 id="SpringBoot系列-集成JWT实现接口权限认证"><a href="#SpringBoot系列-集成JWT实现接口权限认证" class="headerlink" title="SpringBoot系列 - 集成JWT实现接口权限认证"></a>SpringBoot系列 - 集成JWT实现接口权限认证</h1><p>一般来讲，对于RESTful API都会有认证(Authentication)和授权(Authorization)过程，保证API的安全性。</p>
<p>Authentication指的是确定这个用户的身份，Authorization是确定该用户拥有什么操作权限。</p>
<p>认证方式一般有三种</p>
<p><em>Basic Authentication</em></p>
<p>这种方式是直接将用户名和密码放到Header中，使用<code>Authorization: Basic Zm9vOmJhcg==</code>，使用最简单但是最不安全。</p>
<p><em>TOKEN认证</em></p>
<p>这种方式也是再HTTP头中，使用<code>Authorization: Bearer &lt;token&gt;</code>，使用最广泛的TOKEN是JWT，通过签名过的TOKEN。</p>
<p><em>OAuth2.0</em></p>
<p>这种方式安全等级最高，但是也是最复杂的。如果不是大型API平台或者需要给第三方APP使用的，没必要整这么复杂。</p>
<p>一般项目中的RESTful API使用JWT来做认证就足够了。</p>
<p>关于JWT的介绍请参考我的另一篇文章：<a href="https://www.xncoding.com/2017/06/22/security/jwt.html" target="_blank" rel="noopener">https://www.xncoding.com/2017/06/22/security/jwt.html</a></p>
<h2 id="SpringBoot集成JWT"><a href="#SpringBoot集成JWT" class="headerlink" title="SpringBoot集成JWT"></a>SpringBoot集成JWT</h2><p>简要的说明下我们为什么要用JWT，因为我们要实现完全的前后端分离，所以不可能使用session，cookie的方式进行鉴权， 所以JWT就被派上了用场，可以通过一个加密密钥来进行前后端的鉴权。</p>
<p>程序逻辑:</p>
<ol>
<li>我们POST用户名与密码到/login进行登入，如果成功返回一个加密token，失败的话直接返回401错误。</li>
<li>之后用户访问每一个需要权限的网址请求必须在header中添加Authorization字段，例如Authorization: token，token为密钥。</li>
<li>后台会进行token的校验，如果不通过直接返回401。</li>
</ol>
<p>这里我讲一下如何在SpringBoot中使用JWT来做接口权限认证，安全框架依旧使用Shiro，JWT的实现使用 <a href="https://github.com/jwtk/jjwt" target="_blank" rel="noopener">jjwt</a></p>
<h3 id="添加Maven依赖"><a href="#添加Maven依赖" class="headerlink" title="添加Maven依赖"></a>添加Maven依赖</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-tomcat<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jetty<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.auth0<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>java-jwt<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- shiro 权限控制 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- shiro ehcache (shiro缓存)--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-ehcache<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="创建用户Service"><a href="#创建用户Service" class="headerlink" title="创建用户Service"></a>创建用户Service</h3><p>这个在shiro一节讲过如果创建角色权限表，添加用户Service来执行查找用户操作，这里就不多讲具体实现了，只列出关键代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 通过名称查找用户</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> username</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ManagerInfo <span class="title">findByUsername</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">    ManagerInfo managerInfo = managerInfoDao.findByUsername(username);</span><br><span class="line">    <span class="keyword">if</span> (managerInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnknownAccountException();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> managerInfo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>用户信息类：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ManagerInfo</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 主键ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 账号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 密码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * md5密码盐</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String salt;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 一个管理员具有多个角色</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;SysRole&gt; roles;</span><br></pre></td></tr></table></figure>

<h3 id="JWT工具类"><a href="#JWT工具类" class="headerlink" title="JWT工具类"></a>JWT工具类</h3><p>我们写一个简单的JWT加密，校验工具，并且使用用户自己的密码充当加密密钥， 这样保证了token 即使被他人截获也无法破解。并且我们在token中附带了username信息，并且设置密钥5分钟就会过期。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JWTUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(JWTUtil<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 过期时间5分钟</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> EXPIRE_TIME = <span class="number">5</span> * <span class="number">60</span> * <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成签名,5min后过期</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> username 用户名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> secret   用户的密码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 加密的token</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">sign</span><span class="params">(String username, String secret)</span> </span>&#123;</span><br><span class="line">        Date date = <span class="keyword">new</span> Date(System.currentTimeMillis() + EXPIRE_TIME);</span><br><span class="line">        Algorithm algorithm = Algorithm.HMAC256(secret);</span><br><span class="line">        <span class="comment">// 附带username信息</span></span><br><span class="line">        <span class="keyword">return</span> JWT.create()</span><br><span class="line">                .withClaim(<span class="string">"username"</span>, username)</span><br><span class="line">                .withExpiresAt(date)</span><br><span class="line">                .sign(algorithm);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 校验token是否正确</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> token  密钥</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> secret 用户的密码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 是否正确</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">verify</span><span class="params">(String token, String username, String secret)</span> </span>&#123;</span><br><span class="line">        Algorithm algorithm = Algorithm.HMAC256(secret);</span><br><span class="line">        JWTVerifier verifier = JWT.require(algorithm)</span><br><span class="line">                .withClaim(<span class="string">"username"</span>, username)</span><br><span class="line">                .build();</span><br><span class="line">        DecodedJWT jwt = verifier.verify(token);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获得token中的信息无需secret解密也能获得</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> token中包含的用户名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getUsername</span><span class="params">(String token)</span> </span>&#123;</span><br><span class="line">        DecodedJWT jwt = JWT.decode(token);</span><br><span class="line">        <span class="keyword">return</span> jwt.getClaim(<span class="string">"username"</span>).asString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="编写登录接口"><a href="#编写登录接口" class="headerlink" title="编写登录接口"></a>编写登录接口</h3><p>为了让用户登录的时候获取到正确的JWT Token，需要实现登录接口，这里我编写一个<code>LoginController.java</code>：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 登录接口类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ManagerInfoService managerInfoService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger _logger = LoggerFactory.getLogger(LoginController<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/login"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> BaseResponse&lt;String&gt; <span class="title">login</span><span class="params">(@RequestHeader(name=<span class="string">"Content-Type"</span>, defaultValue = <span class="string">"application/json"</span>)</span> String contentType,</span></span><br><span class="line"><span class="function">                                      @RequestBody LoginParam loginParam) </span>&#123;</span><br><span class="line">        _logger.info(<span class="string">"用户请求登录获取Token"</span>);</span><br><span class="line">        String username = loginParam.getUsername();</span><br><span class="line">        String password = loginParam.getPassword();</span><br><span class="line">        ManagerInfo user = managerInfoService.findByUsername(username);</span><br><span class="line">        <span class="comment">//随机数盐</span></span><br><span class="line">        String salt = user.getSalt();</span><br><span class="line">        <span class="comment">//原密码加密（通过username + salt作为盐）</span></span><br><span class="line">        String encodedPassword = ShiroKit.md5(password, username + salt);</span><br><span class="line">        <span class="keyword">if</span> (user.getPassword().equals(encodedPassword)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> BaseResponse&lt;&gt;(<span class="keyword">true</span>, <span class="string">"Login success"</span>, JWTUtil.sign(username, encodedPassword));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UnauthorizedException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意上面登录的时候，我会从数据库中把这个用户取出来，密码加盐算MD5值比较，通过之后再用密码作为密钥来签名生成JWT。</p>
<h3 id="编写RESTful接口"><a href="#编写RESTful接口" class="headerlink" title="编写RESTful接口"></a>编写RESTful接口</h3><p>先编写一个通用的接口返回类：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * API接口的基础返回类</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> XiongNeng</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2018/1/7</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseResponse</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否成功</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> success;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 说明</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String msg;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> T data;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BaseResponse</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BaseResponse</span><span class="params">(<span class="keyword">boolean</span> success, String msg, T data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.success = success;</span><br><span class="line">        <span class="keyword">this</span>.msg = msg;</span><br><span class="line">        <span class="keyword">this</span>.data = data;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过SpringMVC实现RESTful接口，这里我只写一个示例方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 机具管理API接口类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/api/v1"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PublicController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger _logger = LoggerFactory.getLogger(PublicController<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 入网绑定查询接口</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 是否入网</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/join"</span>, method = RequestMethod.GET)</span><br><span class="line">    <span class="meta">@RequiresAuthentication</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> BaseResponse <span class="title">join</span><span class="params">(@RequestParam(<span class="string">"imei"</span>)</span> String imei) </span>&#123;</span><br><span class="line">        _logger.info(<span class="string">"入网查询接口 start... imei="</span> + imei);</span><br><span class="line">        BaseResponse result = <span class="keyword">new</span> BaseResponse();</span><br><span class="line">        result.setSuccess(<span class="keyword">true</span>);</span><br><span class="line">        result.setMsg(<span class="string">"已入网并绑定了网点"</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="自定义异常"><a href="#自定义异常" class="headerlink" title="自定义异常"></a>自定义异常</h3><p>为了实现我自己能够手动抛出异常，我自己写了一个<code>UnauthorizedException.java</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UnauthorizedException</span> <span class="keyword">extends</span> <span class="title">RuntimeException</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UnauthorizedException</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UnauthorizedException</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="处理框架异常"><a href="#处理框架异常" class="headerlink" title="处理框架异常"></a>处理框架异常</h3><p>之前说过restful要统一返回的格式，所以我们也要全局处理Spring Boot的抛出异常。利用@RestControllerAdvice能很好的实现。 注意这个统一异常处理器只对认证过的用户调用接口中的异常有作用，对AuthenticationException没有用</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExceptionController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 捕捉shiro的异常</span></span><br><span class="line">    <span class="meta">@ResponseStatus</span>(HttpStatus.UNAUTHORIZED)</span><br><span class="line">    <span class="meta">@ExceptionHandler</span>(ShiroException<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">BaseResponse</span> <span class="title">handle401</span>(<span class="title">ShiroException</span> <span class="title">e</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BaseResponse(<span class="keyword">false</span>, <span class="string">"shiro的异常"</span>, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 捕捉UnauthorizedException</span></span><br><span class="line">    <span class="meta">@ResponseStatus</span>(HttpStatus.UNAUTHORIZED)</span><br><span class="line">    <span class="meta">@ExceptionHandler</span>(UnauthorizedException<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">BaseResponse</span> <span class="title">handle401</span>() </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BaseResponse(<span class="keyword">false</span>, <span class="string">"UnauthorizedException"</span>, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 捕捉其他所有异常</span></span><br><span class="line">    <span class="meta">@ExceptionHandler</span>(Exception<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    @<span class="title">ResponseStatus</span>(<span class="title">HttpStatus</span>.<span class="title">BAD_REQUEST</span>)</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">BaseResponse</span> <span class="title">globalException</span>(<span class="title">HttpServletRequest</span> <span class="title">request</span>, <span class="title">Throwable</span> <span class="title">ex</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BaseResponse(<span class="keyword">false</span>, <span class="string">"其他异常"</span>, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> HttpStatus <span class="title">getStatus</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        Integer statusCode = (Integer) request.getAttribute(<span class="string">"javax.servlet.error.status_code"</span>);</span><br><span class="line">        <span class="keyword">if</span> (statusCode == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> HttpStatus.INTERNAL_SERVER_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> HttpStatus.valueOf(statusCode);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="配置Shiro"><a href="#配置Shiro" class="headerlink" title="配置Shiro"></a>配置Shiro</h3><p>大家可以先看下官方的 <a href="http://shiro.apache.org/spring.html" target="_blank" rel="noopener">Spring-Shiro</a> 整合教程，有个初步的了解。 不过既然我们用了SpringBoot，那我们肯定要争取零配置文件。</p>
<p><em>实现JWTToken</em></p>
<p>JWTToken差不多就是Shiro用户名密码的载体。因为我们是前后端分离，服务器无需保存用户状态，所以不需要RememberMe这类功能， 我们简单的实现下AuthenticationToken接口即可。因为token自己已经包含了用户名等信息，所以这里我就弄了一个字段。 如果你喜欢钻研，可以看看官方的UsernamePasswordToken是如何实现的。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JWTToken</span> <span class="keyword">implements</span> <span class="title">AuthenticationToken</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 密钥</span></span><br><span class="line">    <span class="keyword">private</span> String token;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JWTToken</span><span class="params">(String token)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.token = token;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getPrincipal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> token;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getCredentials</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> token;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><em>实现Realm</em></p>
<p>realm的用于处理用户是否合法的这一块，需要我们自己实现。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Description  : 身份校验核心类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyShiroRealm</span> <span class="keyword">extends</span> <span class="title">AuthorizingRealm</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger _logger = LoggerFactory.getLogger(MyShiroRealm<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    ManagerInfoService managerInfoService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * JWT签名密钥，这里没用。我使用的是用户的MD5密码作为签名密钥</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String SECRET = <span class="string">"9281e268b77b7c439a20b46fd1483b9a"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 必须重写此方法，不然Shiro会报错</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(AuthenticationToken token)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> token <span class="keyword">instanceof</span> JWTToken;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 认证信息(身份验证)</span></span><br><span class="line"><span class="comment">     * Authentication 是用来验证用户身份</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> auth</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> AuthenticationException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> AuthenticationInfo <span class="title">doGetAuthenticationInfo</span><span class="params">(AuthenticationToken auth)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">        _logger.info(<span class="string">"MyShiroRealm.doGetAuthenticationInfo()"</span>);</span><br><span class="line"></span><br><span class="line">        String token = (String) auth.getCredentials();</span><br><span class="line">        <span class="comment">// 解密获得username，用于和数据库进行对比</span></span><br><span class="line">        String username = JWTUtil.getUsername(token);</span><br><span class="line">        <span class="keyword">if</span> (username == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AuthenticationException(<span class="string">"token invalid"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//通过username从数据库中查找 ManagerInfo对象</span></span><br><span class="line">        <span class="comment">//实际项目中，这里可以根据实际情况做缓存，如果不做，Shiro自己也是有时间间隔机制，2分钟内不会重复执行该方法</span></span><br><span class="line">        ManagerInfo managerInfo = managerInfoService.findByUsername(username);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (managerInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AuthenticationException(<span class="string">"User didn't existed!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!JWTUtil.verify(token, username, managerInfo.getPassword())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AuthenticationException(<span class="string">"Username or password error"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SimpleAuthenticationInfo(token, token, <span class="string">"my_realm"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 此方法调用hasRole,hasPermission的时候才会进行回调.</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * 权限信息.(授权):</span></span><br><span class="line"><span class="comment">     * 1、如果用户正常退出，缓存自动清空；</span></span><br><span class="line"><span class="comment">     * 2、如果用户非正常退出，缓存自动清空；</span></span><br><span class="line"><span class="comment">     * 3、如果我们修改了用户的权限，而用户不退出系统，修改的权限无法立即生效。</span></span><br><span class="line"><span class="comment">     * （需要手动编程进行实现；放在service进行调用）</span></span><br><span class="line"><span class="comment">     * 在权限修改后调用realm中的方法，realm已经由spring管理，所以从spring中获取realm实例，调用clearCached方法；</span></span><br><span class="line"><span class="comment">     * :Authorization 是授权访问控制，用于对用户进行的操作授权，证明该用户是否允许进行当前操作，如访问某个链接，某个资源文件等。</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> principals</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> AuthorizationInfo <span class="title">doGetAuthorizationInfo</span><span class="params">(PrincipalCollection principals)</span> </span>&#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 当没有使用缓存的时候，不断刷新页面的话，这个代码会不断执行，</span></span><br><span class="line"><span class="comment">         * 当其实没有必要每次都重新设置权限信息，所以我们需要放到缓存中进行管理；</span></span><br><span class="line"><span class="comment">         * 当放到缓存中时，这样的话，doGetAuthorizationInfo就只会执行一次了，</span></span><br><span class="line"><span class="comment">         * 缓存过期之后会再次执行。</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        _logger.info(<span class="string">"权限配置--&gt;MyShiroRealm.doGetAuthorizationInfo()"</span>);</span><br><span class="line">        String username = JWTUtil.getUsername(principals.toString());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 下面的可以使用缓存提升速度</span></span><br><span class="line">        ManagerInfo managerInfo = managerInfoService.findByUsername(username);</span><br><span class="line"></span><br><span class="line">        SimpleAuthorizationInfo authorizationInfo = <span class="keyword">new</span> SimpleAuthorizationInfo();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置相应角色的权限信息</span></span><br><span class="line">        <span class="keyword">for</span> (SysRole role : managerInfo.getRoles()) &#123;</span><br><span class="line">            <span class="comment">//设置角色</span></span><br><span class="line">            authorizationInfo.addRole(role.getRole());</span><br><span class="line">            <span class="keyword">for</span> (Permission p : role.getPermissions()) &#123;</span><br><span class="line">                <span class="comment">//设置权限</span></span><br><span class="line">                authorizationInfo.addStringPermission(p.getPermission());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> authorizationInfo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>doGetAuthenticationInfo</code>中用户可以自定义抛出很多异常，详情见文档。</p>
<p><em>重写Filter</em></p>
<p>所有的请求都会先经过Filter，所以我们继承官方的<code>BasicHttpAuthenticationFilter</code>，并且重写鉴权的方法， 另外通过重写preHandle，实现跨越访问。</p>
<p>代码的执行流程<code>preHandle-&gt;isAccessAllowed-&gt;isLoginAttempt-&gt;executeLogin</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JWTFilter</span> <span class="keyword">extends</span> <span class="title">BasicHttpAuthenticationFilter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Logger LOGGER = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断用户是否想要登入。</span></span><br><span class="line"><span class="comment">     * 检测header里面是否包含Authorization字段即可</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isLoginAttempt</span><span class="params">(ServletRequest request, ServletResponse response)</span> </span>&#123;</span><br><span class="line">        HttpServletRequest req = (HttpServletRequest) request;</span><br><span class="line">        String authorization = req.getHeader(<span class="string">"Authorization"</span>);</span><br><span class="line">        <span class="keyword">return</span> authorization != <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">executeLogin</span><span class="params">(ServletRequest request, ServletResponse response)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        HttpServletRequest httpServletRequest = (HttpServletRequest) request;</span><br><span class="line">        String authorization = httpServletRequest.getHeader(<span class="string">"Authorization"</span>);</span><br><span class="line">        JWTToken token = <span class="keyword">new</span> JWTToken(authorization);</span><br><span class="line">        <span class="comment">// 提交给realm进行登入，如果错误他会抛出异常并被捕获</span></span><br><span class="line">        getSubject(request, response).login(token);</span><br><span class="line">        <span class="comment">// 如果没有抛出异常则代表登入成功，返回true</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 这里我们详细说明下为什么最终返回的都是true，即允许访问</span></span><br><span class="line"><span class="comment">     * 例如我们提供一个地址 GET /article</span></span><br><span class="line"><span class="comment">     * 登入用户和游客看到的内容是不同的</span></span><br><span class="line"><span class="comment">     * 如果在这里返回了false，请求会被直接拦截，用户看不到任何东西</span></span><br><span class="line"><span class="comment">     * 所以我们在这里返回true，Controller中可以通过 subject.isAuthenticated() 来判断用户是否登入</span></span><br><span class="line"><span class="comment">     * 如果有些资源只有登入用户才能访问，我们只需要在方法上面加上 <span class="doctag">@RequiresAuthentication</span> 注解即可</span></span><br><span class="line"><span class="comment">     * 但是这样做有一个缺点，就是不能够对GET,POST等请求进行分别过滤鉴权(因为我们重写了官方的方法)，但实际上对应用影响不大</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isAccessAllowed</span><span class="params">(ServletRequest request, ServletResponse response, Object mappedValue)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (isLoginAttempt(request, response)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                executeLogin(request, response);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                response401(request, response);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 对跨域提供支持</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(ServletRequest request, ServletResponse response)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        HttpServletRequest httpServletRequest = (HttpServletRequest) request;</span><br><span class="line">        HttpServletResponse httpServletResponse = (HttpServletResponse) response;</span><br><span class="line">        httpServletResponse.setHeader(<span class="string">"Access-control-Allow-Origin"</span>, httpServletRequest.getHeader(<span class="string">"Origin"</span>));</span><br><span class="line">        httpServletResponse.setHeader(<span class="string">"Access-Control-Allow-Methods"</span>, <span class="string">"GET,POST,OPTIONS,PUT,DELETE"</span>);</span><br><span class="line">        httpServletResponse.setHeader(<span class="string">"Access-Control-Allow-Headers"</span>, httpServletRequest.getHeader(<span class="string">"Access-Control-Request-Headers"</span>));</span><br><span class="line">        <span class="comment">// 跨域时会首先发送一个option请求，这里我们给option请求直接返回正常状态</span></span><br><span class="line">        <span class="keyword">if</span> (httpServletRequest.getMethod().equals(RequestMethod.OPTIONS.name())) &#123;</span><br><span class="line">            httpServletResponse.setStatus(HttpStatus.OK.value());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.preHandle(request, response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将非法请求跳转到 /401</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">response401</span><span class="params">(ServletRequest req, ServletResponse resp)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            HttpServletResponse httpServletResponse = (HttpServletResponse) resp;</span><br><span class="line">            httpServletResponse.sendRedirect(<span class="string">"/401"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            LOGGER.error(e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><em>编写ShiroConfig配置类</em></p>
<p>这里我还增加了EhCache缓存管理支持，不需要每次都调用数据库做授权。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Order</span>(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShiroConfig</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ShiroFilterFactoryBean 处理拦截资源文件问题。</span></span><br><span class="line"><span class="comment">     * 注意：单独一个ShiroFilterFactoryBean配置是或报错的，以为在</span></span><br><span class="line"><span class="comment">     * 初始化ShiroFilterFactoryBean的时候需要注入：SecurityManager Filter Chain定义说明</span></span><br><span class="line"><span class="comment">     * 1、一个URL可以配置多个Filter，使用逗号分隔</span></span><br><span class="line"><span class="comment">     * 2、当设置多个过滤器时，全部验证通过，才视为通过</span></span><br><span class="line"><span class="comment">     * 3、部分过滤器可指定参数，如perms，roles</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ShiroFilterFactoryBean <span class="title">shirFilter</span><span class="params">(SecurityManager securityManager)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        ShiroFilterFactoryBean shiroFilterFactoryBean = <span class="keyword">new</span> ShiroFilterFactoryBean();</span><br><span class="line">        <span class="comment">// 必须设置 SecurityManager</span></span><br><span class="line">        shiroFilterFactoryBean.setSecurityManager(securityManager);</span><br><span class="line">        <span class="comment">//验证码过滤器</span></span><br><span class="line">        Map&lt;String, Filter&gt; filtersMap = shiroFilterFactoryBean.getFilters();</span><br><span class="line">        filtersMap.put(<span class="string">"jwt"</span>, <span class="keyword">new</span> JWTFilter());</span><br><span class="line">        shiroFilterFactoryBean.setFilters(filtersMap);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 拦截器</span></span><br><span class="line">        Map&lt;String, String&gt; filterChainDefinitionMap = <span class="keyword">new</span> LinkedHashMap&lt;String, String&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 其他的</span></span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">"/**"</span>, <span class="string">"jwt"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 访问401和404页面不通过我们的Filter</span></span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">"/401"</span>, <span class="string">"anon"</span>);</span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">"/404"</span>, <span class="string">"anon"</span>);</span><br><span class="line"></span><br><span class="line">        shiroFilterFactoryBean.setFilterChainDefinitionMap(filterChainDefinitionMap);</span><br><span class="line">        <span class="keyword">return</span> shiroFilterFactoryBean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SecurityManager <span class="title">securityManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        DefaultWebSecurityManager securityManager = <span class="keyword">new</span> DefaultWebSecurityManager();</span><br><span class="line">        <span class="comment">// 设置realm.</span></span><br><span class="line">        securityManager.setRealm(myShiroRealm());</span><br><span class="line">        <span class="comment">//注入缓存管理器</span></span><br><span class="line">        securityManager.setCacheManager(ehCacheManager());</span><br><span class="line">        <span class="comment">// 关闭shiro自带的session</span></span><br><span class="line">        DefaultSubjectDAO subjectDAO = <span class="keyword">new</span> DefaultSubjectDAO();</span><br><span class="line">        DefaultSessionStorageEvaluator defaultSessionStorageEvaluator = <span class="keyword">new</span> DefaultSessionStorageEvaluator();</span><br><span class="line">        defaultSessionStorageEvaluator.setSessionStorageEnabled(<span class="keyword">false</span>);</span><br><span class="line">        subjectDAO.setSessionStorageEvaluator(defaultSessionStorageEvaluator);</span><br><span class="line">        securityManager.setSubjectDAO(subjectDAO);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> securityManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 身份认证realm; (这个需要自己写，账号密码校验；权限等)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MyShiroRealm <span class="title">myShiroRealm</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        MyShiroRealm myShiroRealm = <span class="keyword">new</span> MyShiroRealm();</span><br><span class="line">        <span class="keyword">return</span> myShiroRealm;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 开启shiro aop注解支持. 使用代理方式; 所以需要开启代码支持;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> securityManager 安全管理器</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 授权Advisor</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AuthorizationAttributeSourceAdvisor <span class="title">authorizationAttributeSourceAdvisor</span><span class="params">(SecurityManager securityManager)</span> </span>&#123;</span><br><span class="line">        AuthorizationAttributeSourceAdvisor authorizationAttributeSourceAdvisor = <span class="keyword">new</span> AuthorizationAttributeSourceAdvisor();</span><br><span class="line">        authorizationAttributeSourceAdvisor.setSecurityManager(securityManager);</span><br><span class="line">        <span class="keyword">return</span> authorizationAttributeSourceAdvisor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * shiro缓存管理器;</span></span><br><span class="line"><span class="comment">     * 需要注入对应的其它的实体类中：</span></span><br><span class="line"><span class="comment">     * 1、安全管理器：securityManager</span></span><br><span class="line"><span class="comment">     * 可见securityManager是整个shiro的核心；</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> EhCacheManager <span class="title">ehCacheManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        EhCacheManager cacheManager = <span class="keyword">new</span> EhCacheManager();</span><br><span class="line">        cacheManager.setCacheManagerConfigFile(<span class="string">"classpath:ehcache.xml"</span>);</span><br><span class="line">        <span class="keyword">return</span> cacheManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>里面URL规则自己参考文档 <a href="http://shiro.apache.org/web.html" target="_blank" rel="noopener">http://shiro.apache.org/web.html</a> ，这个在shiro那篇说的很清楚了。</p>
<h2 id="运行验证"><a href="#运行验证" class="headerlink" title="运行验证"></a>运行验证</h2><p>最后是将代码跑起来验证这一切是否正常。</p>
<p>启动SpringBoot后，先通过POST请求登录拿到token</p>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="assets/1591542467-9b00d88be51aa31ba69f11f360ef7d00.png" alt=""></p>
<p>然后在调用入网接口的时候在header中带上这个token认证：</p>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="assets/1591542467-d594da55382048c1e13d4a8a4aa252d3.png" alt=""></p>
<p>如果token认证不正确会报异常：</p>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="assets/1591542467-84999364ce6e55b32523c292879f6792.png" alt=""></p>
<p>如果使用普通用户登录，认证正确但是授权访问接口失败，会返回如下的未授权结果：</p>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="assets/1591542467-8332d765b7055a9b7fc75e1b6127d18c.png" alt=""></p>
<h2 id="GitHub源码"><a href="#GitHub源码" class="headerlink" title="GitHub源码"></a>GitHub源码</h2><p><a href="https://github.com/yidao620c/SpringBootBucket/tree/master/springboot-jwt" target="_blank" rel="noopener">springboot-jwt</a>   —已测试</p>
<h2 id="来源"><a href="#来源" class="headerlink" title="来源"></a>来源</h2><p><a href="https://www.xncoding.com/" target="_blank" rel="noopener">https://www.xncoding.com/</a></p>
]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>springboot</tag>
        <tag>jwt</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot系列 - 集成MongoDB</title>
    <url>/2020/06/08/SpringBoot%E7%B3%BB%E5%88%97-%E9%9B%86%E6%88%90MongoDB/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><h1 id="SpringBoot系列-集成MongoDB"><a href="#SpringBoot系列-集成MongoDB" class="headerlink" title="SpringBoot系列 - 集成MongoDB"></a>SpringBoot系列 - 集成MongoDB</h1><p>MongoDB是一个高性能、开源、无模式的文档型数据库，是当前NoSql数据库中比较热门的一种。 适合对大量或者无固定格式的数据进行存储，比如：日志、缓存等。对事物支持较弱，不适用复杂的多文档（多表）的级联查询。</p>
<p>MongoDB的适用场景：</p>
<ol>
<li>在应用服务器的日志记录</li>
<li>存储一些监控数据</li>
<li>应用不需要事务及复杂 join 支持</li>
<li>应用需要2000-3000以上的读写QPS</li>
<li>应用需要TB甚至 PB 级别数据存储</li>
<li>应用发展迅速，需要能快速水平扩展</li>
<li>应用要求存储的数据不丢失</li>
<li>应用需要99.999%高可用</li>
<li>应用需要大量的地理位置查询、文本查询</li>
</ol>
<p>本篇将介绍如何在SpringBoot中使用MongoDB数据库。</p>
<h2 id="maven依赖"><a href="#maven依赖" class="headerlink" title="maven依赖"></a>maven依赖</h2><p>只需要添加：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-mongodb<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="安装MongoDB"><a href="#安装MongoDB" class="headerlink" title="安装MongoDB"></a>安装MongoDB</h2><p>MongoDB的安装教程请参考 <a href="https://docs.mongodb.com/manual/tutorial/install-mongodb-on-red-hat/" target="_blank" rel="noopener">官网安装</a></p>
<p>我是在centos7上面安装的MongoDB 4.0，并且修改配置文件<code>/etc/mongod.conf</code>，将绑定端口设置成<code>0.0.0.0</code>，让其他主机也能访问。</p>
<p>启动mongodb后，添加一个用户，步骤如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mongo --port 27017</span><br><span class="line">use test</span><br><span class="line">db.createUser(</span><br><span class="line">   &#123;</span><br><span class="line">     user: &quot;xiongneng&quot;,</span><br><span class="line">     pwd: &quot;123456&quot;,</span><br><span class="line">     roles: [ &#123; role: &quot;readWrite&quot;, db: &quot;test&quot; &#125; ]</span><br><span class="line">   &#125;</span><br><span class="line"> )</span><br></pre></td></tr></table></figure>

<h2 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h2><p>修改<code>application.yml</code>配置，增加mongodb的配置项：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">data:</span></span><br><span class="line">    <span class="attr">mongodb:</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">mongodb://xiongneng:123456@localhost:27017/test</span></span><br></pre></td></tr></table></figure>

<h2 id="定义实体类"><a href="#定义实体类" class="headerlink" title="定义实体类"></a>定义实体类</h2><p>这里只是为了测试，我就定义一个简单的客户类：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Document</span>(collection = <span class="string">"customer"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Customer</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="keyword">private</span> String firstName;</span><br><span class="line">    <span class="keyword">private</span> String lastName;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Customer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Customer</span><span class="params">(String firstName, String lastName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.firstName = firstName;</span><br><span class="line">        <span class="keyword">this</span>.lastName = lastName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 省略get、set方法</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> String.format(</span><br><span class="line">                <span class="string">"Customer[id=%s, firstName='%s', lastName='%s']"</span>,</span><br><span class="line">                id, firstName, lastName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中的id属性是MongoDB用来唯一识别客户的主键，其实这里可以不用注解，因为默认就叫id。</p>
<p>另外MongoDB里面的数据会存储到集合中，Spring Data MongoDB会将Customer类的数据映射到名字叫<code>customer</code>的集合中。</p>
<h2 id="定义DAO类"><a href="#定义DAO类" class="headerlink" title="定义DAO类"></a>定义DAO类</h2><p>这里可继承<code>MongoRepository</code>，这样一些通用操作的方法，比如增删改查你就不用写了，只需要添加你自己自定义的其他方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CustomerRepository</span> <span class="keyword">extends</span> <span class="title">MongoRepository</span>&lt;<span class="title">Customer</span>, <span class="title">String</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">Customer <span class="title">findByFirstName</span><span class="params">(String firstName)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">List&lt;Customer&gt; <span class="title">findByLastName</span><span class="params">(String lastName)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里我定义了两个简单查询方法，一个是根据名称查找单个客户，一个是根据姓来查找客户列表。 你无需去写实现类，运行时SpringBoot会自动帮你生成实现，这也是它的强大之处，将你从代码樊笼中解脱出来。</p>
<h2 id="编写服务类"><a href="#编写服务类" class="headerlink" title="编写服务类"></a>编写服务类</h2><p>接下来编写核心的业务服务类 <code>CustomerService</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomerService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> CustomerRepository repository;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除所有的客户</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        repository.deleteAll();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 保存客户</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> customer 客户</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">(Customer customer)</span> </span>&#123;</span><br><span class="line">        repository.save(customer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询所有客户列表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 客户列表</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Iterable&lt;Customer&gt; <span class="title">findAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> repository.findAll();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过名查找某个客户</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> firstName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Customer <span class="title">findByFirstName</span><span class="params">(String firstName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> repository.findByFirstName(firstName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过姓查找客户列表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> lastName</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Customer&gt; <span class="title">findByLastName</span><span class="params">(String lastName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> repository.findByLastName(lastName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="编写测试用例"><a href="#编写测试用例" class="headerlink" title="编写测试用例"></a>编写测试用例</h2><p>OK，一切准备妥当之后，我们来编写测试用例：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">SpringBootTest</span></span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">ApplicationTests</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(ApplicationTests<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> CustomerService service;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 测试增删改查</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        service.deleteAll();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// save a couple of customers</span></span><br><span class="line">        service.save(<span class="keyword">new</span> Customer(<span class="string">"Alice"</span>, <span class="string">"Smith"</span>));</span><br><span class="line">        service.save(<span class="keyword">new</span> Customer(<span class="string">"Bob"</span>, <span class="string">"Smith"</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// fetch all customers</span></span><br><span class="line">        System.out.println(<span class="string">"Customers found with findAll():"</span>);</span><br><span class="line">        System.out.println(<span class="string">"-------------------------------"</span>);</span><br><span class="line">        <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (Customer customer : service.findAll()) &#123;</span><br><span class="line">            System.out.println(customer);</span><br><span class="line">            count++;</span><br><span class="line">        &#125;</span><br><span class="line">        assertThat(count, is(<span class="number">2</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// fetch an individual customer</span></span><br><span class="line">        System.out.println(<span class="string">"Customer found with findByFirstName('Alice'):"</span>);</span><br><span class="line">        System.out.println(<span class="string">"--------------------------------"</span>);</span><br><span class="line">        Customer c = service.findByFirstName(<span class="string">"Alice"</span>);</span><br><span class="line">        assertThat(c, notNullValue());</span><br><span class="line">        assertThat(c.getFirstName(), is(<span class="string">"Alice"</span>));</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"Customers found with findByLastName('Smith'):"</span>);</span><br><span class="line">        System.out.println(<span class="string">"--------------------------------"</span>);</span><br><span class="line"></span><br><span class="line">        List&lt;Customer&gt; list = service.findByLastName(<span class="string">"Smith"</span>);</span><br><span class="line">        assertThat(list, notNullValue());</span><br><span class="line">        assertThat(list.size(), greaterThan(<span class="number">1</span>));</span><br><span class="line">        assertThat(list.size(), is(<span class="number">2</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在上面的测试中，我先删掉数据库中所有客户数据，然后新增两条数据，查询所有的数据，根据姓或名查询。</p>
<p>运行测试结果为green bar，同时输出：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Customers found with findAll():</span><br><span class="line">-------------------------------</span><br><span class="line">Customer[id&#x3D;5a9a30e616afd63f48afeea6, firstName&#x3D;&#39;Alice&#39;, lastName&#x3D;&#39;Smith&#39;]</span><br><span class="line">Customer[id&#x3D;5a9a30e616afd63f48afeea7, firstName&#x3D;&#39;Bob&#39;, lastName&#x3D;&#39;Smith&#39;]</span><br><span class="line">Customer found with findByFirstName(&#39;Alice&#39;):</span><br><span class="line">--------------------------------</span><br><span class="line">Customers found with findByLastName(&#39;Smith&#39;):</span><br></pre></td></tr></table></figure>

<p>更多关于MongoDB的使用，请移步 <a href="https://www.mongodb.com/" target="_blank" rel="noopener">官网</a></p>
<h2 id="GitHub源码"><a href="#GitHub源码" class="headerlink" title="GitHub源码"></a>GitHub源码</h2><p><a href="https://github.com/yidao620c/SpringBootBucket/tree/master/springboot-mongodb" target="_blank" rel="noopener">springboot-mongodb</a></p>
<h2 id="来源"><a href="#来源" class="headerlink" title="来源"></a>来源</h2><p><a href="https://www.xncoding.com/" target="_blank" rel="noopener">https://www.xncoding.com/</a></p>
]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>springboot</tag>
        <tag>mongodb</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot系列 - 集成MyBatis</title>
    <url>/2020/06/08/SpringBoot%E7%B3%BB%E5%88%97-%E9%9B%86%E6%88%90MyBatis/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><h1 id="SpringBoot系列-集成MyBatis"><a href="#SpringBoot系列-集成MyBatis" class="headerlink" title="SpringBoot系列 - 集成MyBatis"></a>SpringBoot系列 - 集成MyBatis</h1><p>MyBatis 是一款优秀的持久层框架，它支持定制化 SQL、存储过程以及高级映射。MyBatis 避免了几乎所有的 JDBC 代码和手动设置参数以及获取结果集。 MyBatis 可以使用简单的 XML 或注解来配置和映射原生信息，将接口和 Java 的 POJOs映射成数据库中的记录。</p>
<p>使用MyBatis的时候需要自己手动编写SQL语句，也有代码自动生成工具来简化开发，我一般会使用Mybatis-Plus增强工具包来简化MyBatis的开发。</p>
<p>Mybatis-Plus官网：<a href="https://github.com/baomidou/mybatis-plus" target="_blank" rel="noopener">https://github.com/baomidou/mybatis-plus</a></p>
<p>同时它还提供了与SpringBoot的集成starter，非常的方便，本篇我将讲解如何在SpringBoot中集成MyBatis-Plus。</p>
<h2 id="maven依赖"><a href="#maven依赖" class="headerlink" title="maven依赖"></a>maven依赖</h2><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"> <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.reporting.outputEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">druid.version</span>&gt;</span>1.1.2<span class="tag">&lt;/<span class="name">druid.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mysql-connector.version</span>&gt;</span>8.0.7-dmr<span class="tag">&lt;/<span class="name">mysql-connector.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mybatis-plus.version</span>&gt;</span>2.1.8<span class="tag">&lt;/<span class="name">mybatis-plus.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mybatisplus-spring-boot-starter.version</span>&gt;</span>1.0.5<span class="tag">&lt;/<span class="name">mybatisplus-spring-boot-starter.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;mysql-connector.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;druid.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- MyBatis plus增强和springboot的集成--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;mybatis-plus.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatisplus-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;mybatisplus-spring-boot-starter.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.hamcrest<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hamcrest-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里我使用mysql数据库，阿里的druid连接池。</p>
<h2 id="初始化表"><a href="#初始化表" class="headerlink" title="初始化表"></a>初始化表</h2><p>关于mysql数据库的安装我这里就不讲了，只提供schema.sql文件初始化一个用户表，用作演示：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> pos <span class="keyword">default</span> <span class="keyword">charset</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci;</span><br><span class="line"><span class="keyword">SET</span> FOREIGN_KEY_CHECKS=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">USE</span> pos;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 用户表</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`t_user`</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`t_user`</span> (</span><br><span class="line">  <span class="string">`id`</span>                        <span class="built_in">INT</span>(<span class="number">11</span>) PRIMARY <span class="keyword">KEY</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'主键ID'</span>,</span><br><span class="line">  <span class="string">`username`</span>                  <span class="built_in">VARCHAR</span>(<span class="number">32</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'账号'</span>,</span><br><span class="line">  <span class="string">`name`</span>                      <span class="built_in">VARCHAR</span>(<span class="number">16</span>) <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'名字'</span>,</span><br><span class="line">  <span class="string">`password`</span>                  <span class="built_in">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'密码'</span>,</span><br><span class="line">  <span class="string">`salt`</span>                      <span class="built_in">VARCHAR</span>(<span class="number">64</span>) <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'md5密码盐'</span>,</span><br><span class="line">  <span class="string">`phone`</span>                     <span class="built_in">VARCHAR</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="string">''</span> <span class="keyword">COMMENT</span> <span class="string">'联系电话'</span>,</span><br><span class="line">  <span class="string">`tips`</span>                      <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">COMMENT</span> <span class="string">'备注'</span>,</span><br><span class="line">  <span class="string">`state`</span>                     <span class="built_in">TINYINT</span>(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="number">1</span> <span class="keyword">COMMENT</span> <span class="string">'状态 1:正常 2:禁用'</span>,</span><br><span class="line">  <span class="string">`created_time`</span>              DATETIME <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,</span><br><span class="line">  <span class="string">`updated_time`</span>              DATETIME <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="keyword">CURRENT_TIMESTAMP</span> <span class="keyword">COMMENT</span> <span class="string">'更新时间'</span></span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">1</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 <span class="keyword">COMMENT</span>=<span class="string">'用户表'</span>;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`t_user`</span> <span class="keyword">VALUES</span> (<span class="number">1</span>,<span class="string">'admin'</span>,<span class="string">'系统管理员'</span>,<span class="string">'123456'</span>,<span class="string">'www'</span>, <span class="string">'17890908889'</span>, <span class="string">'系统管理员'</span>, <span class="number">1</span>, <span class="string">'2017-12-12 09:46:12'</span>, <span class="string">'2017-12-12 09:46:12'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`t_user`</span> <span class="keyword">VALUES</span> (<span class="number">2</span>,<span class="string">'aix'</span>,<span class="string">'张三'</span>,<span class="string">'123456'</span>,<span class="string">'eee'</span>, <span class="string">'17859569358'</span>, <span class="string">''</span>, <span class="number">1</span>, <span class="string">'2017-12-12 09:46:12'</span>, <span class="string">'2017-12-12 09:46:12'</span>);</span><br></pre></td></tr></table></figure>

<h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><p>修改application.yml配置文件，注意是mysql连接信息和mybatis-plus的配置：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment">###################  mybatis-plus配置  ###################</span></span><br><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">mapper-locations:</span> <span class="string">classpath*:com/xncoding/pos/common/dao/repository/mapping/*.xml</span></span><br><span class="line">  <span class="attr">typeAliasesPackage:</span> <span class="string">&gt;</span></span><br><span class="line">    <span class="string">com.xncoding.pos.common.dao.entity</span></span><br><span class="line">  <span class="attr">global-config:</span></span><br><span class="line">    <span class="attr">id-type:</span> <span class="number">0</span>  <span class="comment"># 0:数据库ID自增   1:用户输入id  2:全局唯一id(IdWorker)  3:全局唯一ID(uuid)</span></span><br><span class="line">    <span class="attr">db-column-underline:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">refresh-mapper:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">configuration:</span></span><br><span class="line">    <span class="attr">map-underscore-to-camel-case:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">cache-enabled:</span> <span class="literal">true</span> <span class="comment">#配置的缓存的全局开关</span></span><br><span class="line">    <span class="attr">lazyLoadingEnabled:</span> <span class="literal">true</span> <span class="comment">#延时加载的开关</span></span><br><span class="line">    <span class="attr">multipleResultSetsEnabled:</span> <span class="literal">true</span> <span class="comment">#开启的话，延时加载一个属性时会加载该对象全部属性，否则按需加载属性</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/pos?useSSL=false&amp;autoReconnect=true&amp;tinyInt1isBit=false&amp;useUnicode=true&amp;characterEncoding=utf8</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">      <span class="attr">password:</span> <span class="number">123456</span></span><br></pre></td></tr></table></figure>

<p>主要解释两个配置：</p>
<ol>
<li>mapper-locations 这个是你定义的mapping文件，支持通配符，如果有多个用逗号隔开。</li>
<li>typeAliasesPackage 这个定义实体类所在的包名，或者其他能使用别名的类所在的包。</li>
</ol>
<h2 id="配置类"><a href="#配置类" class="headerlink" title="配置类"></a>配置类</h2><p>由于使用到的Druid连接池的配置项非常多，可先定义一个<code>DruidProperties</code>属性类，具体的数据源配置我就不贴了。 然后再定义<code>MybatisPlusConfig</code>如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span>(order = <span class="number">2</span>)</span><br><span class="line"><span class="meta">@MapperScan</span>(basePackages = &#123;</span><br><span class="line">        <span class="string">"com.xncoding.pos.common.dao.repository"</span>,</span><br><span class="line">        <span class="string">"com.xncoding.pos.dao.repository"</span>&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MybatisPlusConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> DruidProperties druidProperties;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 单数据源连接池配置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DruidDataSource <span class="title">singleDatasource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        DruidDataSource dataSource = <span class="keyword">new</span> DruidDataSource();</span><br><span class="line">        druidProperties.config(dataSource);</span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * mybatis-plus分页插件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PaginationInterceptor <span class="title">paginationInterceptor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> PaginationInterceptor();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里要说明一下：</p>
<p>@EnableTransactionManagement开启了事务支持。</p>
<p>@MapperScan注解扫描DAO类，支持多个包，用逗号隔开。</p>
<p>然后在里面定义了一个数据源的类，另外还定义了分页插件，这个用在分页查询上面，本篇演示还用不到。</p>
<h2 id="实体类"><a href="#实体类" class="headerlink" title="实体类"></a>实体类</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@TableName</span>(value = <span class="string">"t_user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Model</span>&lt;<span class="title">User</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 主键ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@TableId</span>(value=<span class="string">"id"</span>, type= IdType.AUTO)</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 账号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 名字</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 密码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * md5密码盐</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String salt;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 联系电话</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String phone;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 备注</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String tips;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 状态 1:正常 2:禁用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer state;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Date createdTime;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 更新时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Date updatedTime;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 省略getter/setter</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="DAO类"><a href="#DAO类" class="headerlink" title="DAO类"></a>DAO类</h2><p>接下来定义DAO操作类：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserMapper</span> <span class="keyword">extends</span> <span class="title">BaseMapper</span>&lt;<span class="title">User</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个接口继承 <code>BaseMapper&lt;User&gt;</code>后即可获得常用的增删改查的方法， 如果有其他复杂的操作，就再定义自己的方法，并同时定义mapping文件即可。</p>
<p>这里演示比较简单，无需自己再去写mapping文件。</p>
<h2 id="业务逻辑Servcie"><a href="#业务逻辑Servcie" class="headerlink" title="业务逻辑Servcie"></a>业务逻辑Servcie</h2><p>接下来定义业务逻辑处理类，并将DAO类注入进去：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过ID查找用户</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">findById</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userMapper.selectById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 新增用户</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> user</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertUser</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        userMapper.insert(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 修改用户</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> user</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateUser</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">        userMapper.updateById(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除用户</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteUser</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line">        userMapper.deleteById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="测试类"><a href="#测试类" class="headerlink" title="测试类"></a>测试类</h2><p>一切搞定后，接下来开始编写测试用例试试看：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RunWith</span>(SpringRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">SpringBootTest</span></span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">ApplicationTests</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(ApplicationTests<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 测试增删改查</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        user.setUsername(<span class="string">"xiaoxx"</span>);</span><br><span class="line">        user.setName(<span class="string">"小星星"</span>);</span><br><span class="line">        user.setPassword(<span class="string">"222222"</span>);</span><br><span class="line">        user.setPhone(<span class="string">"13890907676"</span>);</span><br><span class="line">        userService.insertUser(user);</span><br><span class="line"></span><br><span class="line">        User user1 = userService.findById(user.getId());</span><br><span class="line">        assertThat(user1.getUsername(), is(<span class="string">"xiaoxx"</span>));</span><br><span class="line">        assertThat(user1.getName(), is(<span class="string">"小星星"</span>));</span><br><span class="line"></span><br><span class="line">        user1.setPassword(<span class="string">"888888"</span>);</span><br><span class="line">        userService.updateUser(user1);</span><br><span class="line">        User user2 = userService.findById(user.getId());</span><br><span class="line">        assertThat(user2.getPassword(), is(<span class="string">"888888"</span>));</span><br><span class="line"></span><br><span class="line">        userService.deleteUser(user.getId());</span><br><span class="line"></span><br><span class="line">        User user3 = userService.findById(user.getId());</span><br><span class="line">        assertThat(user3, nullValue());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先创建一个用户，插入到表中，使用了数据库的自增主键，调用<code>insertUser</code>成功后，user的id会被自动设置上。 然后再通过id查询用户，确保能查询到。后面更新用户并确认，删除用户并确认。</p>
<p>运行测试用例，结果是green bar，测试通过。</p>
<h2 id="GitHub源码"><a href="#GitHub源码" class="headerlink" title="GitHub源码"></a>GitHub源码</h2><p><a href="https://github.com/yidao620c/SpringBootBucket/tree/master/springboot-mybatis" target="_blank" rel="noopener">springboot-mybatis</a>   —已测试</p>
<h2 id="来源"><a href="#来源" class="headerlink" title="来源"></a>来源</h2><p><a href="https://www.xncoding.com/" target="_blank" rel="noopener">https://www.xncoding.com/</a></p>
]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>mybatis</tag>
        <tag>springboot</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot系列 - 集成Shiro权限管理</title>
    <url>/2020/06/08/SpringBoot%E7%B3%BB%E5%88%97-%E9%9B%86%E6%88%90Shiro%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><h1 id="SpringBoot系列-集成Shiro权限管理"><a href="#SpringBoot系列-集成Shiro权限管理" class="headerlink" title="SpringBoot系列 - 集成Shiro权限管理"></a>SpringBoot系列 - 集成Shiro权限管理</h1><p><code>Apache Shiro</code>是Java的一个安全框架。目前，使用<code>Apache Shiro</code>的人越来越多，相比<code>Spring Security</code>而言相当简单， 可能没有<code>Spring Security</code>做的功能强大，但是在实际工作时可能并不需要那么复杂的东西， 所以使用小而简单的Shiro就足够了。对于它俩到底哪个好，这个不必纠结，能更简单的解决项目问题就好了。</p>
<p>本教程只介绍基本的Shiro使用，不会过多分析源码等，重在使用。</p>
<h2 id="Shiro架构"><a href="#Shiro架构" class="headerlink" title="Shiro架构"></a>Shiro架构</h2><p>Shiro可以非常容易的开发出足够好的应用，其不仅可以用在JavaSE环境，也可以用在JavaEE环境。 Shiro可以帮助我们完成：认证、授权、加密、会话管理、与Web集成、缓存等。这不就是我们想要的嘛， 而且Shiro的API也是非常简单；其基本功能点如下图所示：</p>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="assets/1591541990-7423bbe4e69fb2cc25b5a2a09ab09a5e.png" alt=""></p>
<ul>
<li>Authentication：身份认证/登录，验证用户是不是拥有相应的身份；</li>
<li>Authorization：授权，即权限验证，验证某个已认证的用户是否拥有某个权限；即判断用户是否能做事情，常见的如：验证某个用户是否拥有某个角色。或者细粒度的验证某个用户对某个资源是否具有某个权限；</li>
<li>Session Manager：会话管理，即用户登录后就是一次会话，在没有退出之前，它的所有信息都在会话中；会话可以是普通JavaSE环境的，也可以是如Web环境的；</li>
<li>Cryptography：加密，保护数据的安全性，如密码加密存储到数据库，而不是明文存储；</li>
<li>Web Support：Web支持，可以非常容易的集成到Web环境；</li>
<li>Caching：缓存，比如用户登录后，其用户信息、拥有的角色/权限不必每次去查，这样可以提高效率；</li>
<li>Concurrency：shiro支持多线程应用的并发验证，即如在一个线程中开启另一个线程，能把权限自动传播过去；</li>
<li>Testing：提供测试支持；</li>
<li>Run As：允许一个用户假装为另一个用户（如果他们允许）的身份进行访问；</li>
<li>Remember Me：记住我，这个是非常常见的功能，即一次登录后，下次再来的话不用登录了。</li>
</ul>
<p>记住一点，Shiro不会去维护用户、维护权限；这些需要我们自己去设计/提供；然后通过相应的接口注入给Shiro即可。</p>
<p>接下来我们分别从外部和内部来看看Shiro的架构，对于一个好的框架，从外部来看应该具有非常简单易于使用的API， 且API契约明确；从内部来看的话，其应该有一个可扩展的架构，即非常容易插入用户自定义实现，因为任何框架都不能满足所有需求。</p>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="assets/1591541990-d5dd266072a3cfece1811ece11d99aa9.png" alt=""></p>
<p>可以看到：应用代码直接交互的对象是Subject，也就是说Shiro的对外API核心就是Subject。</p>
<ul>
<li>Subject：主体，代表了当前“用户”，这个用户不一定是一个具体的人，与当前应用交互的任何东西都是Subject，如网络爬虫，机器人等；即一个抽象概念；所有Subject都绑定到SecurityManager，与Subject的所有交互都会委托给SecurityManager；可以把Subject认为是一个门面；SecurityManager才是实际的执行者；</li>
<li>SecurityManager：安全管理器；即所有与安全有关的操作都会与SecurityManager交互；且它管理着所有Subject；可以看出它是Shiro的核心，它负责与后边介绍的其他组件进行交互，如果学习过SpringMVC，你可以把它看成DispatcherServlet前端控制器；</li>
<li>Realm：域，Shiro从从Realm获取安全数据（如用户、角色、权限），就是说SecurityManager要验证用户身份，那么它需要从Realm获取相应的用户进行比较以确定用户身份是否合法；也需要从Realm得到用户相应的角色/权限进行验证用户是否能进行操作；可以把Realm看成DataSource，即安全数据源。</li>
</ul>
<p>也就是说对于我们而言，最简单的一个Shiro应用：</p>
<ol>
<li>应用代码通过Subject来进行认证和授权，而Subject又委托给SecurityManager；</li>
<li>我们需要给Shiro的SecurityManager注入Realm，从而让SecurityManager能得到合法的用户及其权限进行判断。</li>
</ol>
<p>从以上也可以看出，Shiro不提供维护用户/权限，而是通过Realm让开发人员自己注入。</p>
<p>接下来我们来从Shiro内部来看下Shiro的架构，如下图所示：</p>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="assets/1591541990-b4239eb4af9485aaef0f2d6e2dc997bc.png" alt=""></p>
<ul>
<li>Subject：主体，可以看到主体可以是任何可以与应用交互的“用户”；</li>
<li>SecurityManager：相当于SpringMVC中的DispatcherServlet或者Struts2中的FilterDispatcher；是Shiro的心脏；所有具体的交互都通过SecurityManager进行控制；它管理着所有Subject、且负责进行认证和授权、及会话、缓存的管理。</li>
<li>Authenticator：认证器，负责主体认证的，这是一个扩展点，如果用户觉得Shiro默认的不好，可以自定义实现；其需要认证策略（Authentication Strategy），即什么情况下算用户认证通过了；</li>
<li>Authorizer：授权器，或者访问控制器，用来决定主体是否有权限进行相应的操作；即控制着用户能访问应用中的哪些功能；</li>
<li>Realm：可以有1个或多个Realm，可以认为是安全实体数据源，即用于获取安全实体的；可以是JDBC实现，也可以是LDAP实现，或者内存实现等等；由用户提供；注意：Shiro不知道你的用户/权限存储在哪及以何种格式存储；所以我们一般在应用中都需要实现自己的Realm；</li>
<li>SessionManager：如果写过Servlet就应该知道Session的概念，Session呢需要有人去管理它的生命周期，这个组件就是SessionManager；而Shiro并不仅仅可以用在Web环境，也可以用在如普通的JavaSE环境、EJB等环境；所有呢，Shiro就抽象了一个自己的Session来管理主体与应用之间交互的数据；这样的话，比如我们在Web环境用，刚开始是一台Web服务器；接着又上了台EJB服务器；这时想把两台服务器的会话数据放到一个地方，这个时候就可以实现自己的分布式会话（如把数据放到Memcached服务器）；</li>
<li>SessionDAO：DAO大家都用过，数据访问对象，用于会话的CRUD，比如我们想把Session保存到数据库，那么可以实现自己的SessionDAO，通过如JDBC写到数据库；比如想把Session放到Memcached中，可以实现自己的Memcached SessionDAO；另外SessionDAO中可以使用Cache进行缓存，以提高性能；</li>
<li>CacheManager：缓存控制器，来管理如用户、角色、权限等的缓存的；因为这些数据基本上很少去改变，放到缓存中后可以提高访问的性能</li>
<li>Cryptography：密码模块，Shiro提高了一些常见的加密组件用于如密码加密/解密的。</li>
</ul>
<p>参考 <a href="http://shiro.apache.org/reference.html" target="_blank" rel="noopener">Shiro官网</a></p>
<h2 id="SpringBoot集成"><a href="#SpringBoot集成" class="headerlink" title="SpringBoot集成"></a>SpringBoot集成</h2><p>实现一个最长见的验证码登录、记住我、权限自定义（or），缓存功能的SpringBoot应用，模板使用Thymeleaf 3</p>
<p>Maven依赖：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- thymeleaf模板中shiro标签--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.theborakompanioni<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>thymeleaf-extras-shiro<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- shiro 权限控制 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- shiro ehcache (shiro缓存)--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-ehcache<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--验证码框架--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.axet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kaptcha<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.9<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>新建一个配置类<code>ShiroConfig.java</code>，内容如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Description  : Apache Shiro 核心通过 Filter 来实现，就好像SpringMvc 通过DispachServlet 来主控制一样。</span></span><br><span class="line"><span class="comment"> * 既然是使用 Filter 一般也就能猜到，是通过URL规则来进行过滤和权限校验，所以我们需要定义一系列关于URL的规则和访问权限。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@Order</span>(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShiroConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//配置kaptcha图片验证码框架提供的Servlet,,这是个坑,很多人忘记注册(注意)</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServletRegistrationBean <span class="title">kaptchaServlet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ServletRegistrationBean servlet = <span class="keyword">new</span> ServletRegistrationBean(<span class="keyword">new</span> KaptchaServlet(), <span class="string">"/kaptcha.jpg"</span>);</span><br><span class="line">        servlet.addInitParameter(Constants.KAPTCHA_SESSION_CONFIG_KEY, Constants.KAPTCHA_SESSION_KEY);<span class="comment">//session key</span></span><br><span class="line">        servlet.addInitParameter(Constants.KAPTCHA_TEXTPRODUCER_FONT_SIZE, <span class="string">"50"</span>);<span class="comment">//字体大小</span></span><br><span class="line">        servlet.addInitParameter(Constants.KAPTCHA_BORDER, <span class="string">"no"</span>);</span><br><span class="line">        servlet.addInitParameter(Constants.KAPTCHA_BORDER_COLOR, <span class="string">"105,179,90"</span>);</span><br><span class="line">        servlet.addInitParameter(Constants.KAPTCHA_TEXTPRODUCER_FONT_SIZE, <span class="string">"45"</span>);</span><br><span class="line">        servlet.addInitParameter(Constants.KAPTCHA_TEXTPRODUCER_CHAR_LENGTH, <span class="string">"4"</span>);</span><br><span class="line">        servlet.addInitParameter(Constants.KAPTCHA_TEXTPRODUCER_FONT_NAMES, <span class="string">"宋体,楷体,微软雅黑"</span>);</span><br><span class="line">        servlet.addInitParameter(Constants.KAPTCHA_TEXTPRODUCER_FONT_COLOR, <span class="string">"blue"</span>);</span><br><span class="line">        servlet.addInitParameter(Constants.KAPTCHA_IMAGE_WIDTH, <span class="string">"125"</span>);</span><br><span class="line">        servlet.addInitParameter(Constants.KAPTCHA_IMAGE_HEIGHT, <span class="string">"60"</span>);</span><br><span class="line">        <span class="comment">//可以设置很多属性,具体看com.google.code.kaptcha.Constants</span></span><br><span class="line">        <span class="keyword">return</span> servlet;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//注入异常处理类</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MyExceptionResolver <span class="title">myExceptionResolver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MyExceptionResolver();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ShiroFilterFactoryBean 处理拦截资源文件问题。</span></span><br><span class="line"><span class="comment">     * 注意：单独一个ShiroFilterFactoryBean配置是或报错的，以为在</span></span><br><span class="line"><span class="comment">     * 初始化ShiroFilterFactoryBean的时候需要注入：SecurityManager Filter Chain定义说明</span></span><br><span class="line"><span class="comment">     * 1、一个URL可以配置多个Filter，使用逗号分隔</span></span><br><span class="line"><span class="comment">     * 2、当设置多个过滤器时，全部验证通过，才视为通过</span></span><br><span class="line"><span class="comment">     * 3、部分过滤器可指定参数，如perms，roles</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ShiroFilterFactoryBean <span class="title">shirFilter</span><span class="params">(SecurityManager securityManager)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        ShiroFilterFactoryBean shiroFilterFactoryBean = <span class="keyword">new</span> ShiroFilterFactoryBean();</span><br><span class="line">        <span class="comment">// 必须设置 SecurityManager</span></span><br><span class="line">        shiroFilterFactoryBean.setSecurityManager(securityManager);</span><br><span class="line">        <span class="comment">//验证码过滤器</span></span><br><span class="line">        Map&lt;String, Filter&gt; filtersMap = shiroFilterFactoryBean.getFilters();</span><br><span class="line">        KaptchaFilter kaptchaFilter = <span class="keyword">new</span> KaptchaFilter();</span><br><span class="line">        filtersMap.put(<span class="string">"kaptchaFilter"</span>, kaptchaFilter);</span><br><span class="line">        <span class="comment">//实现自己规则roles,这是为了实现or的效果</span></span><br><span class="line">        <span class="comment">//RoleFilter roleFilter = new RoleFilter();</span></span><br><span class="line">        <span class="comment">//filtersMap.put("roles", roleFilter);</span></span><br><span class="line">        shiroFilterFactoryBean.setFilters(filtersMap);</span><br><span class="line">        <span class="comment">// 拦截器</span></span><br><span class="line">        <span class="comment">//rest：比如/admins/user/**=rest[user],根据请求的方法，相当于/admins/user/**=perms[user：method] ,其中method为post，get，delete等。</span></span><br><span class="line">        <span class="comment">//port：比如/admins/user/**=port[8081],当请求的url的端口不是8081是跳转到schemal：//serverName：8081?queryString,其中schmal是协议http或https等，serverName是你访问的host,8081是url配置里port的端口，queryString是你访问的url里的？后面的参数。</span></span><br><span class="line">        <span class="comment">//perms：比如/admins/user/**=perms[user：add：*],perms参数可以写多个，多个时必须加上引号，并且参数之间用逗号分割，比如/admins/user/**=perms["user：add：*,user：modify：*"]，当有多个参数时必须每个参数都通过才通过，想当于isPermitedAll()方法。</span></span><br><span class="line">        <span class="comment">//roles：比如/admins/user/**=roles[admin],参数可以写多个，多个时必须加上引号，并且参数之间用逗号分割，当有多个参数时，比如/admins/user/**=roles["admin,guest"],每个参数通过才算通过，相当于hasAllRoles()方法。//要实现or的效果看http://zgzty.blog.163.com/blog/static/83831226201302983358670/</span></span><br><span class="line">        <span class="comment">//anon：比如/admins/**=anon 没有参数，表示可以匿名使用。</span></span><br><span class="line">        <span class="comment">//authc：比如/admins/user/**=authc表示需要认证才能使用，没有参数</span></span><br><span class="line">        <span class="comment">//authcBasic：比如/admins/user/**=authcBasic没有参数表示httpBasic认证</span></span><br><span class="line">        <span class="comment">//ssl：比如/admins/user/**=ssl没有参数，表示安全的url请求，协议为https</span></span><br><span class="line">        <span class="comment">//user：比如/admins/user/**=user没有参数表示必须存在用户，当登入操作时不做检查</span></span><br><span class="line">        Map&lt;String, String&gt; filterChainDefinitionMap = <span class="keyword">new</span> LinkedHashMap&lt;String, String&gt;();</span><br><span class="line">        <span class="comment">// 配置退出过滤器,其中的具体的退出代码Shiro已经替我们实现了</span></span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">"/logout"</span>, <span class="string">"logout"</span>);</span><br><span class="line">        <span class="comment">//配置记住我或认证通过可以访问的地址</span></span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">"/index"</span>, <span class="string">"user"</span>);</span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">"/"</span>, <span class="string">"user"</span>);</span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">"/login"</span>, <span class="string">"kaptchaFilter"</span>);</span><br><span class="line">        <span class="comment">// &lt;!-- 过滤链定义，从上向下顺序执行，一般将 /**放在最为下边 --&gt;:这是一个坑呢，一不小心代码就不好使了;</span></span><br><span class="line">        <span class="comment">//这段是配合 actuator框架使用的，配置相应的角色才能访问</span></span><br><span class="line">        <span class="comment">// filterChainDefinitionMap.put("/health", "roles[aix]");//服务器健康状况页面</span></span><br><span class="line">        <span class="comment">// filterChainDefinitionMap.put("/info", "roles[aix]");//服务器信息页面</span></span><br><span class="line">        <span class="comment">// filterChainDefinitionMap.put("/env", "roles[aix]");//应用程序的环境变量</span></span><br><span class="line">        <span class="comment">// filterChainDefinitionMap.put("/metrics", "roles[aix]");</span></span><br><span class="line">        <span class="comment">// filterChainDefinitionMap.put("/configprops", "roles[aix]");</span></span><br><span class="line">        <span class="comment">//开放的静态资源</span></span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">"/favicon.ico"</span>, <span class="string">"anon"</span>);<span class="comment">//网站图标</span></span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">"/static/**"</span>, <span class="string">"anon"</span>);<span class="comment">//配置static文件下资源能被访问的，这是个例子</span></span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">"/kaptcha.jpg"</span>, <span class="string">"anon"</span>);<span class="comment">//图片验证码(kaptcha框架)</span></span><br><span class="line"></span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">"/api/v1/**"</span>, <span class="string">"anon"</span>);<span class="comment">//API接口</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// swagger接口文档</span></span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">"/v2/api-docs"</span>, <span class="string">"anon"</span>);</span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">"/webjars/**"</span>, <span class="string">"anon"</span>);</span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">"/swagger-resources/**"</span>, <span class="string">"anon"</span>);</span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">"/swagger-ui.html"</span>, <span class="string">"anon"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 其他的</span></span><br><span class="line">        filterChainDefinitionMap.put(<span class="string">"/**"</span>, <span class="string">"authc"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果不设置默认会自动寻找Web工程根目录下的"/login.jsp"页面</span></span><br><span class="line">        shiroFilterFactoryBean.setLoginUrl(<span class="string">"/login"</span>);</span><br><span class="line">        <span class="comment">// 登录成功后要跳转的链接</span></span><br><span class="line">        shiroFilterFactoryBean.setSuccessUrl(<span class="string">"/index"</span>);</span><br><span class="line">        <span class="comment">// 未授权界面，不生效(详情原因看MyExceptionResolver)</span></span><br><span class="line">        shiroFilterFactoryBean.setUnauthorizedUrl(<span class="string">"/errorView/403_error.html"</span>);</span><br><span class="line">        shiroFilterFactoryBean.setFilterChainDefinitionMap(filterChainDefinitionMap);</span><br><span class="line">        <span class="keyword">return</span> shiroFilterFactoryBean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SecurityManager <span class="title">securityManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        DefaultWebSecurityManager securityManager = <span class="keyword">new</span> DefaultWebSecurityManager();</span><br><span class="line">        <span class="comment">// 设置realm.</span></span><br><span class="line">        securityManager.setRealm(myShiroRealm());</span><br><span class="line">        <span class="comment">//注入缓存管理器</span></span><br><span class="line">        securityManager.setCacheManager(ehCacheManager());<span class="comment">//这个如果执行多次，也是同样的一个对象;</span></span><br><span class="line">        <span class="comment">//注入记住我管理器;</span></span><br><span class="line">        securityManager.setRememberMeManager(rememberMeManager());</span><br><span class="line">        <span class="keyword">return</span> securityManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 身份认证realm; (这个需要自己写，账号密码校验；权限等)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MyShiroRealm <span class="title">myShiroRealm</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        MyShiroRealm myShiroRealm = <span class="keyword">new</span> MyShiroRealm();</span><br><span class="line">        myShiroRealm.setCredentialsMatcher(hashedCredentialsMatcher());</span><br><span class="line">        <span class="keyword">return</span> myShiroRealm;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 凭证匹配器 （由于我们的密码校验交给Shiro的SimpleAuthenticationInfo进行处理了</span></span><br><span class="line"><span class="comment">     * 所以我们需要修改下doGetAuthenticationInfo中的代码; <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> HashedCredentialsMatcher <span class="title">hashedCredentialsMatcher</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        HashedCredentialsMatcher hashedCredentialsMatcher = <span class="keyword">new</span> HashedCredentialsMatcher();</span><br><span class="line">        hashedCredentialsMatcher.setHashAlgorithmName(<span class="string">"md5"</span>);<span class="comment">// 散列算法:这里使用MD5算法;</span></span><br><span class="line">        hashedCredentialsMatcher.setHashIterations(<span class="number">2</span>);<span class="comment">// 散列的次数，比如散列两次，相当于md5(md5(""));</span></span><br><span class="line">        hashedCredentialsMatcher.setStoredCredentialsHexEncoded(<span class="keyword">true</span>);<span class="comment">//表示是否存储散列后的密码为16进制，需要和生成密码时的一样，默认是base64；</span></span><br><span class="line">        <span class="keyword">return</span> hashedCredentialsMatcher;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 开启shiro aop注解支持. 使用代理方式; 所以需要开启代码支持;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> securityManager</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AuthorizationAttributeSourceAdvisor <span class="title">authorizationAttributeSourceAdvisor</span><span class="params">(SecurityManager securityManager)</span> </span>&#123;</span><br><span class="line">        AuthorizationAttributeSourceAdvisor authorizationAttributeSourceAdvisor = <span class="keyword">new</span> AuthorizationAttributeSourceAdvisor();</span><br><span class="line">        authorizationAttributeSourceAdvisor.setSecurityManager(securityManager);</span><br><span class="line">        <span class="keyword">return</span> authorizationAttributeSourceAdvisor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * shiro缓存管理器;</span></span><br><span class="line"><span class="comment">     * 需要注入对应的其它的实体类中：</span></span><br><span class="line"><span class="comment">     * 1、安全管理器：securityManager</span></span><br><span class="line"><span class="comment">     * 可见securityManager是整个shiro的核心；</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> EhCacheManager <span class="title">ehCacheManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        EhCacheManager cacheManager = <span class="keyword">new</span> EhCacheManager();</span><br><span class="line">        cacheManager.setCacheManagerConfigFile(<span class="string">"classpath:ehcache.xml"</span>);</span><br><span class="line">        <span class="keyword">return</span> cacheManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * cookie对象;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SimpleCookie <span class="title">rememberMeCookie</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//System.out.println("ShiroConfiguration.rememberMeCookie()");</span></span><br><span class="line">        <span class="comment">//这个参数是cookie的名称，对应前端的checkbox的name = rememberMe</span></span><br><span class="line">        SimpleCookie simpleCookie = <span class="keyword">new</span> SimpleCookie(<span class="string">"rememberMe"</span>);</span><br><span class="line">        <span class="comment">//&lt;!-- 记住我cookie生效时间30天 ,单位秒;--&gt;</span></span><br><span class="line">        simpleCookie.setMaxAge(<span class="number">259200</span>);</span><br><span class="line">        <span class="keyword">return</span> simpleCookie;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * cookie管理对象;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CookieRememberMeManager <span class="title">rememberMeManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//System.out.println("ShiroConfiguration.rememberMeManager()");</span></span><br><span class="line">        CookieRememberMeManager cookieRememberMeManager = <span class="keyword">new</span> CookieRememberMeManager();</span><br><span class="line">        cookieRememberMeManager.setCookie(rememberMeCookie());</span><br><span class="line">        <span class="keyword">return</span> cookieRememberMeManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span>(name = <span class="string">"shiroDialect"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ShiroDialect <span class="title">shiroDialect</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ShiroDialect();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>代码中解释都非常清楚。</p>
<p><code>MyShiroRealm.java</code>的内容如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyShiroRealm</span> <span class="keyword">extends</span> <span class="title">AuthorizingRealm</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger _logger = LoggerFactory.getLogger(MyShiroRealm<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    ManagerInfoService managerInfoService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 认证信息.(身份验证)</span></span><br><span class="line"><span class="comment">     * Authentication 是用来验证用户身份</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> AuthenticationInfo <span class="title">doGetAuthenticationInfo</span><span class="params">(AuthenticationToken token)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line"></span><br><span class="line">        _logger.info(<span class="string">"MyShiroRealm.doGetAuthenticationInfo()"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取用户的输入的账号.</span></span><br><span class="line">        String username = (String) token.getPrincipal();</span><br><span class="line">        <span class="comment">//_logger.info("用户的账号:"+username);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//通过username从数据库中查找 ManagerInfo对象</span></span><br><span class="line">        <span class="comment">//实际项目中，这里可以根据实际情况做缓存，如果不做，Shiro自己也是有时间间隔机制，2分钟内不会重复执行该方法</span></span><br><span class="line">        ManagerInfo managerInfo = managerInfoService.findByUsername(username);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (managerInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//交给AuthenticatingRealm使用CredentialsMatcher进行密码匹配，如果觉得人家的不好可以自定义实现</span></span><br><span class="line">        SimpleAuthenticationInfo authenticationInfo = <span class="keyword">new</span> SimpleAuthenticationInfo(</span><br><span class="line">                managerInfo, <span class="comment">//用户</span></span><br><span class="line">                managerInfo.getPassword(), <span class="comment">//密码</span></span><br><span class="line">                ByteSource.Util.bytes(managerInfo.getCredentialsSalt()),<span class="comment">//salt=username+salt</span></span><br><span class="line">                getName()  <span class="comment">//realm name</span></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">//明文: 若存在，将此用户存放到登录认证info中，无需自己做密码对比，Shiro会为我们进行密码对比校验</span></span><br><span class="line"><span class="comment">//        SimpleAuthenticationInfo authenticationInfo = new SimpleAuthenticationInfo(</span></span><br><span class="line"><span class="comment">//                managerInfo, //用户名</span></span><br><span class="line"><span class="comment">//                managerInfo.getPassword(), //密码</span></span><br><span class="line"><span class="comment">//                getName()  //realm name</span></span><br><span class="line"><span class="comment">//        );</span></span><br><span class="line">        <span class="keyword">return</span> authenticationInfo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 此方法调用hasRole,hasPermission的时候才会进行回调.</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * 权限信息.(授权):</span></span><br><span class="line"><span class="comment">     * 1、如果用户正常退出，缓存自动清空；</span></span><br><span class="line"><span class="comment">     * 2、如果用户非正常退出，缓存自动清空；</span></span><br><span class="line"><span class="comment">     * 3、如果我们修改了用户的权限，而用户不退出系统，修改的权限无法立即生效。</span></span><br><span class="line"><span class="comment">     * （需要手动编程进行实现；放在service进行调用）</span></span><br><span class="line"><span class="comment">     * 在权限修改后调用realm中的方法，realm已经由spring管理，所以从spring中获取realm实例，调用clearCached方法；</span></span><br><span class="line"><span class="comment">     * :Authorization 是授权访问控制，用于对用户进行的操作授权，证明该用户是否允许进行当前操作，如访问某个链接，某个资源文件等。</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> principals</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> AuthorizationInfo <span class="title">doGetAuthorizationInfo</span><span class="params">(PrincipalCollection principals)</span> </span>&#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 当没有使用缓存的时候，不断刷新页面的话，这个代码会不断执行，</span></span><br><span class="line"><span class="comment">         * 当其实没有必要每次都重新设置权限信息，所以我们需要放到缓存中进行管理；</span></span><br><span class="line"><span class="comment">         * 当放到缓存中时，这样的话，doGetAuthorizationInfo就只会执行一次了，</span></span><br><span class="line"><span class="comment">         * 缓存过期之后会再次执行。</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        _logger.info(<span class="string">"权限配置--&gt;MyShiroRealm.doGetAuthorizationInfo()"</span>);</span><br><span class="line">        SimpleAuthorizationInfo authorizationInfo = <span class="keyword">new</span> SimpleAuthorizationInfo();</span><br><span class="line">        ManagerInfo managerInfo = (ManagerInfo) principals.getPrimaryPrincipal();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置相应角色的权限信息</span></span><br><span class="line">        <span class="keyword">for</span> (SysRole role : managerInfo.getRoles()) &#123;</span><br><span class="line">            <span class="comment">//设置角色</span></span><br><span class="line">            authorizationInfo.addRole(role.getRole());</span><br><span class="line">            <span class="keyword">for</span> (Permission p : role.getPermissions()) &#123;</span><br><span class="line">                <span class="comment">//设置权限</span></span><br><span class="line">                authorizationInfo.addStringPermission(p.getPermission());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> authorizationInfo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置认证加密方式</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCredentialsMatcher</span><span class="params">(CredentialsMatcher credentialsMatcher)</span> </span>&#123;</span><br><span class="line">        HashedCredentialsMatcher md5CredentialsMatcher = <span class="keyword">new</span> HashedCredentialsMatcher();</span><br><span class="line">        md5CredentialsMatcher.setHashAlgorithmName(ShiroKit.HASH_ALGORITHM_NAME);</span><br><span class="line">        md5CredentialsMatcher.setHashIterations(ShiroKit.HASH_ITERATIONS);</span><br><span class="line">        <span class="keyword">super</span>.setCredentialsMatcher(md5CredentialsMatcher);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>自定义异常处理类<code>MyExceptionResolver.java</code> :</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyExceptionResolver</span> <span class="keyword">implements</span> <span class="title">HandlerExceptionResolver</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ModelAndView <span class="title">resolveException</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//如果是shiro无权操作，因为shiro 在操作auno等一部分不进行转发至无权限url</span></span><br><span class="line">        <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> UnauthorizedException) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ModelAndView(<span class="string">"error/shiro_403"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="接口控制"><a href="#接口控制" class="headerlink" title="接口控制"></a>接口控制</h2><p>配置好了Shiro后就可以通过注解方式来限制某些接口调用需要相应的角色或权限了：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/index"</span>)</span><br><span class="line"><span class="meta">@RequiresRoles</span>(<span class="string">"admin"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">index</span><span class="params">(HttpServletRequest request, Model model)</span> </span>&#123;</span><br><span class="line">    _logger.info(<span class="string">"进入项目管理首页..."</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其他的注解请参考官网的 <a href="https://shiro.apache.org/java-annotations-list.html" target="_blank" rel="noopener">Shiro注解</a></p>
<h2 id="Thymeleaf的shiro标签"><a href="#Thymeleaf的shiro标签" class="headerlink" title="Thymeleaf的shiro标签"></a>Thymeleaf的shiro标签</h2><p>可以在Thymeleaf模板中使用shiro的权限标签来控制某些菜单或按钮是否显示。</p>
<p>maven中添加依赖，这个前面已经有了：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- thymeleaf模板中shiro标签--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.theborakompanioni<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>thymeleaf-extras-shiro<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在ShiroConfig中添加一个Bean配置：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span>(name = <span class="string">"shiroDialect"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ShiroDialect <span class="title">shiroDialect</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ShiroDialect();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在html页面添加如下内容：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">xmlns</span>=<span class="string">"http://www.w3.org/1999/xhtml"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">xmlns:th</span>=<span class="string">"http://www.thymeleaf.org"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">xmlns:shiro</span>=<span class="string">"http://www.pollix.at/thymeleaf/shiro"</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>添加完后在html页面调用如下：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 认证通过或已记住的用户。 --&gt;</span>    </span><br><span class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">shiro:user</span>=<span class="string">""</span>&gt;</span>    </span><br><span class="line">   Welcome back John! Not John? Click <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"login.html"</span>&gt;</span>here<span class="tag">&lt;/<span class="name">a</span>&gt;</span> to login.    </span><br><span class="line"><span class="tag">&lt;/<span class="name">p</span>&gt;</span>    </span><br><span class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">shiro:notAuthenticated</span>=<span class="string">""</span>&gt;</span>  </span><br><span class="line">    未身份验证（包括记住我）  </span><br><span class="line"><span class="tag">&lt;/<span class="name">p</span>&gt;</span>   </span><br><span class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">shiro:guest</span>=<span class="string">""</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">"white-space:pre;"</span>&gt;</span> <span class="tag">&lt;/<span class="name">span</span>&gt;</span>Please <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"login.html"</span>&gt;</span>login5555<span class="tag">&lt;/<span class="name">a</span>&gt;</span> <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>第二种：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">shiro:guest</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">a</span>&gt;</span> <span class="tag">&lt;<span class="name">a</span>&gt;</span>注册<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">shiro:guest</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">shiro:user</span>&gt;</span></span><br><span class="line">    欢迎<span class="tag">&lt;<span class="name">shiro:principal</span> <span class="attr">property</span>=<span class="string">"name"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">shiro:user</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="权限数据库设计"><a href="#权限数据库设计" class="headerlink" title="权限数据库设计"></a>权限数据库设计</h2><p>一般来讲都会讲用户的角色和权限保存到数据库，这里设计一种最通用的模型， 使用RBAC（Role-Based Access Control，基于角色的访问控制）模型设计用户，角色和权限间的关系。简单地说， 一个用户拥有若干角色，每一个角色拥有若干权限。这样，就构造成“用户-角色-权限”的授权模型。</p>
<p>在这种模型中，用户与角色之间，角色与权限之间，一般者是多对多的关系。如下图所示：</p>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="assets/1591541990-bc1d0b1ed83368bfa27f6c485ca517c4.png" alt=""></p>
<p>根据这个模型，设计数据库表，并插入一些测试数据，具体可参考源码中的<code>schema.sql</code>，后面我将<code>t_user</code>表名字改成<code>t_manager</code></p>
<p>然后我们通过MyBatis实现<code>ManagerInfoService</code>，</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 后台用户管理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ManagerInfoService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ManagerInfoDao managerInfoDao;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ManagerInfo <span class="title">findByUsername</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> managerInfoDao.findByUsername(username);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后对应的<code>ManagerInfoDao.xml</code>如下：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">"ManagerInfoMap"</span> <span class="attr">type</span>=<span class="string">"managerInfo"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">"id"</span> <span class="attr">column</span>=<span class="string">"id"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"username"</span> <span class="attr">column</span>=<span class="string">"username"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"name"</span> <span class="attr">column</span>=<span class="string">"name"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"password"</span> <span class="attr">column</span>=<span class="string">"password"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"salt"</span> <span class="attr">column</span>=<span class="string">"salt"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"state"</span> <span class="attr">column</span>=<span class="string">"state"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">collection</span> <span class="attr">property</span>=<span class="string">"roles"</span> <span class="attr">ofType</span>=<span class="string">"sysRole"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">"id"</span> <span class="attr">column</span>=<span class="string">"role_id"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"role"</span> <span class="attr">column</span>=<span class="string">"role_role"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">collection</span> <span class="attr">property</span>=<span class="string">"permissions"</span> <span class="attr">ofType</span>=<span class="string">"permission"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">"id"</span> <span class="attr">column</span>=<span class="string">"perm_id"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">"permission"</span> <span class="attr">column</span>=<span class="string">"perm_permission"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">collection</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">collection</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"findByUsername"</span> <span class="attr">resultMap</span>=<span class="string">"ManagerInfoMap"</span>&gt;</span></span><br><span class="line">    SELECT DISTINCT</span><br><span class="line">        A.id AS id,</span><br><span class="line">        A.username AS username,</span><br><span class="line">        A.name AS name,</span><br><span class="line">        A.password AS password,</span><br><span class="line">        A.salt AS salt,</span><br><span class="line">        A.state AS state,</span><br><span class="line">        C.id AS role_id,</span><br><span class="line">        C.role AS role_role,</span><br><span class="line">        E.id AS perm_id,</span><br><span class="line">        E.permission AS perm_permission</span><br><span class="line">    FROM t_manager A</span><br><span class="line">        LEFT JOIN t_manager_role B ON A.id=B.manager_id</span><br><span class="line">        LEFT JOIN t_role C ON B.role_id=C.id</span><br><span class="line">        LEFT JOIN t_role_permission D ON C.id=D.role_id</span><br><span class="line">        LEFT JOIN t_permission E ON D.permission_Id=E.id</span><br><span class="line">    WHERE username=#&#123;username&#125;</span><br><span class="line">    LIMIT 1</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>ManagerInfo.java</code>如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ManagerInfo</span> <span class="keyword">extends</span> <span class="title">Manager</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 一个管理员具有多个角色</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;SysRole&gt; roles;<span class="comment">// 一个用户具有多个角色</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后来几张效果图：</p>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="assets/1591541990-0b74c30725735c0706d12bb24fb38477.png" alt=""></p>
<p>admin角色登录之后：</p>
<h2 id="GitHub源码"><a href="#GitHub源码" class="headerlink" title="GitHub源码"></a>GitHub源码</h2><p><a href="https://github.com/yidao620c/SpringBootBucket/tree/master/springboot-shiro" target="_blank" rel="noopener">springboot-shiro</a>   —已测试</p>
<h2 id="来源"><a href="#来源" class="headerlink" title="来源"></a>来源</h2><p><a href="https://www.xncoding.com/" target="_blank" rel="noopener">https://www.xncoding.com/</a></p>
]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>springboot</tag>
        <tag>shiro</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot系列 - 集成SocketIO实时通信</title>
    <url>/2020/06/08/SpringBoot%E7%B3%BB%E5%88%97-%E9%9B%86%E6%88%90SocketIO%E5%AE%9E%E6%97%B6%E9%80%9A%E4%BF%A1/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><h1 id="SpringBoot系列-集成SocketIO实时通信"><a href="#SpringBoot系列-集成SocketIO实时通信" class="headerlink" title="SpringBoot系列 - 集成SocketIO实时通信"></a>SpringBoot系列 - 集成SocketIO实时通信</h1><p>上一篇讲解了基于STOMP协议实现的WebSocket方案，本篇我讲一下Socket.IO的实现方案。</p>
<p>Socket.IO 主要使用WebSocket协议。但是如果需要的话，Socket.io可以回退到几种其它方法， 例如Adobe Flash Sockets、JSONP拉取、或是传统的AJAX拉取，并且提供完全相同的接口。 尽管它可以被用作WebSocket的包装库，它还是提供了许多其它功能，比如广播至多个套接字，存储与不同客户有关的数据，和异步IO操作。</p>
<p>更多请参考 Socket.IO 官网：<a href="https://socket.io/" target="_blank" rel="noopener">https://socket.io/</a></p>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>基于 socket.io 来说，采用 node 实现更加合适，本文使用两个后端的Java开源框架实现。</p>
<ul>
<li>服务端使用 <a href="https://github.com/mrniko/netty-socketio" target="_blank" rel="noopener">netty-socketio</a></li>
<li>客户端使用 <a href="https://github.com/socketio/socket.io-client-java" target="_blank" rel="noopener">socket.io-client-java</a></li>
</ul>
<p>业务需求是将之前通过轮询方式调动RESTFul API改成使用WebSocket长连接方式，实现要服务器实时的推送消息，另外还要实时监控POS机的在线状态等。</p>
<h2 id="引入依赖"><a href="#引入依赖" class="headerlink" title="引入依赖"></a>引入依赖</h2><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- netty-socketio--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.corundumstudio.socketio<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>netty-socketio<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.13<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.netty<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>netty-resolver<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.1.15.Final<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.netty<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>netty-transport<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.1.15.Final<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.socket<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>socket.io-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="服务器代码"><a href="#服务器代码" class="headerlink" title="服务器代码"></a>服务器代码</h2><p>先来服务端程序爽一把，话不多说，先上代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NamespaceSocketServer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(NamespaceSocketServer<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 创建Socket，并设置监听端口</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        Configuration config = <span class="keyword">new</span> Configuration();</span><br><span class="line">        <span class="comment">//设置主机名</span></span><br><span class="line">        config.setHostname(<span class="string">"localhost"</span>);</span><br><span class="line">        <span class="comment">//设置监听端口</span></span><br><span class="line">        config.setPort(<span class="number">9092</span>);</span><br><span class="line">        <span class="comment">// 协议升级超时时间（毫秒），默认10秒。HTTP握手升级为ws协议超时时间</span></span><br><span class="line">        config.setUpgradeTimeout(<span class="number">10000</span>);</span><br><span class="line">        <span class="comment">// Ping消息超时时间（毫秒），默认60秒，这个时间间隔内没有接收到心跳消息就会发送超时事件</span></span><br><span class="line">        config.setPingTimeout(<span class="number">180000</span>);</span><br><span class="line">        <span class="comment">// Ping消息间隔（毫秒），默认25秒。客户端向服务器发送一条心跳消息间隔</span></span><br><span class="line">        config.setPingInterval(<span class="number">60000</span>);</span><br><span class="line">        <span class="comment">// 连接认证，这里使用token更合适</span></span><br><span class="line">        config.setAuthorizationListener(<span class="keyword">new</span> AuthorizationListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAuthorized</span><span class="params">(HandshakeData data)</span> </span>&#123;</span><br><span class="line">                <span class="comment">// String token = data.getSingleUrlParam("token");</span></span><br><span class="line">                <span class="comment">// String username = JWTUtil.getSocketUsername(token);</span></span><br><span class="line">                <span class="comment">// return JWTUtil.verifySocket(token, "secret");</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> SocketIOServer server = <span class="keyword">new</span> SocketIOServer(config);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 添加连接监听事件，监听是否与客户端连接到服务器</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        server.addConnectListener(<span class="keyword">new</span> ConnectListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onConnect</span><span class="params">(SocketIOClient client)</span> </span>&#123;</span><br><span class="line">                <span class="comment">// 判断是否有客户端连接</span></span><br><span class="line">                <span class="keyword">if</span> (client != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    logger.info(<span class="string">"连接成功。clientId="</span> + client.getSessionId().toString());</span><br><span class="line">                    client.joinRoom(client.getHandshakeData().getSingleUrlParam(<span class="string">"appid"</span>));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    logger.error(<span class="string">"并没有人连接上。。。"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 添加监听事件，监听客户端的事件</span></span><br><span class="line"><span class="comment">         * 1.第一个参数eventName需要与客户端的事件要一致</span></span><br><span class="line"><span class="comment">         * 2.第二个参数eventClase是传输的数据类型</span></span><br><span class="line"><span class="comment">         * 3.第三个参数listener是用于接收客户端传的数据，数据类型需要与eventClass一致</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        server.addEventListener(<span class="string">"login"</span>, LoginRequest<span class="class">.<span class="keyword">class</span>, <span class="title">new</span> <span class="title">DataListener</span>&lt;<span class="title">LoginRequest</span>&gt;() </span>&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onData</span><span class="params">(SocketIOClient client, LoginRequest data, AckRequest ackRequest)</span> </span>&#123;</span><br><span class="line">                logger.info(<span class="string">"接收到客户端login消息：code = "</span> + data.getCode() + <span class="string">",body = "</span> + data.getBody());</span><br><span class="line">                <span class="comment">// check is ack requested by client, but it's not required check</span></span><br><span class="line">                <span class="keyword">if</span> (ackRequest.isAckRequested()) &#123;</span><br><span class="line">                    <span class="comment">// send ack response with data to client</span></span><br><span class="line">                    ackRequest.sendAckData(<span class="string">"已成功收到客户端登录请求"</span>, <span class="string">"yeah"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 向客户端发送消息</span></span><br><span class="line">                List&lt;String&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">                list.add(<span class="string">"登录成功，sessionId="</span> + client.getSessionId());</span><br><span class="line">                <span class="comment">// 第一个参数必须与eventName一致，第二个参数data必须与eventClass一致</span></span><br><span class="line">                String room = client.getHandshakeData().getSingleUrlParam(<span class="string">"appid"</span>);</span><br><span class="line">                server.getRoomOperations(room).sendEvent(<span class="string">"login"</span>, list.toString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">//启动服务</span></span><br><span class="line">        server.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Android客户端"><a href="#Android客户端" class="headerlink" title="Android客户端"></a>Android客户端</h2><p>老规矩，先上代码爽爽</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SocketClient</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Socket socket;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(SocketClient<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> URISyntaxException </span>&#123;</span><br><span class="line">        IO.Options options = <span class="keyword">new</span> IO.Options();</span><br><span class="line">        options.transports = <span class="keyword">new</span> String[]&#123;<span class="string">"websocket"</span>&#125;;</span><br><span class="line">        options.reconnectionAttempts = <span class="number">2</span>;     <span class="comment">// 重连尝试次数</span></span><br><span class="line">        options.reconnectionDelay = <span class="number">1000</span>;     <span class="comment">// 失败重连的时间间隔(ms)</span></span><br><span class="line">        options.timeout = <span class="number">20000</span>;              <span class="comment">// 连接超时时间(ms)</span></span><br><span class="line">        options.forceNew = <span class="keyword">true</span>;</span><br><span class="line">        options.query = <span class="string">"username=test1&amp;password=test1&amp;appid=com.xncoding.apay2"</span>;</span><br><span class="line">        socket = IO.socket(<span class="string">"http://localhost:9092/"</span>, options);</span><br><span class="line">        socket.on(Socket.EVENT_CONNECT, <span class="keyword">new</span> Emitter.Listener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Object... args)</span> </span>&#123;</span><br><span class="line">                <span class="comment">// 客户端一旦连接成功，开始发起登录请求</span></span><br><span class="line">                LoginRequest message = <span class="keyword">new</span> LoginRequest(<span class="number">12</span>, <span class="string">"这是客户端消息体"</span>);</span><br><span class="line">                socket.emit(<span class="string">"login"</span>, JsonConverter.objectToJSONObject(message), (Ack) args1 -&gt; &#123;</span><br><span class="line">                    logger.info(<span class="string">"回执消息="</span> + Arrays.stream(args1).map(Object::toString).collect(Collectors.joining(<span class="string">","</span>)));</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).on(<span class="string">"login"</span>, <span class="keyword">new</span> Emitter.Listener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Object... args)</span> </span>&#123;</span><br><span class="line">                logger.info(<span class="string">"接受到服务器房间广播的登录消息："</span> + Arrays.toString(args));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).on(Socket.EVENT_CONNECT_ERROR, <span class="keyword">new</span> Emitter.Listener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Object... args)</span> </span>&#123;</span><br><span class="line">                logger.info(<span class="string">"Socket.EVENT_CONNECT_ERROR"</span>);</span><br><span class="line">                socket.disconnect();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).on(Socket.EVENT_CONNECT_TIMEOUT, <span class="keyword">new</span> Emitter.Listener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Object... args)</span> </span>&#123;</span><br><span class="line">                logger.info(<span class="string">"Socket.EVENT_CONNECT_TIMEOUT"</span>);</span><br><span class="line">                socket.disconnect();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).on(Socket.EVENT_PING, <span class="keyword">new</span> Emitter.Listener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Object... args)</span> </span>&#123;</span><br><span class="line">                logger.info(<span class="string">"Socket.EVENT_PING"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).on(Socket.EVENT_PONG, <span class="keyword">new</span> Emitter.Listener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Object... args)</span> </span>&#123;</span><br><span class="line">                logger.info(<span class="string">"Socket.EVENT_PONG"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).on(Socket.EVENT_MESSAGE, <span class="keyword">new</span> Emitter.Listener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Object... args)</span> </span>&#123;</span><br><span class="line">                logger.info(<span class="string">"-----------接受到消息啦--------"</span> + Arrays.toString(args));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).on(Socket.EVENT_DISCONNECT, <span class="keyword">new</span> Emitter.Listener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Object... args)</span> </span>&#123;</span><br><span class="line">                logger.info(<span class="string">"客户端断开连接啦。。。"</span>);</span><br><span class="line">                socket.disconnect();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        socket.connect();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="关于心跳机制"><a href="#关于心跳机制" class="headerlink" title="关于心跳机制"></a>关于心跳机制</h2><p>根据 <a href="https://github.com/socketio/engine.io#methods-1" target="_blank" rel="noopener">Socket.IO文档</a> 解释， 客户端会定期发送心跳包，并触发一个ping事件和一个pong事件，如下：</p>
<ul>
<li><code>ping</code> Fired when a ping packet is written out to the server.</li>
<li><code>pong</code> Fired when a pong is received from the server. Parameters:<ul>
<li><code>Number</code> number of ms elapsed since <code>ping</code> packet (i.e.: latency)</li>
</ul>
</li>
</ul>
<p>这里最重要的两个服务器参数如下：</p>
<ol>
<li>pingTimeout (Number): how many ms without a pong packet to consider the connection closed (60000)</li>
<li>pingInterval (Number): how many ms before sending a new ping packet (25000).</li>
</ol>
<p>也就是说握手协议的时候，客户端从服务器拿到这两个参数，一个是ping消息的发送间隔时间，一个是从服务器返回pong消息的超时时间， 客户端会在超时后断开连接。心跳包发送方向是客户端向服务器端发送，以维持在线状态。</p>
<h2 id="关于断线和超时"><a href="#关于断线和超时" class="headerlink" title="关于断线和超时"></a>关于断线和超时</h2><p>关闭浏览器、直接关闭客户端程序、kill进程、主动执行disconnect方法都会导致立刻产生断线事件。 而客户端把网络断开，服务器端在 <code>pingTimeout</code> ms后产生断线事件、客户端在 <code>pingTimeout</code> ms后也产生断线事件。</p>
<p>实际上，超时后会产生一个断线事件，叫”disconnect”。客户端和服务器端都可以对这个事件作出应答，释放连接。</p>
<p>客户端代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">.on(Socket.EVENT_DISCONNECT, <span class="keyword">new</span> Emitter.Listener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Object... args)</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"客户端断开连接啦。。。"</span>);</span><br><span class="line">        socket.disconnect();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>连上服务器后，断开网络。超过了心跳超时时间后，产生断线事件。如果客户端不主动断开连接的话，会自动重连， 这时候发现连接不上，又产生连接错误事件，然后重试2次，都失败后自动断开连接了。</p>
<p>下面是客户端日志：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SocketClient - 回执消息&#x3D;服务器已成功收到客户端登录请求,yeah</span><br><span class="line">SocketClient - Socket.EVENT_PING</span><br><span class="line">SocketClient - Socket.EVENT_PONG</span><br><span class="line">SocketClient - 客户端断开连接啦。。。</span><br><span class="line">SocketClient - Socket.EVENT_CONNECT_ERROR</span><br></pre></td></tr></table></figure>

<p>服务器端代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">server.addDisconnectListener(<span class="keyword">new</span> DisconnectListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDisconnect</span><span class="params">(SocketIOClient client)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"服务器收到断线通知... sessionId="</span> + client.getSessionId());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>服务器逻辑是，如果在心跳超时后，就直接断开这个连接，并且产生一个断开连接事件。</p>
<p>服务器通过netty处理心跳包ping/pong的日志如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">WebSocket08FrameDecoder - Decoding WebSocket Frame opCode&#x3D;1</span><br><span class="line">WebSocket08FrameDecoder - Decoding WebSocket Frame length&#x3D;1</span><br><span class="line">WebSocket08FrameEncoder - Encoding WebSocket Frame opCode&#x3D;1 length&#x3D;1</span><br></pre></td></tr></table></figure>

<h2 id="浏览器客户端演示"><a href="#浏览器客户端演示" class="headerlink" title="浏览器客户端演示"></a>浏览器客户端演示</h2><p>对于<code>netty-socketio</code>有一个demo工程，里面通过一个网页的聊天小程序演示了各种使用方法。</p>
<p>demo地址：<a href="https://github.com/mrniko/netty-socketio-demo" target="_blank" rel="noopener">netty-socketio-demo</a></p>
<h2 id="SpringBoot集成"><a href="#SpringBoot集成" class="headerlink" title="SpringBoot集成"></a>SpringBoot集成</h2><p>最后重点讲一下如何在SpringBoot中集成。</p>
<h3 id="修改配置"><a href="#修改配置" class="headerlink" title="修改配置"></a>修改配置</h3><p>首先maven依赖之前已经讲过了，先修改下<code>application.yml</code>配置文件来配置下几个参数，比如主机、端口、心跳时间等等。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment">###################  自定义项目配置 ###################</span></span><br><span class="line"><span class="attr">xncoding:</span></span><br><span class="line">  <span class="attr">socket-hostname:</span> <span class="string">localhost</span></span><br><span class="line">  <span class="attr">socket-port:</span> <span class="number">9096</span></span><br></pre></td></tr></table></figure>

<h3 id="添加Bean配置"><a href="#添加Bean配置" class="headerlink" title="添加Bean配置"></a>添加Bean配置</h3><p>然后增加一个SocketServer的Bean配置：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NettySocketConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> MyProperties myProperties;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ApiService apiService;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> ManagerInfoService managerInfoService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(NettySocketConfig<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SocketIOServer <span class="title">socketIOServer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 创建Socket，并设置监听端口</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        com.corundumstudio.socketio.Configuration config = <span class="keyword">new</span> com.corundumstudio.socketio.Configuration();</span><br><span class="line">        <span class="comment">// 设置主机名，默认是0.0.0.0</span></span><br><span class="line">        <span class="comment">// config.setHostname("localhost");</span></span><br><span class="line">        <span class="comment">// 设置监听端口</span></span><br><span class="line">        config.setPort(<span class="number">9096</span>);</span><br><span class="line">        <span class="comment">// 协议升级超时时间（毫秒），默认10000。HTTP握手升级为ws协议超时时间</span></span><br><span class="line">        config.setUpgradeTimeout(<span class="number">10000</span>);</span><br><span class="line">        <span class="comment">// Ping消息间隔（毫秒），默认25000。客户端向服务器发送一条心跳消息间隔</span></span><br><span class="line">        config.setPingInterval(<span class="number">60000</span>);</span><br><span class="line">        <span class="comment">// Ping消息超时时间（毫秒），默认60000，这个时间间隔内没有接收到心跳消息就会发送超时事件</span></span><br><span class="line">        config.setPingTimeout(<span class="number">180000</span>);</span><br><span class="line">        <span class="comment">// 这个版本0.9.0不能处理好namespace和query参数的问题。所以为了做认证必须使用全局默认命名空间</span></span><br><span class="line">        config.setAuthorizationListener(<span class="keyword">new</span> AuthorizationListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAuthorized</span><span class="params">(HandshakeData data)</span> </span>&#123;</span><br><span class="line">                <span class="comment">// 可以使用如下代码获取用户密码信息</span></span><br><span class="line">                String username = data.getSingleUrlParam(<span class="string">"username"</span>);</span><br><span class="line">                String password = data.getSingleUrlParam(<span class="string">"password"</span>);</span><br><span class="line">                logger.info(<span class="string">"连接参数：username="</span> + username + <span class="string">",password="</span> + password);</span><br><span class="line">                ManagerInfo managerInfo = managerInfoService.findByUsername(username);</span><br><span class="line">                <span class="comment">// MD5盐</span></span><br><span class="line">                String salt = managerInfo.getSalt();</span><br><span class="line">                String encodedPassword = ShiroKit.md5(password, username + salt);</span><br><span class="line">                <span class="comment">// 如果认证不通过会返回一个Socket.EVENT_CONNECT_ERROR事件</span></span><br><span class="line">                <span class="keyword">return</span> encodedPassword.equals(managerInfo.getPassword());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> SocketIOServer server = <span class="keyword">new</span> SocketIOServer(config);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> server;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SpringAnnotationScanner <span class="title">springAnnotationScanner</span><span class="params">(SocketIOServer socketServer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SpringAnnotationScanner(socketServer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意，我在<code>AuthorizationListener</code>里面通过调用service做了用户名和密码的认证。通过注解方式可以注入service， 执行相应的连接授权动作。</p>
<p>后面还有个<code>SpringAnnotationScanner</code>的定义不能忘记。</p>
<h3 id="添加消息结构类"><a href="#添加消息结构类" class="headerlink" title="添加消息结构类"></a>添加消息结构类</h3><p>预先定义好客户端和服务器端直接传递的消息类型，使用简单的JavaBean即可，比如</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReportParam</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * IMEI码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String imei;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 位置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String location;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getImei</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> imei;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setImei</span><span class="params">(String imei)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.imei = imei;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getLocation</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> location;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLocation</span><span class="params">(String location)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.location = location;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="添加消息处理类"><a href="#添加消息处理类" class="headerlink" title="添加消息处理类"></a>添加消息处理类</h3><p>这里才是最核心的接口处理类，所有接口处理逻辑都应该写在这里面，我只举了一个例子，就是POS上传位置接口：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 消息事件处理器</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> XiongNeng</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2018/1/19</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageEventHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SocketIOServer server;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ApiService apiService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(MessageEventHandler<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MessageEventHandler</span><span class="params">(SocketIOServer server, ApiService apiService)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.server = server;</span><br><span class="line">        <span class="keyword">this</span>.apiService = apiService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//添加connect事件，当客户端发起连接时调用</span></span><br><span class="line">    <span class="meta">@OnConnect</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onConnect</span><span class="params">(SocketIOClient client)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (client != <span class="keyword">null</span>) &#123;</span><br><span class="line">            String imei = client.getHandshakeData().getSingleUrlParam(<span class="string">"imei"</span>);</span><br><span class="line">            String applicationId = client.getHandshakeData().getSingleUrlParam(<span class="string">"appid"</span>);</span><br><span class="line">            logger.info(<span class="string">"连接成功, applicationId="</span> + applicationId + <span class="string">", imei="</span> + imei +</span><br><span class="line">                    <span class="string">", sessionId="</span> + client.getSessionId().toString() );</span><br><span class="line">            client.joinRoom(applicationId);</span><br><span class="line">            <span class="comment">// 更新POS监控状态为在线</span></span><br><span class="line">            ReportParam param = <span class="keyword">new</span> ReportParam();</span><br><span class="line">            param.setImei(imei);</span><br><span class="line">            apiService.updateJustState(param, client.getSessionId().toString(), <span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            logger.error(<span class="string">"客户端为空"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//添加@OnDisconnect事件，客户端断开连接时调用，刷新客户端信息</span></span><br><span class="line">    <span class="meta">@OnDisconnect</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDisconnect</span><span class="params">(SocketIOClient client)</span> </span>&#123;</span><br><span class="line">        String imei = client.getHandshakeData().getSingleUrlParam(<span class="string">"imei"</span>);</span><br><span class="line">        logger.info(<span class="string">"客户端断开连接, imei="</span> + imei + <span class="string">", sessionId="</span> + client.getSessionId().toString());</span><br><span class="line">        <span class="comment">// 更新POS监控状态为离线</span></span><br><span class="line">        ReportParam param = <span class="keyword">new</span> ReportParam();</span><br><span class="line">        param.setImei(imei);</span><br><span class="line">        apiService.updateJustState(param, <span class="string">""</span>, <span class="number">2</span>);</span><br><span class="line">        client.disconnect();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 消息接收入口</span></span><br><span class="line">    <span class="meta">@OnEvent</span>(value = Socket.EVENT_MESSAGE)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEvent</span><span class="params">(SocketIOClient client, AckRequest ackRequest, Object data)</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"接收到客户端消息"</span>);</span><br><span class="line">        <span class="keyword">if</span> (ackRequest.isAckRequested()) &#123;</span><br><span class="line">            <span class="comment">// send ack response with data to client</span></span><br><span class="line">            ackRequest.sendAckData(<span class="string">"服务器回答Socket.EVENT_MESSAGE"</span>, <span class="string">"好的"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 广播消息接收入口</span></span><br><span class="line">    <span class="meta">@OnEvent</span>(value = <span class="string">"broadcast"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBroadcast</span><span class="params">(SocketIOClient client, AckRequest ackRequest, Object data)</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"接收到广播消息"</span>);</span><br><span class="line">        <span class="comment">// 房间广播消息</span></span><br><span class="line">        String room = client.getHandshakeData().getSingleUrlParam(<span class="string">"appid"</span>);</span><br><span class="line">        server.getRoomOperations(room).sendEvent(<span class="string">"broadcast"</span>, <span class="string">"广播啦啦啦啦"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 报告地址接口</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> client 客户端</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ackRequest 回执消息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> param 报告地址参数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@OnEvent</span>(value = <span class="string">"doReport"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDoReport</span><span class="params">(SocketIOClient client, AckRequest ackRequest, ReportParam param)</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"报告地址接口 start...."</span>);</span><br><span class="line">        BaseResponse result = postReport(param);</span><br><span class="line">        ackRequest.sendAckData(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*----------------------------------------下面是私有方法-------------------------------------*/</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> BaseResponse <span class="title">postReport</span><span class="params">(ReportParam param)</span> </span>&#123;</span><br><span class="line">        BaseResponse result = <span class="keyword">new</span> BaseResponse();</span><br><span class="line">        <span class="keyword">int</span> r = apiService.report(param);</span><br><span class="line">        <span class="keyword">if</span> (r &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            result.setSuccess(<span class="keyword">true</span>);</span><br><span class="line">            result.setMsg(<span class="string">"报告地址成功"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            result.setSuccess(<span class="keyword">false</span>);</span><br><span class="line">            result.setMsg(<span class="string">"该POS机还没有入网，报告地址失败。"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="添加ServerRunner"><a href="#添加ServerRunner" class="headerlink" title="添加ServerRunner"></a>添加ServerRunner</h2><p>还有一个步骤就是添加启动器，在SpringBoot启动之后立马执行：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * SpringBoot启动之后执行</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> XiongNeng</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2017/7/15</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Order</span>(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerRunner</span> <span class="keyword">implements</span> <span class="title">CommandLineRunner</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SocketIOServer server;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(ServerRunner<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ServerRunner</span><span class="params">(SocketIOServer server)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.server = server;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(String... args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"ServerRunner 开始启动啦..."</span>);</span><br><span class="line">        server.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="nginx反向代理"><a href="#nginx反向代理" class="headerlink" title="nginx反向代理"></a>nginx反向代理</h2><p>要实现通过域名并走标准80或443端口的话，最好使用nginx做反向代理，跟正常的http反向代理基本一致， 不过websocket需要增加一个upgrade的配置。</p>
<p>下面我以一个实际使用例子来说明如何配置nginx的https访问websocket，并且开启301自动http跳转https。</p>
<p>首先要有一个域名，比如<code>test.enzhico.net</code>，然后申请letsencrypt的免费证书，这个过程我不讲了，另外的博客文章里面有。</p>
<p>配置如下:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">map $http_upgrade $connection_upgrade &#123;</span><br><span class="line">    default upgrade;</span><br><span class="line">    &#39;&#39; close;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">      server_name test.enzhico.net;</span><br><span class="line">      location &#x2F; &#123;</span><br><span class="line">          proxy_pass http:&#x2F;&#x2F;localhost:9096;</span><br><span class="line">          proxy_read_timeout 300s;</span><br><span class="line">          proxy_set_header Host $host;</span><br><span class="line">          proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">          proxy_http_version 1.1;</span><br><span class="line">          proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">          proxy_set_header Connection $connection_upgrade;</span><br><span class="line">      &#125;</span><br><span class="line">      #root &#x2F;opt&#x2F;www&#x2F;test.enzhico.net;</span><br><span class="line">      #index index.html index.htm;</span><br><span class="line">      error_page 404 &#x2F;404.html;</span><br><span class="line">          location &#x3D; &#x2F;40x.html &#123;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      error_page 500 502 503 504 &#x2F;50x.html;</span><br><span class="line">          location &#x3D; &#x2F;50x.html &#123;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    listen 443 ssl; # managed by Certbot</span><br><span class="line">    ssl_certificate &#x2F;etc&#x2F;letsencrypt&#x2F;live&#x2F;test.enzhico.net&#x2F;fullchain.pem; # managed by Certbot</span><br><span class="line">    ssl_certificate_key &#x2F;etc&#x2F;letsencrypt&#x2F;live&#x2F;test.enzhico.net&#x2F;privkey.pem; # managed by Certbot</span><br><span class="line">    include &#x2F;etc&#x2F;letsencrypt&#x2F;options-ssl-nginx.conf; # managed by Certbot</span><br><span class="line">    ssl_dhparam &#x2F;etc&#x2F;letsencrypt&#x2F;ssl-dhparams.pem; # managed by Certbot</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name test.enzhico.net;</span><br><span class="line">    return 301 https:&#x2F;&#x2F;$host$request_uri; # managed by Certbot</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意这其中和普通HTTP代理的关键不同是：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">proxy_set_header Connection $connection_upgrade;</span><br></pre></td></tr></table></figure>

<h2 id="GitHub源码"><a href="#GitHub源码" class="headerlink" title="GitHub源码"></a>GitHub源码</h2><p><a href="https://github.com/yidao620c/SpringBootBucket/tree/master/springboot-socketio" target="_blank" rel="noopener">springboot-socketio</a>   —已测试</p>
<h2 id="来源"><a href="#来源" class="headerlink" title="来源"></a>来源</h2><p><a href="https://www.xncoding.com/" target="_blank" rel="noopener">https://www.xncoding.com/</a></p>
]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>springboot</tag>
        <tag>socketio</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot系列 - 集成Swagger2</title>
    <url>/2020/06/08/SpringBoot%E7%B3%BB%E5%88%97-%E9%9B%86%E6%88%90Swagger2/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><h1 id="SpringBoot系列-集成Swagger2"><a href="#SpringBoot系列-集成Swagger2" class="headerlink" title="SpringBoot系列 - 集成Swagger2"></a>SpringBoot系列 - 集成Swagger2</h1><p>Swagger是一个简单但功能强大的API表达工具。它具有地球上最大的API工具生态系统，数以千计的开发人员， 使用几乎所有的现代编程语言，都在支持和使用Swagger。使用Swagger生成API，我们可以得到交互式文档， 自动生成代码的SDK以及API的发现特性等。</p>
<p>Swagger2可以利用注解快速、自动地生成接口文档页面，方便调用方查阅！</p>
<p>这一篇讲解如何在Spring Boot中集成Swagger2.</p>
<p>先来张效果图：</p>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="assets/1591542244-f05b9a86b70114e6c9277b9344178fe7.png" alt=""></p>
<p>可以看到Swagger-Ui是以controller分类,点击一个controller可以看到其中的具体接口,再点击接口就可以看到接口的信息了,如图:</p>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="assets/1591542244-41508f39b62d4a628087c57076f22038.png" alt=""></p>
<p>我们可以看到该接口的请求方式,返回数据信息和需要传递的参数.而且以上数据是自动生成的,即使代码有一些修改, Swagger文档也会自动同步修改.非常的方便。</p>
<h2 id="构建RESTful-API"><a href="#构建RESTful-API" class="headerlink" title="构建RESTful API"></a>构建RESTful API</h2><p>在使用Swagger2前我们需要有一个RESTful API的项目，Spring Boot创建RESTful API项目非常的方便和快速。</p>
<p>Spring Boot构建RESTful API极为简单，实际就是Spring MVC。</p>
<p>比如我的机具管理API如下，提供了3个接口：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/traffic"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TrafficController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OutTrafficService ts;</span><br><span class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断该账户是否存在于交警6合1系统</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> req</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/checkAccount"</span>, method = RequestMethod.POST)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity&lt;AccountResponse&gt; <span class="title">checkTrafficAccount</span><span class="params">(@RequestBody TrafficAccountReq req)</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"检查用户账号接口 start..."</span>);</span><br><span class="line">        AccountResponse result = ts.checkTrafficAccount(req);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResponseEntity&lt;&gt;(result, HttpStatus.OK);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据业务流水号获取机动车缴款信息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> req</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/jdcPayInfo"</span>, method = RequestMethod.POST)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity&lt;JDCPayInfoResponse&gt; <span class="title">getJDCPayInfo</span><span class="params">(@RequestBody TrafficPayJDCReq req)</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"获取机动车缴款信息接口 start..."</span>);</span><br><span class="line">        JDCPayInfoResponse result = ts.getJDCPayinfo(req);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResponseEntity&lt;&gt;(result, HttpStatus.OK);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据身份证获取缴款信息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> req</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/jsrPayInfo"</span>, method = RequestMethod.POST)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity&lt;JSZPayInfoResponse&gt; <span class="title">getJSZPayinfo</span><span class="params">(@RequestBody TrafficPayJSZReq req)</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"获取驾驶证缴款信息接口 start..."</span>);</span><br><span class="line">        JSZPayInfoResponse result = ts.getJSZPayinfo(req);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResponseEntity&lt;&gt;(result, HttpStatus.OK);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取整个管理部门信息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/departmentInfo"</span>, method = RequestMethod.GET)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity&lt;DepartmentInfoResponse&gt; <span class="title">getDepartmentinfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"获取整个管理部门信息 start..."</span>);</span><br><span class="line">        DepartmentInfoResponse result = ts.getDepartmentinfo();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResponseEntity&lt;&gt;(result, HttpStatus.OK);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="添加Swagger2依赖"><a href="#添加Swagger2依赖" class="headerlink" title="添加Swagger2依赖"></a>添加Swagger2依赖</h2><p>maven依赖：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- swagger2 集成--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.8.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger-ui<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.8.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>我自己也定制过一个ui，github地址：<a href="https://github.com/yidao620c/springfox-swagger-ui" target="_blank" rel="noopener">https://github.com/yidao620c/springfox-swagger-ui</a></p>
<h2 id="创建Swagger2的Java配置类"><a href="#创建Swagger2的Java配置类" class="headerlink" title="创建Swagger2的Java配置类"></a>创建Swagger2的Java配置类</h2><p>通过<code>@Configuration</code>注解，表明它是一个配置类，<code>@EnableSwagger2</code> 注解开启swagger2。 <code>apiInfo()</code> 方法配置一些基本的信息。<code>createRestApi()</code> 方法指定扫描的包会生成文档， 默认是显示所有接口,可以用<code>@ApiIgnore</code>注解标识该接口不显示。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableSwagger</span>2</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Swagger2Config</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Docket <span class="title">createRestApi</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Docket(DocumentationType.SWAGGER_2)</span><br><span class="line">                .produces(Sets.newHashSet(<span class="string">"application/json"</span>))</span><br><span class="line">                .consumes(Sets.newHashSet(<span class="string">"application/json"</span>))</span><br><span class="line">                .protocols(Sets.newHashSet(<span class="string">"http"</span>, <span class="string">"https"</span>))</span><br><span class="line">                .apiInfo(apiInfo())</span><br><span class="line">                .forCodeGeneration(<span class="keyword">true</span>)</span><br><span class="line">                .useDefaultResponseMessages(<span class="keyword">false</span>)</span><br><span class="line">                .select()</span><br><span class="line">                <span class="comment">// 指定controller存放的目录路径</span></span><br><span class="line">                .apis(RequestHandlerSelectors.basePackage(<span class="string">"com.xncoding.modules.traffic.controller"</span>))</span><br><span class="line"><span class="comment">//                .paths(PathSelectors.ant("/api/v1/*"))</span></span><br><span class="line">                .paths(PathSelectors.any())</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> ApiInfo <span class="title">apiInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ApiInfoBuilder()</span><br><span class="line">                <span class="comment">// 文档标题</span></span><br><span class="line">                .title(<span class="string">"XX系统API服务"</span>)</span><br><span class="line">                <span class="comment">// 文档描述</span></span><br><span class="line">                .description(<span class="string">"XX系统API接口文档简要描述"</span>)</span><br><span class="line">                <span class="comment">// .termsOfServiceUrl("https://github.com/yidao620c")</span></span><br><span class="line">                .version(<span class="string">"v1"</span>)</span><br><span class="line">                .license(<span class="string">"MIT 协议"</span>)</span><br><span class="line">                .licenseUrl(<span class="string">"http://www.opensource.org/licenses/MIT"</span>)</span><br><span class="line">                .contact(<span class="keyword">new</span> Contact(<span class="string">"熊能"</span>, <span class="string">"https://github.com/yidao620c"</span>, <span class="string">"yidao620@gmail.com"</span>))</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="添加Swagger2注解"><a href="#添加Swagger2注解" class="headerlink" title="添加Swagger2注解"></a>添加Swagger2注解</h2><p>通过在接口上面添加注解方式可配置丰富接口的信息，先看一个例子：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Api</span>(value = <span class="string">"交警业务接口类"</span>, tags = <span class="string">"交警6合1业务接口"</span>, description = <span class="string">"主要任务和交警的专网通信"</span>)</span><br><span class="line"><span class="meta">@ApiResponses</span>(value = &#123;</span><br><span class="line">        <span class="meta">@ApiResponse</span>(code = <span class="number">200</span>, message = <span class="string">"请求正常完成"</span>),</span><br><span class="line">        <span class="meta">@ApiResponse</span>(code = <span class="number">400</span>, message = <span class="string">"请求中有语法问题，或不能满足请求"</span>),</span><br><span class="line"><span class="comment">//        @ApiResponse(code = 401, message = "未授权客户机访问数据"),</span></span><br><span class="line"><span class="comment">//        @ApiResponse(code = 403, message = "服务器接受请求，但是拒绝处理"),</span></span><br><span class="line"><span class="comment">//        @ApiResponse(code = 404, message = "服务器找不到给定的资源，文档不存在"),</span></span><br><span class="line">        <span class="meta">@ApiResponse</span>(code = <span class="number">500</span>, message = <span class="string">"服务器出现异常"</span>)&#125;</span><br><span class="line">)</span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/traffic"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TrafficController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OutTrafficService ts;</span><br><span class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断该账户是否存在于交警6合1系统</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> req</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ApiOperation</span>(value = <span class="string">"检查用户账号接口"</span>, notes = <span class="string">"检查该用户是否在6合1系统中存在"</span>, produces = <span class="string">"application/json"</span>)</span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/checkAccount"</span>, method = RequestMethod.POST)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity&lt;AccountResponse&gt; <span class="title">checkTrafficAccount</span><span class="params">(@RequestBody TrafficAccountReq req)</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">"检查用户账号接口 start..."</span>);</span><br><span class="line">        AccountResponse result = ts.checkTrafficAccount(req);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResponseEntity&lt;&gt;(result, HttpStatus.OK);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Swagger2提供了一些注解来丰富接口的信息,常用的有:</p>
<p>说明：</p>
<ul>
<li>@Api：用在类上，说明该类的作用</li>
<li>@ApiOperation：用在方法上，说明方法的作用</li>
<li>@ApiImplicitParams：用在方法上包含一组参数说明</li>
<li>@ApiImplicitParam：用在@ApiImplicitParams注解中，指定一个请求参数的各个方面<ul>
<li>paramType：参数放在哪个地方<ul>
<li>header–&gt;请求参数的获取：@RequestHeader</li>
<li>query–&gt;请求参数的获取：@RequestParam</li>
<li>path（用于restful接口）–&gt;请求参数的获取：@PathVariable</li>
<li>body（不常用）</li>
<li>form（不常用）</li>
</ul>
</li>
<li>name：参数名</li>
<li>dataType：参数类型</li>
<li>required：参数是否必须传</li>
<li>value：参数的意思</li>
<li>defaultValue：参数的默认值</li>
</ul>
</li>
<li>@ApiResponses：用于表示一组响应</li>
<li>@ApiResponse：用在@ApiResponses中，一般用于表达一个错误的响应信息<ul>
<li>code：数字，例如400</li>
<li>message：信息，例如”请求参数没填好”</li>
<li>response：抛出异常的类</li>
</ul>
</li>
<li>@ApiModel：描述一个Model的信息（这种一般用在post创建的时候，使用@RequestBody这样的场景，请求参数无法使用@ApiImplicitParam注解进行描述的时候）</li>
<li>@ApiModelProperty：描述一个model的属性</li>
</ul>
<p>以上这些就是最常用的几个注解了。</p>
<p>具体其他的注解，查看：</p>
<p><a href="https://github.com/swagger-api/swagger-core/wiki/Annotations#apimodel" target="_blank" rel="noopener">https://github.com/swagger-api/swagger-core/wiki/Annotations#apimodel</a></p>
<p>更多请参考<a href="http://docs.swagger.io/swagger-core/apidocs/com/wordnik/swagger/annotations/package-summary.html" target="_blank" rel="noopener">Swagger注解文档</a></p>
<h2 id="与Shiro集成配置"><a href="#与Shiro集成配置" class="headerlink" title="与Shiro集成配置"></a>与Shiro集成配置</h2><p>注意如果Spring Boot使用过Shiro或Spring Security框架，需要将相应的URL访问权限放开，以Shiro为例，添加匿名访问过滤器：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">filterChainDefinitionMap.put(<span class="string">"/api/v1/**"</span>, <span class="string">"anon"</span>); <span class="comment">//API接口</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// swagger接口文档</span></span><br><span class="line">filterChainDefinitionMap.put(<span class="string">"/v2/api-docs"</span>, <span class="string">"anon"</span>);</span><br><span class="line">filterChainDefinitionMap.put(<span class="string">"/webjars/**"</span>, <span class="string">"anon"</span>);</span><br><span class="line">filterChainDefinitionMap.put(<span class="string">"/swagger-resources/**"</span>, <span class="string">"anon"</span>);</span><br><span class="line">filterChainDefinitionMap.put(<span class="string">"/swagger-ui.html"</span>, <span class="string">"anon"</span>);</span><br></pre></td></tr></table></figure>

<h2 id="访问SwaggerUI"><a href="#访问SwaggerUI" class="headerlink" title="访问SwaggerUI"></a>访问SwaggerUI</h2><p>访问<code>http://localhost:8080/swagger-ui.html</code>页面查看API文档</p>
<p>如果使用的是<code>swagger-bootstrap-ui</code>，请访问<code>http://localhost:8080/doc.html</code></p>
<h2 id="生成PDF文档"><a href="#生成PDF文档" class="headerlink" title="生成PDF文档"></a>生成PDF文档</h2><p>参考我的另一篇文章 <a href="https://www.xncoding.com/2017/06/09/web/swagger.html" target="_blank" rel="noopener">使用Swagger生成RESTful API文档</a></p>
<p>这里我通过SpringBoot + Swagger2方式来生成AsciiDoc，然后剩下的步骤和上面博客一样。</p>
<h3 id="maven依赖"><a href="#maven依赖" class="headerlink" title="maven依赖"></a>maven依赖</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.pegdown<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>pegdown<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.6.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.github.swagger2markup<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>swagger2markup<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>另外修改下surefire插件，增加2个系统属性，也就是swagger.json和adoc文件生成的位置：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-surefire-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.20<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">systemPropertyVariables</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">swaggerOutputDir</span>&gt;</span>$&#123;project.basedir&#125;/src/main/resources/swagger<span class="tag">&lt;/<span class="name">swaggerOutputDir</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">asciiDocOutputDir</span>&gt;</span>$&#123;project.basedir&#125;/src/main/resources/swagger/swagger<span class="tag">&lt;/<span class="name">asciiDocOutputDir</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">systemPropertyVariables</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">skip</span>&gt;</span>true<span class="tag">&lt;/<span class="name">skip</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="编写单元测试方法"><a href="#编写单元测试方法" class="headerlink" title="编写单元测试方法"></a>编写单元测试方法</h3><p>原理是通过SpringBoot的MockMvc启动后访问<code>/v2/api-docs</code>，这个是Swagger的接口数据，然后保存为<code>swagger.json</code>，</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@AutoConfigureMockMvc</span></span><br><span class="line"><span class="meta">@RunWith</span>(SpringRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">SpringBootTest</span>(<span class="title">classes</span> </span>= Application<span class="class">.<span class="keyword">class</span>, <span class="title">webEnvironment</span> </span>= SpringBootTest.WebEnvironment.RANDOM_PORT)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Swagger2MarkupTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MockMvc mockMvc;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOG = LoggerFactory.getLogger(Swagger2MarkupTest<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createSpringFoxSwaggerJson</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"><span class="comment">//        String outputDir = System.getProperty("swaggerOutputDir"); // mvn test</span></span><br><span class="line">        MvcResult mvcResult = <span class="keyword">this</span>.mockMvc.perform(get(<span class="string">"/v2/api-docs"</span>)</span><br><span class="line">                .accept(MediaType.APPLICATION_JSON))</span><br><span class="line">                .andExpect(status().isOk())</span><br><span class="line">                .andReturn();</span><br><span class="line">        MockHttpServletResponse response = mvcResult.getResponse();</span><br><span class="line">        String swaggerJson = response.getContentAsString();</span><br><span class="line"><span class="comment">//        Files.createDirectories(Paths.get(outputDir));</span></span><br><span class="line"><span class="comment">//        try (BufferedWriter writer = Files.newBufferedWriter(Paths.get(outputDir, "swagger.json"), StandardCharsets.UTF_8))&#123;</span></span><br><span class="line"><span class="comment">//            writer.write(swaggerJson);</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line">        LOG.info(<span class="string">"--------------------swaggerJson create --------------------"</span>);</span><br><span class="line">        convertAsciidoc(swaggerJson);</span><br><span class="line">        LOG.info(<span class="string">"--------------------swagon.json to asciiDoc finished --------------------"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将swagger.yaml或swagger.json转换成漂亮的 AsciiDoc</span></span><br><span class="line"><span class="comment">     * 访问：http://localhost:9095/v2/api-docs</span></span><br><span class="line"><span class="comment">     * 将页面结果保存为src/main/resources/swagger.json</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">convertAsciidoc</span><span class="params">(String swaggerStr)</span> </span>&#123;</span><br><span class="line"><span class="comment">//        Path localSwaggerFile = Paths.get(System.getProperty("swaggerOutputDir"), "swagger.json");</span></span><br><span class="line">        Path outputFile = Paths.get(System.getProperty(<span class="string">"asciiDocOutputDir"</span>));</span><br><span class="line">        Swagger2MarkupConfig config = <span class="keyword">new</span> Swagger2MarkupConfigBuilder()</span><br><span class="line">                .withMarkupLanguage(MarkupLanguage.ASCIIDOC)</span><br><span class="line">                .withOutputLanguage(Language.ZH)</span><br><span class="line">                .withPathsGroupedBy(GroupBy.TAGS)</span><br><span class="line">                .withGeneratedExamples()</span><br><span class="line">                .withoutInlineSchema()</span><br><span class="line">                .build();</span><br><span class="line">        Swagger2MarkupConverter converter = Swagger2MarkupConverter.from(swaggerStr)</span><br><span class="line">                .withConfig(config)</span><br><span class="line">                .build();</span><br><span class="line">        converter.toFile(outputFile);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行之后会在<code>resources/swagger/</code>下面生成<code>swagger.adoc</code>，在<code>swagger.adoc</code>的顶部加入：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">:toclevels: 3</span><br><span class="line">:numbered:</span><br></pre></td></tr></table></figure>

<p>注意有个空行分割，目的是左边导航菜单是3级，并且自动加序号。为了美化显示，根据你的需要调整表格宽度，比如</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cols&#x3D;&quot;.^2,.^3,.^9,.^4,.^2&quot;</span><br></pre></td></tr></table></figure>

<p>替换成：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cols&#x3D;&quot;.^2,.^3,.^6,.^4,.^5&quot;</span><br></pre></td></tr></table></figure>

<p>然后在/resources目录下面执行：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">asciidoctor-pdf -r asciidoctor-pdf-cjk-kai_gen_gothic -a pdf-style&#x3D;KaiGenGothicCN swagger&#x2F;swagger.adoc</span><br></pre></td></tr></table></figure>

<p>更详细的安装字体和asciidoctor-pdf命令的方法，请参考上面的博客，将adoc文件转换成好看的PDF。</p>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="assets/1591542244-ec16d046fa94cf95570171c2a25f0f61.png" alt=""></p>
<h2 id="GitHub源码"><a href="#GitHub源码" class="headerlink" title="GitHub源码"></a>GitHub源码</h2><p><a href="https://github.com/yidao620c/SpringBootBucket/tree/master/springboot-swagger2" target="_blank" rel="noopener">springboot-swagger2</a>   —已测试</p>
<h2 id="来源"><a href="#来源" class="headerlink" title="来源"></a>来源</h2><p><a href="https://www.xncoding.com/" target="_blank" rel="noopener">https://www.xncoding.com/</a></p>
]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>springboot</tag>
        <tag>swagger2</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot系列 - 集成WebSocket实时通信</title>
    <url>/2020/06/08/SpringBoot%E7%B3%BB%E5%88%97-%E9%9B%86%E6%88%90WebSocket%E5%AE%9E%E6%97%B6%E9%80%9A%E4%BF%A1/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><h1 id="SpringBoot系列-集成WebSocket实时通信"><a href="#SpringBoot系列-集成WebSocket实时通信" class="headerlink" title="SpringBoot系列 - 集成WebSocket实时通信"></a>SpringBoot系列 - 集成WebSocket实时通信</h1><p>WebSocket是 HTML5 开始提供的一种浏览器与服务器间进行全双工通讯的网络技术。 WebSocket 通信协议于2011年被IETF定为标准RFC 6455，WebSocketAPI 被W3C定为标准。 在WebSocket API 中，浏览器和服务器只需要要做一个握手的动作，然后，浏览器和服务器之间就形成了一条快速通道。 两者之间就直接可以数据互相传送。</p>
<p>注意特点：</p>
<ul>
<li>为浏览器和服务端提供了双工异步通信的功能，即服务器可以主动向客户端推送信息，客户端也可以主动向服务器发送信息，是真正的双向平等对话，属于服务器推送技术的一种。</li>
<li>建立在 TCP 协议之上，服务器端的实现比较容易。</li>
<li>与 HTTP 协议有着良好的兼容性。默认端口也是80和443，并且握手阶段采用 HTTP 协议，因此握手时不容易屏蔽，能通过各种 HTTP 代理服务器。</li>
<li>数据格式比较轻量，性能开销小，通信高效。</li>
<li>可以发送文本，也可以发送二进制数据。</li>
<li>没有同源限制，客户端可以与任意服务器通信。</li>
<li>协议标识符是ws（如果加密，则为wss），服务器网址就是 URL。</li>
</ul>
<p>有多种方式实现WebSocket协议，比如SpringBoot官方推荐的基于STOMP实现，实现起来非常简单，还有通过Socket.IO来实现。 这里我讲一下基于STOMP的实现方案。</p>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>STOMP：即<code>Simple Text Orientated Messaging Protocol</code>，它是一个简单的文本消息传输协议，属于 WebSocket 的子协议， 提供了一个可互操作的连接格式，允许STOMP客户端与任意STOMP消息代理（Broker）进行交互。STOMP协议由于设计简单， 易于开发客户端，因此在多种语言和多种平台上得到广泛地应用。</p>
<h2 id="引入依赖"><a href="#引入依赖" class="headerlink" title="引入依赖"></a>引入依赖</h2><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-websocket<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-tomcat<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jetty<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>个人喜好用jetty取代tomcat，所以才这样写。你可以只需要引入<code>spring-boot-starter-websocket</code>即可。</p>
<h2 id="配置类"><a href="#配置类" class="headerlink" title="配置类"></a>配置类</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSocketMessageBroker</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebSocketConfig</span> <span class="keyword">extends</span> <span class="title">AbstractWebSocketMessageBrokerConfigurer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerStompEndpoints</span><span class="params">(StompEndpointRegistry stompEndpointRegistry)</span> </span>&#123;</span><br><span class="line">        stompEndpointRegistry.addEndpoint(<span class="string">"/simple"</span>)</span><br><span class="line">                .setAllowedOrigins(<span class="string">"*"</span>) <span class="comment">//解决跨域问题</span></span><br><span class="line">                .withSockJS();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configureMessageBroker</span><span class="params">(MessageBrokerRegistry registry)</span> </span>&#123;</span><br><span class="line">        registry.enableSimpleBroker(<span class="string">"/topic"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>关于这个类说明如下：</p>
<ol>
<li>@EnableWebSocketMessageBroker注解表示开启使用STOMP协议来传输基于代理的消息，Broker就是代理的意思。</li>
<li>registerStompEndpoints方法表示注册STOMP协议的节点，并指定映射的URL</li>
<li>addEndpoint(“/simple”).withSockJS(); 用来注册STOMP协议节点，同时指定使用SockJS</li>
<li>configureMessageBroker方法用来配置消息代理，由于我们是实现推送功能，这里的消息代理是/topic</li>
</ol>
<h2 id="请求消息类"><a href="#请求消息类" class="headerlink" title="请求消息类"></a>请求消息类</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestMessage</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="响应消息类"><a href="#响应消息类" class="headerlink" title="响应消息类"></a>响应消息类</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResponseMessage</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String responseMessage;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ResponseMessage</span><span class="params">(String responseMessage)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.responseMessage = responseMessage;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getResponseMessage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> responseMessage;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="SpringMVC控制器"><a href="#SpringMVC控制器" class="headerlink" title="SpringMVC控制器"></a>SpringMVC控制器</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WsController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SimpMessagingTemplate messagingTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WsController</span><span class="params">(SimpMessagingTemplate messagingTemplate)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.messagingTemplate = messagingTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@MessageMapping</span>(<span class="string">"/welcome"</span>)</span><br><span class="line">    <span class="meta">@SendTo</span>(<span class="string">"/topic/say"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseMessage <span class="title">say</span><span class="params">(RequestMessage message)</span> </span>&#123;</span><br><span class="line">        System.out.println(message.getName());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResponseMessage(<span class="string">"welcome,"</span> + message.getName() + <span class="string">" !"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 定时推送消息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Scheduled</span>(fixedRate = <span class="number">1000</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callback</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 发现消息</span></span><br><span class="line">        DateFormat df = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>);</span><br><span class="line">        messagingTemplate.convertAndSend(<span class="string">"/topic/callback"</span>, <span class="string">"定时推送消息时间: "</span> + df.format(<span class="keyword">new</span> Date()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>say方法上添加的@MessageMapping注解和我们之前使用的@RequestMapping类似。@SendTo注解表示当服务器有消息需要推送的时候， 会对订阅了@SendTo中路径的浏览器发送消息。</p>
<p>除此之外，我还定义了一个定时推送消息方法，这个方法每隔1秒会主动给订阅了主题<code>/topic/callback</code>的客户端推送消息。</p>
<p>到此为止服务器端就编写完成，可以看到服务器的编写非常简单。</p>
<h2 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h2><p>这里我使用浏览器的js来测试，先添加三个js文件：</p>
<ol>
<li>STOMP协议的客户端脚本stomp.js</li>
<li>SockJS的客户端脚本sock.js</li>
<li>页面dom操作脚本jQuery</li>
</ol>
<p>可在我的github项目源码里面找到这三个js文件。</p>
<p>下面是演示的页面：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>广播式WebSocket<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"js/sockjs.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"js/stomp.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"js/jquery-3.1.1.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">onload</span>=<span class="string">"disconnect()"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">noscript</span>&gt;</span><span class="tag">&lt;<span class="name">h2</span> <span class="attr">style</span>=<span class="string">"color: #e80b0a;"</span>&gt;</span>Sorry，浏览器不支持WebSocket<span class="tag">&lt;/<span class="name">h2</span>&gt;</span><span class="tag">&lt;/<span class="name">noscript</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">"connect"</span> <span class="attr">onclick</span>=<span class="string">"connect();"</span>&gt;</span>连接<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">"disconnect"</span> <span class="attr">disabled</span>=<span class="string">"disabled"</span> <span class="attr">onclick</span>=<span class="string">"disconnect();"</span>&gt;</span>断开连接<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"conversationDiv"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">label</span>&gt;</span>输入你的名字<span class="tag">&lt;/<span class="name">label</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">id</span>=<span class="string">"name"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">"sendName"</span> <span class="attr">onclick</span>=<span class="string">"sendName();"</span>&gt;</span>发送<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">"response"</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">"callback"</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">var</span> stompClient = <span class="literal">null</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">setConnected</span><span class="params">(connected)</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">document</span>.getElementById(<span class="string">"connect"</span>).disabled = connected;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">document</span>.getElementById(<span class="string">"disconnect"</span>).disabled = !connected;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">document</span>.getElementById(<span class="string">"conversationDiv"</span>).style.visibility = connected ? <span class="string">'visible'</span> : <span class="string">'hidden'</span>;</span></span><br><span class="line"><span class="javascript">        $(<span class="string">"#response"</span>).html();</span></span><br><span class="line"><span class="javascript">        $(<span class="string">"#callback"</span>).html();</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">connect</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> socket = <span class="keyword">new</span> SockJS(<span class="string">'http://localhost:8092/simple'</span>);</span></span><br><span class="line">        stompClient = Stomp.over(socket);</span><br><span class="line"><span class="actionscript">        stompClient.connect(&#123;&#125;, <span class="function"><span class="keyword">function</span> <span class="params">(frame)</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">            setConnected(<span class="literal">true</span>);</span></span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(<span class="string">'Connected:'</span> + frame);</span></span><br><span class="line"><span class="actionscript">            stompClient.subscribe(<span class="string">'/topic/say'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(response)</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">                showResponse(<span class="built_in">JSON</span>.parse(response.body).responseMessage);</span></span><br><span class="line">            &#125;);</span><br><span class="line"><span class="actionscript">            <span class="comment">// 另外再注册一下定时任务接受</span></span></span><br><span class="line"><span class="actionscript">            stompClient.subscribe(<span class="string">'/topic/callback'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(response)</span> </span>&#123;</span></span><br><span class="line">                showCallback(response.body);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">disconnect</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">if</span> (stompClient != <span class="literal">null</span>) &#123;</span></span><br><span class="line">            stompClient.disconnect();</span><br><span class="line">        &#125;</span><br><span class="line"><span class="actionscript">        setConnected(<span class="literal">false</span>);</span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(<span class="string">'Disconnected'</span>);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">sendName</span><span class="params">()</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> name = $(<span class="string">'#name'</span>).val();</span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(<span class="string">'name:'</span> + name);</span></span><br><span class="line"><span class="javascript">        stompClient.send(<span class="string">"/welcome"</span>, &#123;&#125;, <span class="built_in">JSON</span>.stringify(&#123;<span class="string">'name'</span>: name&#125;));</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">showResponse</span><span class="params">(message)</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">        $(<span class="string">"#response"</span>).html(message);</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="actionscript">    <span class="function"><span class="keyword">function</span> <span class="title">showCallback</span><span class="params">(message)</span> </span>&#123;</span></span><br><span class="line"><span class="javascript">        $(<span class="string">"#callback"</span>).html(message);</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>页面上面点击”连接”按钮后，开始连接到<code>/simple</code>节点。输入名字后点击发送，将向<code>/welcome</code>的url发送消息。</p>
<p>同时订阅了两个主题：<code>/topic/say</code> 和 <code>/topic/callback</code>，会接收到服务器的say方法的返回，以及定时推送消息。</p>
<p>演示效果：</p>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="assets/1591543223-6e221e2b415531b8575eadb10c0538b6.png" alt=""></p>
<p>每隔一秒页面都会刷新显示当前时间。同时控制台也会打印定时推送过来的消息。</p>
<h2 id="Android客户端"><a href="#Android客户端" class="headerlink" title="Android客户端"></a>Android客户端</h2><p>对于想要使用Android客户端进行WebSocket通信的， 可参考 <a href="https://github.com/NaikSoftware/StompProtocolAndroid" target="_blank" rel="noopener">StompProtocolAndroid</a></p>
<h2 id="GitHub源码"><a href="#GitHub源码" class="headerlink" title="GitHub源码"></a>GitHub源码</h2><p><a href="https://github.com/yidao620c/SpringBootBucket/tree/master/springboot-websocket" target="_blank" rel="noopener">springboot-websocket</a>   —已测试</p>
<h2 id="来源"><a href="#来源" class="headerlink" title="来源"></a>来源</h2><p><a href="https://www.xncoding.com/" target="_blank" rel="noopener">https://www.xncoding.com/</a></p>
]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>springboot</tag>
        <tag>websocket</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringCloud、RabbitMQ、Solr、Docker、Kubernetes</title>
    <url>/2020/03/29/SpringCloud%E3%80%81RabbitMQ%E3%80%81Solr%E3%80%81Docker%E3%80%81Kubernetes/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><h1 id="SpringCloud、RabbitMQ、Solr、Docker、Kubernetes"><a href="#SpringCloud、RabbitMQ、Solr、Docker、Kubernetes" class="headerlink" title="SpringCloud、RabbitMQ、Solr、Docker、Kubernetes"></a>SpringCloud、RabbitMQ、Solr、Docker、Kubernetes</h1><p><a href="https://blog.csdn.net/weixin_38305440/article/details/102775484" target="_blank" rel="noopener" title="Spring Cloud入门操作手册(Greenwich)">Spring Cloud入门操作手册(Greenwich)</a></p>
<p><a href="https://blog.csdn.net/weixin_38305440/article/details/102810522" target="_blank" rel="noopener" title="RabbitMQ">RabbitMQ</a></p>
<p><a href="https://blog.csdn.net/weixin_38305440/article/details/102810509" target="_blank" rel="noopener" title="Lucene Solr 811">Lucene Solr 811</a></p>
<p><a href="https://blog.csdn.net/weixin_38305440/article/details/102810532" target="_blank" rel="noopener" title="Docker">Docker</a></p>
<p><a href="https://blog.csdn.net/weixin_38305440/article/details/102810541" target="_blank" rel="noopener" title="Docker案例">Docker案例</a></p>
<p><a href="https://blog.csdn.net/weixin_38305440/article/details/102810548" target="_blank" rel="noopener" title="Kubernetes">Kubernetes</a></p>
<p>老师的笔记，收藏备用。2019-12-05 10:20:47 星期四 &euro;</p>
]]></content>
      <categories>
        <category>后端</category>
      </categories>
      <tags>
        <tag>springCloud</tag>
        <tag>rabbitMQ</tag>
        <tag>solr</tag>
        <tag>docker</tag>
        <tag>kubernetes</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot系列 - 集成Thymeleaf构建Web应用</title>
    <url>/2020/06/08/SpringBoot%E7%B3%BB%E5%88%97-%E9%9B%86%E6%88%90Thymeleaf%E6%9E%84%E5%BB%BAWeb%E5%BA%94%E7%94%A8/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><h1 id="SpringBoot系列-集成Thymeleaf构建Web应用"><a href="#SpringBoot系列-集成Thymeleaf构建Web应用" class="headerlink" title="SpringBoot系列 - 集成Thymeleaf构建Web应用"></a>SpringBoot系列 - 集成Thymeleaf构建Web应用</h1><p>Thymeleaf 是一个跟 Velocity、FreeMarker 类似的模板引擎，它可以完全替代 JSP 。相较与其他的模板引擎，它有如下三个极吸引人的特点：</p>
<ol>
<li>Thymeleaf 在有网络和无网络的环境下皆可运行，即它可以让美工在浏览器查看页面的静态效果，也可以让程序员在服务器查看带数据的动态页面效果。</li>
<li>Thymeleaf 开箱即用的特性。它提供标准和spring标准两种方言，可以直接套用模板实现JSTL、 OGNL表达式效果，避免每天套模板、该jstl、改标签的困扰。</li>
<li>Thymeleaf 提供spring标准方言和一个与 SpringMVC 完美集成的可选模块，可以快速的实现表单绑定、属性编辑器、国际化等功能。</li>
</ol>
<p>目前最新版本是Thymeleaf 3，官网地址：<a href="http://www.thymeleaf.org/" target="_blank" rel="noopener">http://www.thymeleaf.org</a></p>
<p>本篇将介绍如何在SpringBoot中集成Thymeleaf构建Web应用。</p>
<h2 id="maven依赖"><a href="#maven依赖" class="headerlink" title="maven依赖"></a>maven依赖</h2><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.reporting.outputEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">thymeleaf.version</span>&gt;</span>3.0.7.RELEASE<span class="tag">&lt;/<span class="name">thymeleaf.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">thymeleaf-layout-dialect.version</span>&gt;</span>2.2.2<span class="tag">&lt;/<span class="name">thymeleaf-layout-dialect.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-tomcat<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jetty<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="资源目录"><a href="#资源目录" class="headerlink" title="资源目录"></a>资源目录</h2><p>Spring Boot默认提供静态资源目录位置需置于classpath下，目录名需符合如下规则：</p>
<ol>
<li>/static</li>
<li>/public</li>
<li>/resources</li>
<li>/META-INF/resources</li>
</ol>
<p>举例：我们可以在<code>src/main/resources/</code>目录下创建static，在该位置放置一个图片文件<code>pic.jpg</code>。 启动程序后，尝试访问<code>http://localhost:8080/pic.jpg</code>。如能显示图片，配置成功。</p>
<p>SpringBoot的默认模板路径为：<code>src/main/resources/templates</code></p>
<h2 id="添加页面"><a href="#添加页面" class="headerlink" title="添加页面"></a>添加页面</h2><p>这里我在<code>src/main/resources/templates</code>下面添加一个<code>index.html</code>首页，同时引用到一些css、js文件，看看Thymeleaf 3的语法：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">xmlns</span>=<span class="string">"http://www.w3.org/1999/xhtml"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">xmlns:th</span>=<span class="string">"http://www.thymeleaf.org"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"renderer"</span> <span class="attr">content</span>=<span class="string">"webkit"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>首页<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"shortcut icon"</span> <span class="attr">th:href</span>=<span class="string">"@&#123;/favicon.ico&#125;"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">th:href</span>=<span class="string">"@&#123;/static/css/bootstrap.min.css&#125;"</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">th:href</span>=<span class="string">"@&#123;/static/css/font-awesome.min.css&#125;"</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">class</span>=<span class="string">"fixed-sidebar full-height-layout gray-bg"</span> <span class="attr">style</span>=<span class="string">"overflow:hidden"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"wrapper"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span> <span class="attr">th:text</span>=<span class="string">"$&#123;msg&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">th:src</span>=<span class="string">"@&#123;/static/js/jquery.min.js&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">th:src</span>=<span class="string">"@&#123;/static/js/bootstrap.min.js&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>页面中几个地方说明一下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;html xmlns&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;1999&#x2F;xhtml&quot;</span><br><span class="line">      xmlns:th&#x3D;&quot;http:&#x2F;&#x2F;www.thymeleaf.org&quot;&gt;</span><br></pre></td></tr></table></figure>

<p>加上这个命名空间后就能在页面中使用Thymeleaf自己的标签了，以<code>th:</code>开头。</p>
<p>连接语法 <code>th:href=&quot;@{/static/css/bootstrap.min.css}&quot;</code></p>
<p>访问Model中的数据语法 <code>th:text=&quot;${msg}&quot;</code></p>
<p>这里我在页面里显示的是一个键为<code>msg</code>的消息，需要后台传递过来。</p>
<p>Thymeleaf 3的详细语法规则请参考 <a href="http://www.thymeleaf.org/doc/tutorials/3.0/usingthymeleaf.html" target="_blank" rel="noopener">官网教程</a></p>
<h2 id="编写Controller"><a href="#编写Controller" class="headerlink" title="编写Controller"></a>编写Controller</h2><p>接下来编写控制器类，将URL <code>/</code> 和 <code>/index</code> 都返回index.html页面：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IndexController</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger _logger = LoggerFactory.getLogger(IndexController<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 主页</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> model</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(&#123;<span class="string">"/"</span>, <span class="string">"/index"</span>&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">index</span><span class="params">(Model model)</span> </span>&#123;</span><br><span class="line">        model.addAttribute(<span class="string">"msg"</span>, <span class="string">"welcome you!"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"index"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里，我再model里面添加了一个属性，key=<code>msg</code>，值为<code>welcome you!</code>。</p>
<p>接下来启动应用后，打开首页看看效果如何。消息正确显示，成功！。</p>
<h2 id="GitHub源码"><a href="#GitHub源码" class="headerlink" title="GitHub源码"></a>GitHub源码</h2><p>已测试</p>
<h2 id="来源"><a href="#来源" class="headerlink" title="来源"></a>来源</h2><p><a href="https://www.xncoding.com/" target="_blank" rel="noopener">https://www.xncoding.com/</a></p>
]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>springboot</tag>
        <tag>thymeleaf</tag>
      </tags>
  </entry>
  <entry>
    <title>Sql语句</title>
    <url>/2020/04/05/Sql%E8%AF%AD%E5%8F%A5/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><hr>
<p>一、创建建数据库、创建建数据表、查看数据库、查看数据表</p>
<hr>
<p>– 01.查看mysql服务器中所有数据库</p>
<pre><code>show databases;</code></pre><p>– 02.进入某一数据库（进入数据库后，才能操作库中的表和表记录）</p>
<pre><code>use test;</code></pre><p>– 查看已进入的库</p>
<pre><code>select database();</code></pre><p>– 03.查看当前数据库中的所有表</p>
<pre><code>show tables;</code></pre><p>– 04.删除mydb1库</p>
<pre><code>-- 语法：drop database 库名;
drop database  mydb1;
-- 思考：当删除的表不存在时，如何避免错误产生?
drop database if exists mydb1;</code></pre><p>– 05.重新创建mydb1库，指定编码为utf8</p>
<pre><code>-- 语法：create database 库名 charset 编码;
create database mydb1 charset utf8;

-- 如果不存在则创建mydb1;
create database mydb1 if not exists charset utf8; </code></pre><p>– 06.查看建库时的语句（并验证数据库库使用的编码）</p>
<pre><code>-- 语法：show create database 库名;
show create database mydb1;</code></pre><p>– 07.进入mydb1库，删除stu学生表(如果存在)</p>
<pre><code>-- 语法：drop table 表名;
use mydb1
drop table stu;
drop table if exists stu;</code></pre><p>– 08.创建stu学生表（编号[数值类型]、姓名、性别、出生年月、考试成绩[浮点型]）</p>
<pre><code>/* 建表的语法：
create table 表名(
    列名 数据类型,
    列名 数据类型,
    ...
); */</code></pre><hr>
<pre><code>create table if not exists stu(
    id int primary key auto_increment,
    name varchar(20),
    genger varchar(10),
    birthday date,
    score double
);</code></pre><p>– 09.查看stu学生表结构</p>
<pre><code>show create table stu;
desc stu;</code></pre><hr>
<p>二、新增、修改、删除表记录 <strong><strong>**</strong></strong></p>
<hr>
<p>– 10.往学生表(stu)中插入记录(数据)</p>
<pre><code>-- 插入记录：insert into 表名(列1，列2，列3...) values(值1，值2，值3...);
insert into stu(id,name,genger,birthday,score)     values(null,&apos;赵伟成&apos;,&apos;女&apos;,&apos;2018-3-9&apos;,33);

insert into stu values(null,&apos;赵伟成&apos;,&apos;女&apos;,&apos;2018-3-9&apos;,33);
insert into stu values(null,&apos;张三&apos;,&apos;男&apos;,&apos;2018-3-9&apos;,11);
insert into stu values(null,&apos;卫程&apos;,&apos;女&apos;,&apos;2022-1-11&apos;,55);
/* 提示：
 设置编码：set names gbk;
 查看MySQL数据库使用的编码：show variables like &apos;char%&apos;;
 mysql --default-character-set=gbk -uroot -proot */</code></pre><p>– 11.查询stu表所有学生的信息</p>
<pre><code>select * from stu;
select id,name from stu;</code></pre><p>– 12.修改stu表中所有学生的成绩，加10分特长分</p>
<pre><code>-- 修改语法: update 表名 set 列=值,列=值,列=值...;
update stu set score=score+10;</code></pre><p>– 13.修改stu表中王海涛的成绩，将成绩改为88分。\c取消当前语句的执行</p>
<pre><code>update stu set score=88
where name = &apos;卫程&apos;;

/* 提示：where子句用于对记录进行筛选过滤，
   保留符合条件的记录，将不符合条件的记录剔除。*/</code></pre><p>– 14.删除stu表中所有的记录</p>
<pre><code>-- 删除记录语法: delete from 表名 [where条件] 
delete from stu;

-- 仅删除符合条件的
delete from stu where id= 1;</code></pre><hr>
<p>三、基础查询、where子句查询</p>
<hr>
<p>– 准备数据： 以下练习将使用db10库中的表及表记录，请先进入db10数据库!!!<br>– 准备数据： 以下练习将使用db10库中的表及表记录，请先进入db10数据库!!!</p>
<p>– <strong>****</strong> 基础查询 <strong>****</strong><br>– 15.查询emp表中的所有员工，显示姓名，薪资，奖金</p>
<pre><code>use db10;
select name,sal,bonus  
from emp;</code></pre><p>– 16.查询emp表中的所有员工，显示所有列</p>
<pre><code>select * from emp;
/* 使用 *（星号）的缺点：把不必要的列也查询出来了，而且效率不如直接指定列名 */</code></pre><p>– 17.查询emp表中的所有部门和职位</p>
<pre><code>select dept,job 
from emp;

/* 思考：如果查询的结果中，存在大量重复的记录，如何剔除重复记录，只保留一条？ */

-- distinct 用于剔除重复的记录
select distinct dept,job from emp;</code></pre><p>– <strong>****</strong> WHERE子句查询 <strong>****</strong><br>– 18.查询emp表中薪资大于3000的所有员工，显示员工姓名、薪资</p>
<pre><code>select name,sal from emp
where sal&gt;3000;</code></pre><p>– 19.查询emp表中总薪资(薪资+奖金)大于3500的所有员工，显示员工姓名、总薪资</p>
<pre><code>select name,sal+ifnull(bonus,0) from emp
where sal+ifnull(bonus,0)&gt;3500;
-- ifnull(列, 值)函数: 判断指定的列是否包含null值, 如果有null值, 用第二个值替换null值</code></pre><p>select name,sal+ifnull(bonus,0) from emp</p>
<pre><code>where sal+ifnull(bonus,0)&gt;3500;
-- 注意查看上面查询结果中的表头，如何将表头中的 sal+bonus 修改为 &quot;总薪资&quot;，as可省略</code></pre><p>select name  姓名,sal+ifnull(bonus,0) as 总薪资 from emp</p>
<pre><code>where sal+ifnull(bonus,0)&gt;3500;

-- 试一试：where中能使用定义好的别名吗?
不能</code></pre><p>– 20.查询emp表中薪资在3000和4500之间的员工，显示员工姓名和薪资</p>
<pre><code>select name,sal from emp
where sal&gt;=3000&amp;&amp;sal&lt;=4500;
-- 提示: between...and... 在...之间
select name,sal from emp
where sal between 3200 and 4500;</code></pre><p>– 21.查询emp表中薪资为 1400、1600、1800的员工，显示员工姓名和薪资<br>select name,sal</p>
<pre><code>from emp
where sal=1400 or sal=1600 or sal=1800;
-- 或者
select name,sal
from emp
where sal in(1400,1600,1800);</code></pre><p>– 22.查询薪资不为1400、1600、1800的员工</p>
<pre><code>select name,sal
from emp
where not (sal=1400 or sal=1600 or sal=1800);
-- 或者
select name,sal
from emp
where sal!=1400 and sal!=1600 and sal!=1800;
-- 或者
select name,sal
from emp
where sal not in(1400,1600,1800);</code></pre><p>– 23.查询emp表中薪资大于4000和薪资小于2000的员工，显示员工姓名、薪资。</p>
<pre><code>select name,sal
from emp
where sal&gt;4000 or sal&lt;2000;</code></pre><p>– 24.查询emp表中薪资大于3000并且奖金小于600的员工，显示员工姓名、薪资、奖金。</p>
<pre><code>select name,sal,bonus
from emp
where sal&gt;3000 and bonus&lt;600;
-- 处理null值
select name,sal,bonus
from emp
where sal&gt;3000 and ifnull(bonus,0)&lt;600;
-- 处理null值</code></pre><p>– 25.查询没有部门的员工（即部门列为null值）</p>
<pre><code>select * from emp
where dept is null;
-- 思考：如何查询有部门的员工（即部门列不为null值）
select * from emp
where dept is not null;
-- 思考：如何查询有部门的员工（即部门列不为null值）</code></pre><p>– <strong>****</strong> Like模糊查询 <strong>****</strong><br>– 26.查询emp表中姓名中以”刘”开头的员工，显示员工姓名。</p>
<pre><code>select name from emp
where name like&apos;刘%&apos;;

/* like进行模糊查询，&quot;%&quot; 表示通配，表示0或多个字符。
&quot;_&quot;表示一个任意的字符 */
select name from emp
where name like&apos;刘_&apos;;</code></pre><p>– 27.查询emp表中姓名中包含”涛”员工，显示员工姓名。\</p>
<pre><code>select name from emp
where name like&apos;%涛%&apos;;</code></pre><p>– 28.查询emp表中姓名以”刘”开头并且姓名为2个字的员工，显示员工姓名。</p>
<pre><code>select name from emp
where name like&apos;刘_&apos;;</code></pre><hr>
<p>– 三、分组查询、聚合函数、排序查询</p>
<hr>
<p>– 29.对emp表按照部门对员工进行分组，查看分组后效果</p>
<pre><code>/* 分组的语法: 
select 查询的列 from 表名 group by 列名
根据指定的列进行分组 */
select * from emp 
group by dept;</code></pre><p>– 30.对emp表按照职位进行分组, 并统计每个职位的人数, 显示职位和对应人数</p>
<pre><code>select count(id) 人数,job 职位 
from emp 
group by job;</code></pre><p>– 31.对emp表按照部门进行分组, 求每个部门的最高薪资(不包含奖金)，显示部门名称和最高薪资 max() min(),</p>
<pre><code>select dept 部门,max(sal) 最高薪资
from emp
group by dept;</code></pre><p>– 32.统计emp表中薪资大于3000的员工个数（- count(column)统计某列的行数）</p>
<pre><code>select count(*) from emp
where sal&gt;3000;</code></pre><p>– 33.统计emp表中所有员工的薪资总和(不包含奖金)（- sum(column)对某列的值求和）</p>
<pre><code>select sum(sal) from emp ;</code></pre><p>– 34.统计emp表员工的平均薪资(不包含奖金)（- avg(column)对某列的值求平均值）</p>
<pre><code>select avg(sal) from emp ;</code></pre><p>– 35.查询emp表中所有在1993和1995年之间出生的员工，显示姓名、出生日期。</p>
<pre><code>select name,birthday 
from emp
where birthday between &apos;1993-01-01&apos; and &apos;1995-12-31&apos;;

-- 或者 year(),month(),day(),
select name,birthday 
from emp
where year(birthday) between 1993 and 1995;</code></pre><p>– 36.查询本月过生日的所有员工</p>
<pre><code>select * from emp
where month(curdate())= month(birthday);
/* 
curdate() 获取当前日期 年月日
select curdate();
curtime() 获取当前时间 时分秒
select curtime();
sysdate() 获取当前日期+时间 年月日 时分秒 
select sysdate();
select now();
*/</code></pre><hr>
<p>– <strong><strong><strong>****</strong></strong></strong> 排序查询 <strong><strong><strong>***</strong></strong></strong></p>
<hr>
<pre><code>/* order by 排序的列 asc 升序(从低到高)
order by 排序的列 desc 降序(从高到低)
默认就是升序，所以asc可以省略不写 */</code></pre><p>– 37.对emp表中所有员工的薪资进行升序(从低到高)排序，显示员工姓名、薪资。</p>
<pre><code>select name,sal from emp
order by sal;</code></pre><p>– 38.对emp表中所有员工奖金进行降序(从高到低)排序，显示员工姓名、奖金。</p>
<pre><code>select name,bonus from emp
order by bonus desc;</code></pre><hr>
<p>– <strong><strong><strong>****</strong></strong></strong> 分页查询 <strong><strong><strong>***</strong></strong></strong></p>
<hr>
<pre><code>/* 在mysql中，通过limit进行分页查询：
limit (页码-1)*每页显示记录数, 每页显示记录数 */</code></pre><p>– 39.查询emp表中的所有记录，分页显示：每页显示3条记录，返回第 1 页。</p>
<pre><code>select * from emp
limit 0,3;
select * from emp
limit 6,3;</code></pre><p>– 40.查询emp表中的所有记录，分页显示：每页显示3条记录，返回第 2 页。</p>
<pre><code>select * from emp
limit 3,3;

select * from emp
limit 9,3;</code></pre><hr>
<p>– 三、外键</p>
<hr>
<p>– 准备数据： 以下练习将使用db20库中的表及表记录，请先进入db20数据库!!!<br>– 准备数据： 以下练习将使用db20库中的表及表记录，请先进入db20数据库!!!<br>– 41.尝试删除dept表中的某一个部门</p>
<pre><code>/* 上面的部门删除成功后，员工表里的某些员工就没有了对应的部门,
这种我们称之为数据的完整性被破坏了,
为了避免这种情况，可以在删除之前，查看将要删除的部门下是否还有员工存在，如果有就不要删除;
或者，让数据库帮我们去维护这样的对应关系，也就是当将要被删除的部门下如果还有员工，
就阻止删除操作，让数据库帮我们维护这样的对应关系，就需要指定外键。*/</code></pre><p>– 42.重新创建db20中的dept和emp表，在创建时，指定emp表中的dept_id列为外键，即这一列要严格参考dept表中的id列, 再次尝试删除dept表中的某一个部门，查看是否能删除成功</p>
<hr>
<p>– 四、关联查询、外连接查询</p>
<hr>
<p>– 准备数据： 以下练习将使用db30库中的表及表记录，请先进入db30数据库!!!<br>– 准备数据： 以下练习将使用db30库中的表及表记录，请先进入db30数据库!!!</p>
<p>– 43.查询部门和部门对应的员工信息</p>
<pre><code>select * from emp,dept
where dept.id = emp.dept_id;
--
select * from dept inner join emp
on dept.id = emp.dept_id;</code></pre><p>– 44.查询所有部门和部门下的员工，如果部门下没有员工，员工显示为null</p>
<pre><code>select * from dept left join emp
on dept.id = emp.dept_id;</code></pre><p>– 45.查询部门和所有员工，如果员工没有所属部门，部门显示为null</p>
<pre><code>select * from dept right join emp
on dept.id = emp.dept_id;</code></pre><hr>
<p>– 五、子查询、多表查询</p>
<hr>
<p>– 准备数据：以下练习将使用db40库中的表及表记录，请先进入db40数据库!!!<br>– 准备数据：以下练习将使用db40库中的表及表记录，请先进入db40数据库!!!</p>
<p>– 46.列出薪资比’王海涛’薪资高的所有员工，显示姓名、薪资</p>
<pre><code>select name,sal from emp
where sal&gt;(
select sal from emp
where name= &apos;王海涛&apos;
);</code></pre><p>– 47.列出与’刘沛霞’从事相同职位的所有员工，显示姓名、职位。</p>
<pre><code>select name,job from emp
where job = (
select job from emp
where name = &apos;刘沛霞&apos;
);</code></pre><p>– 48.列出薪资比’大数据部’部门(已知部门编号为30)所有员工薪资都高的员工信息，显示员工姓名、薪资和部门名称。</p>
<pre><code>select emp.name,sal,dept.name 
from emp,dept
where emp.dept_id = dept.id and sal&gt;(
    select max(sal) from emp,dept
    where dept_id = 30 and emp.dept_id = dept.id
);

select emp.name,sal,dept.name 
from emp left join dept
on emp.dept_id = dept.id and 
where sal&gt;(
    select max(sal) from emp
    where dept_id = 30 
);</code></pre><p>– 49.列出在’培优部’任职的员工，假定不知道’培优部’的部门编号， 显示部门名称，员工名称。</p>
<pre><code>-- 关联查询两张表
-- 求出在培优部的员工
select dept.name,emp.name 
from emp,dept
where emp.dept_id = dept.id and 
   dept.name = &apos;培优部&apos;;</code></pre><p>– 50.(自查询)列出所有员工及其直接上级，显示员工姓名、上级编号，上级姓名</p>
<pre><code>select e1.name,e2.topid,e2.name 
from emp as e1,emp e2
where e1.topid = e2.id;</code></pre><p>– 51.列出最低薪资大于1500的各种职位，显示职位和该职位最低薪资</p>
<pre><code>select job, min(sal)
from emp
group by job
having min(sal)&gt;1500;</code></pre><p>– 52.列出在每个部门就职的员工数量、平均工资。显示部门编号、员工数量，平均薪资。</p>
<pre><code>select dept_id,count(*),avg(sal)
from emp
group by dept_id;</code></pre><p>– 53.查出至少有一个员工的部门。显示部门编号、部门名称、部门位置、部门人数。</p>
<pre><code>-- 关联查询两张表(dept, emp)
-- 替换要显示的列和统计部门人数
select dept.id,dept.name,dept.loc,count(*)
from emp,dept
where emp.dept_id = dept.id 
group by dept.name;</code></pre><p>– 54.列出受雇日期早于直接上级的所有员工的编号、姓名、部门名称。</p>
<pre><code>/* 
列: e1.id, e1.name, d.name
表:    emp e1: 员工表
    emp e2: 上级表
    dept d: 部门表
关联条件: e1.topid=e2.id
        e1.dept_id=d.id
        e1.hdate&lt;e2.hdate  */
select e1.id, e1.name, d.name
from emp e1,emp e2,dept d
where e1.topid=e2.id and e1.dept_id=d.id
    and e1.hdate&lt;e2.hdate;</code></pre><p>– 55.列出每个部门薪资最高的员工信息，显示部门编号、员工姓名、薪资</p>
<pre><code>-- 查询emp表中所有员工的部门编号、姓名、薪资
-- 查询emp表中每个部门的最高薪资，显示部门编号、最高薪资
-- 第二次查询的结果作为一张临时表和第一次查询进行关联查询

select emp.dept_id, t1.ms,emp.name
from emp,(
    select dept_id, max(sal) ms 
    from emp 
    group by dept_id) t1
where emp.dept_id = t1.dept_id and t1.ms=emp.sal;</code></pre><p>======================================<br>补充1、笛卡尔积查询：</p>
<pre><code>笛卡尔积查询：如果同时查询两张表，左边表有m条数据，右边表有n条数据，那么笛卡尔积查询是结果就是 m*n 条记录。这就是笛卡尔积查询。例如： 
select * from dept,emp;
上面的查询中包含大量错误的数据, 一般不使用这种查询。

如果只想保留正确的记录，可以通过where条件进行筛选，将符合条件的保留下来，不符合条件的自然就会被剔除，例如：
select * from dept,emp
where dept.id=emp.dept_id;</code></pre><p>补充2、左外连接和右外连接查询：</p>
<pre><code>(1) 左外连接查询：是将左边表中所有数据都查询出来, 如果在右边表中没有对应的记录, 右边表显示为null即可。
(2) 右外连接查询：是将右边表中所有数据都查询出来, 如果在左边表中没有对应的记录, 左边表显示为null即可。</code></pre><p>补充3、where和having都用于筛选过滤，但是： </p>
<pre><code>(1) where用于在分组之前进行筛选, having用于在分组之后进行筛选
(2) 并且where中不能使用列别名, having中可以使用别名
(3) where子句中不能使用列别名(可以使用表别名), 因为where子句比select先执行!!</code></pre><p>补充4、SQL语句的书写顺序和执行顺序:<br>  SQL语句的书写顺序：</p>
<pre><code>select...
from...
where...
group by...
order by...
...</code></pre><p>  SQL语句的执行顺序：</p>
<pre><code>from... -- 确定要查询的是哪张表 (定义表别名)
where... -- 从整张表的数据中进行筛选过滤
select... -- 确定要显示哪些列 (定义列别名)
group by... -- 根据指定的列进行分组
order by... -- 根据指定的列进行排序
...</code></pre><p>======================================</p>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>sql</tag>
      </tags>
  </entry>
  <entry>
    <title>Zookeeper</title>
    <url>/2020/03/27/Zookeeper/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><h1 id="Zookeeper-安装"><a href="#Zookeeper-安装" class="headerlink" title="Zookeeper 安装"></a>Zookeeper 安装</h1><h2 id="1-1Zookeeper"><a href="#1-1Zookeeper" class="headerlink" title="1.1Zookeeper"></a>1.1Zookeeper</h2><h3 id="1-1-1Zookeeper介绍"><a href="#1-1-1Zookeeper介绍" class="headerlink" title="1.1.1Zookeeper介绍"></a>1.1.1Zookeeper介绍</h3><p>ZooKeeper是一个分布式的，开放源码的分布式应用程序协调服务，是Google的Chubby一个开源的实现，是Hadoop和Hbase的重要组件。它是一个为分布式应用提供一致性服务的软件，提供的功能包括：配置维护、域名服务、分布式同步、组服务等。<br>ZooKeeper的目标就是封装好复杂易出错的关键服务，将简单易用的接口和性能高效、功能稳定的系统提供给用户。<br>ZooKeeper包含一个简单的原语集,提供Java和C的接口。<br>ZooKeeper代码版本中，提供了分布式独享锁、选举、队列的接口，代码在zookeeper-3.4.3\src\recipes。其中分布锁和队列有Java和C两个版本，选举只有Java版本。<br>总结:Zookeeper负责服务的协调调度.当客户端发起请求时,返回正确的服务器地址.</p>
<h3 id="1-1-2Zookeeper下载"><a href="#1-1-2Zookeeper下载" class="headerlink" title="1.1.2Zookeeper下载"></a>1.1.2Zookeeper下载</h3><p>网址: <a href="http://zookeeper.apache.org/releases.html" target="_blank" rel="noopener">http://zookeeper.apache.org/releases.html</a>.<br>如图-2所示</p>
<hr>
<h2 id=""><a href="#" class="headerlink" title=""></a><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-8216270faedd430d85ed24fe29898f31.png" alt="image.png"></h2><p>图-2<br>下载路径,点击download.<br>如图-3所示</p>
<hr>
<h2 id="-1"><a href="#-1" class="headerlink" title=""></a><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-eedd0e510d7943ee829628375061624f.png" alt="image.png"></h2><p>图-3<br>下载Zookeeper地址.<br><a href="http://mirrors.hust.edu.cn/apache/zookeeper/" target="_blank" rel="noopener">http://mirrors.hust.edu.cn/apache/zookeeper/</a><br>如图-4所示</p>
<hr>
<h2 id="-2"><a href="#-2" class="headerlink" title=""></a><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-41f07c949eaf4d71b10d3d1df73fa693.png" alt="image.png"></h2><p>图-4</p>
<h2 id="1-2Zookeeper安装"><a href="#1-2Zookeeper安装" class="headerlink" title="1.2Zookeeper安装"></a>1.2Zookeeper安装</h2><h3 id="1-2-1安装JDK"><a href="#1-2-1安装JDK" class="headerlink" title="1.2.1安装JDK"></a>1.2.1安装JDK</h3><p>将JDK1.8文件上传到Linux操作系统中/src/usr/local/java/文件下.<br>如图-5所示</p>
<hr>
<h2 id="-3"><a href="#-3" class="headerlink" title=""></a><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-7074267a86504a7bb7d608e53530c7b6.png" alt="image.png"></h2><p>图-5<br>1.解压文件<br>tar -xvf jdk-8u51-linux-x64.tar.gz<br>2.配置环境变量<br>编辑环境变量配置文件<br>vim /etc/profile<br>如图-6所示</p>
<hr>
<h2 id="-4"><a href="#-4" class="headerlink" title=""></a><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-860af512cce74a00983685715f187959.png" alt="image.png"></h2><p>图-6<br>使JDK生效,之后检查jdk安装是否成功<br>source /etc/profile<br>如图 -7所示</p>
<hr>
<h2 id="-5"><a href="#-5" class="headerlink" title=""></a><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-781c797140fe4380881e91619d8fcf5c.png" alt="image.png"></h2><p>图-7</p>
<h3 id="1-2-2上传安装文件"><a href="#1-2-2上传安装文件" class="headerlink" title="1.2.2上传安装文件"></a>1.2.2上传安装文件</h3><p>说明:上传zookeeper安装文件.之后解压.<br>如图-8所示</p>
<hr>
<h2 id="-6"><a href="#-6" class="headerlink" title=""></a><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-971e330e1d7341ea872052081c42fc9b.png" alt="image.png"></h2><p>图-8<br>解压目录:<br>tar -xvf zookeeper-3.4.8.tar.gz</p>
<h3 id="1-2-3修改配置文件"><a href="#1-2-3修改配置文件" class="headerlink" title="1.2.3修改配置文件"></a>1.2.3修改配置文件</h3><p>在zk根目录下创建文件夹data/log<br>mkdir data log<br>如图-9所示</p>
<hr>
<h2 id="-7"><a href="#-7" class="headerlink" title=""></a><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-a57e315772904f6fa0e053f88211be4f.png" alt="image.png"></h2><p>图-9<br>复制配置文件并且修改名称<br>cp zoo_sample.cfg zoo.cfg<br>如图-10所示</p>
<hr>
<h2 id="-8"><a href="#-8" class="headerlink" title=""></a><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-9185194983bf4296b3331ee19c6b55a2.png" alt="image.png"></h2><p>图-10</p>
<h3 id="1-2-4启动zk"><a href="#1-2-4启动zk" class="headerlink" title="1.2.4启动zk"></a>1.2.4启动zk</h3><p>zk启动关闭命令如下.<br>sh zkServer.sh start     或者  ./zkServer.sh start<br>sh zkServer.sh stop<br>sh zkServer.sh status<br>如图-11所示</p>
<hr>
<h2 id="-9"><a href="#-9" class="headerlink" title=""></a><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-47e0942ad88443fab74a7328a65bdbb0.png" alt="image.png"></h2><p>图-11</p>
<h2 id="1-3Zookeeper集群安装"><a href="#1-3Zookeeper集群安装" class="headerlink" title="1.3Zookeeper集群安装"></a>1.3Zookeeper集群安装</h2><h3 id="1-3-1准备文件夹"><a href="#1-3-1准备文件夹" class="headerlink" title="1.3.1准备文件夹"></a>1.3.1准备文件夹</h3><p>在zookeeper根目录中创建新的文件夹zkCluster.<br>如图-12所示</p>
<hr>
<h2 id="-10"><a href="#-10" class="headerlink" title=""></a><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-6f229215118a4742b272dcd82284412a.png" alt="image.png"></h2><p>图-12<br>如图-13所示</p>
<h2 id="创建zk1-zk2-zk3文件夹"><a href="#创建zk1-zk2-zk3文件夹" class="headerlink" title="创建zk1/zk2/zk3文件夹."></a>创建zk1/zk2/zk3文件夹.</h2><h2 id="-11"><a href="#-11" class="headerlink" title=""></a><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-a231d6cf8f624ea6afe754f027cc4026.png" alt="image.png"></h2><p>图-13<br>在每个文件夹里创建data/log文件夹.<br>mkdir {zk1,zk2,zk3}/{data,log}<br>如图-14所示</p>
<hr>
<h2 id="-12"><a href="#-12" class="headerlink" title=""></a><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-22fca11a61de4db5944f17c7ceca09f7.png" alt="image.png"></h2><p>图-14</p>
<h3 id="1-3-2添加myid文件"><a href="#1-3-2添加myid文件" class="headerlink" title="1.3.2添加myid文件"></a>1.3.2添加myid文件</h3><p>分别在zk1/zk2/zk3中的data文件夹中创建新的文件myid.其中的内容依次为1/2/3,与zk节点号对应.<br>如图-15所示</p>
<hr>
<h2 id="-13"><a href="#-13" class="headerlink" title=""></a><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-6efe08a4dac84be38670a491f08851a1.png" alt="image.png"></h2><p>图-15<br>编辑myid文件,定义编号.<br>图-16所示</p>
<hr>
<h2 id="-14"><a href="#-14" class="headerlink" title=""></a><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-cba24531f3b04988ba41302de0e8e8da.png" alt="image.png"></h2><p>图-16</p>
<h3 id="1-3-3编辑配置文件"><a href="#1-3-3编辑配置文件" class="headerlink" title="1.3.3编辑配置文件"></a>1.3.3编辑配置文件</h3><p>将zoo_sample.cfg 复制为zoo1.cfg之后修改配置文件.<br>如图-17所示</p>
<hr>
<h2 id="-15"><a href="#-15" class="headerlink" title=""></a><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-f060179ff53d4e2a8c73a3304f50aa42.png" alt="image.png"></h2><p>图-17</p>
<h3 id="1-3-4修改zoo1-cfg"><a href="#1-3-4修改zoo1-cfg" class="headerlink" title="1.3.4修改zoo1.cfg"></a>1.3.4修改zoo1.cfg</h3><p>如图-18所示</p>
<hr>
<h2 id="-16"><a href="#-16" class="headerlink" title=""></a><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-7ec28ae2215a4f45a49c784263cb5023.png" alt="image.png"></h2><p>图-18<br>配置完成后将zoo1.cfg复制2份.之后需要修改对应的文件夹目录.和不同的端口即可.</p>
<h3 id="1-3-5ZK集群测试"><a href="#1-3-5ZK集群测试" class="headerlink" title="1.3.5ZK集群测试"></a>1.3.5ZK集群测试</h3><p>通过下面的命令启动zk集群.<br>sh zkServer.sh start   zoo1.cfg<br>sh zkServer.sh stop    zoo1.cfg<br>sh zkServer.sh status  zoo1.cfg<br>检查主从关系,从机情况说明.<br>如图-19所示</p>
<hr>
<h2 id="-17"><a href="#-17" class="headerlink" title=""></a><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-de4854b240504612b6dce11f46ed2645.png" alt="image.png"></h2><p>图-19<br>检查主从关系,主机情况说明.<br>如图-20所示</p>
<hr>
<h2 id="-18"><a href="#-18" class="headerlink" title=""></a><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2019/12/image-748f94c832c343c08ac3cdeff31ea15f.png" alt="image.png"></h2><p>图-20</p>
<h3 id="1-3-6关于zookeeper集群说明"><a href="#1-3-6关于zookeeper集群说明" class="headerlink" title="1.3.6关于zookeeper集群说明"></a>1.3.6关于zookeeper集群说明</h3><p>Zookeeper集群中leader负责监控集群状态,follower主要负责客户端链接获取服务列表信息.同时参与投票.</p>
]]></content>
      <categories>
        <category>后端</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>zookeeper</tag>
      </tags>
  </entry>
  <entry>
    <title>github仓库-CS-Notes</title>
    <url>/2020/04/11/github%E4%BB%93%E5%BA%93-CS-Notes/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><table>
<thead>
<tr>
<th align="center">&nbsp;算法&nbsp;</th>
<th align="center">操作系统</th>
<th align="center">&nbsp;网络&nbsp;</th>
<th align="center">面向对象</th>
<th align="center">&nbsp;&nbsp;数据库&nbsp;&nbsp;</th>
<th align="center">&nbsp;&nbsp;&nbsp;Java&nbsp;&nbsp;&nbsp;</th>
<th align="center">系统设计</th>
<th align="center">&nbsp;&nbsp;&nbsp;工具&nbsp;&nbsp;&nbsp;</th>
<th align="center">编码实践</th>
<th align="center">&nbsp;&nbsp;&nbsp;后记&nbsp;&nbsp;&nbsp;</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><a href="#pencil2-算法">:pencil2:</a></td>
<td align="center"><a href="#computer-操作系统">:computer:</a></td>
<td align="center"><a href="#cloud-网络">:cloud:</a></td>
<td align="center"><a href="#art-面向对象">:art:</a></td>
<td align="center"><a href="#floppy_disk-数据库">:floppy_disk:</a></td>
<td align="center"><a href="#coffee-java">:coffee:</a></td>
<td align="center"><a href="#bulb-系统设计">:bulb:</a></td>
<td align="center"><a href="#wrench-工具">:wrench:</a></td>
<td align="center"><a href="#watermelon-编码实践">:watermelon:</a></td>
<td align="center"><a href="#memo-后记">:memo:</a></td>
</tr>
</tbody></table>
<br>

<div align="center">
    <img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/githubio/LogoMakr_0zpEzN.png" width="200px">
</div>



<br>

<h2 id="pencil2-算法"><a href="#pencil2-算法" class="headerlink" title=":pencil2: 算法"></a>:pencil2: 算法</h2><ul>
<li><a href="https://github.com/CyC2018/CS-Notes/blob/master/notes/剑指%20Offer%20题解%20-%20目录.md" target="_blank" rel="noopener">剑指 Offer 题解</a></li>
<li><a href="https://github.com/CyC2018/CS-Notes/blob/master/notes/Leetcode%20题解%20-%20目录.md" target="_blank" rel="noopener">Leetcode 题解</a></li>
<li><a href="https://github.com/CyC2018/CS-Notes/blob/master/notes/算法%20-%20目录.md" target="_blank" rel="noopener">算法</a></li>
<li><a href="https://www.nowcoder.com/contestRoom?from=cyc_github" target="_blank" rel="noopener">笔试面试题库</a></li>
</ul>
<h2 id="computer-操作系统"><a href="#computer-操作系统" class="headerlink" title=":computer: 操作系统"></a>:computer: 操作系统</h2><ul>
<li><a href="https://github.com/CyC2018/CS-Notes/blob/master/notes/计算机操作系统%20-%20目录.md" target="_blank" rel="noopener">计算机操作系统</a></li>
<li><a href="https://github.com/CyC2018/CS-Notes/blob/master/notes/Linux.md" target="_blank" rel="noopener">Linux</a></li>
</ul>
<h2 id="cloud-网络"><a href="#cloud-网络" class="headerlink" title=":cloud: 网络"></a>:cloud: 网络</h2><ul>
<li><a href="https://github.com/CyC2018/CS-Notes/blob/master/notes/计算机网络%20-%20目录.md" target="_blank" rel="noopener">计算机网络</a></li>
<li><a href="https://github.com/CyC2018/CS-Notes/blob/master/notes/HTTP.md" target="_blank" rel="noopener">HTTP</a></li>
<li><a href="https://github.com/CyC2018/CS-Notes/blob/master/notes/Socket.md" target="_blank" rel="noopener">Socket</a></li>
</ul>
<h2 id="art-面向对象"><a href="#art-面向对象" class="headerlink" title=":art: 面向对象"></a>:art: 面向对象</h2><ul>
<li><a href="https://github.com/CyC2018/CS-Notes/blob/master/notes/设计模式%20-%20目录.md" target="_blank" rel="noopener">设计模式</a></li>
<li><a href="https://github.com/CyC2018/CS-Notes/blob/master/notes/面向对象思想.md" target="_blank" rel="noopener">面向对象思想</a></li>
</ul>
<h2 id="floppy-disk-数据库"><a href="#floppy-disk-数据库" class="headerlink" title=":floppy_disk: 数据库"></a>:floppy_disk: 数据库</h2><ul>
<li><a href="https://github.com/CyC2018/CS-Notes/blob/master/notes/数据库系统原理.md" target="_blank" rel="noopener">数据库系统原理</a></li>
<li><a href="https://github.com/CyC2018/CS-Notes/blob/master/notes/SQL.md" target="_blank" rel="noopener">SQL</a></li>
<li><a href="https://github.com/CyC2018/CS-Notes/blob/master/notes/Leetcode-Database%20题解.md" target="_blank" rel="noopener">Leetcode-Database 题解</a></li>
<li><a href="https://github.com/CyC2018/CS-Notes/blob/master/notes/MySQL.md" target="_blank" rel="noopener">MySQL</a></li>
<li><a href="https://github.com/CyC2018/CS-Notes/blob/master/notes/Redis.md" target="_blank" rel="noopener">Redis</a></li>
</ul>
<h2 id="coffee-Java"><a href="#coffee-Java" class="headerlink" title=":coffee: Java"></a>:coffee: Java</h2><ul>
<li><a href="https://github.com/CyC2018/CS-Notes/blob/master/notes/Java%20基础.md" target="_blank" rel="noopener">Java 基础</a></li>
<li><a href="https://github.com/CyC2018/CS-Notes/blob/master/notes/Java%20容器.md" target="_blank" rel="noopener">Java 容器</a></li>
<li><a href="https://github.com/CyC2018/CS-Notes/blob/master/notes/Java%20并发.md" target="_blank" rel="noopener">Java 并发</a></li>
<li><a href="https://github.com/CyC2018/CS-Notes/blob/master/notes/Java%20虚拟机.md" target="_blank" rel="noopener">Java 虚拟机</a></li>
<li><a href="https://github.com/CyC2018/CS-Notes/blob/master/notes/Java%20IO.md" target="_blank" rel="noopener">Java I/O</a></li>
</ul>
<h2 id="bulb-系统设计"><a href="#bulb-系统设计" class="headerlink" title=":bulb: 系统设计"></a>:bulb: 系统设计</h2><ul>
<li><a href="https://github.com/CyC2018/CS-Notes/blob/master/notes/系统设计基础.md" target="_blank" rel="noopener">系统设计基础</a></li>
<li><a href="https://github.com/CyC2018/CS-Notes/blob/master/notes/分布式.md" target="_blank" rel="noopener">分布式</a></li>
<li><a href="https://github.com/CyC2018/CS-Notes/blob/master/notes/集群.md" target="_blank" rel="noopener">集群</a></li>
<li><a href="https://github.com/CyC2018/CS-Notes/blob/master/notes/攻击技术.md" target="_blank" rel="noopener">攻击技术</a></li>
<li><a href="https://github.com/CyC2018/CS-Notes/blob/master/notes/缓存.md" target="_blank" rel="noopener">缓存</a></li>
<li><a href="https://github.com/CyC2018/CS-Notes/blob/master/notes/消息队列.md" target="_blank" rel="noopener">消息队列</a></li>
</ul>
<h2 id="wrench-工具"><a href="#wrench-工具" class="headerlink" title=":wrench: 工具"></a>:wrench: 工具</h2><ul>
<li><a href="https://github.com/CyC2018/CS-Notes/blob/master/notes/Git.md" target="_blank" rel="noopener">Git</a></li>
<li><a href="https://github.com/CyC2018/CS-Notes/blob/master/notes/Docker.md" target="_blank" rel="noopener">Docker</a></li>
<li><a href="https://github.com/CyC2018/CS-Notes/blob/master/notes/构建工具.md" target="_blank" rel="noopener">构建工具</a></li>
<li><a href="https://github.com/CyC2018/CS-Notes/blob/master/notes/正则表达式.md" target="_blank" rel="noopener">正则表达式</a></li>
</ul>
<h2 id="watermelon-编码实践"><a href="#watermelon-编码实践" class="headerlink" title=":watermelon: 编码实践"></a>:watermelon: 编码实践</h2><ul>
<li><a href="https://github.com/CyC2018/CS-Notes/blob/master/notes/代码可读性.md" target="_blank" rel="noopener">代码可读性</a></li>
<li><a href="https://github.com/CyC2018/CS-Notes/blob/master/notes/代码风格规范.md" target="_blank" rel="noopener">代码风格规范</a></li>
</ul>
]]></content>
      <categories>
        <category>面试题</category>
      </categories>
      <tags>
        <tag>github</tag>
      </tags>
  </entry>
  <entry>
    <title>github仓库--JavaGuide</title>
    <url>/2020/04/12/github%E4%BB%93%E5%BA%93--JavaGuide/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><p>传送门—–<a href="https://github.com/zhangpengpeng69/JavaGuide" target="_blank" rel="noopener">java基础知识</a></p>
<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ul>
<li><a href="#java">Java</a><ul>
<li><a href="#基础">基础</a></li>
<li><a href="#容器">容器</a></li>
<li><a href="#并发">并发</a></li>
<li><a href="#jvm">JVM</a></li>
<li><a href="#io">I/O</a></li>
<li><a href="#java-8">Java 8</a></li>
<li><a href="#编程规范">编程规范</a></li>
</ul>
</li>
<li><a href="#网络">网络</a></li>
<li><a href="#操作系统">操作系统</a><ul>
<li><a href="#linux相关">Linux相关</a></li>
</ul>
</li>
<li><a href="#数据结构与算法">数据结构与算法</a><ul>
<li><a href="#数据结构">数据结构</a></li>
<li><a href="#算法">算法</a></li>
</ul>
</li>
<li><a href="#数据库">数据库</a><ul>
<li><a href="#mysql">MySQL</a></li>
<li><a href="#redis">Redis</a></li>
</ul>
</li>
<li><a href="#系统设计">系统设计</a><ul>
<li><a href="#设计模式">设计模式(工厂模式、单例模式 … )</a></li>
<li><a href="#常用框架">常用框架(Spring、Zookeeper … )</a></li>
<li><a href="#数据通信">数据通信(消息队列、Dubbo … )</a></li>
<li><a href="#网站架构">网站架构</a></li>
</ul>
</li>
<li><a href="#面试指南">面试指南</a><ul>
<li><a href="#备战面试">备战面试</a></li>
<li><a href="#常见面试题总结">常见面试题总结</a></li>
<li><a href="#面经">面经</a></li>
</ul>
</li>
<li><a href="#工具">工具</a><ul>
<li><a href="#git">Git</a></li>
<li><a href="#Docker">Docker</a></li>
</ul>
</li>
<li><a href="#资源">资源</a><ul>
<li><a href="#书单">书单</a></li>
<li><a href="#Github榜单">Github榜单</a></li>
</ul>
</li>
<li><a href="#待办">待办</a></li>
<li><a href="#说明">说明</a></li>
</ul>
<h2 id="Java"><a href="#Java" class="headerlink" title="Java"></a>Java</h2><h3 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h3><ul>
<li><a href="docs/java/Java基础知识.md">Java 基础知识回顾</a></li>
<li><a href="docs/java/Java疑难点.md">Java 基础知识疑难点/易错点</a></li>
<li><a href="docs/java/Java程序设计题.md">一些重要的Java程序设计题</a></li>
<li><a href="docs/java/J2EE基础知识.md">J2EE 基础知识回顾</a></li>
</ul>
<h3 id="容器"><a href="#容器" class="headerlink" title="容器"></a>容器</h3><ul>
<li><a href="docs/java/collection/Java集合框架常见面试题.md">Java容器常见面试题/知识点总结</a></li>
<li><a href="docs/java/collection/ArrayList.md">ArrayList 源码学习</a>  </li>
<li><a href="docs/java/collection/LinkedList.md">LinkedList 源码学习</a>   </li>
<li><a href="docs/java/collection/HashMap.md">HashMap(JDK1.8)源码学习</a>  </li>
</ul>
<h3 id="并发"><a href="#并发" class="headerlink" title="并发"></a>并发</h3><ul>
<li><a href="docs/java/Multithread/JavaConcurrencyBasicsCommonInterviewQuestionsSummary.md">Java 并发基础常见面试题总结</a></li>
<li><a href="docs/java/Multithread/JavaConcurrencyAdvancedCommonInterviewQuestions.md">Java 并发进阶常见面试题总结</a></li>
<li><a href="docs/java/Multithread/并发容器总结.md">并发容器总结</a></li>
<li><a href="docs/essential-content-for-interview/面试必备之乐观锁与悲观锁.md">乐观锁与悲观锁</a></li>
<li><a href="docs/java/Multithread/Atomic.md">JUC 中的 Atomic 原子类总结</a></li>
<li><a href="docs/java/Multithread/AQS.md">AQS 原理以及 AQS 同步组件总结</a></li>
</ul>
<h3 id="JVM"><a href="#JVM" class="headerlink" title="JVM"></a>JVM</h3><ul>
<li><a href="docs/java/jvm/Java内存区域.md">一 Java内存区域</a></li>
<li><a href="docs/java/jvm/JVM垃圾回收.md">二 JVM垃圾回收</a></li>
<li><a href="docs/java/jvm/JDK监控和故障处理工具总结.md">三 JDK 监控和故障处理工具</a></li>
<li><a href="docs/java/jvm/类文件结构.md">四 类文件结构</a></li>
<li><a href="docs/java/jvm/类加载过程.md">五 类加载过程</a></li>
<li><a href="docs/java/jvm/类加载器.md">六 类加载器</a></li>
</ul>
<h3 id="I-O"><a href="#I-O" class="headerlink" title="I/O"></a>I/O</h3><ul>
<li><a href="docs/java/BIO-NIO-AIO.md">BIO,NIO,AIO 总结 </a></li>
<li><a href="docs/java/Java%20IO与NIO.md">Java IO 与 NIO系列文章</a></li>
</ul>
<h3 id="Java-8"><a href="#Java-8" class="headerlink" title="Java 8"></a>Java 8</h3><ul>
<li><a href="docs/java/What's%20New%20in%20JDK8/Java8Tutorial.md">Java 8 新特性总结</a></li>
<li><a href="docs/java/What's%20New%20in%20JDK8/Java8教程推荐.md">Java 8 学习资源推荐</a></li>
<li><a href="docs/java/What's%20New%20in%20JDK8/Java8foreach指南.md">Java8 forEach 指南</a></li>
</ul>
<h3 id="编程规范"><a href="#编程规范" class="headerlink" title="编程规范"></a>编程规范</h3><ul>
<li><a href="docs/java/Java编程规范.md">Java 编程规范</a></li>
</ul>
<h2 id="网络"><a href="#网络" class="headerlink" title="网络"></a>网络</h2><ul>
<li><a href="docs/network/计算机网络.md">计算机网络常见面试题</a></li>
<li><a href="docs/network/干货：计算机网络知识总结.md">计算机网络基础知识总结</a></li>
<li><a href="docs/network/HTTPS中的TLS.md">HTTPS中的TLS</a></li>
</ul>
<h2 id="操作系统"><a href="#操作系统" class="headerlink" title="操作系统"></a>操作系统</h2><h3 id="Linux相关"><a href="#Linux相关" class="headerlink" title="Linux相关"></a>Linux相关</h3><ul>
<li><a href="docs/operating-system/后端程序员必备的Linux基础知识.md">后端程序员必备的 Linux 基础知识</a>  </li>
<li><a href="docs/operating-system/Shell.md">Shell 编程入门</a> </li>
</ul>
<h2 id="数据结构与算法"><a href="#数据结构与算法" class="headerlink" title="数据结构与算法"></a>数据结构与算法</h2><h3 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h3><ul>
<li><a href="docs/dataStructures-algorithms/数据结构.md">数据结构知识学习与面试</a></li>
</ul>
<h3 id="算法"><a href="#算法" class="headerlink" title="算法"></a>算法</h3><ul>
<li><a href="docs/dataStructures-algorithms/算法学习资源推荐.md">算法学习资源推荐</a>  </li>
<li><a href="docs/dataStructures-algorithms/几道常见的子符串算法题.md">几道常见的字符串算法题总结 </a></li>
<li><a href="docs/dataStructures-algorithms/几道常见的链表算法题.md">几道常见的链表算法题总结 </a>   </li>
<li><a href="docs/dataStructures-algorithms/剑指offer部分编程题.md">剑指offer部分编程题</a></li>
<li><a href="docs/dataStructures-algorithms/公司真题.md">公司真题</a></li>
<li><a href="docs/dataStructures-algorithms/Backtracking-NQueens.md">回溯算法经典案例之N皇后问题</a></li>
</ul>
<h2 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h2><h3 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h3><ul>
<li><a href="docs/database/MySQL.md">MySQL 学习与面试</a></li>
<li><a href="docs/database/一千行MySQL命令.md">一千行MySQL学习笔记</a></li>
<li><a href="docs/database/MySQL高性能优化规范建议.md">MySQL高性能优化规范建议</a></li>
<li><a href="docs/database/MySQL%20Index.md">数据库索引总结</a></li>
<li><a href="docs/database/事务隔离级别(图文详解).md">事务隔离级别(图文详解)</a></li>
<li><a href="docs/database/一条sql语句在mysql中如何执行的.md">一条SQL语句在MySQL中如何执行的</a></li>
</ul>
<h3 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h3><ul>
<li><a href="docs/database/Redis/Redis.md">Redis 总结</a></li>
<li><a href="docs/database/Redis/Redlock分布式锁.md">Redlock分布式锁</a></li>
<li><a href="docs/database/Redis/如何做可靠的分布式锁，Redlock真的可行么.md">如何做可靠的分布式锁，Redlock真的可行么</a></li>
</ul>
<h2 id="系统设计"><a href="#系统设计" class="headerlink" title="系统设计"></a>系统设计</h2><h3 id="设计模式"><a href="#设计模式" class="headerlink" title="设计模式"></a>设计模式</h3><ul>
<li><a href="docs/system-design/设计模式.md">设计模式系列文章</a></li>
</ul>
<h3 id="常用框架"><a href="#常用框架" class="headerlink" title="常用框架"></a>常用框架</h3><h4 id="Spring"><a href="#Spring" class="headerlink" title="Spring"></a>Spring</h4><ul>
<li><a href="docs/system-design/framework/spring/Spring.md">Spring 学习与面试</a></li>
<li><a href="docs/system-design/framework/spring/SpringInterviewQuestions.md">Spring 常见问题总结</a></li>
<li><a href="docs/system-design/framework/spring/SpringBean.md">Spring中bean的作用域与生命周期</a></li>
<li><a href="docs/system-design/framework/spring/SpringMVC-Principle.md">SpringMVC 工作原理详解</a></li>
<li><a href="docs/system-design/framework/spring/Spring-Design-Patterns.md">Spring中都用到了那些设计模式?</a></li>
<li><a href="https://github.com/Snailclimb/springboot-guide" target="_blank" rel="noopener">SpringBoot 使用指南</a></li>
<li><a href="https://github.com/Snailclimb/spring-security-jwt-guide" target="_blank" rel="noopener">Spring Security with JWT</a></li>
</ul>
<h4 id="ZooKeeper"><a href="#ZooKeeper" class="headerlink" title="ZooKeeper"></a>ZooKeeper</h4><ul>
<li><a href="docs/system-design/framework/ZooKeeper.md">ZooKeeper 相关概念总结</a></li>
<li><a href="docs/system-design/framework/ZooKeeper数据模型和常见命令.md">ZooKeeper 数据模型和常见命令</a></li>
</ul>
<h3 id="数据通信"><a href="#数据通信" class="headerlink" title="数据通信"></a>数据通信</h3><ul>
<li><a href="docs/system-design/data-communication/summary.md">数据通信(RESTful、RPC、消息队列)相关知识点总结</a></li>
<li><a href="docs/system-design/data-communication/dubbo.md">Dubbo 总结：关于 Dubbo 的重要知识点</a></li>
<li><a href="docs/system-design/data-communication/message-queue.md">消息队列总结</a></li>
<li><a href="docs/system-design/data-communication/rabbitmq.md">RabbitMQ 入门</a></li>
<li><a href="docs/system-design/data-communication/RocketMQ-Questions.md">RocketMQ的几个简单问题与答案</a></li>
<li><a href="docs/system-design/data-communication/Kafka系统设计开篇-面试看这篇就够了.md">Kafka系统设计开篇-面试看这篇就够了</a></li>
</ul>
<h3 id="网站架构"><a href="#网站架构" class="headerlink" title="网站架构"></a>网站架构</h3><ul>
<li><a href="docs/system-design/website-architecture/分布式.md">一文读懂分布式应该学什么</a></li>
<li><a href="docs/system-design/website-architecture/8%20张图读懂大型网站技术架构.md">8 张图读懂大型网站技术架构</a></li>
<li><a href="docs/system-design/website-architecture/【面试精选】关于大型网站系统架构你不得不懂的10个问题.md">【面试精选】关于大型网站系统架构你不得不懂的10个问题</a></li>
</ul>
<h2 id="面试指南"><a href="#面试指南" class="headerlink" title="面试指南"></a>面试指南</h2><h3 id="备战面试"><a href="#备战面试" class="headerlink" title="备战面试"></a>备战面试</h3><ul>
<li><a href="docs/essential-content-for-interview/PreparingForInterview/程序员的简历之道.md">【备战面试1】程序员的简历就该这样写</a></li>
<li><a href="docs/essential-content-for-interview/PreparingForInterview/interviewPrepare.md">【备战面试2】初出茅庐的程序员该如何准备面试？</a></li>
<li><a href="docs/essential-content-for-interview/PreparingForInterview/JavaProgrammerNeedKnow.md">【备战面试3】7个大部分程序员在面试前很关心的问题</a></li>
<li><a href="docs/essential-content-for-interview/PreparingForInterview/JavaInterviewLibrary.md">【备战面试4】Github上开源的Java面试/学习相关的仓库推荐</a></li>
<li><a href="docs/essential-content-for-interview/PreparingForInterview/如果面试官问你“你有什么问题问我吗？”时，你该如何回答.md">【备战面试5】如果面试官问你“你有什么问题问我吗？”时，你该如何回答</a></li>
<li><a href="docs/essential-content-for-interview/PreparingForInterview/美团面试常见问题总结.md">【备战面试6】美团面试常见问题总结（附详解答案）</a></li>
</ul>
<h3 id="常见面试题总结"><a href="#常见面试题总结" class="headerlink" title="常见面试题总结"></a>常见面试题总结</h3><ul>
<li><a href="docs/essential-content-for-interview/MostCommonJavaInterviewQuestions/第一周（2018-8-7）.md">第一周（2018-8-7）</a> (为什么 Java 中只有值传递、==与equals、 hashCode与equals)</li>
<li><a href="docs/essential-content-for-interview/MostCommonJavaInterviewQuestions/第二周(2018-8-13).md">第二周（2018-8-13）</a>(String和StringBuffer、StringBuilder的区别是什么？String为什么是不可变的？、什么是反射机制？反射机制的应用场景有哪些？……)</li>
<li><a href="docs/java/collection/Java集合框架常见面试题.md">第三周（2018-08-22）</a> （Arraylist 与 LinkedList 异同、ArrayList 与 Vector 区别、HashMap的底层实现、HashMap 和 Hashtable 的区别、HashMap 的长度为什么是2的幂次方、HashSet 和 HashMap 区别、ConcurrentHashMap 和 Hashtable 的区别、ConcurrentHashMap线程安全的具体实现方式/底层具体实现、集合框架底层数据结构总结）</li>
<li><a href="docs/essential-content-for-interview/MostCommonJavaInterviewQuestions/第四周(2018-8-30).md">第四周(2018-8-30).md</a> （主要内容是几道面试常问的多线程基础题。）</li>
</ul>
<h3 id="面经"><a href="#面经" class="headerlink" title="面经"></a>面经</h3><ul>
<li><a href="docs/essential-content-for-interview/BATJrealInterviewExperience/5面阿里,终获offer.md">5面阿里,终获offer(2018年秋招)</a></li>
<li><a href="docs/essential-content-for-interview/BATJrealInterviewExperience/蚂蚁金服实习生面经总结(已拿口头offer).md">蚂蚁金服2019实习生面经总结(已拿口头offer)</a></li>
<li><a href="docs/essential-content-for-interview/BATJrealInterviewExperience/2019alipay-pinduoduo-toutiao.md">2019年蚂蚁金服、头条、拼多多的面试总结</a></li>
</ul>
<h2 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h2><h3 id="Git"><a href="#Git" class="headerlink" title="Git"></a>Git</h3><ul>
<li><a href="docs/tools/Git.md">Git入门</a></li>
</ul>
<h3 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h3><ul>
<li><a href="docs/tools/Docker.md">Docker 入门</a></li>
<li><a href="docs/tools/Docker-Image.md">一文搞懂 Docker 镜像的常用操作！</a></li>
</ul>
<h2 id="资源"><a href="#资源" class="headerlink" title="资源"></a>资源</h2><h3 id="书单"><a href="#书单" class="headerlink" title="书单"></a>书单</h3><ul>
<li><a href="docs/data/java-recommended-books.md">Java程序员必备书单</a></li>
</ul>
<h3 id="实战项目推荐"><a href="#实战项目推荐" class="headerlink" title="实战项目推荐"></a>实战项目推荐</h3><ul>
<li><a href="https://github.com/YunaiV/onemall" target="_blank" rel="noopener">onemall</a> : mall 商城，基于微服务的思想，构建在 B2C 电商场景下的项目实战。核心技术栈，是 Spring Boot + Dubbo 。未来，会重构成 Spring Cloud Alibaba 。</li>
</ul>
<h3 id="Github-历史榜单"><a href="#Github-历史榜单" class="headerlink" title="Github 历史榜单"></a>Github 历史榜单</h3><ul>
<li><a href="docs/github-trending/JavaGithubTrending.md">Java 项目月榜单</a></li>
</ul>
<hr>
<h2 id="待办"><a href="#待办" class="headerlink" title="待办"></a>待办</h2><ul>
<li><input disabled="" type="checkbox"> Java 多线程类别知识重构(—正在进行中—)</li>
<li><input disabled="" type="checkbox"> Netty 总结(—正在进行中—)</li>
<li><input disabled="" type="checkbox"> 数据结构总结重构(—正在进行中—)</li>
</ul>
<h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h2>]]></content>
      <categories>
        <category>面试题</category>
      </categories>
      <tags>
        <tag>github</tag>
      </tags>
  </entry>
  <entry>
    <title>github部署静态网页</title>
    <url>/2020/04/21/github%E9%83%A8%E7%BD%B2%E9%9D%99%E6%80%81%E7%BD%91%E9%A1%B5/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><p>用github部署静态网页其实很简单还不用动服务器，记录一次静态网页的部署。</p>
<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>在网站设计中，纯粹HTML（标准通用标记语言下的一个应用）格式的网页通常被称为“静态网页”，静态网页是标准的HTML文件，它的文件扩展名是.htm、.html，可以包含文本、图像、声音、FLASH动画、客户端脚本和ActiveX控件及JAVA小程序等。静态网页是网站建设的基础，早期的网站一般都是由静态网页制作的。静态网页是相对于动态网页而言，是指没有后台数据库、不含程序和不可交互的网页。静态网页相对更新起来比较麻烦，适用于一般更新较少的展示型网站。容易误解的是静态页面都是htm这类页面，实际上静态也不是完全静态，他也可以出现各种动态的效果，如GIF格式的动画、FLASH、滚动字幕等。</p>
<h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><blockquote>
<p>前提：<br>了解html、css、js等前端知识。(可以自己编写或修改页面)<br>会使用github（代码仓库）<br>了解git基本语法（上传代码到github）</p>
</blockquote>
<ol>
<li><p>从网上下载了一份简历模板（当然也可以自己编写）。<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/image-87a51cc72224409698800143465ac714.png" alt="image.png"></p>
</li>
<li><p>github新建仓库<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/image-0b38993db9f343a799bf38973188206c.png" alt="image.png"></p>
</li>
<li><p>用git上传<br>git init<br>git add .<br>git commit -m ‘jianli’<br>git push 地址 master<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/image-44721c1cfb274534b2a0e94a9ba7d5b4.png" alt="image.png"></p>
</li>
<li><p>进入仓库，找到settings-GitHub Pages-none<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/image-6e81bf0c5a1f486fa22d689fed5225bf.png" alt="image.png"><br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/image-ea1492ed6bf84126a4666449bcd9bbaa.png" alt="image.png"></p>
</li>
<li><p>点击后找到网址<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/image-44e2afd932b0435d8bcb998b11fbff20.png" alt="image.png"></p>
</li>
<li><p>访问<br>记得加上自己的文件路径<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/image-dbef78dac157480d9836e5d0d3d78b6f.png" alt="image.png"></p>
</li>
<li><p>成功哈哈。</p>
<h2 id="域名绑定"><a href="#域名绑定" class="headerlink" title="域名绑定"></a>域名绑定</h2><blockquote>
<p>前提：<br>有阿里云账号（我用的阿里云）<br>拥有一个自己的域名且已备案</p>
</blockquote>
</li>
</ol>
<p>1.打开cmd窗口ping自己的github仓库网址如 例如：ping zhangpengpeng69.github.io<br>得到 ip地址<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/image-953c4f242ef941a4af0174fe388d6910.png" alt="image.png"></p>
<p>2.阿里云域名解析<br>将自己的域名指向刚刚的ip<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/image-0d54e92a0f2a4f4a93141b2c3e8df433.png" alt="image.png"></p>
<p>3.仓库新建文件CNAME<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/image-bc2369b7a69d4dc68e8d8f87165635dd.png" alt="image.png"></p>
<p>4.写入域名保存<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/image-2840890a9d5744728cb053f9f07e76e3.png" alt="image.png"></p>
<p>或者：在此处添加域名，会自动生成一个CNAME文件<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/image-a22c0299269f4531b9aacd8704228d65.png" alt="image.png"></p>
<p>5.访问即可<br><a href="http://www.zhangpeng.plus/jianli1/index.html" target="_blank" rel="noopener">http://www.zhangpeng.plus/jianli1/index.html</a><br>我又修改了下我的仓库目录结构，所以多了个jianli1<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/image-80faf2a1580848369856bd0593d4adae.png" alt="image.png"><br>成功！</p>
]]></content>
      <categories>
        <category>分享</category>
      </categories>
      <tags>
        <tag>github</tag>
      </tags>
  </entry>
  <entry>
    <title>Hello World</title>
    <url>/2020/04/30/hello-world/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/one-command-deployment.html" target="_blank" rel="noopener">Deployment</a></p>
]]></content>
  </entry>
  <entry>
    <title>lombok插件</title>
    <url>/2020/04/09/lombok%E6%8F%92%E4%BB%B6/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><h2 id="lombok插件-简化代码"><a href="#lombok插件-简化代码" class="headerlink" title="lombok插件 简化代码"></a>lombok插件 简化代码</h2><p><a href="https://projectlombok.org/" target="_blank" rel="noopener">lombok</a><br>&emsp;&emsp;Project Lombok<br>&emsp;&emsp;Project Lombok is a java library that automatically plugs into your editor and build tools, spicing up your java.<br>Never write another getter or equals method again, with one annotation your class has a fully featured builder, Automate your logging variables, and much more.<br>&emsp;&emsp;Lombok项目是一个Java库，它会自动插入编辑器和构建工具中，Lombok提供了一组有用的注释，用来消除Java类中的大量样板代码。仅五个字符(@Data)就可以替换数百行代码从而产生干净，简洁且易于维护的Java类。<br>&emsp;&emsp;Lombok通过增加一些“处理程序”，可以让java变得简洁、快速。<br>&emsp;&emsp;Lombok能以简单的注解形式来简化java代码，提高开发人员的开发效率。例如开发中经常需要写的javabean，都需要花时间去添加相应的getter/setter，也许还要去写构造器、equals等方法，而且需要维护，当属性多时会出现大量的getter/setter方法，这些显得很冗长也没有太多技术含量，一旦修改属性，就容易出现忘记修改对应方法的失误。</p>
<p>&emsp;&emsp;Lombok能通过注解的方式，在编译时自动为属性生成构造器、getter/setter、equals、hashcode、toString方法。出现的神奇就是在源码中没有getter和setter方法，但是在编译生成的字节码文件中有getter和setter方法。这样就省去了手动重建这些代码的麻烦，使代码看起来更简洁些。</p>
<h3 id="1-引入jar包"><a href="#1-引入jar包" class="headerlink" title="1.引入jar包"></a>1.引入jar包</h3><p>引入插件lombok 自动的set/get/构造方法插件  </p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;lombok&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<h3 id="2-找到lombokjar包文件位置-以java方式运行"><a href="#2-找到lombokjar包文件位置-以java方式运行" class="headerlink" title="2.找到lombokjar包文件位置 以java方式运行"></a>2.找到lombokjar包文件位置 以java方式运行</h3><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2020/3/image-2bd1b12e0041491ab1c25d89b3ceab8d.png" alt="image.png"></p>
<h3 id="3-命令"><a href="#3-命令" class="headerlink" title="3.命令:"></a>3.命令:</h3><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2020/3/image-25ea6cb0fe704751bf0efd0e5f425ac5.png" alt="image.png"><br>之后点击install/update即可<br>在eclipse安装的根目录下会生成lombok.jar包文件,表示插件安装成功.<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2020/3/image-0be5f4eabff74481a5fa694174e65640.png" alt="image.png"></p>
<h3 id="4-配置"><a href="#4-配置" class="headerlink" title="4.配置"></a>4.配置</h3><p>在文件安装的根目录找到SpringToolSuite4.ini中<br>手动在ini文件中最后一行添加<br>-vmargs -javaagent:lombok.jar</p>
<p>安装完成后重启Eclipse即可</p>
<h3 id="5-常用注解"><a href="#5-常用注解" class="headerlink" title="5.常用注解"></a>5.常用注解</h3><p> Lombok主要常用的注解有：@Data,@getter,@setter,@NoArgsConstructor,@AllArgsConstructor,@ToString,@EqualsAndHashCode,@Slf4j,@Log4j。我们一个一个来看：</p>
<p>@Data注解：在JavaBean或类JavaBean中使用，这个注解包含范围最广，它包含getter、setter、NoArgsConstructor注解，即当使用当前注解时，会自动生成包含的所有方法；</p>
<p>@getter注解：在JavaBean或类JavaBean中使用，使用此注解会生成对应的getter方法；</p>
<p>@setter注解：在JavaBean或类JavaBean中使用，使用此注解会生成对应的setter方法；</p>
<p>@NoArgsConstructor注解：在JavaBean或类JavaBean中使用，使用此注解会生成对应的无参构造方法；</p>
<p>@AllArgsConstructor注解：在JavaBean或类JavaBean中使用，使用此注解会生成对应的有参构造方法；</p>
<p>@ToString注解：在JavaBean或类JavaBean中使用，使用此注解会自动重写对应的toStirng方法；</p>
<p>@EqualsAndHashCode注解：在JavaBean或类JavaBean中使用，使用此注解会自动重写对应的equals方法和hashCode方法；</p>
<p>@Slf4j：在需要打印日志的类中使用，当项目中使用了slf4j打印日志框架时使用该注解，会简化日志的打印流程，只需调用info方法即可；</p>
<p>@Log4j：在需要打印日志的类中使用，当项目中使用了log4j打印日志框架时使用该注解，会简化日志的打印流程，只需调用info方法即可；</p>
<p>在使用以上注解需要处理参数时，处理方法如下（以@ToString注解为例，其他注解同@ToString注解）：</p>
<p>@ToString(exclude=”column”)</p>
<p>意义：排除column列所对应的元素，即在生成toString方法时不包含column参数；</p>
<p>@ToString(exclude={“column1”,”column2”})</p>
<p>意义：排除多个column列所对应的元素，其中间用英文状态下的逗号进行分割，即在生成toString方法时不包含多个column参数；</p>
<p>@ToString(of=”column”)</p>
<p>意义：只生成包含column列所对应的元素的参数的toString方法，即在生成toString方法时只包含column参数；；</p>
<p>@ToString(of={“column1”,”column2”})<br>意义：只生成包含多个column列所对应的元素的参数的toString方法，其中间用英文状态下的逗号进行分割，即在生成toString方法时只包含多个column参数；<br>@Accessors(chain=true)<br>链式加载</p>
<h3 id="可能问题"><a href="#可能问题" class="headerlink" title="可能问题"></a>可能问题</h3><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2020/3/image-e3803a1ea7cd48f79d857b2a00fbe985.png" alt="image.png"><br>sts安装lombok后重启时，如报以上错误，是没有找到jdk的安装路径<br>解决：<br>    在SpringToolSuite4.ini中加入如下代码：<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2020/3/image-7000f78eee3a4955ba436dcf5597926a.png" alt="image.png">    </p>
]]></content>
      <categories>
        <category>工具</category>
      </categories>
      <tags>
        <tag>插件</tag>
        <tag>lombok</tag>
      </tags>
  </entry>
  <entry>
    <title>java-jdk安装与配置idea配置jdk</title>
    <url>/2020/05/05/java-jdk%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AEidea%E9%85%8D%E7%BD%AEjdk/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><p>·</p>
<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>1.介绍<br>简单来讲，JDK是Java语言的软件开发工具包，我们使用JDK所提供的开发工具完成对java程序的开发；JRE是运行Java程序锁必须的环境，使用JRE运行开发好的java应用程序。</p>
<p>　　· JDK(Java Development Kit　　Java开发工具包)：JDK是提供给Java开发人员使用的，其中包含了java的开发工具，也包括JRE。所以安装了JDK,就不用再单独安装JRE了。</p>
<p>　　· JRE(Java Runtime Environment　　Java运行环境)：包括Java虚拟机（JVM：Java Virtual Machine）和Java程序所需的核心类库等，如果想要运行一个开发好的Java程序，计算机中只需要安全JRE即可。</p>
<h2 id="下载安装"><a href="#下载安装" class="headerlink" title="下载安装"></a>下载安装</h2><p>1.下载<br>地址：<a href="https://www.oracle.com/java/technologies/javase-downloads.html" target="_blank" rel="noopener">https://www.oracle.com/java/technologies/javase-downloads.html</a><br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/05/Snipaste_2020-05-03_21-23-03-da6d277afc054e23bd03c9abea8b7787.png" alt="Snipaste_2020-05-03_21-23-03"><br>2.安装<br>傻瓜式安装</p>
<h2 id="环境变量配置"><a href="#环境变量配置" class="headerlink" title="环境变量配置"></a>环境变量配置</h2><p>4.环境变量配置<br>为了方便java程序的开发，我们需要配置一下环境变量。右击此电脑&gt;属性&gt;高级系统设置&gt;环境变量&gt;单击[新建(W)]添加以下环境变量<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/05/Snipaste_2020-05-03_21-32-17-17f4088ae5bc4ee886779780704d189b.png" alt="Snipaste_2020-05-03_21-32-17"><br>（1）配置JAVA_HOME</p>
<p>　　新建JAVA_HOME</p>
<p>　　变量名        JAVA_HOME</p>
<p>　　变量值        D:\java\jdk  你的jdk的安装地址<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/05/Snipaste_2020-05-03_21-35-04-b7c8c86db6a4414da21d04e2d3783aee.png" alt="Snipaste_2020-05-03_21-35-04"></p>
<p>（2）配置CLASSPATH</p>
<p>　　新建CLASSPATH</p>
<p>　　变量名   CLASSPATH</p>
<p>　　变量值   .;%JAVA_HOME%\lib\dt.jar;%JAVA_HOME%\lib\tools.jar<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/05/Snipaste_2020-05-03_21-36-07-f17b9d4cca084d3789b2f22cc2523c4e.png" alt="Snipaste_2020-05-03_21-36-07"></p>
<p>（3）配置PATH （追加）</p>
<p>　　在PATH变量最后面添加两条变量值                            </p>
<p>　　变量名  Path</p>
<p>　　变量值  %JAVA_HOME%\bin</p>
<p>　　变量值  %JAVA_HOME%\jre\bin<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/05/Snipaste_2020-05-03_21-38-42-1cf01d3024f34f0195ab9751aaaf2456.png" alt="Snipaste_2020-05-03_21-38-42"></p>
<p>5.检查是否安装成功<br>windows+r调出cmd窗口输入java -version<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/05/Snipaste_2020-05-03_21-41-02-be1a133d83bb488d8c2305934b487d23.png" alt="Snipaste_2020-05-03_21-41-02"></p>
<h2 id="idea配置"><a href="#idea配置" class="headerlink" title="idea配置"></a>idea配置</h2><p>File-Project Structure-SDKs<br>D:\java\jdk<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/05/Snipaste_2020-05-03_21-58-10-126adb5c93e24a9ba5e40fec57ad4870.png" alt="Snipaste_2020-05-03_21-58-10"></p>
]]></content>
      <categories>
        <category>工具</category>
      </categories>
      <tags>
        <tag>jdk</tag>
        <tag>idea</tag>
      </tags>
  </entry>
  <entry>
    <title>idea安装与破解</title>
    <url>/2020/05/03/idea%E5%AE%89%E8%A3%85%E4%B8%8E%E7%A0%B4%E8%A7%A3/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><p>之前一直使用eclipse，决定不用了，以后用idea。。</p>
<blockquote>
<p>IDEA 全称 IntelliJ IDEA，是java编程语言开发的集成环境。IntelliJ在业界被公认为最好的java开发工具，尤其在智能代码助手、代码自动提示、重构、JavaEE支持、各类版本工具(git、svn等)、JUnit、CVS整合、代码分析、 创新的GUI设计等方面的功能可以说是超常的。IDEA是JetBrains公司的产品，这家公司总部位于捷克共和国的首都布拉格，开发人员以严谨著称的东欧程序员为主。它的旗舰版本还支持HTML，CSS，PHP，MySQL，Python等。免费版只支持Java等少数语言。</p>
</blockquote>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>1.下载<br>官网：<a href="https://www.jetbrains.com/" target="_blank" rel="noopener">https://www.jetbrains.com/</a><br>下载：<a href="https://www.jetbrains.com/idea/download/#section=windows" target="_blank" rel="noopener">https://www.jetbrains.com/idea/download/#section=windows</a><br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/05/Snipaste_2020-05-03_21-11-53-c17a04424522428ba82a33f534456267.jpg" alt="Snipaste_2020-05-03_21-11-53"><br>开源版和旗舰版的区别<br>开源版（Community）完全免费，旗舰版（Ultimate）需要收费，但是注册账号后可以试用30天<br>两者的安装包是不同的，同一台机器可以同时安装开源版和旗舰版<br>旗舰版比开源版多了很多功能，例如支持HTML/CSS/JavaScript/TypeScript的代码智能提醒、提供常用框架（Spring，Play，Grails）的实用插件、提供数据库工具、自动检查代码重复等。<br>旗舰版的收费目前是订阅模式收费策略，支持按年订阅或者按月订阅。</p>
<p>2.安装<br>无特殊，选择安装位置安装就好<br>我的安装路径：D:\software2\idea\IntelliJ IDEA 2019.3.3<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/05/Snipaste_2020-05-03_21-06-24-cc857dd4e3504ba3b3a2b02ca1b12fa2.jpg" alt="Snipaste_2020-05-03_21-06-24"></p>
<p>##破解<br>1.先适用30天进入idea，新建个项目<br>2.网上下载破解补丁jetbrains-agent.jar<br>3.放在idea安装目录的bin目录下<br>D:\software2\idea\IntelliJ IDEA 2019.3.3\bin<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/05/image-ee5d202b11444d1aa1275172e2fb6078.png" alt="image.png"><br>4.idea-help-Edit Custom VM Options<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/05/image-ce0570929d094c028d9cf3f6a762d69b.png" alt="image.png"></p>
<p>5.末尾加上一行（填写自己的路径）：<br>-javaagent:D:\software2\idea\IntelliJ IDEA 2019.3.3\bin\jetbrains-agent.jar<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/05/image-cf055a5139dd4717ad62be3dd816da20.png" alt="image.png"></p>
<p>6.关掉ieda重启</p>
<p>7.填入激活码，激活<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/05/image-082ae1ce53dd463c98a8a0dfe7c4bce1.png" alt="image.png"></p>
<p>8.本文不包含任何资源，请自行百度。</p>
]]></content>
      <categories>
        <category>工具</category>
      </categories>
      <tags>
        <tag>idea</tag>
      </tags>
  </entry>
  <entry>
    <title>hexo+github部署自己的静态博客</title>
    <url>/2020/05/01/hexo+github%E9%83%A8%E7%BD%B2%E8%87%AA%E5%B7%B1%E7%9A%84%E9%9D%99%E6%80%81%E5%8D%9A%E5%AE%A2/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><blockquote>
<p>作为程序员拥有一个属于自己的个人技术博客，是很有好处的，经常写写文章，面试时亮出博客地址也会让面试官对你的好感度倍增。我已经有halo博客了，为什么来搞这个呢？完全是好奇而已。hexo+github部署自己的静态博客最大的好处是自己不用花钱去买服务器了。</p>
</blockquote>
<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>官网：<a href="https://hexo.io/zh-cn/" target="_blank" rel="noopener">https://hexo.io/zh-cn/</a><br>官方文档：<a href="https://hexo.io/zh-cn/docs/" target="_blank" rel="noopener">https://hexo.io/zh-cn/docs/</a><br>主题:<a href="https://hexo.io/themes/" target="_blank" rel="noopener">https://hexo.io/themes/</a><br>hexo：Hexo 是一个快速、简洁且高效的博客框架。Hexo 使用 Markdown（或其他渲染引擎）解析文章，在几秒内，即可利用靓丽的主题生成静态网页。</p>
<blockquote>
<p>超快速度<br>Node.js 所带来的超快生成速度，让上百个页面在几秒内瞬间完成渲染</p>
</blockquote>
<blockquote>
<p>支持 Markdown<br>Hexo 支持 GitHub Flavored Markdown 的所有功能，甚至可以整合 Octopress 的大多数插件。</p>
</blockquote>
<blockquote>
<p>一键部署<br>只需一条指令即可部署到 GitHub Pages, Heroku 或其他平台。</p>
</blockquote>
<blockquote>
<p>插件和可扩展性<br>强大的 API 带来无限的可能，与数种模板引擎（EJS，Pug，Nunjucks）和工具（Babel，PostCSS，Less/Sass）轻易集成</p>
</blockquote>
<h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><blockquote>
<p>前提<br>已安装Node.js (Node.js 版本需不低于 8.10，建议使用 Node.js 10.0 及以上版本)（node -v）（npm -v）<br>已安装Git（$ git –version）</p>
</blockquote>
<p><strong>安装：</strong></p>
<ol>
<li>新建文件夹（例如hexoblog）</li>
<li>右键：git bush here</li>
<li>切换阿里的npm镜像：$ npm install -g cnpm –registry=<a href="https://registry.npm.taobao.org" target="_blank" rel="noopener">https://registry.npm.taobao.org</a></li>
<li>$ cnpm install hexo-cli -g</li>
<li>$ npm install hexo  </li>
<li>$ hexo init hexo（以hexo文件夹名为例）</li>
<li>$ cd hexo</li>
<li>$ cnpm install</li>
<li>$ hexo server</li>
<li>访问： <a href="http://localhost:4000" target="_blank" rel="noopener">http://localhost:4000</a></li>
</ol>
<p><strong>部署到github：</strong></p>
<ol>
<li>github 创建仓库 XXX.github.io<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/image-92580a30751440a8af455c74aaaf70ea.png" alt="image.png"></li>
<li>配置_config.yml文件<br>修改_config.yml文件，添加你创建的GitHub仓库地址（以我的为例）<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">deploy:</span><br><span class="line">  type: git</span><br><span class="line">  repo: https:&#x2F;&#x2F;github.com&#x2F;zpengit&#x2F;zpengit.github.io</span><br><span class="line">  # example, https:&#x2F;&#x2F;github.com&#x2F;hexojs&#x2F;hexojs.github.io</span><br><span class="line">  branch: master</span><br></pre></td></tr></table></figure>


</li>
</ol>
<ol start="3">
<li><p>hexo-deployer-git.</p>
</li>
<li><p>hexo clean &amp;&amp; hexo deploy 。</p>
</li>
<li><p>查看 zpengit.github.io 上的网页是否部署成功。(我这是更换了主题的样子)<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/image-df81cef6c54a48adb7dd09255e1834f4.png" alt="image.png"></p>
</li>
</ol>
<p><strong>修改主题</strong><br>主题网址：<a href="https://hexo.io/themes/" target="_blank" rel="noopener">https://hexo.io/themes/</a><br>我以主题<a href="https://github.com/iissnan/hexo-theme-next为例" target="_blank" rel="noopener">https://github.com/iissnan/hexo-theme-next为例</a></p>
<ol>
<li>mkdir themes/next</li>
<li>下载git clone <a href="https://github.com/iissnan/hexo-theme-next" target="_blank" rel="noopener">https://github.com/iissnan/hexo-theme-next</a> themes/next</li>
<li>配置_config.yml<br>修改_config.yml文件中的theme属性<br>theme: next</li>
<li>打包上传看看效果：<br>hexo clean<br>hexo generate<br>hexo deploy</li>
<li>访问<a href="https://zpengit.github.io/">https://zpengit.github.io/</a><br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/05/image-694d6fea956e4edaac4b4c783ffcc8ca.png" alt="image.png"></li>
</ol>
<p><strong>配置域名</strong></p>
<ol>
<li>将域名指向GitHub的服务器地址</li>
<li>进入存放博客的GitHub仓库，点击settings，设置Custom domain，输入域名xxx.xx。<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/05/image-5fb60de8ce2547f8918bae6d0904e59f.png" alt="image.png"></li>
<li>然后在本地博客文件source中创建一个名为CNAME文件，不要后缀。写上你的域名。</li>
<li>最后重新编译上传文件，访问：xxx.xx即可。<br>hexo clean<br>hexo generate<br>hexo deploy</li>
</ol>
]]></content>
      <categories>
        <category>分享</category>
      </categories>
      <tags>
        <tag>github</tag>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>java基础面试题</title>
    <url>/2020/04/06/java%E5%9F%BA%E7%A1%80%E9%9D%A2%E8%AF%95%E9%A2%98/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><h1 id="java基础面试题"><a href="#java基础面试题" class="headerlink" title="java基础面试题"></a>java基础面试题</h1><h2 id="1、面向对象都有哪些特性以及你对这些特性的理解-？"><a href="#1、面向对象都有哪些特性以及你对这些特性的理解-？" class="headerlink" title="1、面向对象都有哪些特性以及你对这些特性的理解 ？"></a>1、面向对象都有哪些特性以及你对这些特性的理解 ？</h2><p>答：面向对象的三大特征：1.继承  2.封装 3.多态性<br/><br>  （1）继承：就是保留父类的属性，开扩新的东西。通过子类可以实现继承，子类继承父类的所有状态和行为，同时添加自身的状态和行为。<br/><br>  （2）封装：就是类的私有化。将代码及处理数据绑定在一起的一种编程机制，该机制保证程序和数据不受外部干扰。<br/><br>  （3）多态：是允许将父对象设置成为和一个和多个它的子对象相等的技术。包括重载和重写。重载为编译时多态，重写是运行时多态。<br/></p>
<h2 id="2、什么是自动装箱和拆箱？"><a href="#2、什么是自动装箱和拆箱？" class="headerlink" title="2、什么是自动装箱和拆箱？"></a>2、什么是自动装箱和拆箱？</h2><p>  答：自动装箱就是Java自动将原始类型值转换成对应的对象，比如将int的变量转换成Integer对象，这个过程叫做装箱，反之将Integer对象转换成int类型值，这个过程叫做拆箱。因为这里的装箱和拆箱是自动进行的非人为转换，所以就称作为自动装箱和拆箱。<br/><br>  原始类型byte,short,char,int,long,float,double和boolean对应的封装类为Byte,Short,Character,Integer,Long,Float,Double,Boolean。自动装箱和拆箱从Java 1.5开始引入，目的是将原始类型值转自动地转换成对应的对象。自动装箱与拆箱的机制可以让我们在Java的变量赋值或者是方法调用等情况下使用原始类型或者对象类型更加简单直接。<br/></p>
<h2 id="3、什么是-java-序列化，如何实现-java-序列化？"><a href="#3、什么是-java-序列化，如何实现-java-序列化？" class="headerlink" title="3、什么是 java 序列化，如何实现 java 序列化？"></a>3、什么是 java 序列化，如何实现 java 序列化？</h2><p>  答：序列化就是一种用来处理对象流的机制，所谓对象流也就是将对象的内容进行流化。可以对流化后的对象进行读写操作，也可将流化后的对象传输于网络之间。序列化是为了解决在对对象流进行读写操作时所引发的问题。<br/><br>  序 列 化 的 实 现 ： 将 需 要 被 序 列 化 的 类 实 现 Serializable 接 口 ， 该 接 口 没 有 需 要 实 现 的 方 法 ，implements Serializable 只是为了标注该对象是可被序列化的，然后使用一个输出流(如： FileOutputStream)来构造一个 ObjectOutputStream(对象流)对象，接着，使用 ObjectOutputStream 对象的 writeObject(Object obj)方法就可以将参数为 obj 的对象写出(即保存其状态)，要恢复的话则用输入流。<br/></p>
<h2 id="4、char-型变量中能不能存储一个中文汉字，为什么？"><a href="#4、char-型变量中能不能存储一个中文汉字，为什么？" class="headerlink" title="4、char 型变量中能不能存储一个中文汉字，为什么？"></a>4、char 型变量中能不能存储一个中文汉字，为什么？</h2><p>  答：char 类型可以存储一个中文汉字，因为 Java 中使用的编码是 Unicode（不选择任何特定的编码，直接使用字符在字符集中的编号，这是统一的唯一方法），一个 char 类型占 2 个字节（16 比特），所以放一个中文是没问题的。</p>
<h2 id="5、List-和-Map、-Set-的区别？"><a href="#5、List-和-Map、-Set-的区别？" class="headerlink" title="5、List 和 Map、 Set 的区别？"></a>5、List 和 Map、 Set 的区别？</h2><p>  答：List 和 Set 是存储单列数据的集合， Map 是存储键和值这样的双列数据的集合； List 中存储的数据是有顺序，并且允许重复； Map 中存储的数据是没有顺序的，其键是不能重复的，它的值是可以有重复的， Set 中存储的数据是无序的，且不允许有重复，但元素在集合中的位置由元素的 hashcode 决定，位置是固定的（Set 集合根据 hashcode 来进行数据的存储，所以位置是固定的，但是位置不是用户可以控制的，所以对于用户来说 set 中的元素还是无序的） 。</p>
<h2 id="6、HashMap-和-HashTable-有什么区别"><a href="#6、HashMap-和-HashTable-有什么区别" class="headerlink" title="6、HashMap 和 HashTable 有什么区别?"></a>6、HashMap 和 HashTable 有什么区别?</h2><p>  HashMap 是线程不安全的,HashMap 是一个接口,是 Map 的一个子接口,是将键映射到值得对象,不允许键值重复允许空键和空值;由于非线程安全,HashMap 的效率要较 HashTable 的效率高一些.HashTable 是线程安全的一个集合,不允许 null 值作为一个 key 值或者 Value 值;HashTable 是 sychronize,多个线程访问时不需要自己为它的方法实现同步,而 HashMap 在被多个线程访问的时候需要自己为它的方法实现同步。</p>
<h2 id="7、谈谈-JVM-的内存结构和内存分配？"><a href="#7、谈谈-JVM-的内存结构和内存分配？" class="headerlink" title="7、谈谈 JVM 的内存结构和内存分配？"></a>7、谈谈 JVM 的内存结构和内存分配？</h2><p>a)Java 内存模型 <br/><br>    Java 虚拟机将其管辖的内存大致分三个逻辑部分：方法区(Method Area)、 Java 栈和 Java 堆。<br/><br>  1、方法区是静态分配的，编译器将变量绑定在某个存储位置上，而且这些绑定不会在运行时改变。常数池，源代码中的命名常量、 String 常量和 static 变量保存在方法区。<br/><br>  2、 Java Stack 是一个逻辑概念，特点是后进先出。一个栈的空间可能是连续的，也可能是不连续的。最典型的 Stack 应用是方法的调用， Java 虚拟机每调用一次方法就创建一个方法帧（frame），退出该方法则对应的 方法帧被弹出(pop)。栈中存储的数据也是运行时确定的。<br/><br>  3、 Java 堆分配(heap allocation)意味着以随意的顺序，在运行时进行存储空间分配和收回的内存管理模型。堆中存储的数据常常是大小、数量和生命期在编译时无法确定的。 Java 对象的内存总是在 heap 中分配。<br/><br>    b) java 内存分配<br/><br>  1、基础数据类型直接在栈空间分配;<br/><br>  2、方法的形式参数，直接在栈空间分配，当方法调用完成后从栈空间回收;<br/><br>  3、引用数据类型，需要用 new 来创建，既在栈空间分配一个地址空间，又在堆空间分配对象的类变量;<br/><br>  4、方法的引用参数，在栈空间分配一个地址空间，并指向堆空间的对象区，当方法调用完后从栈空间回收;<br/><br>  5、局部变量 new 出来时，在栈空间和堆空间中分配空间，当局部变量生命周期结束后，栈空间立刻被回收，堆空间区域等待 GC 回收;<br/><br>  6、方法调用时传入的实际参数，先在栈空间分配，在方法调用完成后从栈空间释放;<br/><br>  7、字符串常量在 DATA 区域分配 ， this 在堆空间分配;<br/><br>  8、数组既在栈空间分配数组名称， 又在堆空间分配数组实际的大小。<br/></p>
<h2 id="8、wait-与sleep-的区别"><a href="#8、wait-与sleep-的区别" class="headerlink" title="8、wait()与sleep()的区别"></a>8、wait()与sleep()的区别</h2><p>a)sleep()来自Thread类，和wait()来自Object类.调用sleep()方法的过程中，线程不会释放对象锁。而 调用 wait 方法线程会释放对象锁。<br/><br>  b)sleep()睡眠后不出让系统资源，wait让其他线程可以占用CPU。<br/><br>  c)sleep(milliseconds)需要指定一个睡眠时间，时间一到会自动唤醒.而wait()需要配合notify()或者notifyAll()使用。<br/></p>
<h2 id="9、说说你对-Java-中反射的理解-？"><a href="#9、说说你对-Java-中反射的理解-？" class="headerlink" title="9、说说你对 Java 中反射的理解 ？"></a>9、说说你对 Java 中反射的理解 ？</h2><p>JAVA反射机制是在运行状态中，对于任意一个类，都能够知道这个类的所有属性和方法；对于任意一个对象，都能够调用它的任意一个方法；这种动态获取的信息以及动态调用对象的方法的功能称为java语言的反射机制。</p>
<h2 id="10、写出常见的5个RuntimeException"><a href="#10、写出常见的5个RuntimeException" class="headerlink" title="10、写出常见的5个RuntimeException"></a>10、写出常见的5个RuntimeException</h2><p>     (1)java.lang.NullPointerException空指针异常，出现原因：调用了未经初始化的对性爱那个或者不存在的对象。<br/><br>       (2)ClassNoFoundException 指定类找不到，出现原因：类的名称和路径加载错误，通常是试图通过字符串来加载某个类时可能引发异常。<br/><br>       (3)NumberFormatException字符串转换为数字异常，出现原因：字符串数据中包含非数字型字符。<br/><br>       (4)IndexOutOfBoundsException数组下标越界异常<br/><br>       (5)IllegalArgumentException 方法传递参数错误<br/><br>       (6)ClassCastException数据类型转换异常<br/><br>       (7)NoClassDefFoundExcetion 未找到类定义错误<br/><br>       (8)SQLException SQL异常<br/><br>       (9)InstantiationException实例化异常<br/><br>       (10)NoSuchMethodExceptioin 方法不存在异常<br/></p>
]]></content>
      <categories>
        <category>面试题</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>maven安装与配置idea配置maven</title>
    <url>/2020/05/03/maven%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AEidea%E9%85%8D%E7%BD%AEmaven/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><h2 id="maven介绍"><a href="#maven介绍" class="headerlink" title="maven介绍"></a>maven介绍</h2><p>Apache Maven是一个软件项目管理和理解工具。基于项目对象模型（POM）的概念，Maven可以从中央信息管理项目的构建，报告和文档。<br>Maven是一个项目管理和整合的工具。Maven为开发者提供了一套完整的构建生命周期框架。开发团队基本不用花多少时间就能自动完成工程的基础构建配置，因为Maven使用了一个标准的目录结构和一个默认的构建生命周期。在创建报告、检查、构建和测试自动配置时，Maven可以让开发者的工作变得更简单。<br>官网：<a href="https://maven.apache.org/" target="_blank" rel="noopener">https://maven.apache.org/</a></p>
<h2 id="下载与安装"><a href="#下载与安装" class="headerlink" title="下载与安装"></a>下载与安装</h2><p>1.下载：<a href="https://maven.apache.org/download.cgi" target="_blank" rel="noopener">https://maven.apache.org/download.cgi</a><br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/05/Snipaste_2020-05-03_22-08-30-e054caf2efd14a5bbd157f7678a25a87.png" alt="Snipaste_2020-05-03_22-08-30"><br>2.安装<br>next<br>我的路径：D:\java\maven\apache-maven-3.6.2</p>
<h2 id="环境变量配置"><a href="#环境变量配置" class="headerlink" title="环境变量配置"></a>环境变量配置</h2><p>1.右击此电脑&gt;属性&gt;高级系统设置&gt;环境变量&gt;单击[新建(W)]添加以下环境变量<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/05/Snipaste_2020-05-03_21-32-17-17f4088ae5bc4ee886779780704d189b.png" alt="Snipaste_2020-05-03_21-32-17"><br>2.新建环境变量<br>M2_HOME<br>D:\java\maven\apache-maven-3.6.2<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/05/Snipaste_2020-05-03_22-13-28-1e1f407b86134790b3734495ec5d7777.png" alt="Snipaste_2020-05-03_22-13-28"><br>3.更新 PATH 变量，添加 Maven bin 文件夹到 PATH 的最后<br>Path<br>D:\java\maven\apache-maven-3.6.2\bin<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/05/Snipaste_2020-05-03_22-14-36-7b23a71b9d4c4893a54520da2392990c.png" alt="Snipaste_2020-05-03_22-14-36"></p>
<h2 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h2><p>windows+r调出cmd窗口输入  mvn -v<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/05/image-8dfa789d6490436fb27485bb5c582eac.png" alt="image.png"><br>成功</p>
<h2 id="settings文件修改"><a href="#settings文件修改" class="headerlink" title="settings文件修改"></a>settings文件修改</h2><p>（1）本地仓库（可选）<br>Default: ${user.home}/.m2/repository<br><localRepository>D:\java\repository\rep1</localRepository><br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/05/Snipaste_2020-05-03_22-26-19-d83c003d3b7f4991ae296213c83ec4dd.png" alt="Snipaste_2020-05-03_22-26-19"><br>（2）配置阿里云镜像仓库</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;mirror&gt;</span><br><span class="line">            &lt;id&gt;alimaven-central&lt;&#x2F;id&gt;</span><br><span class="line">            &lt;mirrorOf&gt;central&lt;&#x2F;mirrorOf&gt;</span><br><span class="line">            &lt;name&gt;aliyun maven&lt;&#x2F;name&gt;</span><br><span class="line">            &lt;url&gt;http:&#x2F;&#x2F;maven.aliyun.com&#x2F;nexus&#x2F;content&#x2F;repositories&#x2F;central&#x2F;&lt;&#x2F;url&gt;</span><br><span class="line">        &lt;&#x2F;mirror&gt;</span><br><span class="line">        </span><br><span class="line">  &lt;&#x2F;mirrors&gt;</span><br></pre></td></tr></table></figure>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/05/Snipaste_2020-05-03_22-27-44-77c6ea7ac3a04d64a611e7dd1c373cf6.png" alt="Snipaste_2020-05-03_22-27-44"><br>（3）配置jdk版本</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;profile&gt;</span><br><span class="line">            &lt;id&gt;jdk18&lt;&#x2F;id&gt;</span><br><span class="line">            &lt;activation&gt;</span><br><span class="line">                &lt;jdk&gt;1.8&lt;&#x2F;jdk&gt;</span><br><span class="line">                &lt;activeByDefault&gt;true&lt;&#x2F;activeByDefault&gt;</span><br><span class="line">            &lt;&#x2F;activation&gt;</span><br><span class="line">            &lt;properties&gt;</span><br><span class="line">                &lt;maven.compiler.source&gt;1.8&lt;&#x2F;maven.compiler.source&gt;</span><br><span class="line">                &lt;maven.compiler.target&gt;1.8&lt;&#x2F;maven.compiler.target&gt;</span><br><span class="line">                &lt;maven.compiler.compilerVersion&gt;1.8&lt;&#x2F;maven.compiler.compilerVersion&gt;</span><br><span class="line">            &lt;&#x2F;properties&gt;</span><br><span class="line">        &lt;&#x2F;profile&gt;</span><br></pre></td></tr></table></figure>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/05/Snipaste_2020-05-03_22-27-53-ad6d6ea2d6c047d29dfeee9837523a27.png" alt="Snipaste_2020-05-03_22-27-53"></p>
<h2 id="idea配置maven"><a href="#idea配置maven" class="headerlink" title="idea配置maven"></a>idea配置maven</h2><p>File-settings-Build，Excution，Deployment-BuildTools-Maven<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/05/Snipaste_2020-05-03_22-22-29-0f8e492bb6fb41aa80faeb535f21c6f2.png" alt="Snipaste_2020-05-03_22-22-29"></p>
]]></content>
      <categories>
        <category>工具</category>
      </categories>
      <tags>
        <tag>idea</tag>
        <tag>maven</tag>
      </tags>
  </entry>
  <entry>
    <title>vuepress+github部署自己的静态博客</title>
    <url>/2020/05/08/vuepress+github%E9%83%A8%E7%BD%B2%E8%87%AA%E5%B7%B1%E7%9A%84%E9%9D%99%E6%80%81%E5%8D%9A%E5%AE%A2/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><p>没错，我又弄了一个静态博客，哈哈,我也不知道为什么，当作学习了吧!</p>
<h2 id="Vue-js"><a href="#Vue-js" class="headerlink" title="Vue.js"></a>Vue.js</h2><p>还要从昨天想要学习vue开始，</p>
<blockquote>
<p>Vue.js是一套构建用户界面的渐进式框架。与其他重量级框架不同的是，Vue 采用自底向上增量开发的设计。Vue 的核心库只关注视图层，并且非常容易学习，非常容易与其它库或已有项目整合。另一方面，Vue 完全有能力驱动采用单文件组件和Vue生态系统支持的库开发的复杂单页应用。</p>
</blockquote>
<p>官网：<a href="https://cn.vuejs.org/" target="_blank" rel="noopener">https://cn.vuejs.org/</a><br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/05/image-92a23e88c1ec4966ae0a2769ec2f03ac.png" alt="image.png"></p>
<p>vue没学倒是挺喜欢官网的界面的，想着是怎么做的，就找到了vuepress。</p>
<h2 id="VuePress"><a href="#VuePress" class="headerlink" title="VuePress"></a>VuePress</h2><p>官网：<a href="https://www.vuepress.cn/" target="_blank" rel="noopener">https://www.vuepress.cn/</a><br>简洁至上<br>以 Markdown 为中心的项目结构，以最少的配置帮助你专注于写作。<br>Vue 驱动<br>享受 Vue + webpack 的开发体验，可以在 Markdown 中使用 Vue 组件，又可以使用 Vue 来开发自定义主题。<br>高性能<br>VuePress 会为每个页面预渲染生成静态的 HTML，同时，每个页面被加载的时候，将作为 SPA 运行。<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/05/image-3694e7a68e494d70b127c4f8966eda35.png" alt="image.png"><br>其实就是用来写Markdown的<br><a href="http://www.zhangpeng.plus/vuepress/" target="_blank" rel="noopener">http://www.zhangpeng.plus/vuepress/</a></p>
<h2 id="vuepress搭博客"><a href="#vuepress搭博客" class="headerlink" title="vuepress搭博客"></a>vuepress搭博客</h2><p>但是我找了个模板就开始搞博客哈哈</p>
<blockquote>
<p>请确保你的 Node.js 版本 &gt;= 8。<br>vuepress</p>
</blockquote>
<ol>
<li><p>全局安装</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 安装</span><br><span class="line">yarn global add vuepress # 或者：npm install -g vuepress</span><br><span class="line"></span><br><span class="line"># 创建项目目录</span><br><span class="line">mkdir vuepress-starter &amp;&amp; cd vuepress-starter</span><br><span class="line"></span><br><span class="line"># 新建一个 markdown 文件</span><br><span class="line">echo &#39;# Hello VuePress!&#39; &gt; README.md</span><br><span class="line"></span><br><span class="line"># 开始写作</span><br><span class="line">vuepress dev .</span><br><span class="line"></span><br><span class="line"># 构建静态文件</span><br><span class="line">vuepress build .</span><br></pre></td></tr></table></figure>
</li>
<li><p>现有项目</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 将 VuePress 作为一个本地依赖安装</span><br><span class="line">yarn add -D vuepress # 或者：npm install -D vuepress</span><br><span class="line"></span><br><span class="line"># 新建一个 docs 文件夹</span><br><span class="line">mkdir docs</span><br><span class="line"></span><br><span class="line"># 新建一个 markdown 文件</span><br><span class="line">echo &#39;# Hello VuePress!&#39; &gt; docs&#x2F;README.md</span><br><span class="line"></span><br><span class="line"># 开始写作</span><br><span class="line">npx vuepress dev docs</span><br></pre></td></tr></table></figure></li>
<li><p>详细教程：<a href="https://www.vuepress.cn/" target="_blank" rel="noopener">https://www.vuepress.cn/</a></p>
</li>
</ol>
<h2 id="部署github"><a href="#部署github" class="headerlink" title="部署github"></a>部署github</h2><ol>
<li>部署github，创建一个如下的 deploy.sh 文件<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#!&#x2F;usr&#x2F;bin&#x2F;env sh</span><br><span class="line"></span><br><span class="line"># 确保脚本抛出遇到的错误</span><br><span class="line">set -e</span><br><span class="line"></span><br><span class="line"># 生成静态文件</span><br><span class="line">npm run docs:build</span><br><span class="line"></span><br><span class="line"># 进入生成的文件夹</span><br><span class="line">cd docs&#x2F;.vuepress&#x2F;dist</span><br><span class="line"></span><br><span class="line"># 如果是发布到自定义域名</span><br><span class="line"># echo &#39;www.example.com&#39; &gt; CNAME</span><br><span class="line"></span><br><span class="line">git init</span><br><span class="line">git add -A</span><br><span class="line">git commit -m &#39;deploy&#39;</span><br><span class="line"></span><br><span class="line"># 如果发布到 https:&#x2F;&#x2F;&lt;USERNAME&gt;.github.io</span><br><span class="line"># git push -f git@github.com:&lt;USERNAME&gt;&#x2F;&lt;USERNAME&gt;.github.io.git master</span><br><span class="line"></span><br><span class="line"># 如果发布到 https:&#x2F;&#x2F;&lt;USERNAME&gt;.github.io&#x2F;&lt;REPO&gt;</span><br><span class="line"># git push -f git@github.com:&lt;USERNAME&gt;&#x2F;&lt;REPO&gt;.git master:gh-pages</span><br><span class="line"></span><br><span class="line">cd -</span><br></pre></td></tr></table></figure></li>
<li>小问题</li>
</ol>
<blockquote>
<p>在 docs/.vuepress/config.js 中设置正确的 base。<br>如果你打算发布到 https://&lt;USERNAME.github.io/，则可以省略这一步，因为 base 默认即是 “/“。<br>如果你打算发布到 https://&lt;USERNAME.github.io/&lt;REPO/（也就是说你的仓库在 <a href="https://github.com/" target="_blank" rel="noopener">https://github.com/</a>&lt;USERNAME/&lt;REPO），则将 base 设置为 “/&lt;REPO/“。</p>
</blockquote>
<ol start="3">
<li>每个账号可以有几个github pages</li>
</ol>
<p>解决了我一个难题，之前我甚至注册了个新的邮箱去放我的hexo博客</p>
<blockquote>
<p>个人主页必须要和用户的GitHub帐号同名，所以每个用户有且只能有一个repo作为个人主页，且必须是<username>/<username>.github.io的形式；而项目主页的命名则没有这种限制，且数量有任意多个。</p>
</blockquote>
<blockquote>
<p>不考虑绑定的自定义域名的前提下，个人主页的GitHub二级域名为&lt;username.github.io;项目主页的GitHub二级域名为&lt;username.github.io/&lt;projectname,没有&lt;projectname.&lt;username.github.io这种方式</p>
</blockquote>
<blockquote>
<p>个人主页的展示内容以master分支里的文件为准；而项目主页的展示内容以gh-pages分支内的文件为准</p>
</blockquote>
<p><a href="https://help.github.com/en/github/working-with-github-pages/about-github-pages" target="_blank" rel="noopener">https://help.github.com/en/github/working-with-github-pages/about-github-pages</a></p>
<h2 id="结果展示"><a href="#结果展示" class="headerlink" title="结果展示"></a>结果展示</h2><p>文档：<a href="http://www.zhangpeng.plus/vuepress/" target="_blank" rel="noopener">http://www.zhangpeng.plus/vuepress/</a><br>博客：<a href="https://zhangpengpeng69.github.io/vuepressblog/" target="_blank" rel="noopener">https://zhangpengpeng69.github.io/vuepressblog/</a></p>
]]></content>
      <categories>
        <category>前端</category>
      </categories>
      <tags>
        <tag>github</tag>
        <tag>java</tag>
        <tag>vue</tag>
        <tag>vuepress</tag>
      </tags>
  </entry>
  <entry>
    <title>wlop画的画真的超级好看呀</title>
    <url>/2020/04/18/wlop%E7%94%BB%E7%9A%84%E7%94%BB%E7%9C%9F%E7%9A%84%E8%B6%85%E7%BA%A7%E5%A5%BD%E7%9C%8B%E5%91%80/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><h2 id="WLOP"><a href="#WLOP" class="headerlink" title="WLOP"></a>WLOP</h2><p>&emsp;&emsp;个人非常的喜欢收集各种类型的图片，没事的时候拿出来看看，感觉非常的舒心。对于wlop这个人不怎么了解，但是他的画是真的好看呀！<br/><br>&emsp;&emsp;抽出时间用pr做了一个视频，放到了B站上。</p>
<iframe id="spkj" src="https://player.bilibili.com/player.html?aid=455247425&bvid=BV1i5411t7oY&cid=175655266&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true" width=100%> </iframe>
<script type="text/javascript">  
document.getElementById("spkj").style.height=document.getElementById("spkj").scrollWidth*0.76+"px";
</script>


<iframe id="spkjj" src="https://player.bilibili.com/player.html?aid=967734713&bvid=BV1Up4y1C7gQ&cid=175813580&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true" width=100%> </iframe>
<script type="text/javascript">  
document.getElementById("spkjj").style.height=document.getElementById("spkj").scrollWidth*0.76+"px";
</script>




<h2 id="artstation"><a href="#artstation" class="headerlink" title="artstation"></a>artstation</h2><p>&emsp;&emsp;最早是在artstation（<a href="https://www.artstation.com/" target="_blank" rel="noopener">https://www.artstation.com/</a>）上看到的他的画，非常喜欢，便收集来做壁纸了，哈哈。这个网站需要翻墙才能进去，里面的大神非常的多，虽然我不是从事这个行业，但是非常的喜欢。<br/><br>有这种的<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/jwhs_W2kQP3%201567733352j-won-han-234231221222-8480818490c74f6f991b84a53ed487f1.jpg" alt="jwhs_W2kQP3 1567733352j-won-han-234231221222"><br/><br>这种的<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/tohad_qAgNm2%201585776214sylvain-sarrailh-yoshiexotic-1343f59c8ff64ca298d2fa1c2b433e48.jpg" alt="tohad_qAgNm2 1585776214sylvain-sarrailh-yoshiexotic"><br/><br>或者是这种的<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/syy1983_bambxd%201555770386sui-yangyang-dragon3-40cc726b2ba44e2f8c9b62c225ec4fa6.jpg" alt="syy1983_bambxd 1555770386sui-yangyang-dragon3"><br/><br>各种各样的，真的是佩服这些人的想象力！</p>
<h2 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h2><p>artstation这么多图片，想下载怎么办，答案,豆皮图片下载器，批量下载哈哈。<br>首先打开想要下载的某个人的主页，复制地址<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/Snipaste_2020-04-12_01-01-05-701fed33e1a8439ba544ecab0b7a1c04.jpg" alt="Snipaste_20200412_010105.jpg"><br>打开豆皮图片下载器，填入地址，选择输出文件夹。开始下载。<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/image-7df1fd173d194de7b12ff5f887f47310.png" alt="image.png"><br>这样这个人的所有作品都会下载下来了。</p>
]]></content>
      <categories>
        <category>娱乐</category>
      </categories>
      <tags>
        <tag>wlop</tag>
        <tag>图片</tag>
      </tags>
  </entry>
  <entry>
    <title>入门three.js</title>
    <url>/2020/04/20/%E5%85%A5%E9%97%A8three.js/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><p>突然感觉three.js挺有意思的，简单入门了一下three.js，但是并没有打算深入学习。</p>
<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>&emsp;&emsp;three.js是JavaScript编写的WebGL第三方库。提供了非常多的3D显示功能。<br>&emsp;&emsp;Three.js 是一款运行在浏览器中的 3D 引擎，你可以用它创建各种三维场景，包括了摄影机、光影、材质等各种对象。你可以在它的主页上看到许多精彩的演示。不过，这款引擎还处在比较不成熟的开发阶段，其不够丰富的 API 以及匮乏的文档增加了初学者的学习难度（尤其是文档的匮乏）three.js的代码托管在github上面。<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/image-1481693e51244af7af24d3ec2ace6dfb.png" alt="image.png"><br>官网：<a href="https://threejs.org/" target="_blank" rel="noopener">https://threejs.org/</a></p>
<p>Github：<a href="https://github.com/mrdoob/three.js/" target="_blank" rel="noopener">https://github.com/mrdoob/three.js/</a></p>
<p>目录结构：<br>Build目录：包含两个文件，three.js 和three.min.js 。这是three.js最终被引用的文件。一个已经压缩，一个没有压缩的js文件。</p>
<p>Docs目录：这里是three.js的帮助文档，里面是各个函数的api，可惜并没有详细的解释。试图用这些文档来学会three.js是不可能的。</p>
<p>Editor目录：一个类似3D-max的简单编辑程序，它能创建一些三维物体。</p>
<p>Examples目录：一些很有趣的例子demo，可惜没有文档介绍。对图像学理解不深入的同学，学习成本非常高。</p>
<p>Src目录：源代码目录，里面是所有源代码。</p>
<p>Test目录：一些测试代码，基本没用。</p>
<p>Utils目录：存放一些脚本，python文件的工具目录。例如将3D-Max格式的模型转换为three.js特有的json模型。</p>
<p>.gitignore文件：git工具的过滤规则文件，没有用。</p>
<p>CONTRIBUTING.md文件：一个怎么报bug，怎么获得帮助的说明文档。</p>
<p>LICENSE文件：版权信息。</p>
<p>README.md文件：介绍three.js的一个文件，里面还包含了各个版本的更新内容列表。</p>
<h2 id="入门程序"><a href="#入门程序" class="headerlink" title="入门程序"></a>入门程序</h2><ol>
<li><p>下载three.js</p>
</li>
<li><p>导入three.js</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;script src&#x3D;&quot;js&#x2F;three.js&quot;&gt;&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>三大组件<br>在Three.js中，要渲染物体到网页中，我们需要3个组建：场景（scene）、相机（camera）和渲染器（renderer）。有了这三样东西，才能将物体渲染到网页中去。<br>创建这三要素的代码如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">var scene &#x3D; new THREE.Scene();	&#x2F;&#x2F; 场景</span><br><span class="line">var camera &#x3D; new THREE.PerspectiveCamera(75, window.innerWidth&#x2F;window.innerHeight, 0.1, 1000);&#x2F;&#x2F; 透视相机</span><br><span class="line">var renderer &#x3D; new THREE.WebGLRenderer();	&#x2F;&#x2F; 渲染器</span><br><span class="line">renderer.setSize(window.innerWidth, window.innerHeight);	&#x2F;&#x2F; 设置渲染器的大小为窗口的内宽度，也就是内容区的宽度</span><br><span class="line">document.body.appendChild(renderer.domElement);</span><br></pre></td></tr></table></figure>


</li>
</ol>
<p>在Threejs中场景就只有一种，用THREE.Scene来表示，要构件一个场景也很简单，只要new一个对象就可以了，代码如下：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">var scene &#x3D; new THREE.Scene();</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>相机<br>另一个组建是相机，相机决定了场景中那个角度的景色会显示出来。相机就像人的眼睛一样，人站在不同位置，抬头或者低头都能够看到不同的景色。</li>
</ol>
<p>场景只有一种，但是相机却又很多种。和现实中一样，不同的相机确定了呈相的各个方面。比如有的相机适合人像，有的相机适合风景，专业的摄影师根据实际用途不一样，选择不同的相机。对程序员来说，只要设置不同的相机参数，就能够让相机产生不一样的效果。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">var camera &#x3D; new THREE.PerspectiveCamera(75, window.innerWidth&#x2F;window.innerHeight, 0.1, 1000);</span><br></pre></td></tr></table></figure>
<p>5.渲染器<br>最后一步就是设置渲染器，渲染器决定了渲染的结果应该画在页面的什么元素上面，并且以怎样的方式来绘制。这里我们定义了一个WebRenderer渲染器，代码如下所示：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">var renderer &#x3D; new THREE.WebGLRenderer();</span><br><span class="line">renderer.setSize(window.innerWidth, window.innerHeight);</span><br><span class="line">document.body.appendChild(renderer.domElement);</span><br></pre></td></tr></table></figure>

<p>6.渲染<br>渲染应该使用渲染器，结合相机和场景来得到结果画面。实现这个功能的函数是</p>
<p>renderer.render(scene, camera);</p>
<p>渲染函数的原型如下：</p>
<p>render( scene, camera, renderTarget, forceClear )</p>
<p>各个参数的意义是：</p>
<p>scene：前面定义的场景</p>
<p>camera：前面定义的相机</p>
<p>renderTarget：渲染的目标，默认是渲染到前面定义的render变量中</p>
<p>forceClear：每次绘制之前都将画布的内容给清除，即使自动清除标志autoClear为false，也会清除。</p>
<p>7.完整代码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;&lt;&#x2F;title&gt;</span><br><span class="line">    &lt;style&gt;canvas &#123; width: 100%; height: 100% &#125;&lt;&#x2F;style&gt;</span><br><span class="line">    &lt;script src&#x3D;&quot;js&#x2F;three.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;script&gt;</span><br><span class="line">        var scene &#x3D; new THREE.Scene();</span><br><span class="line">        </span><br><span class="line">        var camera &#x3D; new THREE.PerspectiveCamera(75, window.innerWidth&#x2F;window.innerHeight, 0.1, 1000);</span><br><span class="line">        </span><br><span class="line">        var renderer &#x3D; new THREE.WebGLRenderer();</span><br><span class="line">        </span><br><span class="line">        renderer.setSize(window.innerWidth, window.innerHeight);</span><br><span class="line">        </span><br><span class="line">        document.body.appendChild(renderer.domElement);</span><br><span class="line">        var geometry &#x3D; new THREE.CubeGeometry(1,1,1);</span><br><span class="line">        var material &#x3D; new THREE.MeshBasicMaterial(&#123;color: 0x00ff00&#125;);</span><br><span class="line">        var cube &#x3D; new THREE.Mesh(geometry, material); scene.add(cube);</span><br><span class="line">        camera.position.z &#x3D; 5;</span><br><span class="line">        function render() &#123;</span><br><span class="line">            requestAnimationFrame(render);</span><br><span class="line">            cube.rotation.x +&#x3D; 0.1;</span><br><span class="line">            cube.rotation.y +&#x3D; 0.1;</span><br><span class="line">            renderer.render(scene, camera);</span><br><span class="line">        &#125;</span><br><span class="line">        render();</span><br><span class="line">    &lt;&#x2F;script&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>
<h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><p>官网全部示例：<a href="https://threejs.org/examples/#webgl_animation_cloth" target="_blank" rel="noopener">https://threejs.org/examples/#webgl_animation_cloth</a></p>
]]></content>
      <categories>
        <category>前端</category>
      </categories>
      <tags>
        <tag>three.js</tag>
      </tags>
  </entry>
  <entry>
    <title>关于我</title>
    <url>/2020/05/01/%E5%85%B3%E4%BA%8E%E6%88%91/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><h3 id="1-订阅："><a href="#1-订阅：" class="headerlink" title="1.订阅："></a>1.订阅：</h3><p>网站：<a href="https://www.zhangpeng.fun/" target="_blank" rel="noopener">https://www.zhangpeng.fun/</a></p>
<p>公众号：爱敲代码的鹏</p>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88-81e85115b3a2458fae718b858a0680da.png" alt="扫码_搜索联合传播样式-标准色版"></p>
<p>小程序：爱敲代码的我</p>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88-1eba896f22fd4b409edd064695228758.png" alt="扫码_搜索联合传播样式-标准色版"></p>
<p>app（安卓.苹果）：</p>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/app-e8bc0b4c209c4ecfa5fb6c8d70ab9b45.png" alt="app"></p>
<p>抖音：</p>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/%E6%8A%96%E9%9F%B33-ee272066c20242c2b559967f64173e93.jpg" alt="抖音3"></p>
<p>B站：<a href="https://space.bilibili.com/106097751" target="_blank" rel="noopener">https://space.bilibili.com/106097751</a><br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/bzhan-71bc0f420d554893bdd69ae0fadf6ecc.png" alt="bzhan"></p>
<h3 id="2-关于："><a href="#2-关于：" class="headerlink" title="2.关于："></a>2.关于：</h3><p>刚刚毕业的计算机专业的大学生，Java开发程序员一枚。<br/></p>
<p>邮箱：<a href="mailto:zpeng_it@163.com">zpeng_it@163.com</a><br/></p>
<p>微信：</p>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/image-d0b96c5b99304fda9bc3fb49ed8b33d2.png" alt="image.png"><br/><br>Github：<a href="https://github.com/zhangpengpeng69" target="_blank" rel="noopener">https://github.com/zhangpengpeng69</a><br/><br>博客：<a href="https://www.zhangpeng.fun/" target="_blank" rel="noopener">https://www.zhangpeng.fun/</a><br/><br>Github博客：<a href="https://github.com/zhangpengpeng69/ZPeng-s-Blog" target="_blank" rel="noopener">https://github.com/zhangpengpeng69/ZPeng-s-Blog</a><br/></p>
<h3 id="3-本博客："><a href="#3-本博客：" class="headerlink" title="3.本博客："></a>3.本博客：</h3><p>Halo：<a href="https://github.com/halo-dev/halo" target="_blank" rel="noopener">https://github.com/halo-dev/halo</a>  –是一款现代化的个人独立博客系统<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/image-6500355f16f0478cb6659923e204170d.png" alt="image.png"><br>社区：<a href="https://bbs.halo.run/" target="_blank" rel="noopener">https://bbs.halo.run/</a><br/><br>官网：<a href="https://halo.run/" target="_blank" rel="noopener">https://halo.run/</a></p>
<h3 id="4-留言："><a href="#4-留言：" class="headerlink" title="4.留言："></a>4.留言：</h3><p>在下方留言加友链&gt;&gt;&gt;&gt;&gt;&gt;</p>
]]></content>
      <categories>
        <category>myblog</category>
      </categories>
      <tags>
        <tag>me</tag>
      </tags>
  </entry>
  <entry>
    <title>内排序</title>
    <url>/2020/04/02/%E5%86%85%E6%8E%92%E5%BA%8F/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><h1 id="内排序"><a href="#内排序" class="headerlink" title="内排序"></a>内排序</h1><p>　　排序使程序开发中一种常见的操作。将一组杂乱无章的数据按一定的规则将其排列好。使数据得以快速检索到，这就是排序的目的。<br>对于一个排序算法，一般可以从下面三个方面去衡量算法的优劣：</p>
<p>1) 时间复杂度：主要缝隙关键字的比较次数和移动字数；<br>2) 空间复杂度：缝隙排序算法中需要多少辅助内存；<br>3) 稳定性：当两个关键字相同，如果排序完成后两者的顺序保持不变，则是该排序算法是稳定。<br>　排序算法大致可以分为内部算法和外部算法。如果整个排序过程不需要借助于外部储存器（磁盘），所有的操作都在内存中完成，则称之为内部算法。如果参与排序树数据元素非常多，数据量非常大，则计算机必须借助外部储存器（如磁盘），这种排序称为外部排序。</p>
<h2 id="内部排序的分类"><a href="#内部排序的分类" class="headerlink" title="内部排序的分类"></a>内部排序的分类</h2><p>一般我们所说排序指的就是内部排序，常见的内部排序又可以分为6大类。</p>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://182.92.171.224/upload/20191125_12321758.png" alt=""></p>
 <figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> sort;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义一个数据包装类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DataWrap</span> <span class="keyword">implements</span> <span class="title">Comparable</span>&lt;<span class="title">DataWrap</span>&gt;</span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> data;</span><br><span class="line">    String flag;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DataWrap</span><span class="params">(<span class="keyword">int</span> data, String flag)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.data = data;</span><br><span class="line">        <span class="keyword">this</span>.flag = flag;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> data + flag;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 根据data实例变量来决定两个DataWrap的大小</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(DataWrap dw)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.data &gt; dw.data ? <span class="number">1</span></span><br><span class="line">            : (<span class="keyword">this</span>.data == dw.data ? <span class="number">0</span> : -<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="1-1-选择排序"><a href="#1-1-选择排序" class="headerlink" title="1.1 选择排序"></a>1.1 选择排序</h2><p>选择排序方法有两种，直接选择排序和堆排序。直接选择排序简单直观，但是性能较差；堆排序较为高效，但是实现起来较为复杂。</p>
<h3 id="1-1-1-直接选择排序"><a href="#1-1-1-直接选择排序" class="headerlink" title="1.1.1 直接选择排序"></a>1.1.1 直接选择排序</h3><p>直接选择排序思想：程序遍历n个数，然后比较出最大的一个与最后一个数进行交换，最大值确定好了；接下来遍历n-1，找个这n-1个数中的最大值并且交换位置，直至n=0位置。<br>该排序方法的数据交换次数是，但是比较次数较多。总的时间效率是。空间效率是，并且算法不稳定。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> sort;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SelectSort</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">selectSort</span><span class="params">(DataWrap[] data)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"开始排序"</span>);</span><br><span class="line">        <span class="keyword">int</span> arrayLength = data.length;</span><br><span class="line">        <span class="comment">// 依次进行n-1趟比较, 第i趟比较将第i大的值选出放在i位置上。</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; arrayLength - <span class="number">1</span> ; i++ )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// minIndex永远保留本趟比较中最小值的索引</span></span><br><span class="line">            <span class="keyword">int</span> minIndex = i ;</span><br><span class="line">            <span class="comment">// 第i个数据只需和它后面的数据比较</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = i + <span class="number">1</span> ; j &lt; arrayLength ; j++ )</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 如果第minIndex位置的数据 &gt; j位置的数据</span></span><br><span class="line">                <span class="keyword">if</span> (data[minIndex].compareTo(data[j]) &gt; <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 将j的值赋给minIndex</span></span><br><span class="line">                    minIndex = j;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 每趟比较最多交换一次</span></span><br><span class="line">            <span class="keyword">if</span> (minIndex != i)</span><br><span class="line">            &#123;</span><br><span class="line">                DataWrap tmp = data[i];</span><br><span class="line">                data[i] = data[minIndex];</span><br><span class="line">                data[minIndex] = tmp;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(java.util.Arrays.toString(data));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        DataWrap[] data = &#123;</span><br><span class="line">            <span class="keyword">new</span> DataWrap(<span class="number">21</span> , <span class="string">""</span>),</span><br><span class="line">            <span class="keyword">new</span> DataWrap(<span class="number">30</span> , <span class="string">""</span>),</span><br><span class="line">            <span class="keyword">new</span> DataWrap(<span class="number">49</span> , <span class="string">""</span>),</span><br><span class="line">            <span class="keyword">new</span> DataWrap(<span class="number">30</span> , <span class="string">"*"</span>),</span><br><span class="line">            <span class="keyword">new</span> DataWrap(<span class="number">16</span> , <span class="string">""</span>),</span><br><span class="line">            <span class="keyword">new</span> DataWrap(<span class="number">9</span> , <span class="string">""</span>)</span><br><span class="line">        &#125;;</span><br><span class="line">        System.out.println(<span class="string">"排序之前：\n"</span></span><br><span class="line">            + java.util.Arrays.toString(data));</span><br><span class="line">        selectSort(data);</span><br><span class="line">        System.out.println(<span class="string">"排序之后：\n"</span></span><br><span class="line">            + java.util.Arrays.toString(data));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-1-2-堆排序"><a href="#1-1-2-堆排序" class="headerlink" title="1.1.2 堆排序"></a>1.1.2 堆排序</h3><p>堆排序的思路：将数据建立成最大（小）堆，将根节点与最后一个节点交换；重复上面的过程。<br>1）堆树是一颗完全二叉树；<br>2）堆树中某个节点的值总是不大于或不小于其孩子节点的值；<br>3）堆树中每个节点的子树都是堆树。<br>当父节点的键值总是大于或等于任何一个子节点的键值时为最大堆。 当父节点的键值总是小于或等于任何一个子节点的键值时为最小堆。如下图所示，左边为最大堆，右边为最小堆。<br>引用：<a href="https://www.cnblogs.com/zf-blog/p/9010977.html" target="_blank" rel="noopener">https://www.cnblogs.com/zf-blog/p/9010977.html</a><br>堆排序是选择算法的改进，可以减少选择排序中的比较次数，进而减少排序时间。对于堆排序来说，有n个数据，需要进行n-1次建堆，每次建堆本身耗时为,所以其时间效率为，堆排序是不稳定的。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> sort;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HeapSort</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">heapSort</span><span class="params">(DataWrap[] data)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"开始排序"</span>);</span><br><span class="line">        <span class="keyword">int</span> arrayLength=data.length;</span><br><span class="line">        <span class="comment">//循环建堆</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;arrayLength-<span class="number">1</span>;i++) &#123;</span><br><span class="line">            <span class="comment">//建堆</span></span><br><span class="line">            buildMaxdHeap(data,arrayLength-<span class="number">1</span>-i);</span><br><span class="line">            <span class="comment">//交换堆与最后一个的数据</span></span><br><span class="line">            swap(data,<span class="number">0</span>,arrayLength-<span class="number">1</span>-i);</span><br><span class="line">            System.out.println(java.util.Arrays.toString(data));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">swap</span><span class="params">(DataWrap[] data, <span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">        DataWrap tmp=data[i];</span><br><span class="line">        data[i]=data[j];</span><br><span class="line">        data[j]=tmp;</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">buildMaxdHeap</span><span class="params">(DataWrap[] data, <span class="keyword">int</span> lastIndex)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//从lastIndex出节点(最后一个)的父节点开始</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=(lastIndex-<span class="number">1</span>)/<span class="number">2</span>;i&gt;+<span class="number">0</span>;i--) &#123;</span><br><span class="line">            <span class="comment">//k保存当前正在判断的点</span></span><br><span class="line">            <span class="keyword">int</span> k=i;</span><br><span class="line">            <span class="comment">//如果当前K节点的子节点存在</span></span><br><span class="line">            <span class="keyword">while</span>(k*<span class="number">2</span>+<span class="number">1</span>&lt;=lastIndex) &#123;</span><br><span class="line">                <span class="comment">//k节点的左子节点的索引</span></span><br><span class="line">                <span class="keyword">int</span> biggerIndex=<span class="number">2</span>*k+<span class="number">1</span>;</span><br><span class="line">                <span class="comment">//判断是否存在右子节点</span></span><br><span class="line">                <span class="keyword">if</span>(biggerIndex&lt;lastIndex) &#123;</span><br><span class="line">                    biggerIndex++;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span>((data[k].compareTo(data[biggerIndex])&lt;<span class="number">0</span>)) &#123;</span><br><span class="line">                    swap(data,k,biggerIndex);</span><br><span class="line">                    k=biggerIndex;</span><br><span class="line">                &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        DataWrap[] data = &#123;</span><br><span class="line">            <span class="keyword">new</span> DataWrap(<span class="number">21</span> , <span class="string">""</span>),</span><br><span class="line">            <span class="keyword">new</span> DataWrap(<span class="number">30</span> , <span class="string">""</span>),</span><br><span class="line">            <span class="keyword">new</span> DataWrap(<span class="number">49</span> , <span class="string">""</span>),</span><br><span class="line">            <span class="keyword">new</span> DataWrap(<span class="number">30</span> , <span class="string">"*"</span>),</span><br><span class="line">            <span class="keyword">new</span> DataWrap(<span class="number">21</span> , <span class="string">"*"</span>),</span><br><span class="line">            <span class="keyword">new</span> DataWrap(<span class="number">16</span> , <span class="string">""</span>),</span><br><span class="line">            <span class="keyword">new</span> DataWrap(<span class="number">9</span> , <span class="string">""</span>)</span><br><span class="line">        &#125;;</span><br><span class="line">        System.out.println(<span class="string">"排序之前：\n"</span></span><br><span class="line">            + java.util.Arrays.toString(data));</span><br><span class="line">        heapSort(data);</span><br><span class="line">        System.out.println(<span class="string">"排序之后：\n"</span></span><br><span class="line">            + java.util.Arrays.toString(data));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="1-2-交换排序"><a href="#1-2-交换排序" class="headerlink" title="1.2 交换排序"></a>1.2 交换排序</h2><p>交换排序的主体操作是对数组中的数据不断的进行交换操作。交换排序主要有冒泡排序和快速排序。</p>
<h3 id="1-2-1-冒泡排序"><a href="#1-2-1-冒泡排序" class="headerlink" title="1.2.1  冒泡排序"></a>1.2.1  冒泡排序</h3><p>冒泡排序思路：类似于鱼吐泡泡，一个接着一个，如果靠近鱼的泡泡比远离鱼的泡泡大，则两个泡泡就会交换。一次执行，就成了一串有序的泡泡。<br>时间效率：；空间效率：；算法是有序的；</p>
 <figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> sort;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BubbleSort</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">bubbleSort</span><span class="params">(DataWrap[] data)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"开始排序"</span>);</span><br><span class="line">        <span class="keyword">int</span> arrayLength=data.length;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;arrayLength-<span class="number">1</span>;i++) &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;arrayLength-<span class="number">1</span>-i;j++) &#123;</span><br><span class="line">                <span class="keyword">if</span>(data[j].compareTo(data[j+<span class="number">1</span>])&gt;<span class="number">0</span>) &#123;</span><br><span class="line">                    DataWrap tmp=data[j+<span class="number">1</span>];</span><br><span class="line">                    data[j+<span class="number">1</span>]=data[j];</span><br><span class="line">                    data[j]=tmp;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            System.out.println(java.util.Arrays.toString(data));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        DataWrap[] data = &#123; <span class="keyword">new</span> DataWrap(<span class="number">9</span>, <span class="string">""</span>), <span class="keyword">new</span> DataWrap(<span class="number">16</span>, <span class="string">""</span>), <span class="keyword">new</span> DataWrap(<span class="number">21</span>, <span class="string">"*"</span>), <span class="keyword">new</span> DataWrap(<span class="number">23</span>, <span class="string">""</span>),</span><br><span class="line">                <span class="keyword">new</span> DataWrap(<span class="number">30</span>, <span class="string">""</span>), <span class="keyword">new</span> DataWrap(<span class="number">49</span>, <span class="string">""</span>), <span class="keyword">new</span> DataWrap(<span class="number">21</span>, <span class="string">""</span>), <span class="keyword">new</span> DataWrap(<span class="number">30</span>, <span class="string">"*"</span>) &#125;;</span><br><span class="line">        System.out.println(<span class="string">"排序之前：\n"</span> + java.util.Arrays.toString(data));</span><br><span class="line">        bubbleSort(data);</span><br><span class="line">        System.out.println(<span class="string">"排序之后：\n"</span> + java.util.Arrays.toString(data));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="1-2-2-快速排序"><a href="#1-2-2-快速排序" class="headerlink" title="1.2.2 快速排序"></a>1.2.2 快速排序</h3><p>快速排序的思路：如列队一样，先选择一个士兵为基准，比该士兵高则站在其后面，比该士兵矮则站在其前面，这样大致将队伍分为了两个子列。然后在这两个子进行递归。<br>空间效率：，算法并不稳定。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> sort;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QuickSort</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">// 将指定数组的i和j索引处的元素交换</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">swap</span><span class="params">(DataWrap[] data, <span class="keyword">int</span> i, <span class="keyword">int</span> j)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        DataWrap tmp;</span><br><span class="line">        tmp = data[i];</span><br><span class="line">        data[i] = data[j];</span><br><span class="line">        data[j] = tmp;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 对data数组中从start～end索引范围的子序列进行处理</span></span><br><span class="line">    <span class="comment">// 使之满足所有小于分界值的放在左边，所有大于分界值的放在右边</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">subSort</span><span class="params">(DataWrap[] data</span></span></span><br><span class="line"><span class="function"><span class="params">        , <span class="keyword">int</span> start , <span class="keyword">int</span> end)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 需要排序</span></span><br><span class="line">        <span class="keyword">if</span> (start &lt; end)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 以第一个元素作为分界值</span></span><br><span class="line">            DataWrap base = data[start];</span><br><span class="line">            <span class="comment">// i从左边搜索，搜索大于分界值的元素的索引</span></span><br><span class="line">            <span class="keyword">int</span> i = start;</span><br><span class="line">            <span class="comment">// j从右边开始搜索，搜索小于分界值的元素的索引</span></span><br><span class="line">            <span class="keyword">int</span> j = end + <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">while</span>(<span class="keyword">true</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 找到大于分界值的元素的索引，或i已经到了end处</span></span><br><span class="line">                <span class="keyword">while</span>(i &lt; end &amp;&amp; data[++i].compareTo(base) &lt;= <span class="number">0</span>);</span><br><span class="line">                <span class="comment">// 找到小于分界值的元素的索引，或j已经到了start处</span></span><br><span class="line">                <span class="keyword">while</span>(j &gt; start &amp;&amp; data[--j].compareTo(base) &gt;= <span class="number">0</span>);</span><br><span class="line">                <span class="keyword">if</span> (i &lt; j)</span><br><span class="line">                &#123;</span><br><span class="line">                    swap(data , i , j);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            swap(data , start , j);</span><br><span class="line">            <span class="comment">// 递归左子序列</span></span><br><span class="line">            subSort(data , start , j - <span class="number">1</span>);</span><br><span class="line">            <span class="comment">// 递归右边子序列</span></span><br><span class="line">            subSort(data , j + <span class="number">1</span>, end);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">quickSort</span><span class="params">(DataWrap[] data)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        subSort(data , <span class="number">0</span> , data.length - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        DataWrap[] data = &#123;</span><br><span class="line">            <span class="keyword">new</span> DataWrap(<span class="number">9</span> , <span class="string">""</span>),</span><br><span class="line">            <span class="keyword">new</span> DataWrap(-<span class="number">16</span> , <span class="string">""</span>),</span><br><span class="line">            <span class="keyword">new</span> DataWrap(<span class="number">21</span> , <span class="string">"*"</span>),</span><br><span class="line">            <span class="keyword">new</span> DataWrap(<span class="number">23</span> , <span class="string">""</span>),</span><br><span class="line">            <span class="keyword">new</span> DataWrap(-<span class="number">30</span> , <span class="string">""</span>),</span><br><span class="line">            <span class="keyword">new</span> DataWrap(-<span class="number">49</span> , <span class="string">""</span>),</span><br><span class="line">            <span class="keyword">new</span> DataWrap(<span class="number">21</span> , <span class="string">""</span>),</span><br><span class="line">            <span class="keyword">new</span> DataWrap(<span class="number">30</span> , <span class="string">"*"</span>),</span><br><span class="line">            <span class="keyword">new</span> DataWrap(<span class="number">13</span> , <span class="string">"*"</span>)</span><br><span class="line">        &#125;;</span><br><span class="line">        System.out.println(<span class="string">"排序之前：\n"</span></span><br><span class="line">            + java.util.Arrays.toString(data));</span><br><span class="line">        quickSort(data);</span><br><span class="line">        System.out.println(<span class="string">"排序之后：\n"</span></span><br><span class="line">            + java.util.Arrays.toString(data));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="1-3-插入排序"><a href="#1-3-插入排序" class="headerlink" title="1.3 插入排序"></a>1.3 插入排序</h2><p>插入排序主要分为直接插入排序、Shell排序和折半排序。</p>
<h3 id="1-3-1-直接插入排序"><a href="#1-3-1-直接插入排序" class="headerlink" title="1.3.1 直接插入排序"></a>1.3.1 直接插入排序</h3><p>直接插入排序思路：类似于把一堆杂乱的且大小不一的碗按从大到小（从小到大不符合实际）排序。我可以先拿出一个碗，然后在拿出碗与之比较；这两个碗排好序后，再拿出一个碗进行比较，插在其合适的顺序上，以此方式直至最后一个碗位置。<br>最坏情况的时间复杂度：；空间复杂度：；该算法是稳定的。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> sort;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">insertSort</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">insertSort</span><span class="params">(DataWrap[] data)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"开始排序"</span>);</span><br><span class="line">        <span class="keyword">int</span> arrayLenght=data.length;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;arrayLenght;i++) &#123;</span><br><span class="line">            DataWrap tmp=data[i];</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span>(data[i].compareTo(data[i-<span class="number">1</span>])&lt;<span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">int</span> j=i-<span class="number">1</span>;</span><br><span class="line">                <span class="keyword">for</span>(;j&gt;=<span class="number">0</span>&amp;&amp;data[j].compareTo(tmp)&gt;<span class="number">0</span>;j--) &#123;</span><br><span class="line">                    data[j+<span class="number">1</span>]=data[j];</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                data[j+<span class="number">1</span>]=tmp;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(java.util.Arrays.toString(data));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        DataWrap[] data = &#123;</span><br><span class="line">            <span class="keyword">new</span> DataWrap(<span class="number">9</span> , <span class="string">""</span>),</span><br><span class="line">            <span class="keyword">new</span> DataWrap(-<span class="number">16</span> , <span class="string">""</span>),</span><br><span class="line">            <span class="keyword">new</span> DataWrap(<span class="number">21</span> , <span class="string">"*"</span>),</span><br><span class="line">            <span class="keyword">new</span> DataWrap(<span class="number">23</span> , <span class="string">""</span>),</span><br><span class="line">            <span class="keyword">new</span> DataWrap(-<span class="number">30</span> , <span class="string">""</span>),</span><br><span class="line">            <span class="keyword">new</span> DataWrap(-<span class="number">49</span> , <span class="string">""</span>),</span><br><span class="line">            <span class="keyword">new</span> DataWrap(<span class="number">21</span> , <span class="string">""</span>),</span><br><span class="line">            <span class="keyword">new</span> DataWrap(<span class="number">30</span> , <span class="string">"*"</span>),</span><br><span class="line">            <span class="keyword">new</span> DataWrap(<span class="number">13</span> , <span class="string">"*"</span>)</span><br><span class="line">        &#125;;</span><br><span class="line">        System.out.println(<span class="string">"排序之前：\n"</span></span><br><span class="line">            + java.util.Arrays.toString(data));</span><br><span class="line">        insertSort(data);</span><br><span class="line">        System.out.println(<span class="string">"排序之后：\n"</span></span><br><span class="line">            + java.util.Arrays.toString(data));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-3-2-折半插入排序"><a href="#1-3-2-折半插入排序" class="headerlink" title="1.3.2 折半插入排序"></a>1.3.2 折半插入排序</h3><p>思路：与二分法有点相似。因为之前的数据是排好序的，因此为了减少比较次数，可以选择之前数据的中点与要插入的数据进行比较。我们拿到一个碗，把它插在已经排好的碗中时，可以先看中间的碗，如果中间的碗比插入的碗大，在进行二分即可。<br>算法可能不稳定；</p>
 <figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> sort;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BinaryInsertSort</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">binaryInsertSort</span><span class="params">(DataWrap[] data)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"开始排序：\n"</span>);</span><br><span class="line">        <span class="keyword">int</span> arrayLength = data.length;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">1</span> ; i &lt; arrayLength ; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 当整体后移时，保证data[i]的值不会丢失</span></span><br><span class="line">            DataWrap tmp = data[i];</span><br><span class="line">            <span class="keyword">int</span> low = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">int</span> high = i - <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">while</span>(low &lt;= high)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 找出low、high中间的索引</span></span><br><span class="line">                <span class="keyword">int</span> mid = (low + high) / <span class="number">2</span>;</span><br><span class="line">                <span class="comment">// 如果tmp值大于low、high中间元素的值</span></span><br><span class="line">                <span class="keyword">if</span>(tmp.compareTo(data[mid]) &gt; <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 限制在索引大于mid的那一半中搜索</span></span><br><span class="line">                    low = mid + <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 限制在索引小于mid的那一半中搜索</span></span><br><span class="line">                    high = mid - <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 将low到i处的所有元素向后整体移一位</span></span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j = i ; j &gt; low ; j--)</span><br><span class="line">            &#123;</span><br><span class="line">                data[j] = data[j - <span class="number">1</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 最后将tmp的值插入合适位置</span></span><br><span class="line">            data[low] = tmp;</span><br><span class="line">            System.out.println(java.util.Arrays.toString(data));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        DataWrap[] data = &#123;</span><br><span class="line">            <span class="keyword">new</span> DataWrap(<span class="number">9</span> , <span class="string">""</span>),</span><br><span class="line">            <span class="keyword">new</span> DataWrap(-<span class="number">16</span> , <span class="string">""</span>),</span><br><span class="line">            <span class="keyword">new</span> DataWrap(<span class="number">21</span> , <span class="string">"*"</span>),</span><br><span class="line">            <span class="keyword">new</span> DataWrap(<span class="number">23</span> , <span class="string">""</span>),</span><br><span class="line">            <span class="keyword">new</span> DataWrap(-<span class="number">30</span> , <span class="string">""</span>),</span><br><span class="line">            <span class="keyword">new</span> DataWrap(-<span class="number">49</span> , <span class="string">""</span>),</span><br><span class="line">            <span class="keyword">new</span> DataWrap(<span class="number">21</span> , <span class="string">""</span>),</span><br><span class="line">            <span class="keyword">new</span> DataWrap(<span class="number">30</span> , <span class="string">"*"</span>),</span><br><span class="line">            <span class="keyword">new</span> DataWrap(<span class="number">30</span> , <span class="string">""</span>)</span><br><span class="line">        &#125;;</span><br><span class="line">        System.out.println(<span class="string">"排序之前：\n"</span></span><br><span class="line">            + java.util.Arrays.toString(data));</span><br><span class="line">        binaryInsertSort(data);</span><br><span class="line">        System.out.println(<span class="string">"排序之后：\n"</span></span><br><span class="line">            + java.util.Arrays.toString(data));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-3-3-希尔排序"><a href="#1-3-3-希尔排序" class="headerlink" title="1.3.3 希尔排序"></a>1.3.3 希尔排序</h3><p>Shell排序方法思路:以一个较为合适的步长h，让数据中相差为h的步数进行排序；让后将步长改为h/2,在进行排序；递归下去，直至h=1。（当h=1是，可以认为此时的希尔排序算法就是直接插入排序算法）。对于直接插入算法来说，如果原始数据大部分是有序的，数据的移动操作就会较少。利用希尔排序算法就是把原始数据做到基本有序，有效的减少数据移动的操作。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShellSort</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">shellSort</span><span class="params">(DataWrap[] data)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"开始排序："</span>);</span><br><span class="line">        <span class="keyword">int</span> arrayLength = data.length;</span><br><span class="line">        <span class="comment">// h变量保存可变增量</span></span><br><span class="line">        <span class="keyword">int</span> h = <span class="number">1</span>;</span><br><span class="line">        <span class="comment">// 按h * 3 + 1得到增量序列的最大值</span></span><br><span class="line">        <span class="keyword">while</span>(h &lt;= arrayLength / <span class="number">3</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            h = h * <span class="number">3</span> + <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span>(h &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            System.out.println(<span class="string">"===h的值:"</span> + h + <span class="string">"==="</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = h ; i &lt; arrayLength ; i++ )</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 当整体后移时，保证data[i]的值不会丢失</span></span><br><span class="line">                DataWrap tmp = data[i];</span><br><span class="line">                <span class="comment">// i索引处的值已经比前面所有值都大，表明已经有序，无需插入</span></span><br><span class="line">                <span class="comment">// （i-1索引之前的数据已经有序的，i-1索引处元素的值就是最大值）</span></span><br><span class="line">                <span class="keyword">if</span> (data[i].compareTo(data[i - h]) &lt; <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">int</span> j = i - h;</span><br><span class="line">                    <span class="comment">// 整体后移h格</span></span><br><span class="line">                    <span class="keyword">for</span> ( ; j &gt;= <span class="number">0</span> &amp;&amp; data[j].compareTo(tmp) &gt; <span class="number">0</span> ; j-=h)</span><br><span class="line">                    &#123;</span><br><span class="line">                        data[j + h] = data[j];</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 最后将tmp的值插入合适位置</span></span><br><span class="line">                    data[j + h] = tmp;</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(java.util.Arrays.toString(data));</span><br><span class="line">            &#125;</span><br><span class="line">            h = (h - <span class="number">1</span>) / <span class="number">3</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        DataWrap[] data = &#123;</span><br><span class="line">            <span class="keyword">new</span> DataWrap(<span class="number">9</span> , <span class="string">""</span>),</span><br><span class="line">            <span class="keyword">new</span> DataWrap(-<span class="number">16</span> , <span class="string">""</span>),</span><br><span class="line">            <span class="keyword">new</span> DataWrap(<span class="number">21</span> , <span class="string">"*"</span>),</span><br><span class="line">            <span class="keyword">new</span> DataWrap(<span class="number">23</span> , <span class="string">""</span>),</span><br><span class="line">            <span class="keyword">new</span> DataWrap(-<span class="number">30</span> , <span class="string">""</span>),</span><br><span class="line">            <span class="keyword">new</span> DataWrap(-<span class="number">49</span> , <span class="string">""</span>),</span><br><span class="line">            <span class="keyword">new</span> DataWrap(<span class="number">21</span> , <span class="string">""</span>),</span><br><span class="line">            <span class="keyword">new</span> DataWrap(<span class="number">30</span> , <span class="string">"*"</span>),</span><br><span class="line">            <span class="keyword">new</span> DataWrap(<span class="number">30</span> , <span class="string">""</span>),</span><br><span class="line">        &#125;;</span><br><span class="line">        System.out.println(<span class="string">"排序之前：\n"</span></span><br><span class="line">            + java.util.Arrays.toString(data));</span><br><span class="line">        shellSort(data);</span><br><span class="line">        System.out.println(<span class="string">"排序之后：\n"</span></span><br><span class="line">            + java.util.Arrays.toString(data));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="1-4-归并排序"><a href="#1-4-归并排序" class="headerlink" title="1.4 归并排序"></a>1.4 归并排序</h2><p>归并排序基本思想：就是将两个有序的序列合成一个新的有序序列。其时间效率为，需要一个与原始序列同样大的辅助序列，因此空间效率较差。算法是稳定的。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DataWrap</span> <span class="keyword">implements</span> <span class="title">Comparable</span>&lt;<span class="title">DataWrap</span>&gt;</span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> data;</span><br><span class="line">    String flag;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DataWrap</span><span class="params">(<span class="keyword">int</span> data, String flag)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.data = data;</span><br><span class="line">        <span class="keyword">this</span>.flag = flag;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> data + flag;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 根据data实例变量来决定两个DataWrap的大小</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(DataWrap dw)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.data &gt; dw.data ? <span class="number">1</span></span><br><span class="line">            : (<span class="keyword">this</span>.data == dw.data ? <span class="number">0</span> : -<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MergeSort</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">// 利用归并排序算法对数组data进行排序</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">mergeSort</span><span class="params">(DataWrap[] data)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 归并排序</span></span><br><span class="line">        sort(data , <span class="number">0</span> , data.length - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将索引从left到right范围的数组元素进行归并排序</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> data 待排序的数组</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> left 待排序的数组的第一个元素索引</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> right 待排序的数组的最后一个元素的索引</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sort</span><span class="params">(DataWrap[] data</span></span></span><br><span class="line"><span class="function"><span class="params">         , <span class="keyword">int</span> left, <span class="keyword">int</span> right)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (left &lt; right)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 找出中间索引</span></span><br><span class="line">            <span class="keyword">int</span> center = (left + right) / <span class="number">2</span>;</span><br><span class="line">            <span class="comment">// 对左边数组进行递归</span></span><br><span class="line">            sort(data, left, center);</span><br><span class="line">            <span class="comment">// 对右边数组进行递归</span></span><br><span class="line">            sort(data, center + <span class="number">1</span>, right);</span><br><span class="line">            <span class="comment">// 合并</span></span><br><span class="line">            merge(data, left, center, right);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将两个数组进行归并，归并前两个数组已经有序，归并后依然有序。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> data 数组对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> left 左数组的第一个元素的索引</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> center 左数组的最后一个元素的索引，center+1是右数组第一个元素的索引</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> right 右数组的最后一个元素的索引</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">merge</span><span class="params">(DataWrap[] data</span></span></span><br><span class="line"><span class="function"><span class="params">        , <span class="keyword">int</span> left, <span class="keyword">int</span> center, <span class="keyword">int</span> right)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 定义一个与待排序序列长度相同的临时数组</span></span><br><span class="line">        DataWrap[] tmpArr = <span class="keyword">new</span> DataWrap[data.length];</span><br><span class="line">        <span class="keyword">int</span> mid = center + <span class="number">1</span>;</span><br><span class="line">        <span class="comment">// third记录中间数组的索引</span></span><br><span class="line">        <span class="keyword">int</span> third = left;</span><br><span class="line">        <span class="keyword">int</span> tmp = left;</span><br><span class="line">        <span class="keyword">while</span> (left &lt;= center &amp;&amp; mid &lt;= right)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 从两个数组中取出小的放入中间数组</span></span><br><span class="line">            <span class="keyword">if</span> (data[left].compareTo(data[mid]) &lt;= <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                tmpArr[third++] = data[left++];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                tmpArr[third++] = data[mid++];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 剩余部分依次放入中间数组</span></span><br><span class="line">        <span class="keyword">while</span> (mid &lt;= right)</span><br><span class="line">        &#123;</span><br><span class="line">            tmpArr[third++] = data[mid++];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (left &lt;= center)</span><br><span class="line">        &#123;</span><br><span class="line">            tmpArr[third++] = data[left++];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 将中间数组中的内容复制拷回原数组</span></span><br><span class="line">        <span class="comment">// (原left～right范围的内容复制回原数组)</span></span><br><span class="line">        <span class="keyword">while</span> (tmp &lt;= right)</span><br><span class="line">        &#123;</span><br><span class="line">            data[tmp] = tmpArr[tmp++];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        DataWrap[] data = &#123;</span><br><span class="line">            <span class="keyword">new</span> DataWrap(<span class="number">9</span> , <span class="string">""</span>),</span><br><span class="line">            <span class="keyword">new</span> DataWrap(-<span class="number">16</span> , <span class="string">""</span>),</span><br><span class="line">            <span class="keyword">new</span> DataWrap(<span class="number">21</span> , <span class="string">"*"</span>),</span><br><span class="line">            <span class="keyword">new</span> DataWrap(<span class="number">23</span> , <span class="string">""</span>),</span><br><span class="line">            <span class="keyword">new</span> DataWrap(-<span class="number">30</span> , <span class="string">""</span>),</span><br><span class="line">            <span class="keyword">new</span> DataWrap(-<span class="number">49</span> , <span class="string">""</span>),</span><br><span class="line">            <span class="keyword">new</span> DataWrap(<span class="number">21</span> , <span class="string">""</span>),</span><br><span class="line">            <span class="keyword">new</span> DataWrap(<span class="number">30</span> , <span class="string">"*"</span>),</span><br><span class="line">            <span class="keyword">new</span> DataWrap(<span class="number">30</span> , <span class="string">""</span>)</span><br><span class="line">        &#125;;</span><br><span class="line">        System.out.println(<span class="string">"排序之前：\n"</span></span><br><span class="line">            + java.util.Arrays.toString(data));</span><br><span class="line">        mergeSort(data);</span><br><span class="line">        System.out.println(<span class="string">"排序之后：\n"</span></span><br><span class="line">            + java.util.Arrays.toString(data));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a href="https://www.cnblogs.com/tianliang94/p/10458888.html" target="_blank" rel="noopener">https://www.cnblogs.com/tianliang94/p/10458888.html</a></p>
]]></content>
      <categories>
        <category>算法</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>排序</tag>
      </tags>
  </entry>
  <entry>
    <title>关于本站</title>
    <url>/2020/05/01/%E5%85%B3%E4%BA%8E%E6%9C%AC%E7%AB%99/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><h1 id="关于本站"><a href="#关于本站" class="headerlink" title="关于本站"></a>关于本站</h1><blockquote>
<p>1.本网站2019年12月上线;<br/><br> 2 访问网址: <a href="https://www.zhangpeng.fun/" target="_blank" rel="noopener">https://www.zhangpeng.fun/</a><br/><br> 3.本站为个人博客网站,由本人个人维护,仅为学习所用;<br/><br> 4.网站源码并不是完全由本人开发,取自github开源项目;<br/><br> 5.本站所有文章并非全部个人原创,由本人整理发布,如有错误，请谅解;<br/><br> 6.博客中转载文章会写明来源，如果有异议，请及时联系我处理;<br/><br> 6.本网站部署在阿里云服务器,配置不高,有时加载会慢一些;<br/><br> 7.希望多多评论呦!<br/></p>
</blockquote>
<h3 id="感谢"><a href="#感谢" class="headerlink" title="感谢:"></a>感谢:</h3><p><a href="https://github.com/halo-dev/halo" target="_blank" rel="noopener">https://github.com/halo-dev/halo</a></p>
<p><a href="http://www.tedu.cn/" target="_blank" rel="noopener">http://www.tedu.cn/</a></p>
]]></content>
      <categories>
        <category>myblog</category>
      </categories>
      <tags>
        <tag>me</tag>
      </tags>
  </entry>
  <entry>
    <title>喜欢收集图片的小伙伴点进来（artstation+pixiv）</title>
    <url>/2020/04/19/%E5%96%9C%E6%AC%A2%E6%94%B6%E9%9B%86%E5%9B%BE%E7%89%87%E7%9A%84%E5%B0%8F%E4%BC%99%E4%BC%B4%E7%82%B9%E8%BF%9B%E6%9D%A5%EF%BC%88artstation+pixiv%EF%BC%89/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><p>本文介绍电脑vpn的配置，以及artstation和pixiv两个网站图片的批量下载方法。</p>
<h2 id="一、介绍"><a href="#一、介绍" class="headerlink" title="一、介绍"></a>一、介绍</h2><blockquote>
<p><strong>1.artstation</strong> &nbsp;(<a href="https://www.artstation.com/" target="_blank" rel="noopener">https://www.artstation.com/</a>)</p>
</blockquote>
<p>ArtStation是综合CG视觉艺术网站，集游戏、电影、媒体和娱乐等行业的主流艺术作品展示平台。为用户展示图片、视频、模型等CG设计作品。又名A站。<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/A%E7%AB%99%E9%A6%96%E9%A1%B5-ffef61d3b55d41b3a42f189dae333ccd.jpg" alt="A站首页"><br>这里有很多厉害的人物<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/A%E7%AB%99%E4%BA%BA%E7%89%A9%E9%A1%B5-a4432d30ec724fa7b269acd6f67c1f8b.jpg" alt="A站人物页"></p>
<blockquote>
<p><strong>2.pixiv</strong>&nbsp;(<a href="https://www.pixiv.net/" target="_blank" rel="noopener">https://www.pixiv.net/</a>)</p>
</blockquote>
<p>Pixiv，是一个主要由日本艺术家所组成的虚拟社群，主体为由pixiv股份制有限公司所运营的为插画艺术特化的社交网络服务网站。新兴的日本同人画、插画作品分享站点。采用了web2.0的方式，每个参与者都有自己的主页并可以对作品评价打分。又名P站。<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/P%E7%AB%99%E9%A6%96%E9%A1%B5-d9c797907a4043e2a4eb28e84942b1d2.jpg" alt="P站首页"><br>这里也有很多的厉害的人物啦<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/P%E7%AB%99%E4%BA%BA%E7%89%A9%E9%A1%B5-9fd95bc7c09141b38c6ca9faced68e7c.jpg" alt="P站人物页"></p>
<h2 id="二、翻墙"><a href="#二、翻墙" class="headerlink" title="二、翻墙"></a>二、翻墙</h2><p>有的小伙伴可能已经发现了，网站进不去，需要翻墙怎么办？</p>
<blockquote>
<p>1.自己搭建，购买vps（谷歌云、搬瓦工等）+安装V2Ray+客户端配置，这种方法较复杂，我也不是用的这种方法，所以这里就不多介绍了。有时间自己买个vps玩一下，再写一篇详细的教程。</p>
</blockquote>
<blockquote>
<p>2.插件</p>
</blockquote>
<p>1）谷歌商店插件<br>首先安装Google Helper谷歌上网助手<br>可以让你访问 Google、Gmail 等，装了它你就可以自由的使用 Chrome 应用商店了。<br>插件地址：<a href="http://googlehelper.net/" target="_blank" rel="noopener">http://googlehelper.net/</a><br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/image-aa5e4a92747040f49df8fe0ffc25f288.png" alt="image"><br>然后谷歌商店里搜索vpn插件<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/%E8%B0%B7%E6%AD%8C%E5%95%86%E5%BA%97-e484f97436304d69ae29695b9aaaff77.png" alt="谷歌商店"></p>
<p>几款vpn插件推荐：Astar VPN；1clickVPN；Free VPN；uVPN；VeeVPN。<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/vpn%E6%8E%A8%E8%8D%90-2bf36976c02d4fd0b9dbe14de3b4c22f.png" alt="vpn推荐"><br>哪个速度快，那就需要大家自己慢慢尝试了，尝试换换不同的插件，或者不同的节点。vpn插件同时只能开一个才有效果呦。<br>当然，有了vpn后，我们就不仅仅可以上这两个网站了，可以访问youtube、facebook等。<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/youtobe%E9%A6%96%E9%A1%B5-fee29d383eac4fbf8ea2c3cb025592bb.jpg" alt="youtobe首页"><br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/facebook-5078df600eae4b67b8a48513449825c9.jpg" alt="facebook"></p>
<h2 id="三、图片下载"><a href="#三、图片下载" class="headerlink" title="三、图片下载"></a>三、图片下载</h2><p>应该有很多喜欢收集图片的小伙伴，如果我想下载A站和P站的图片，总不能一个一个点进去下载吧。下面介绍这两个网站批量下载图片的方法。</p>
<blockquote>
<p><strong>1.artstation</strong></p>
</blockquote>
<p>1）下载豆皮图片下载器<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/%E8%B1%86%E7%9A%AE%E4%B8%8B%E8%BD%BD%E5%99%A8-5c32c82d8a5c45bc981b574d5c75b6e4.png" alt="豆皮下载器"></p>
<p>2）复制artstation上某位作家的地址<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/A%E7%AB%99a-1f1eba64b83f4b06bc99f3ae1b7c774f.jpg" alt="A站a"></p>
<p>3）复制到豆皮下载器开始下载<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/%E8%B1%86%E7%9A%AE-9d78aeadced84b36aeb70d10482af8fd.jpg" alt="豆皮"></p>
<blockquote>
<p><strong>2.pixiv</strong></p>
</blockquote>
<p>谷歌应用商店搜索pixiv批量下载插件<br>1）推荐：<a href="https://chrome.google.com/webstore/detail/powerful-pixiv-downloader/dkndmhgdcmjdmkdonmbgjpijejdcilfh" target="_blank" rel="noopener">Powerful Pixiv Downloader</a><br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/pdownloder-9008b652a6224d93a7b922360f172993.png" alt="pdownloder"></p>
<p>1）插件安装后会发现p站画家页面会多出来一个图标点击。<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/p%E7%AB%99%E4%B8%8B%E8%BD%BD1-e7efada15cae4a35bbd5f5a7f845f686.jpg" alt="p站下载1"></p>
<p>2）第一种方法：直接配置-抓取-下载（浏览器下载）<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/P%E7%AB%99%E4%B8%8B%E8%BD%BD3-9db5c38530664bd7bfff89ce33c67b65.jpg" alt="P站下载3"></p>
<p>3）第二种方法：复制url到第三方下载（我用的是idm）<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/%E5%A4%8D%E5%88%B6url-2f3657f38045494280048b6ecc6d75ba.jpg" alt="复制url"><br>任务-剪贴板添加-选择文件-选择位置-确定<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/p%E7%AB%99%E4%B8%8B%E8%BD%BDidm-31506abb01db485aabf4af049c8e4803.jpg" alt="p站下载idm"></p>
<p>这样图片就会批量下载好了，怎么样，是不是很简单。<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/%E6%96%87%E4%BB%B6%E5%A4%B9-452ea4b79b8441a98e9fb20aceb9efbe.png" alt="文件夹"><br>小伙伴们赶快行动起来吧！</p>
]]></content>
      <categories>
        <category>分享</category>
      </categories>
      <tags>
        <tag>pixiv</tag>
        <tag>artstation</tag>
      </tags>
  </entry>
  <entry>
    <title>分布式锁</title>
    <url>/2020/04/04/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><h1 id="分布式锁"><a href="#分布式锁" class="headerlink" title="分布式锁"></a>分布式锁</h1><h2 id="1-什么是分布式锁？"><a href="#1-什么是分布式锁？" class="headerlink" title="1.什么是分布式锁？"></a>1.什么是分布式锁？</h2><p>&emsp;&emsp;分布式锁是控制分布式系统之间同步访问共享资源的一种方式。在分布式系统中，常常需要协调他们的动作。如果不同的系统或是同一个系统的不同主机之间共享了一个或一组资源，那么访问这些资源的时候，往往需要互斥来防止彼此干扰来保证一致性，在这种情况下，便需要使用到分布式锁。<br/><br>&emsp;&emsp;在分布式系统中，常常需要协调他们的动作。如果不同的系统或是同一个系统的不同主机之间共享了一个或一组资源，那么访问这些资源的时候，往往需要互斥来防止彼此干扰来保证一致性，这个时候，便需要使用到分布式锁。</p>
<h2 id="2-为什么要使用分布式锁"><a href="#2-为什么要使用分布式锁" class="headerlink" title="2.为什么要使用分布式锁"></a>2.为什么要使用分布式锁</h2><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/20191210_18202437.png" alt=""></p>
<ul>
<li>成员变量 A 存在 JVM1、JVM2、JVM3 三个 JVM 内存中<br/></li>
<li>成员变量 A 同时都会在 JVM 分配一块内存，三个请求发过来同时对这个变量操作，显然结果是不对的<br/></li>
<li>不是同时发过来，三个请求分别操作三个不同 JVM 内存区域的数据，变量 A 之间不存在共享，也不具有可见性，处理的结果也是不对的<br/><br>注：该成员变量 A 是一个有状态的对象<br/><br>&emsp;&emsp;如果我们业务中确实存在这个场景的话，我们就需要一种方法解决这个问题，这就是分布式锁要解决的问题<br/></li>
</ul>
<p>分布式锁的具体实现方案有如下三种：</p>
<ol>
<li>基于数据库实现；</li>
<li>基于缓存（Redis等）实现；</li>
<li>基于Zookeeper实现；</li>
</ol>
<h2 id="3-基于数据库实现"><a href="#3-基于数据库实现" class="headerlink" title="3.基于数据库实现"></a>3.基于数据库实现</h2><ul>
<li><p>锁设计:数据库中的表有主键,主键不能重复,如果插入一个重复的主键.,则数据库必然报错.</p>
</li>
<li><p>数据库加锁: 向主键添加一个固定值 1;</p>
</li>
<li><p>数据库解锁: 从表中删除主键固定值1;</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jt.lock;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.Condition;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.Lock;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.jt.mapper.MysqlMapper;</span><br><span class="line"><span class="meta">@Service</span>(<span class="string">"mysqlLock"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MysqlLock</span> <span class="keyword">implements</span> <span class="title">Lock</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> MysqlMapper mapper;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//表示尝试加锁</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">tryLock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			mapper.insert();  <span class="comment">//向数据库中插入记录 定值</span></span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;	 <span class="comment">//加锁失败</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;		 <span class="comment">//加锁成功!!!</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//表示加锁机制</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(tryLock()) &#123;</span><br><span class="line">			<span class="comment">//表示加锁成功</span></span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Thread.sleep(<span class="number">100</span>);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">			<span class="comment">// TODO Auto-generated catch block</span></span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		lock();</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unlock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		</span><br><span class="line">		mapper.delete();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lockInterruptibly</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">tryLock</span><span class="params">(<span class="keyword">long</span> time, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Condition <span class="title">newCondition</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.Lock;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.ReentrantLock;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"></span><br><span class="line"><span class="comment">//模拟窗口卖票业务</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@RunWith</span>(SpringRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">MysqlLockTest</span></span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> num = <span class="number">100</span>;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="meta">@Qualifier</span>(<span class="string">"mysqlLock"</span>)</span><br><span class="line">	<span class="keyword">private</span> Lock lock;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">window</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">		<span class="comment">//定义线程卖票操作</span></span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			<span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					lock.lock();</span><br><span class="line">					<span class="keyword">if</span>(num&gt;<span class="number">0</span>) &#123;</span><br><span class="line">						System.out.println(Thread.currentThread().getName()+<span class="string">"卖出第"</span>+(<span class="number">101</span>-num)+<span class="string">"张票"</span>);</span><br><span class="line">						num--;</span><br><span class="line">						Thread.sleep(<span class="number">100</span>);</span><br><span class="line">					&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">						<span class="keyword">break</span>;<span class="comment">//跳出循环</span></span><br><span class="line">					&#125;</span><br><span class="line">					</span><br><span class="line">				&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">					lock.unlock();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test01</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		Runnable window = <span class="keyword">new</span> window();</span><br><span class="line">		Thread thread1 = <span class="keyword">new</span> Thread(window, <span class="string">"窗口A"</span>);</span><br><span class="line">		Thread thread2 = <span class="keyword">new</span> Thread(window, <span class="string">"窗口B"</span>);</span><br><span class="line">		Thread thread3 = <span class="keyword">new</span> Thread(window, <span class="string">"窗口C"</span>);</span><br><span class="line">		thread1.start();</span><br><span class="line">		thread2.start();</span><br><span class="line">		thread3.start();</span><br><span class="line">		<span class="keyword">for</span>(;;); <span class="comment">//防止线程提前结束</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-基于redis实现"><a href="#4-基于redis实现" class="headerlink" title="4.基于redis实现"></a>4.基于redis实现</h2><p>Redis锁的设计理念:</p>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/20191210_18290981.png" alt=""></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jt.lock;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.Condition;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.Lock;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.jt.mapper.MysqlMapper;</span><br><span class="line"><span class="keyword">import</span> com.jt.stream.LuaStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.JedisCluster;</span><br><span class="line"><span class="meta">@Component</span>(<span class="string">"redisLock"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisLock</span> <span class="keyword">implements</span> <span class="title">Lock</span></span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> JedisCluster jedisCluster;</span><br><span class="line">	<span class="keyword">private</span> ThreadLocal&lt;String&gt; thread = <span class="keyword">new</span> ThreadLocal&lt;&gt;();</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String key = <span class="string">"JT_LOCK"</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//表示尝试加锁</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">tryLock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			String value = UUID.randomUUID().toString();</span><br><span class="line">			String result = jedisCluster.set(key, value, <span class="string">"NX"</span>, <span class="string">"PX"</span>, <span class="number">800</span>);</span><br><span class="line">			<span class="keyword">if</span>(result.equalsIgnoreCase(<span class="string">"ok"</span>)) &#123;</span><br><span class="line">				thread.set(value);</span><br><span class="line">				<span class="keyword">return</span> <span class="keyword">true</span>;	<span class="comment">//加锁成功!!!</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;		<span class="comment">//加锁失败</span></span><br><span class="line">		&#125;	</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;			<span class="comment">//加锁失败</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//表示加锁机制</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(tryLock()) &#123;</span><br><span class="line">			<span class="comment">//表示加锁成功</span></span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Thread.sleep(<span class="number">10</span>);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		lock();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unlock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		String	uuid = thread.get();</span><br><span class="line">		<span class="comment">//所以使用lua脚本实现.保证数据的原子性操作</span></span><br><span class="line">		String script = LuaStream.getLuaFileString();</span><br><span class="line">		jedisCluster.eval(script, Arrays.asList(key), Arrays.asList(uuid));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lockInterruptibly</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">tryLock</span><span class="params">(<span class="keyword">long</span> time, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Condition <span class="title">newCondition</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>lua脚本</p>
<pre><code>if redis.call(&quot;get&quot;,KEYS[1]) == ARGV[1] then
    return redis.call(&quot;del&quot;,KEYS[1])
else
    return 0
end</code></pre><p>测试类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.Lock;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.ReentrantLock;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.jt.thread.ThreadPool;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.JedisCluster;</span><br><span class="line"></span><br><span class="line"><span class="comment">//模拟窗口卖票业务</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@RunWith</span>(SpringRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">RedislLockTest</span></span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> num = <span class="number">5000</span>; <span class="comment">//模拟5000张火车票</span></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="meta">@Qualifier</span>(<span class="string">"redisLock"</span>)</span><br><span class="line">	<span class="keyword">private</span> Lock lock;</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> JedisCluster jedisCluster;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">window</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">		<span class="comment">//定义线程卖票操作</span></span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			<span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</span><br><span class="line">				lock.lock(); <span class="comment">//加锁</span></span><br><span class="line">					<span class="keyword">if</span>(num&gt;<span class="number">0</span>) &#123;</span><br><span class="line">						System.out.println(Thread.currentThread().getName()+<span class="string">"售出第"</span>+(<span class="number">5001</span>-num)+<span class="string">"张票"</span>);</span><br><span class="line">						String ticket = jedisCluster.hget(<span class="string">"windows"</span>,Thread.currentThread().getName());</span><br><span class="line">						jedisCluster.hset(<span class="string">"windows"</span>,Thread.currentThread().getName(), ticket+<span class="string">","</span>+(<span class="number">5001</span>-num));</span><br><span class="line">						num--;</span><br><span class="line">					&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">						<span class="keyword">break</span>;<span class="comment">//跳出循环</span></span><br><span class="line">					&#125;</span><br><span class="line">				lock.unlock(); <span class="comment">//解锁</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test01</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		Runnable window = <span class="keyword">new</span> window();</span><br><span class="line">		<span class="comment">//定义线程池 初始化10个线程</span></span><br><span class="line">		List&lt;Thread&gt; pools = ThreadPool.initPool(window,<span class="number">6</span>);</span><br><span class="line">		<span class="keyword">for</span> (Thread thread : pools) &#123;</span><br><span class="line">			thread.start();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">for</span>(;;); <span class="comment">//防止线程提前结束</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-其他锁例子"><a href="#5-其他锁例子" class="headerlink" title="5.其他锁例子"></a>5.其他锁例子</h2><p>lock</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.Lock;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.ReentrantLock;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="comment">//模拟窗口卖票业务</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LockTest</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> num = <span class="number">100</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//定义lock锁</span></span><br><span class="line">	<span class="keyword">private</span> Lock lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">	</span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">Windows</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">		<span class="comment">//定义线程卖票操作</span></span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			<span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</span><br><span class="line">				lock.lock();	<span class="comment">//为线程加锁</span></span><br><span class="line">				<span class="keyword">if</span>(num&gt;<span class="number">0</span>) &#123;</span><br><span class="line">					System.out.println(<span class="string">"恭喜"</span>+Thread.currentThread().getName()+<span class="string">"售出得第"</span>+(<span class="number">101</span>-num)+<span class="string">"张票"</span>);</span><br><span class="line">					num--;</span><br><span class="line">					<span class="keyword">try</span> &#123;</span><br><span class="line">						Thread.sleep(<span class="number">50</span>);</span><br><span class="line">					&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">						e.printStackTrace();</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">					<span class="keyword">break</span>;<span class="comment">//跳出循环</span></span><br><span class="line">				&#125;</span><br><span class="line">				lock.unlock();	<span class="comment">//为线程减锁</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test01</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		Runnable runnable = <span class="keyword">new</span> Windows();</span><br><span class="line">		Thread thread1 = <span class="keyword">new</span> Thread(runnable, <span class="string">"窗口A"</span>);</span><br><span class="line">		Thread thread2 = <span class="keyword">new</span> Thread(runnable, <span class="string">"窗口B"</span>);</span><br><span class="line">		Thread thread3 = <span class="keyword">new</span> Thread(runnable, <span class="string">"窗口C"</span>);</span><br><span class="line">		thread1.start();</span><br><span class="line">		thread2.start();</span><br><span class="line">		thread3.start();</span><br><span class="line">		<span class="keyword">for</span>(;;); <span class="comment">//防止线程提前结束</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>synchronized</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="comment">//模拟窗口卖票业务</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SyncTest</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> num = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">Windows</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">		<span class="comment">//定义线程卖票操作</span></span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			<span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</span><br><span class="line">				<span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">					<span class="keyword">if</span>(num&gt;<span class="number">0</span>) &#123;</span><br><span class="line">						System.out.println(<span class="string">"恭喜"</span>+Thread.currentThread().getName()+<span class="string">"售出得第"</span>+(<span class="number">101</span>-num)+<span class="string">"张票"</span>);</span><br><span class="line">						num--;</span><br><span class="line">						<span class="keyword">try</span> &#123;</span><br><span class="line">							Thread.sleep(<span class="number">50</span>);</span><br><span class="line">						&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">							e.printStackTrace();</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">						<span class="keyword">break</span>;<span class="comment">//跳出循环</span></span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test01</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		Runnable runnable = <span class="keyword">new</span> Windows();</span><br><span class="line">		Thread thread1 = <span class="keyword">new</span> Thread(runnable, <span class="string">"窗口A"</span>);</span><br><span class="line">		Thread thread2 = <span class="keyword">new</span> Thread(runnable, <span class="string">"窗口B"</span>);</span><br><span class="line">		Thread thread3 = <span class="keyword">new</span> Thread(runnable, <span class="string">"窗口C"</span>);</span><br><span class="line">		thread1.start();</span><br><span class="line">		thread2.start();</span><br><span class="line">		thread3.start();</span><br><span class="line">		<span class="keyword">for</span>(;;); <span class="comment">//防止线程提前结束</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>thread</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.jt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="comment">//模拟窗口卖票业务</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TicketTest</span></span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">int</span> num = <span class="number">100</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">Windows</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">		<span class="comment">//定义线程卖票操作</span></span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			<span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</span><br><span class="line">				<span class="keyword">if</span>(num&gt;<span class="number">0</span>) &#123;</span><br><span class="line">					System.out.println(<span class="string">"恭喜"</span>+Thread.currentThread().getName()+<span class="string">"售出得第"</span>+(<span class="number">101</span>-num)+<span class="string">"张票"</span>);</span><br><span class="line">					num--;</span><br><span class="line">					<span class="keyword">try</span> &#123;</span><br><span class="line">						Thread.sleep(<span class="number">500</span>);</span><br><span class="line">					&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">						e.printStackTrace();</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">					<span class="keyword">break</span>;<span class="comment">//跳出循环</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//模拟三个线程同时售卖100张车票</span></span><br><span class="line">	<span class="meta">@Test</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test01</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		Runnable runnable = <span class="keyword">new</span> Windows();</span><br><span class="line">		Thread thread1 = <span class="keyword">new</span> Thread(runnable, <span class="string">"窗口A"</span>);</span><br><span class="line">		Thread thread2 = <span class="keyword">new</span> Thread(runnable, <span class="string">"窗口B"</span>);</span><br><span class="line">		Thread thread3 = <span class="keyword">new</span> Thread(runnable, <span class="string">"窗口C"</span>);</span><br><span class="line">		thread1.start();</span><br><span class="line">		thread2.start();</span><br><span class="line">		thread3.start();</span><br><span class="line">		<span class="keyword">for</span>(;;); <span class="comment">//防止线程提前结束</span></span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>后端</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>分布式</tag>
      </tags>
  </entry>
  <entry>
    <title>命令行录制工具asciinema</title>
    <url>/2020/04/22/%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%BD%95%E5%88%B6%E5%B7%A5%E5%85%B7asciinema/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><blockquote>
<p>Record and share your terminal sessions, the right way.</p>
</blockquote>
<blockquote>
<p><strong>简单录制</strong><br>在终端上记录您的工作。要开始只是运行asciinema rec，完成使用Ctrl-D或输入exit即可</p>
</blockquote>
<blockquote>
<p><strong>复制粘贴</strong><br>每当您看到要在自己的终端中尝试的命令时，只需暂停播放器并复制粘贴所需的内容即可。毕竟只是文本！</p>
</blockquote>
<blockquote>
<p><strong>嵌入</strong><br>轻松地在博客文章，项目文档页面或会议演讲幻灯片中嵌入asciicast播放器。</p>
</blockquote>
<p>官网例子：</p>
<script id="asciicast-239367" src="https://asciinema.org/a/239367.js" async></script>


<p>官网：<a href="https://asciinema.org/" target="_blank" rel="noopener">https://asciinema.org/</a><br>官方教程：<a href="https://asciinema.org/docs/how-it-works" target="_blank" rel="noopener">https://asciinema.org/docs/how-it-works</a></p>
<h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><blockquote>
<p>前提：<br>1.了解服务器相关知识<br>2.注册网站账号</p>
</blockquote>
<p>1.在linux上安装asciinema<br>我的服务器系统为centos7，下面以这个为例，不同系统请参考官方详细安装文档。<br>#安装epel发行包<br>yum -y install epel-release<br>yum -y install asciinema</p>
<p>#用命令测试版本<br>asciinema –version</p>
<p>#安装expect命令 用于交互<br>yum -y install expect<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/image-037157144b674b64bf12dffbcb3ea4cd.png" alt="image.png"><br>2. 录制</p>
<p>执行录制<br>asciinema rec test   （test为文件名，可自定义）</p>
<p>这里我先胡乱输入一些东西。<br>ctrl+d退出录屏，回车则上传录制内容到网站，ctrl+c可以保存到本地（后续也可以通过asciinema upload来上传）</p>
<p>执行播放<br>asciinema play test</p>
<p>上传asciinema upload test<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/image-f80895e02e3942c4bcd74576ebef35a1.png" alt="image.png"></p>
<ol start="3">
<li><p>打开网址或者进入网站就会发现已经有这个东西了<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/image-73db2980e9b24cab91abc27e3e428269.png" alt="image.png"></p>
</li>
<li><p>使用方法<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/image-4e9cc7e47d24405781f2f85c3e6774cf.png" alt="image.png"></p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Link</span><br><span class="line">https:&#x2F;&#x2F;asciinema.org&#x2F;a&#x2F;E9zOTdPU5eb1CoC9F8EXQdIVj</span><br><span class="line"></span><br><span class="line">Append ?t&#x3D;30 to start the playback at 30s, ?t&#x3D;3:20 to start the playback at 3m 20s.</span><br><span class="line"></span><br><span class="line">Embed image link</span><br><span class="line">Use snippets below to display a screenshot linking to this recording.</span><br><span class="line">Useful in places where scripts are not allowed (e.g. in a project&#39;s README file).</span><br><span class="line"></span><br><span class="line">HTML:</span><br><span class="line">&lt;a href&#x3D;&quot;https:&#x2F;&#x2F;asciinema.org&#x2F;a&#x2F;E9zOTdPU5eb1CoC9F8EXQdIVj&quot; target&#x3D;&quot;_blank&quot;&gt;&lt;img src&#x3D;&quot;https:&#x2F;&#x2F;asciinema.org&#x2F;a&#x2F;E9zOTdPU5eb1CoC9F8EXQdIVj.svg&quot; &#x2F;&gt;&lt;&#x2F;a&gt;</span><br><span class="line"></span><br><span class="line">Markdown:</span><br><span class="line">[![asciicast](https:&#x2F;&#x2F;asciinema.org&#x2F;a&#x2F;E9zOTdPU5eb1CoC9F8EXQdIVj.svg)](https:&#x2F;&#x2F;asciinema.org&#x2F;a&#x2F;E9zOTdPU5eb1CoC9F8EXQdIVj)</span><br><span class="line"></span><br><span class="line">Embed the player</span><br><span class="line">If you&#39;re embedding on your own page or on a site which permits script tags, you can use the full player widget:</span><br><span class="line"></span><br><span class="line">&lt;script id&#x3D;&quot;asciicast-E9zOTdPU5eb1CoC9F8EXQdIVj&quot; src&#x3D;&quot;https:&#x2F;&#x2F;asciinema.org&#x2F;a&#x2F;E9zOTdPU5eb1CoC9F8EXQdIVj.js&quot; async&gt;&lt;&#x2F;script&gt;</span><br><span class="line"></span><br><span class="line">Paste the above script tag where you want the player to be displayed on your page.</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>效果<script id="asciicast-E9zOTdPU5eb1CoC9F8EXQdIVj" src="https://asciinema.org/a/E9zOTdPU5eb1CoC9F8EXQdIVj.js" async></script>

</li>
</ol>
<p>6.结束</p>
]]></content>
      <categories>
        <category>工具</category>
      </categories>
      <tags>
        <tag>asciinema</tag>
      </tags>
  </entry>
  <entry>
    <title>小工具</title>
    <url>/2020/04/14/%E5%B0%8F%E5%B7%A5%E5%85%B7/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><p><a href="https://lovelive.tools/" target="_blank" rel="noopener">https://lovelive.tools/</a></p>
<iframe id="jjj"  src="https://lovelive.tools/" width="100%" height="700px"   frameborder="0"  name="我的博客"     scrolling="auto">   
</iframe>
<script type="text/javascript">  
document.getElementById("jjj").style.height=document.getElementById("spkj").scrollWidth*0.76+"px";
</script>]]></content>
      <categories>
        <category>工具</category>
      </categories>
  </entry>
  <entry>
    <title>我的java学习路线总结</title>
    <url>/2020/05/01/%E6%88%91%E7%9A%84java%E4%B9%8B%E8%B7%AF%E6%80%BB%E7%BB%93/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><h1 id="我的java学习路线总结"><a href="#我的java学习路线总结" class="headerlink" title="我的java学习路线总结"></a>我的java学习路线总结</h1><h3 id="一、"><a href="#一、" class="headerlink" title="一、"></a>一、</h3><ol>
<li>开发环境+HelloWorld</li>
<li>基础语法：变量+基本类型+运算符+调试</li>
<li>基础语法：异常+流程控制+分支+循环</li>
<li>基础语法：数组+二维数组+枚举+文件</li>
<li>面向对象：封装+类+对象+重载+构造</li>
<li>面向对象：继承+重写+抽象+接口+内部类</li>
<li>面向对象：多态+final+static+内部类</li>
<li>API：字符串+浮点数+日期+日志</li>
<li>API：泛型+数据结构+集合</li>
<li>知识回顾：重点知识+高级应用</li>
<li>高级：多线程+线程安全+售票</li>
<li>高级：线程锁+ThreadLocal+递归+包扫描</li>
<li>高级：注解+反射+手写jUnit</li>
<li>实战：手写Spring框架实现IoC</li>
<li>高级：手写Spring框架实现DI</li>
<li>高级：网络+爬虫Jsoup </li>
<li>高级：爬取京东</li>
<li>高级：JSON+属性文件+XML+NIO</li>
</ol>
<h3 id="二、"><a href="#二、" class="headerlink" title="二、"></a>二、</h3><ol>
<li>mysql</li>
<li>jdbc</li>
<li>html</li>
<li>css</li>
<li>js</li>
<li>jquery</li>
<li>ajax</li>
<li>tomcat</li>
<li>http</li>
<li>severlet</li>
<li>jsp el jstl</li>
<li>maven</li>
<li>cookie session</li>
<li>mybatis</li>
<li>spring</li>
<li>spring mvc</li>
<li>ssm</li>
<li>ssm 整合</li>
</ol>
<h3 id="三、"><a href="#三、" class="headerlink" title="三、"></a>三、</h3><ol>
<li>javase</li>
<li>mybatis</li>
<li>spring</li>
<li>spring mvc</li>
<li>springboot</li>
<li>aop</li>
<li>项目1：后台管理系统</li>
<li>项目2：宠物商城系统</li>
<li>vue bootstrap thymeleaf shiro</li>
</ol>
<h3 id="四、"><a href="#四、" class="headerlink" title="四、"></a>四、</h3><ol>
<li>springboot</li>
<li>easyui</li>
<li>nginx</li>
<li>linux</li>
<li>redis</li>
<li>dubbo</li>
<li>httpclient</li>
<li>zookeeper</li>
<li>quartz</li>
<li>sso</li>
<li>项目3：分布式商城系统</li>
</ol>
<h3 id="五、"><a href="#五、" class="headerlink" title="五、"></a>五、</h3><ul>
<li>springcloud 微服务 大数据 等……</li>
<li>本文仅为大致顺序,不完全区分先后;</li>
<li>不断学习,持续更新中……</li>
</ul>
]]></content>
      <categories>
        <category>myblog</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>me</tag>
      </tags>
  </entry>
  <entry>
    <title>数据结构</title>
    <url>/2020/04/03/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><h1 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h1><p>  数据结构是计算机存储、组织数据的方式。数据结构是指相互之间存在一种或多种特定关系的数据元素的集合。通常情况下，精心选择的数据结构可以带来更高的运行或者存储效率。数据结构往往同高效的检索算法和索引技术有关。</p>
<h2 id="1-1常用的数据结构编辑"><a href="#1-1常用的数据结构编辑" class="headerlink" title="1.1常用的数据结构编辑"></a>1.1常用的数据结构编辑</h2><p>  在计算机科学的发展过程中，数据结构也随之发展。程序设计中常用的数据结构包括如下几个。 [5] </p>
<h3 id="数组-Array"><a href="#数组-Array" class="headerlink" title="数组(Array)"></a>数组(Array)</h3><p>  数组是一种聚合数据类型，它是将具有相同类型的若干变量有序地组织在一起的集合。数组可以说是最基本的数据结构，在各种编程语言中都有对应。一个数组可以分解为多个数组元素，按照数据元素的类型，数组可以分为整型数组、字符型数组、浮点型数组、指针数组和结构数组等。数组还可以有一维、二维以及多维等表现形式。 [5] </p>
<h3 id="栈-Stack"><a href="#栈-Stack" class="headerlink" title="栈( Stack)"></a>栈( Stack)</h3><p>  栈是一种特殊的线性表，它只能在一个表的一个固定端进行数据结点的插入和删除操作。栈按照后进先出的原则来存储数据，也就是说，先插入的数据将被压入栈底，最后插入的数据在栈顶，读出数据时，从栈顶开始逐个读出。栈在汇编语言程序中，经常用于重要数据的现场保护。栈中没有数据时，称为空栈。 [5] </p>
<h3 id="队列-Queue"><a href="#队列-Queue" class="headerlink" title="队列(Queue)"></a>队列(Queue)</h3><p>  队列和栈类似，也是一种特殊的线性表。和栈不同的是，队列只允许在表的一端进行插入操作，而在另一端进行删除操作。一般来说，进行插入操作的一端称为队尾，进行删除操作的一端称为队头。队列中没有元素时，称为空队列。 [5] </p>
<h3 id="链表-Linked-List"><a href="#链表-Linked-List" class="headerlink" title="链表( Linked List)"></a>链表( Linked List)</h3><p>  链表是一种数据元素按照链式存储结构进行存储的数据结构，这种存储结构具有在物理上存在非连续的特点。链表由一系列数据结点构成，每个数据结点包括数据域和指针域两部分。其中，指针域保存了数据结构中下一个元素存放的地址。链表结构中数据元素的逻辑顺序是通过链表中的指针链接次序来实现的。 [5] </p>
<h3 id="树-Tree"><a href="#树-Tree" class="headerlink" title="树( Tree)"></a>树( Tree)</h3><p>  树是典型的非线性结构，它是包括，2个结点的有穷集合K。在树结构中，有且仅有一个根结点，该结点没有前驱结点。在树结构中的其他结点都有且仅有一个前驱结点，而且可以有两个后继结点，m≥0。 [5] </p>
<h3 id="图-Graph"><a href="#图-Graph" class="headerlink" title="图(Graph)"></a>图(Graph)</h3><p>  图是另一种非线性数据结构。在图结构中，数据结点一般称为顶点，而边是顶点的有序偶对。如果两个顶点之间存在一条边，那么就表示这两个顶点具有相邻关系。 [5] </p>
<h3 id="堆-Heap"><a href="#堆-Heap" class="headerlink" title="堆(Heap)"></a>堆(Heap)</h3><p>  堆是一种特殊的树形数据结构，一般讨论的堆都是二叉堆。堆的特点是根结点的值是所有结点中最小的或者最大的，并且根结点的两个子树也是一个堆结构。 [5] </p>
<h3 id="散列表-Hash"><a href="#散列表-Hash" class="headerlink" title="散列表(Hash)"></a>散列表(Hash)</h3><p>  散列表源自于散列函数(Hash function)，其思想是如果在结构中存在关键字和T相等的记录，那么必定在F(T)的存储位置可以找到该记录，这样就可以不用进行比较操作而直接取得所查记录。 [5]</p>
<h2 id="1-2常用算法编辑"><a href="#1-2常用算法编辑" class="headerlink" title="1.2常用算法编辑"></a>1.2常用算法编辑</h2><p>  数据结构研究的内容：就是如何按一定的逻辑结构，把数据组织起来，并选择适当的存储表示方法把逻辑结构组织好的数据存储到计算机的存储器里。研究的目的是为了更有效的处理数据，提高数据运算效率。数据的运算是定义在数据的逻辑结构上，但运算的具体实现要在存储结构上进行。一般有以下几种常用运算：<br><br/><br>(1)检索。检索就是在数据结构里查找满足一定条件的节点。一般是给定一个某字段的值，找具有该字段值的节点。<br><br/><br>(2)插入。往数据结构中增加新的节点。<br><br/><br>(3)删除。把指定的结点从数据结构中去掉。<br><br/><br>(4)更新。改变指定节点的一个或多个字段的值。<br><br/><br>(5)排序。把节点按某种指定的顺序重新排列。例如递增或递减。<br><br/></p>
]]></content>
      <categories>
        <category>算法</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>愿逝者安息，让全站黑白！</title>
    <url>/2020/04/17/%E6%84%BF%E9%80%9D%E8%80%85%E5%AE%89%E6%81%AF%EF%BC%8C%E8%AE%A9%E5%85%A8%E7%AB%99%E9%BB%91%E7%99%BD%EF%BC%81/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><h3 id="愿逝者安息，愿生者奋发，愿祖国昌盛！"><a href="#愿逝者安息，愿生者奋发，愿祖国昌盛！" class="headerlink" title="愿逝者安息，愿生者奋发，愿祖国昌盛！"></a>愿逝者安息，愿生者奋发，愿祖国昌盛！</h3><p>&emsp;&emsp;为表达全国各族人民对抗击新冠肺炎疫情斗争牺牲烈士和逝世同胞的深切哀悼，国务院今天发布公告，决定2020年4月4日举行全国性哀悼活动。在此期间，全国和驻外使领馆下半旗志哀，全国停止公共娱乐活动。4月4日10时起，全国人民默哀3分钟，汽车、火车、舰船鸣笛，防空警报鸣响。<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/5e873b96a3107bb6f533a554-b7dea45003c4466c829c6a40dca52589.jpeg" alt="5e873b96a3107bb6f533a554"></p>
<p>今天是2020年4月4日，全国将举行哀悼活动，为表达敬意与尊重，应将网站设置为灰度。<br>愿逝者安息，愿生者奋发，愿祖国昌盛！</p>
<p>例如：<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/image-1dc913a7557043338ce1d3edad11b5de.png" alt="image.png"></p>
<p>实现：<br>下面三种方式任选一种都可以，只需要放入html的head标签中即可实现。<br>（1）方式一</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;style type&#x3D;&quot;text&#x2F;css&quot;&gt;</span><br><span class="line">html&#123;</span><br><span class="line">     filter:progid:DXImageTransForm.Microsoft.BasicImage(grayscale&#x3D;1);-webkit-filter:saturate(0)</span><br><span class="line">&#125;</span><br><span class="line">&lt;&#x2F;style&gt;</span><br></pre></td></tr></table></figure>
<p>（2）方式二</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;style&gt;</span><br><span class="line">body&gt;*&#123;</span><br><span class="line">    filter: grayscale(100%);</span><br><span class="line">    -webkit-filter: grayscale(100%);</span><br><span class="line">    -moz-filter: grayscale(100%);</span><br><span class="line">    -ms-filter: grayscale(100%);</span><br><span class="line">    -o-filter: grayscale(100%);</span><br><span class="line">    filter: progid:DXImageTransform.Microsoft.BasicImage(grayscale&#x3D;1);</span><br><span class="line">    -webkit-filter: grayscale(1);</span><br><span class="line">&#125;</span><br><span class="line">&lt;&#x2F;style&gt;</span><br></pre></td></tr></table></figure>
<p>（3）方式三</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;style&gt; </span><br><span class="line">html &#123; </span><br><span class="line">      -webkit-filter: grayscale(100%); </span><br><span class="line">      -moz-filter: grayscale(100%); </span><br><span class="line">      -ms-filter: grayscale(100%); </span><br><span class="line">      -o-filter: grayscale(100%); </span><br><span class="line">      filter:progid:DXImageTransform.Microsoft.BasicImage(grayscale&#x3D;1);  </span><br><span class="line">      _filter:none; </span><br><span class="line"> &#125; </span><br><span class="line">&lt;&#x2F;style&gt;</span><br></pre></td></tr></table></figure>
<p>效果：<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/image-bcb9c3c4d39a4e3080235c1451d67765.png" alt="image.png"><br>赶紧行动起来吧！</p>
<p>来源：<a href="https://mp.weixin.qq.com/s/PtPy6WdltNWRiq8X0b-BeA" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/PtPy6WdltNWRiq8X0b-BeA</a></p>
]]></content>
      <categories>
        <category>前端</category>
      </categories>
      <tags>
        <tag>html</tag>
        <tag>css</tag>
      </tags>
  </entry>
  <entry>
    <title>本博客微信小程序正式上线</title>
    <url>/2020/05/01/%E6%9C%AC%E5%8D%9A%E5%AE%A2%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E6%AD%A3%E5%BC%8F%E4%B8%8A%E7%BA%BF/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><h2 id="经过一番努力，本博客微信小程序正式上线"><a href="#经过一番努力，本博客微信小程序正式上线" class="headerlink" title="经过一番努力，本博客微信小程序正式上线"></a>经过一番努力，本博客微信小程序正式上线</h2><h3 id="1-微信搜索"><a href="#1-微信搜索" class="headerlink" title="1.微信搜索"></a>1.微信搜索</h3><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/%E6%89%AB%E7%A0%81_%E6%90%9C%E7%B4%A2%E8%81%94%E5%90%88%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E6%A0%87%E5%87%86%E8%89%B2%E7%89%88-1eba896f22fd4b409edd064695228758.png" alt="扫码_搜索联合传播样式-标准色版"><br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/04/%E6%90%9C%E7%B4%A2%E6%A1%86%E4%BC%A0%E6%92%AD%E6%A0%B7%E5%BC%8F-%E7%99%BD%E8%89%B2%E7%89%88-170e1e41e25241519090fa8a932779c6.png" alt="搜索框传播样式-白色版"></p>
<h3 id="2-开发过程"><a href="#2-开发过程" class="headerlink" title="2.开发过程"></a>2.开发过程</h3><p>又掉了几根头发。。。。<br><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/03/Snipaste_2020-03-31_13-17-51-0a06443abe794b38b40d76502b774263.png" alt="Snipaste_2020-03-31_13-17-51"></p>
<p>欢迎大家来看看哟！</p>
<h2 id="3-小程序截图"><a href="#3-小程序截图" class="headerlink" title="3.小程序截图"></a>3.小程序截图</h2><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/03/Snipaste_2020-03-31_13-21-31-6cbf7ded31b1415786f4ab9aa58f7402.png" alt="Snipaste_2020-03-31_13-21-31"></p>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="https://www.zhangpeng.fun/upload/2020/03/Snipaste_2020-03-31_13-21-44-7ab41765a4e04ed2b41391486d119c29.png" alt="Snipaste_2020-03-31_13-21-44"><br>哈哈~</p>
<h2 id="4-个人博客"><a href="#4-个人博客" class="headerlink" title="4.个人博客"></a>4.个人博客</h2><p><a href="https://www.zhangpeng.fun/" target="_blank" rel="noopener">https://www.zhangpeng.fun/</a>  —-我的个人博客<br/><br><a href="mailto:zpeng_it@163.com">zpeng_it@163.com</a>   —- 我的邮箱</p>
<h2 id="5-感谢"><a href="#5-感谢" class="headerlink" title="5.感谢"></a>5.感谢</h2><p><a href="https://github.com/aquanlerou/WeHalo" target="_blank" rel="noopener">WeHalo</a></p>
]]></content>
      <categories>
        <category>myblog</category>
      </categories>
      <tags>
        <tag>小程序</tag>
      </tags>
  </entry>
  <entry>
    <title>软件工具推荐</title>
    <url>/2020/04/10/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E5%85%B7%E6%8E%A8%E8%8D%90/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><p>Windows软件推荐，全面武装你的电脑！提高工作工作学习效率，不一定是最好的，但是都是我用的，用起来非常方便，推荐给大家。</p>
<h3 id="1-安全"><a href="#1-安全" class="headerlink" title="1. 安全"></a>1. 安全</h3><p>   火绒</p>
<h3 id="2-浏览器"><a href="#2-浏览器" class="headerlink" title="2. 浏览器"></a>2. 浏览器</h3><p>   chrome<br>   火狐</p>
<h3 id="3-下载工具"><a href="#3-下载工具" class="headerlink" title="3.下载工具"></a>3.下载工具</h3><p>   迅雷<br>   XDM<br>   IDM</p>
<h3 id="4-网络存储"><a href="#4-网络存储" class="headerlink" title="4.网络存储"></a>4.网络存储</h3><p>   百度网盘<br>   金山文档</p>
<h3 id="5-社交"><a href="#5-社交" class="headerlink" title="5.社交"></a>5.社交</h3><p>   微信<br>   TIM</p>
<h3 id="6-媒体"><a href="#6-媒体" class="headerlink" title="6.媒体"></a>6.媒体</h3><p>   网易云音乐<br>   potplayer</p>
<h3 id="7-写作"><a href="#7-写作" class="headerlink" title="7.写作"></a>7.写作</h3><p>   onenote<br>   Typora<br>   印象笔记</p>
<h3 id="8-办公"><a href="#8-办公" class="headerlink" title="8.办公"></a>8.办公</h3><p>   office<br>   foxmail</p>
<h3 id="9-画图"><a href="#9-画图" class="headerlink" title="9.画图"></a>9.画图</h3><p>   Xmind</p>
<h3 id="10-远程"><a href="#10-远程" class="headerlink" title="10. 远程"></a>10. 远程</h3><p>  向日葵<br>  Timeviver</p>
<h3 id="11-工具"><a href="#11-工具" class="headerlink" title="11.工具"></a>11.工具</h3><p>  everything –文件搜索<br>  sinpaste  –屏幕截图<br>  7zip  –压缩<br>  qttabbar  –文件资源管理<br>  officeboxgong  –办公小工具合集<br>  quicklook  –文件预览<br>  chmeditor –chm帮助文档编写<br>  caesium  –图片批量压缩<br>  geek  –卸载<br>  obs  –录屏<br>  ccleaner  –清理<br>  wox  – 快捷启动+搜索<br>  pandownload  –网盘资源下载<br>  ditto  –剪贴板<br>  mydock  –桌面美化<br>  wallpaper enginer  –壁纸</p>
<h3 id="Java开发常用"><a href="#Java开发常用" class="headerlink" title="Java开发常用"></a>Java开发常用</h3><p>   eclipse<br>   sts<br>   idea<br>   postman<br>   everedit<br>   navicat<br>   filezilla<br>   Xshell<br>   HBuilder<br>   git<br>   switchhosts<br>   mysql<br>   oracle<br>   powerdesigner<br>   MarkdownPad 2<br>   vmware<br>   等。。。。。。</p>
<h3 id="我的桌面"><a href="#我的桌面" class="headerlink" title="我的桌面"></a>我的桌面</h3><p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://www.zhangpeng.fun/upload/2020/3/Snipaste_2020-03-27_02-21-40-fdff0aa862484eef8ae028177afcd42c.png" alt="Snipaste_2020-03-27_02-21-40"></p>
<p>????????</p>
]]></content>
      <categories>
        <category>工具</category>
      </categories>
      <tags>
        <tag>推荐</tag>
      </tags>
  </entry>
  <entry>
    <title>面试题目 项目</title>
    <url>/2020/04/08/%E9%9D%A2%E8%AF%95%E9%A2%98%E7%9B%AE%E9%A1%B9%E7%9B%AE/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><h1 id="面试题目-项目"><a href="#面试题目-项目" class="headerlink" title="面试题目 项目"></a>面试题目 项目</h1><h2 id="什么是Redis？"><a href="#什么是Redis？" class="headerlink" title="什么是Redis？"></a>什么是Redis？</h2><p>   Redis是一个key-value存储系统。和Memcached类似，它支持存储的value类型相对更多，包括string(字符串)、list(链表)、set(集合)、zset(sorted set –有序集合)和hash（哈希类型）。这些数据类型都支持push/pop、add/remove及取交集并集和差集及更丰富的操作，而且这些操作都是原子性的。在此基础上，redis支持各种不同方式的排序。与memcached一样，为了保证效率，数据都是缓存在内存中。区别的是redis会周期性的把更新的数据写入磁盘或者把修改操作写入追加的记录文件，并且在此基础上实现了master-slave(主从)同步。<br/><br>   Redis 是一个高性能的key-value数据库。 redis的出现，很大程度补偿了memcached这类key/value存储的不足，在部分场合可以对关系数据库起到很好的补充作用。它提供了Java，C/C++，C#，PHP，JavaScript，Perl，Object-C，Python，Ruby，Erlang等客户端，使用很方便。<br/><br>   Redis支持主从同步。数据可以从主服务器向任意数量的从服务器上同步，从服务器可以是关联其他从服务器的主服务器。这使得Redis可执行单层树复制。存盘可以有意无意的对数据进行写操作。由于完全实现了发布/订阅机制，使得从数据库在任何地方同步树时，可订阅一个频道并接收主服务器完整的消息发布记录。同步对读取操作的可扩展性和数据冗余很有帮助。<br/><br>   可以充当缓存、队列等作用。</p>
<h2 id="2-Redis两种持久化的方式的比较。"><a href="#2-Redis两种持久化的方式的比较。" class="headerlink" title="2 Redis两种持久化的方式的比较。"></a>2 Redis两种持久化的方式的比较。</h2><p>答：Redis的持久化方式有两种，AOF和RDB。<br/><br>   RDB持久化方式能够在指定的时间间隔能对你的数据进行快照存储.<br/><br>   AOF持久化方式记录每次对服务器写的操作,当服务器重启的时候会重新执行这些命令来恢复原始的数据,AOF命令以redis协议追加保存每次写的操作到文件末尾.Redis还能对AOF文件进行后台重写,使得AOF文件的体积不至于过大。<br/><br>两种区别就是，一个是持续的用日志记录写操作，crash（崩溃）后利用日志恢复；一个是平时写操作的时候不触发写，只有手动提交save命令，或者是shutdown关闭命令时，才触发备份操作。<br/><br>选择的标准，就是看系统是愿意牺牲一些性能，换取更高的缓存一致性（aof），还是愿意写操作频繁的时候，不启用备份来换取更高的性能，待手动   运行save的时候，再做备份（rdb）。rdb这个就更有些 最终一致性（eventually consistent）的意思了。<br/></p>
<h2 id="3、说说Redis哈希槽的概念？"><a href="#3、说说Redis哈希槽的概念？" class="headerlink" title="3、说说Redis哈希槽的概念？"></a>3、说说Redis哈希槽的概念？</h2><p>   Redis集群没有使用一致性hash,而是引入了哈希槽的概念，Redis集群有16384个哈希槽，每个key通过CRC16校验后对16384取模来决定放置哪个槽，集群的每个节点负责一部分hash槽。</p>
<h2 id="4、Redis集群最大节点个数是多少？"><a href="#4、Redis集群最大节点个数是多少？" class="headerlink" title="4、Redis集群最大节点个数是多少？"></a>4、Redis集群最大节点个数是多少？</h2><p>16384个</p>
<h2 id="5、Redis中的管道有什么用？"><a href="#5、Redis中的管道有什么用？" class="headerlink" title="5、Redis中的管道有什么用？"></a>5、Redis中的管道有什么用？</h2><p>   一次请求/响应服务器能实现处理新的请求即使旧的请求还未被响应。这样就可以将多个命令发送到服务器，而不用等待回复，最后在一个步骤中读取该答复。<br/><br>   这就是管道（pipelining），是一种几十年来广泛使用的技术。例如许多POP3协议已经实现支持这个功能，大大加快了从服务器下载新邮件的过程。</p>
<h2 id="6、怎么理解Redis事务？"><a href="#6、怎么理解Redis事务？" class="headerlink" title="6、怎么理解Redis事务？"></a>6、怎么理解Redis事务？</h2><p>   事务是一个单独的隔离操作：事务中的所有命令都会序列化、按顺序地执行。事务在执行的过程中，不会被其他客户端发送来的命令请求所打断。<br/><br>   事务是一个原子操作：事务中的命令要么全部被执行，要么全部都不执行。</p>
<h2 id="7、Redis事务相关的命令有哪几个？"><a href="#7、Redis事务相关的命令有哪几个？" class="headerlink" title="7、Redis事务相关的命令有哪几个？"></a>7、Redis事务相关的命令有哪几个？</h2><p>MULTI、EXEC、DISCARD、WATCH</p>
<h2 id="8、Redis如何做内存优化？"><a href="#8、Redis如何做内存优化？" class="headerlink" title="8、Redis如何做内存优化？"></a>8、Redis如何做内存优化？</h2><p>   尽可能使用散列表（hashes），散列表（是说散列表里面存储的数少）使用的内存非常小，所以你应该尽可能的将你的数据模型抽象到一个散列表里面。比如你的web系统中有一个用户对象，不要为这个用户的名称，姓氏，邮箱，密码设置单独的key,而是应该把这个用户的所有信息存储到一张散列表里面.</p>
<h2 id="9-什么是RPC？"><a href="#9-什么是RPC？" class="headerlink" title="9 什么是RPC？"></a>9 什么是RPC？</h2><p>   答案：RPC（Remote Procedure Call）—远程过程调用，它是一种通过网络从远程计算机程序上请求服务，而不需要了解底层网络技术的协议。RPC协议假定某些传输协议的存在，如TCP或UDP，为通信程序之间携带信息数据。在OSI网络通信模型中，RPC跨越了传输层和应用层。RPC使得开发包括网络分布式多程序在内的应用程序更加容易。</p>
<h2 id="10-HttpClient与JSONP区别？"><a href="#10-HttpClient与JSONP区别？" class="headerlink" title="10 HttpClient与JSONP区别？"></a>10 HttpClient与JSONP区别？</h2><p>1发送请求的位置不同.<br/><br>   JSONP:浏览器解析js发出的请求<br/><br>   HttpClient:是业务层java模拟发出Http请求<br/><br>2返回值的格式不同<br/><br>   JSONP:返回数据时必须要有回调函数.<br/><br>   HttpClient:直接返回JSON数据即可.<br/><br>3代码的层级不同<br/><br>   JSONP:代码层级一般3层<br/><br/><br>   HttpClient:一般5层.<br/></p>
<p><img src= data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs= data-src="http://182.92.171.224/upload/20191124_15010765.png" alt=""></p>
<h2 id="11-什么是nginx？"><a href="#11-什么是nginx？" class="headerlink" title="11 什么是nginx？"></a>11 什么是nginx？</h2><p>   答：Nginx (engine x) 是一个高性能的HTTP和反向代理服务。<br/><br>   反向代理方式是指以代理服务器来接收Interrnet上的连接请求，然后将请求转发给内部网络上的服务器；并将从服务器上得到的结果返回给Internet上请求连接的客户端，此时代理服务器对外就表现为一个服务器。<br/><br>   当一个代理服务器能够代理外部网络上的主机，访问内部网络时，这种代理服务的方式称为反向代理服务，当做服务器的替身，这样，代理服务器就在安全数据库和可能的恶意攻击之间提供了又一道屏障。<br/><br>   防火墙通路只允许代理服务器有权进行访问。<br/><br>   可以使用多个代理服务器来处理对一个高用量内容服务器的请求，这样做的好处是内容服务器可以处理更高的负载，并且比其独自工作时更有效率。<br/><br>   配置文件主要由四部分组成：main(全区设置)，server(主机配置)，upstream(负载均衡服务器设置)，和location(URL匹配特定位置设置)。<br/><br>   有1全局变量2事件配置3 http参数4虚拟主机基本设置5 Nignx状态监控6反向代理7负载均衡8 URL重写9 IP限制<br/><br>   主要了解虚拟主机配置，反向代理，负载均衡，url重新<br/></p>
]]></content>
      <categories>
        <category>面试题</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>爬虫</title>
    <url>/2020/04/01/%E7%88%AC%E8%99%AB/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><h1 id="爬虫"><a href="#爬虫" class="headerlink" title="爬虫"></a>爬虫</h1><p>简单学习了下爬虫,感觉挺有意思的……<br>网络爬虫（又称为网页蜘蛛，网络机器人，在FOAF社区中间，更经常的称为网页追逐者），是一种按照一定的规则，自动地抓取万维网信息的程序或者脚本。另外一些不常使用的名字还有蚂蚁、自动索引、模拟程序或者蠕虫。</p>
<pre><code class="java"><span class="keyword">package</span> day17.JD2;
<span class="comment">/**</span>
<span class="comment">*  <span class="doctag">@author</span>         zhang peng</span>
<span class="comment">*  <span class="doctag">@email</span>           332156209@qq.com</span>
<span class="comment">*  <span class="doctag">@date</span>             创建时间：2019年8月22日  下午6:12:15</span>
<span class="comment">*  <span class="doctag">@version</span>        1.0</span>
<span class="comment">*  <span class="doctag">@description</span>  -</span>
<span class="comment">*/</span>


<span class="keyword">import</span> java.io.IOException;
<span class="keyword">import</span> java.util.ArrayList;
<span class="keyword">import</span> java.util.List;

<span class="keyword">import</span> org.jsoup.Jsoup;
<span class="keyword">import</span> org.jsoup.nodes.Element;
<span class="keyword">import</span> org.jsoup.select.Elements;
<span class="keyword">import</span> org.junit.Test;

<span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JD</span> </span>{
    <span class="meta">@Test</span>
    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">site</span><span class="params">()</span> <span class="keyword">throws</span> IOException, InterruptedException </span>{
        <span class="keyword">int</span> sum = <span class="number">0</span>;
        <span class="comment">//获取所有的三级分类</span>
        List&lt;String&gt; catUrlList = JD.getCat3();
        <span class="comment">//遍历3级分类</span>
        <span class="keyword">for</span>(String catUrl : catUrlList) {
            <span class="comment">//延时</span>
            Thread.sleep(<span class="number">10</span>);

            <span class="comment">//返回当前分类的总页数</span>
            <span class="keyword">int</span> maxNum = JD.getPageNum(catUrl);
            <span class="comment">//某个分类下所有分页链接</span>
            List&lt;String&gt; pageUrlList = JD.getPageUrlList(catUrl, maxNum);
            <span class="comment">//遍历当前分类下的所有分页链接</span>
            <span class="keyword">for</span>(String pageUrl : pageUrlList) {
                <span class="comment">//当前分页商品链接</span>
                List&lt;String&gt; itemUrlList = JD.getItemUrlList(pageUrl);
                <span class="keyword">for</span>(String itemUrl : itemUrlList) {
                    System.out.println(itemUrl);
                    sum = sum +<span class="number">1</span>;
                    <span class="comment">//获取到当前商品链接，调用方法获取其标题、价格。。。</span>
                    System.out.println(Jsoup.connect(itemUrl).get().select(<span class="string">".sku-name"</span>).get(<span class="number">0</span>).text());
                }
            }
        }
        System.out.println(sum);
    }

    <span class="meta">@Test</span>
    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testCat3</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>{
        List&lt;String&gt; catList = JD.getCat3();
        <span class="keyword">for</span>(String url : catList) {
            System.out.println(url);
        }
        System.out.println(<span class="string">"处理标准三级分类："</span>+catList.size());
    }

    <span class="comment">//返回所有三级分类。京东三级分类：1286，标准有：1190</span>
    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title">getCat3</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>{
        <span class="comment">//所有分类都在里面</span>
        String url = <span class="string">"http://www.jd.com/allSort.aspx"</span>;

        <span class="comment">//通过选择器把三级分类过滤出来，集合</span>
        Elements els = Jsoup.connect(url).get()
            .select(<span class="string">"div dl dd a"</span>);

        <span class="comment">//存放爬取所有三级分类链接</span>
        List&lt;String&gt; catList = <span class="keyword">new</span> ArrayList&lt;String&gt;();
        <span class="keyword">for</span>(Element e : els) {
            <span class="comment">//获取到三级分类a标签的链接值</span>
            String catUrl = e.attr(<span class="string">"href"</span>);

            <span class="comment">//排除异常链接</span>
            <span class="keyword">if</span>(catUrl.startsWith(<span class="string">"//list.jd.com/list.html?cat="</span>)) {
                catList.add(<span class="string">"http:"</span>+catUrl);
            }
        }

        <span class="keyword">return</span> catList;
    }

    <span class="meta">@Test</span>
    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pageNum</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>{
        String catUrl = <span class="string">"http://list.jd.com/list.html?cat=1713,3274&amp;jth=i"</span>;
        <span class="keyword">int</span> num = JD.getPageNum(catUrl);
        System.out.println(num);
    }

    <span class="comment">//获取某个分类下总页数，参数就是分类链接</span>
    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getPageNum</span><span class="params">(String catUrl)</span> <span class="keyword">throws</span> IOException </span>{
        Integer num = Integer.parseInt(
                Jsoup.connect(catUrl).get()
            .select(<span class="string">".fp-text i"</span>).get(<span class="number">0</span>).text()
            );
        <span class="keyword">return</span> num;
    }

    <span class="meta">@Test</span>    <span class="comment">//测试某个分类下的所有的分页链接</span>
    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pageList</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>{
        String catUrl = <span class="string">"https://list.jd.com/list.html?cat=1713,3274"</span>;
        Integer maxNum = JD.getPageNum(catUrl);
        List&lt;String&gt; itemList = JD.getPageUrlList(catUrl, maxNum);
        <span class="keyword">for</span>(String item : itemList) {
            System.out.println(item);
        }
    }

    <span class="comment">//https://list.jd.com/list.html?cat=1713,3274&amp;page=1</span>
    <span class="comment">//https://list.jd.com/list.html?cat=1713,3274&amp;page=2</span>
    <span class="comment">//拼接某个一个分类下的所有的分页链接</span>
    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title">getPageUrlList</span><span class="params">(String catUrl, Integer maxNum)</span></span>{
        List&lt;String&gt; pageUrlList = <span class="keyword">new</span> ArrayList&lt;String&gt;();

        <span class="comment">//遍历所有页数</span>
        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>; i&lt;=maxNum; i++) {
            String pageUrl = catUrl + <span class="string">"&amp;page="</span> + i;
            pageUrlList.add(pageUrl);
        }
        <span class="keyword">return</span> pageUrlList;
    }

    <span class="meta">@Test</span>    <span class="comment">//某个列表页面上所有商品链接地址</span>
    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">itemList</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>{
        String pageUrl = <span class="string">"http://list.jd.com/list.html?cat=1713,3274&amp;page=210"</span>;
        List&lt;String&gt; itemUrlList = JD.getItemUrlList(pageUrl);
        <span class="keyword">for</span>(String itemUrl : itemUrlList) {
            System.out.println(itemUrl);
        }
    }

    <span class="comment">//抓取某个列表页面中所有商品链接的地址，</span>
    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title">getItemUrlList</span><span class="params">(String pageUrl)</span> <span class="keyword">throws</span> IOException</span>{
        Elements els = Jsoup.connect(pageUrl).get()
            .select(<span class="string">".p-img a"</span>);

        List&lt;String&gt; itemUrlList = <span class="keyword">new</span> ArrayList&lt;String&gt;();
        <span class="comment">//所有a标签，过滤过的</span>
        <span class="keyword">for</span>(Element e : els) {
            <span class="comment">//e是a标签，href属性值</span>
            String itemUrl = e.attr(<span class="string">"href"</span>);
            itemUrlList.add(<span class="string">"http:"</span>+itemUrl); 
        }
        <span class="keyword">return</span> itemUrlList;
    }
}



程序运行一会就会停,因为京东也有反爬虫♥ ♠ ♣ ♥ ◊ ♦ ♠</code></pre>
]]></content>
      <categories>
        <category>后端</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>爬虫</tag>
      </tags>
  </entry>
  <entry>
    <title>面试题目web</title>
    <url>/2020/04/07/%E9%9D%A2%E8%AF%95%E9%A2%98%E7%9B%AEweb/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script><h1 id="第二阶段面试题"><a href="#第二阶段面试题" class="headerlink" title="第二阶段面试题"></a>第二阶段面试题</h1><h2 id="1-1-描述Servlet调用过程？"><a href="#1-1-描述Servlet调用过程？" class="headerlink" title="1.1.描述Servlet调用过程？"></a>1.1.描述Servlet调用过程？</h2><p>答案：<br/><br>（1）在浏览器输入地址，浏览器先去查找hosts文件，将主机名翻译为ip地址，如果找不到就再去查询dns服务器将主机名翻译成ip地址。<br/><br>（2）浏览器根据ip地址和端口号访问服务器，组织http请求信息发送给服务器。<br/><br>（3）服务器收到请求后首先根据Host请求头判断当前访问的是哪台虚拟主机。<br/><br>（4）服务器根据http请求头中的请求URI判断当前访问的是哪个web应用。<br/><br>（5）服务器根据http请求头中的请求URI判断当前访问的是web应用中的哪个web资源。<br/><br>（6）检查web应用的web.xml文件，如果根据路径找到具体的servlet处理类的全路径名交给该servlet处理,如果找不到就交给缺省servlet处理。<br/><br>（7）这个过程中浏览器只知道自己发出来http请求，不久就收到了http响应，浏览器不知道也不关心服务器内部是如何处理的。浏览器和服务器之间的关系是非常单纯的，只有HTTP协议。<br/><br>（8）解析请求、封装RequestResponse对象、创建Servlet、调用Service方法都是服务器自动进行的，开发人员只需要写好Servlet配置进容器中即可，无需操心具体的底层实现。<br/></p>
<h2 id="1-2-简述Servlet生命周期？"><a href="#1-2-简述Servlet生命周期？" class="headerlink" title="1.2.简述Servlet生命周期？"></a>1.2.简述Servlet生命周期？</h2><p>答案：<br/><br>（1）Servlet第一次被访问到时创建对象，创建出来后立即执行init方法执行初始化的操作。<br/><br>（2）从此以后该对象一直驻留在内存中为后续的对这个Servlet的请求进行服务。<br/><br>（3）直到服务器关闭或web应用移除出容器时，随着web应用的销毁Servlet对象销毁掉，在销毁之前调用destory方法执行善后工作。<br/><br>（4）在存活期间，每次对Servlet 的调用都会导致Service方法的执行。<br/></p>
<h2 id="1-3-什么是http协议？"><a href="#1-3-什么是http协议？" class="headerlink" title="1.3.什么是http协议？"></a>1.3.什么是http协议？</h2><p>答案：<br/></p>
<p>HTTP协议就是一套基于tcp/ip协议的应用层协议 。简单来说，就是一个基于应用层的通信规范，双方要进行通信，大家都要遵守一个规范，这个规范就是HTTP协议。它规定了客户端（通常是浏览器）和服务器之间的通信方式。<br/></p>
<h2 id="1-4-HTTP协议工作原理？"><a href="#1-4-HTTP协议工作原理？" class="headerlink" title="1.4.HTTP协议工作原理？"></a>1.4.HTTP协议工作原理？</h2><p>答案：<br/></p>
<p>HTTP协议基于请求响应模型。<br/><br>一次请求对应一次响应。<br/><br>首先客户端发送一个请求(request)给服务器，服务器在接收到这个请求后将生成一个响应(response)返回给客户端。<br/></p>
<h2 id="1-5-HTTP协议的特点是什么"><a href="#1-5-HTTP协议的特点是什么" class="headerlink" title="1.5.HTTP协议的特点是什么 ?"></a>1.5.HTTP协议的特点是什么 ?</h2><p>答案：<br/></p>
<p>（1）它是一个无状态的协议，服务器端在处理相应请求后不会保留任何客户端的信息，每次请求都是独立的<br/><br>（2）客户端与服务器端的每一次数据交互，都要经过一次请求/响应的过程。<br/><br>（3）服务器端无法识别能够出发客户端请求的方法。<br/><br>（4）一个典型的HTTP请求分为 一个请求行 若干请求头 一个空行 实体内容。<br/></p>
<h2 id="1-6-get和post请求的区别？"><a href="#1-6-get和post请求的区别？" class="headerlink" title="1.6.get和post请求的区别？"></a>1.6.get和post请求的区别？</h2><p>答案：<br/></p>
<p>（1）get请求用来从服务器上获得资源，而post是用来向服务器提交数据；<br/><br>（2）get将表单中数据按照name=value的形式，添加到action 所指向的URL 后面，并且两者使用”?”连接，而各个变量之间使用”&amp;”连接；post是将表单中的数据放在HTTP协议的请求头或消息体中，传递到action所指向URL；<br/><br>（3）get传输的数据要受到URL长度限制（1024字节）；而post可以传输大量的数据， POST数据是没有限制的，上传文件通常要使用post方式；<br/><br>（4）使用get时参数会显示在地址栏上，如果这些数据不是敏感数据，那么可以使用get；对于敏感数据还是应用使用post；<br/><br>（5）get使用MIME类型application/x-www-form-urlencoded的URL编码（也叫百分号编码）文本的格式传递参数，保证被传送的参数由遵循规范的文本组成，例如一个空格的编码是”%20”。<br/><br>（6）Jsp页面中的FORM标签里的method属性为get时调用doGet()，为post时调用doPost()。<br/></p>
<h2 id="1-7-请求乱码产生的原因？"><a href="#1-7-请求乱码产生的原因？" class="headerlink" title="1.7.请求乱码产生的原因？"></a>1.7.请求乱码产生的原因？</h2><p>答案：<br/></p>
<p>浏览器用什么码表来打开表单页面就用什么编码来发送数据。当前我们的注册页面指定了用utf-8来打开。这就决定了浏览器是用utf-8打开的页面，浏览器在提交表单时是用utf-8编码的。而tomcat默认情况下会使用iso8859-1来进行解码。我们知道全世界的码表都兼容iso8859-1，所以英文处理是没有问题的。但是iso8859-1中并没有中文，iso8859-1对于无法处理的字节都使用?替代，所以我们看到的都是？。<br/></p>
<h2 id="1-8-如何来处理get请求产生的乱码"><a href="#1-8-如何来处理get请求产生的乱码" class="headerlink" title="1.8.如何来处理get请求产生的乱码?"></a>1.8.如何来处理get请求产生的乱码?</h2><p>答案：<br/></p>
<p>由于客户端发送时使用的是utf-8编码而服务器用iso8859-1解码造成了乱码，虽然字符已经乱掉了，但底层的字节仍然是正确的，我们只要将乱码字符getBytes(“iso8859-1”)转换为字节，就是正确的字节，再将这些字节new String(bytes，“utf-8”)按照正确的码表编码，就可以转换回正确的字符了。从而解决了乱码。</p>
<h2 id="1-9-Request生命周期"><a href="#1-9-Request生命周期" class="headerlink" title="1.9.Request生命周期"></a>1.9.Request生命周期</h2><p>答案：<br/></p>
<p>request对象的生命周期是针对一个客户端(一个浏览器应用程序)的一次请求，当请求完毕之后，request里边的内容也将被释放，一个请求开始时创建，请求结束后销毁。</p>
<h2 id="1-10-如何处理响应乱码？"><a href="#1-10-如何处理响应乱码？" class="headerlink" title="1.10.如何处理响应乱码？"></a>1.10.如何处理响应乱码？</h2><p>答案：</p>
<p>通过response.setHeader(“Content-Type”, “text/html;charset=utf-8”)方法，通知服务器发送数据时的码表；通过response.setCharacterEncoding(“utf-8”)方法，通知浏览器解析时使用的码表。两码相同就不会有乱码了。<br>response提供了setContentType(“text/html;charset=UTF-8”)快捷方法，在它的底层，会同时做上面两件事，所以可以一行代码解决response产生的乱码问题。</p>
<h2 id="1-11-简述ServletContext生命周期？"><a href="#1-11-简述ServletContext生命周期？" class="headerlink" title="1.11.简述ServletContext生命周期？"></a>1.11.简述ServletContext生命周期？</h2><p>答案：<br/></p>
<p>ServletContext对象代表当前web应用。当服务器启动时，服务器在启动时会依次加载web应用，每一个web应用加载完成后都会创建一个ServletContext对象唯一代表该web应用，这个对象一直存活，直到web应用移除出容器或服务器关闭时，随着应用销毁，ServletContext对象跟着销毁。</p>
<h2 id="1-12-转发与重定向的比较？"><a href="#1-12-转发与重定向的比较？" class="headerlink" title="1.12.转发与重定向的比较？"></a>1.12.转发与重定向的比较？</h2><p>答案：<br/></p>
<p>转发是服务器内部资源跳转,重定向是通过302+Location实现浏览器跳转访问。<br/><br>转发一次请求一次响应,重定向两次请求两次响应。<br/><br>转发地址栏不发生变化,重定向地址栏会发生变化。<br/><br>转发之前和转发之后request是一个,重定向之前和之后不是一个request。<br/></p>
<h2 id="1-13-Session生命周期？"><a href="#1-13-Session生命周期？" class="headerlink" title="1.13.Session生命周期？"></a>1.13.Session生命周期？</h2><p>答案：<br/></p>
<p>当程序第一次调用到request.getSession()代码时,服务器明确的知道了需要用到session了,此时创建session。<br/><br>如果session超过30分钟(可以在web.xml中配置的)没人使用,服务器认为这个session超时了,销毁session。<br/><br>明确的调用session.invalidate(),session立即销毁。<br/><br>服务器被非正常关闭或web应用被移除出容器,此时随着web应用的销毁session销毁.如果是正常关闭,session会被钝化.当下次服务器正常启动时,没有超时的session还会被活化回来。<br/></p>
<h2 id="1-14-session的原理？"><a href="#1-14-session的原理？" class="headerlink" title="1.14.session的原理？"></a>1.14.session的原理？</h2><p>答案：<br/></p>
<p>session的原理：在服务器第一次调用request.getSession()方法的时候，会在内存中创建一个session对象，此对象具有一个独一无二的id值，此id值将会以cookie（JSESSIONID）的形式发送给浏览器，浏览器以后每次访问都会带着此cookie，服务器就利用此cookie区分浏览器找到对应的session空间。</p>
<h2 id="1-15-cookie与session的区别"><a href="#1-15-cookie与session的区别" class="headerlink" title="1.15.cookie与session的区别"></a>1.15.cookie与session的区别</h2><p>答案：<br/></p>
<p>cookie数据存放在客户的浏览器上，session数据放在服务器上<br/><br>cookie不是很安全，别人可以分析存放在本地的COOKIE并进行COOKIE欺骗，考虑到安全应当使用session<br/><br>session会在一定时间内保存在服务器上。当访问增多，会比较占用你服务器的性能，考虑到减轻服务器性能方面，应当使用COOKIE<br/></p>
<h2 id="1-16-JSP和Servlet是什么关系？"><a href="#1-16-JSP和Servlet是什么关系？" class="headerlink" title="1.16.JSP和Servlet是什么关系？"></a>1.16.JSP和Servlet是什么关系？</h2><p>答案：<br/></p>
<p>其实这个问题在上面已经阐述过了，Servlet是一个特殊的Java程序，它运行于服务器的JVM中，能够依靠服务器的支持向浏览器提供显示内容。JSP本质上是Servlet的一种简易形式，JSP会被服务器处理成一个类似于Servlet的Java程序，可以简化页面内容的生成。Servlet和JSP最主要的不同点在于，Servlet的应用逻辑是在Java文件中，并且完全从表示层中的HTML分离开来。而JSP的情况是Java和HTML可以组合成一个扩展名为.jsp的文件。有人说，Servlet就是在Java中写HTML，而JSP就是在HTML中写Java代码，当然这个说法是很片面且不够准确的。JSP侧重于视图，Servlet更侧重于控制逻辑，在MVC架构模式中，JSP JSP有哪些内置对象？作用分别是什么？<br/><br>JSP有9个内置对象：<br/></p>
<ul>
<li>request：封装客户端的请求，其中包含来自GET或POST请求的参数；<br/></li>
<li>response：封装服务器对客户端的响应；<br/></li>
<li>pageContext：通过该对象可以获取其他对象；<br/></li>
<li>session：封装用户会话的对象；<br/></li>
<li>application：封装服务器运行环境的对象；<br/></li>
<li>out：输出服务器响应的输出流对象；<br/></li>
<li>config：Web应用的配置对象；<br/></li>
<li>page：JSP页面本身（相当于Java程序中的this）；<br/></li>
<li>exception：封装页H    面抛出异常的对象。<br/><h2 id="1-17-JSP的九大隐式对象是哪九个"><a href="#1-17-JSP的九大隐式对象是哪九个" class="headerlink" title="1.17.JSP的九大隐式对象是哪九个"></a>1.17.JSP的九大隐式对象是哪九个</h2>答案：<br/><br>1：request: 请求对象 在javax.servlet.ServletRequest  作用域为Request来自客服端的请求，如：FORM表单中填写的信息，常用的方法有getParameter，getParamterName   和getParamterValue通过表用获取请求对象中包含的参数值。<br/><br>2:response表示客服端的响应。<br/><br>3：pageContext对象为页面的上下文对象，代表当请运行页面的一些属性。<br/><br>4：session：对象代码服务器与客服端所建立的会话，比如在写购物，客服轨迹跟踪，<br/><br>session”是建立在cookie的基础之上的。常用方法有getId,getValues等。<br>5：application对象负责提供应用程序在服务端运行时的一些全局信息，方法有getMimeType等。<br/><br>6：out：与response不同，通过out对象发送的内容是浏览器需要的显示内容，还可以直接想客服端编写一个有程序动态生成的HTML的文件。<br/><br>7：page：page里的变量没法从index.jsp传递到test.jsp。只要页面跳转了，就不见了。<br/><br>8： exception：他是一个列外的对象，当页面发生了列外，就会会创建该对象。<br/><br>9：config：是在servlet初始化Servlet的时候，JSP引擎向他传递信息用的，此消息包括Servlet初始化时所需要的参数。<br/><h2 id="1-18-如何防止SQL注入攻击呢？"><a href="#1-18-如何防止SQL注入攻击呢？" class="headerlink" title="1.18.如何防止SQL注入攻击呢？"></a>1.18.如何防止SQL注入攻击呢？</h2>答案：<br/></li>
</ul>
<p>SQL注入：就是通过把SQL命令插入到Web表单递交或输入域名或页面请求的查询字符串，最终达到欺骗服务器执行恶意的SQL命令。具体来说，它是利用现有应用程序，将（恶意）的SQL命令注入到后台数据库引擎执行的能力，它可以通过在Web表单中输入（恶意）SQL语句得到一个存在安全漏洞的网站上的数据库，而不是按照设计者意图去执行SQL语句。<br/><br>防止的方法：<br/><br>（1）永远不要信任用户的输入，要对用户的输入进行校验，可以通过正则表达式，或限制长度，对单引号和双”-“进行转换等。<br/><br>（2）永远不要使用动态拼装SQL，可以使用参数化的SQL或者直接使用存储过程进行数据查询存取。<br/><br>（3）永远不要使用管理员权限的数据库连接，为每个应用使用单独的权限有限的数据库连接。<br/><br>（4）不要把机密信息明文存放，请加密或者hash掉密码和敏感的信息。<br/><br>（5）应用的异常信息应该给出尽可能少的提示，最好使用自定义的错误信息对原始错误信息进行包装，把异常信息存放在独立的表中。<br/></p>
<h2 id="1-19-Mysql数据库优化"><a href="#1-19-Mysql数据库优化" class="headerlink" title="1.19.Mysql数据库优化"></a>1.19.Mysql数据库优化</h2><p>答案：<br/></p>
<p>(1)查询时，能不用* 就不用，尽量写全字段名。<br/><br>(2)索引不是越多越好，每个表控制在6个索引以内。范围where条件的情况下，索引不起作用，比如where value&lt;100 <br/><br>(3)大部分情况连接效率远大于子查询，但是有例外。当你对连接查询的效率都感到不能接受的时候可以试试用子查询，虽然大部分情况下你会更失望，但总有碰到惊喜的时候不是么…<br/><br>(4)多用explain 和 profile分析查询语句<br/><br>(5)有时候可以1条大的SQL可以分成几个小SQL顺序执行，分了吧，速度会快很多。<br/><br>(6)每隔一段时间用alter table table_name engine=innodb;优化表<br/><br>(7)连接时注意:小表 jion 大表的原则<br/><br>(8)学会用explain 和 profile判断是什么原因使你的SQL慢<br/><br>(9)查看慢查询日志，找出执行时间长的SQL进行优化<br/><br>(10)尽量避免使用order by<br/><br>(11)因为where子句后面的条件是执行顺序是从右到左，所以尽量把能过滤掉大部分数据的条件放在最后<br/></p>
<h2 id="1-20-Filter-的作用是什么？"><a href="#1-20-Filter-的作用是什么？" class="headerlink" title="1.20.Filter 的作用是什么？"></a>1.20.Filter 的作用是什么？</h2><p>答案：<br/></p>
<p>init为初始化方法，在Filter对象被创建出来时，Servlet容器会调用该方法对filter进行初始化。<br/><br>destory为销毁的方法，在过滤器对象被销毁之前，服务器会调用这个方法执行善后工作。 <br/><br>doFilter为过滤器中最核心的方法，对访问的请求和响应进行拦截，当过滤器拦截到对资源的访问时，服务器会自动调用该方法执行过滤代码。 我们只需要在这个方法中设计过滤器的逻辑代码即可。<br/></p>
<h2 id="1-21-Filter的生命周期？"><a href="#1-21-Filter的生命周期？" class="headerlink" title="1.21.Filter的生命周期？"></a>1.21.Filter的生命周期？</h2><p>答案：<br/></p>
<p>当服务器启动,web应用加载后,立即创建出这个web应用中的所有过滤器对象,创建出来后立即调用过滤器的init方法执行初始化操作.从此这些过滤器对象驻留在内存中为后续的拦截进行服务.每当拦截到资源时,都会导致dofilter方法执行.最终直到服务器关闭或web应用移除出容器时,随着web应用的销毁,过滤器对象销毁,销毁之前调用destory方法执行善后工作。</p>
<h2 id="1-22-什么是数据库连接池及其工作原理"><a href="#1-22-什么是数据库连接池及其工作原理" class="headerlink" title="1.22.什么是数据库连接池及其工作原理"></a>1.22.什么是数据库连接池及其工作原理</h2><p>答案：<br/><br>对于共享资源，有一个很著名的设计模式：资源池（resource pool）。该模式正是为了解决资源的频繁分配﹑释放所造成的问题。为解决上述问题，可以采用数据库连接池技术。数据库连接池的基本思想就是为数据库连接建立一个“缓冲池”。预先在缓冲池中放入一定数量的连接，当需要建立数据库连接时，只需从“缓冲池”中取出一个，使用完毕之后再放回去。我们可以通过设定连接池最大连接数来防止系统无尽的与数据库连接。更为重要的是我们可以通过连接池的管理机制监视数据库的连接的数量﹑使用情况，为系统开发﹑测试及性能调整提供依据。</p>
<h2 id="1-23-如何自己实现一个数据库连接池"><a href="#1-23-如何自己实现一个数据库连接池" class="headerlink" title="1.23.如何自己实现一个数据库连接池"></a>1.23.如何自己实现一个数据库连接池</h2><p>答案：<br/><br>思路如下：<br/><br>1：利用class实现DataSource接口<br/><br>2：在class的构造器一次性创建指定的链接将链接保存LinkedList中<br/><br>3：实现getConnection从LinkedList返回一个链接<br/><br>4：提供将链接放回方法<br/></p>
<pre><code>Public class MyDataSource inplements DataSource{
   Private LinkedList&lt;Connection&gt; dataSource=new LinkedList&lt;&gt;();
   Public MyDataSource(){
   For( int a=0;a&lt;1000;a++){
    Try{
   DriverManager.registerDriver(new SQLServerDriver());
    Connection con=DriverManager.getConnection(“jdbc:sqlserver://localhost:1443;DatabaseName=liming”,”root”,”liming”
}catch(Exception e){

}

}
Public Connection getConnetion(){
   Final Connection conn=dataSource.removeFirst();
}
Public void releasConnection(Connection conn){
    dataSource.add(conn);
}
}
}</code></pre><h2 id="1-24-http和https的区别？"><a href="#1-24-http和https的区别？" class="headerlink" title="1.24. http和https的区别？"></a>1.24. http和https的区别？</h2><p>答案：<br/><br>HTTP协议传输的数据都是未加密的，也就是明文的，因此使用HTTP协议传输隐私信息非常不安全，为了保证这些隐私数据能加密传输，于是网景公司设计了SSL（Secure Sockets Layer）协议用于对HTTP协议传输的数据进行加密，从而就诞生了HTTPS。简单来说，HTTPS协议是由SSL+HTTP协议构建的可进行加密传输、身份认证的网络协议，要比http协议安全。</p>
<h2 id="1-25-Servlet的单例问题"><a href="#1-25-Servlet的单例问题" class="headerlink" title="1.25.Servlet的单例问题"></a>1.25.Servlet的单例问题</h2><p>答案：<br/><br>Servlet是一个供其他java程序调用的类，它不能独立运行，针对客户端的多次请求，通常状况下，Servlet只会创建一个Servlet实例对象，一旦创建它就会驻留在内存中，为后续的请求提供服务，直至退出web应用为止，也就是当我们关闭了浏览器之后我们的Servlet就终止了。<br/><br>当Servlet第一次访问的时候，就被加载到内存中，以后该实例对各个请求服务，没次情况会调用一次service方法。<br/><br>这样会出现什么问题：因为Servlet是单例的，所以会出现线程安全问题<br/></p>
<h2 id="1-26-””-和-null的区别"><a href="#1-26-””-和-null的区别" class="headerlink" title="1.26.”” 和 null的区别"></a>1.26.”” 和 null的区别</h2><p>答案：<br/><br>如果说str是null，那么内存根本没创建字符串对像，并由str引用。不能调用object的方法。<br/><br>        如果说str是空串，那么确实存在一个由str引用的字符串对像，只不过这个字符串的值是””。长度为0；<br/><br>        在获取请求参数的时候为什么要这样判断呢？<br/></p>
<pre><code>if(null==str || &quot;&quot;.equals(str)){
    return &quot;不合法参数&quot;；
}</code></pre><p>如果我们在表单中什么都不填 接收到的字符串就是null;<br/><br>如果我们在表单中填“”，接受到的字符串是“”，但是存入数据库后，查询出来的就是null；<br/></p>
<h2 id="1-27-Servlet的多线程同步问题"><a href="#1-27-Servlet的多线程同步问题" class="headerlink" title="1.27.Servlet的多线程同步问题"></a>1.27.Servlet的多线程同步问题</h2><p>答案：<br/><br>　　Servlet本身是单实例的，这样当有多个用户同时访问某个Servlet时，会访问该唯一的Servlet实例中的成员变量，如果对成员变量进行写入操作，那就会导致Servlet的多线程问题，即数据不一致。<br/><br>1.解决Servlet多线程同步问题的最好方式：去除实例变量，使用局部变量。<br/><br>不使用成员变量，而使用局部变量，因为局部变量在每个线程中都有各自的实例。所以对Servlet来说，如果要对某个变量做写入操作，一定不要使用成员变量，而要使用局部变量。<br/><br>2.使用同步代码块<br/><br>　　synchronized{}<br/><br>3.Servlet实现javax.serlvet.SingleThreadModel，Servlet2.4中已经废弃了该接口，此时Servlet容器将保证Servlet实例以单线程方式运行，也就是说，同一时刻，只会有一个线程执行Servlet的service()方法。<br/></p>
<h2 id="1-28-request-getParameter-和request-getAttribute-的区别？"><a href="#1-28-request-getParameter-和request-getAttribute-的区别？" class="headerlink" title="1.28.request.getParameter()和request.getAttribute()的区别？"></a>1.28.request.getParameter()和request.getAttribute()的区别？</h2><p>答案：<br/></p>
<p>a、request.getParameter()获取的类型是String；<br/><br/><br>    request.getAttribute()获取的类型是Object<br/><br>b、request.getPrameter()获取的是POST/GET传递的参数值和URL中的参数；<br/><br>     request.getAttribute()获取的是对象容器中的数据值/对象<br/><br>c、request.setAttribute()和request.getAttribute()可以发送、接收对象；<br/><br>    request.getParamter()只能接收字符串，官方不开放request.setParamter()（也就是没有这个方法）<br/><br>    setAttribute()和getAttribute()的传参原理：<br/><br>    setAttribute()是应用服务器把这个对象放在该页面所对应的一块内存中去，当你的页面服务器重定向到另外一个页面时，<br/><br>    应用服务器会把这块内存拷贝到另一个页面所对应的那块内存中。这个就可以通过getAttribute()获取到相应的参数值或者对象。<br/></p>
<h2 id="1-29-JSP中动态include和静态include的区别？"><a href="#1-29-JSP中动态include和静态include的区别？" class="headerlink" title="1.29.JSP中动态include和静态include的区别？"></a>1.29.JSP中动态include和静态include的区别？</h2><p>答案：<br/><br> a、静态include：语法：&lt;%@ include file=”文件名” %&gt;，相当于复制，编辑时将对应的文件包含进来，当内容变化时，不会再一次对其编译，不易维护。<br/><br> b、动态include：语法：&lt;jsp:include page=”文件名”&gt;,能够自动检查被包含文件，当客户端对JSP文件进行请求时，会重新将对应的文件包含进来，进行实时的更新。<br/></p>
<h2 id="1-30-详细描述MVC。"><a href="#1-30-详细描述MVC。" class="headerlink" title="1.30. 详细描述MVC。"></a>1.30. 详细描述MVC。</h2><p>答案：<br/><br>基于java的web应用系统采用MVC设计模型，即用Model（模型）、View（视图）和Controller（控制）分离设计，这是目前web应用服务系统的主流设置方向。<br/><br>      Model：处理业务逻辑的模块。<br/><br>      View：负责页面显示，显示Model的处理结果给用户，主要实现数据到页面的转换过程。<br/><br>      Controller：负责每个请求的分发，把Form数据传递给Model进行处理，处理完成后，把处理结果返回给相应的View显示给用户。<br/></p>
<h2 id="1-31-EL表达式的功能，为什么要用EL表达式？（Expression-Language）"><a href="#1-31-EL表达式的功能，为什么要用EL表达式？（Expression-Language）" class="headerlink" title="1.31.EL表达式的功能，为什么要用EL表达式？（Expression Language）"></a>1.31.EL表达式的功能，为什么要用EL表达式？（Expression Language）</h2><p>答案：<br/><br>功能：<br/><br>a、从四个域对象中取出数据数据显示。<br/><br>b、取出请求参数数据显示。<br/><br>原因：<br/><br>在页面中用jsp脚本和jsp表达式来获取数据显示比较麻烦<br/><br>a、需要判断<br/><br>b、可能需要强转<br/></p>
<h2 id="1-32-如何防止表单重复提交？"><a href="#1-32-如何防止表单重复提交？" class="headerlink" title="1.32.如何防止表单重复提交？"></a>1.32.如何防止表单重复提交？</h2><p>答案：<br/><br>使用session技术：<br/><br>a、在regist.jsp页面中生成一个为一个随机值，将其保存到session中，同时将其保存为表单的隐藏域的值。<br/><br>b、在处理注册的请求时，获取session中的值，获取请求参数的值，比较两者是否相同，如果相同说明不是重复提交，请求通过同时删除session中保存的的值，如果不相同则是重复提交，不能通过。<br/></p>
<h2 id="1-33-什么是web容器？"><a href="#1-33-什么是web容器？" class="headerlink" title="1.33.什么是web容器？"></a>1.33.什么是web容器？</h2><p>答案：<br/><br>给处于其中的应用程序组件（JSP、Servlet）提供一个环境，是JSP、Servlet直接跟容器中的变量交互，不必关注其他系统问题。<br/><br>主要有web服务器来实现。例如：tomcat、weblogic、sphere、JBoss等。该容器提供的接口严格遵守J2EE规范中的web application标准。<br/><br>我们把遵守以上标准的web服务器叫做J2EE的web容器。<br/></p>
<h2 id="1-34-J2EE常用的设计模式？说明工厂模式。"><a href="#1-34-J2EE常用的设计模式？说明工厂模式。" class="headerlink" title="1.34.J2EE常用的设计模式？说明工厂模式。"></a>1.34.J2EE常用的设计模式？说明工厂模式。</h2><p>答案：<br/><br>Java中一共有23中设计模式：<br/><br>Factory（工厂模式）、Builder（建造模式）、Factory Method（工厂方法模式）、ProtoType（原始模型模式）、Singleton（单例模式）、<br>Facade（门面模式）、Adapter（适配器模式）、Bridge（桥梁模式）、Composite（合成模式）、Decorator（装饰模式）、<br>FlyWeight（享元模式）、Proxy（代理模式）、Command（命令模式）、Interpreter（解释器模式）、Visitor（访问者模式）、<br>Iterator（迭代子模式）、Mediator（调停者模式）、Memento（备忘录模式）、Observer（观察者模式）、State（状态模式）、<br>Strategy（策略模式）、Template Method（模板方法模式）、Chain Of Responsibility（责任链模式）、<br/><br>工厂模式：工厂模式是一种经常被使用到的模式，根据工厂模式实现的类可以根据提供的数据生成一组类中某个类的实例，通常一组类中有一个公共的抽象父类并且实现了相同的方法，但是这些方法针对不同的数据进行了不同的操作。首先需要定义一个基类，该类的子类通过不同的方法实现了基类中的方法。然后定义一个工厂类，工厂类可以根据条件生成不同的子类实例。当得到子类的实例后，开发人员可以调用基类中的方法而不必考虑到底返回的是哪一个子类的实例。</p>
<h2 id="1-35-什么是事务？"><a href="#1-35-什么是事务？" class="headerlink" title="1.35.什么是事务？"></a>1.35.什么是事务？</h2><p>答案：<br/>v<br>事务时作为一个逻辑单元执行的一系列操作，一个逻辑工作单元必须有四个属性，称为ACID（原子性、一致性、隔离性和持久性）属性，<br>只有这样才能成为一个事务：<br/><br>原子性：事务必须是原子工作单元，对于其数据修改，要么全都执行，要么全都不执行。<br/><br>一致性：事务在完成时，必须使所有的数据保持一致的状态。在相关数据库中，所有规则都必须应用于事务的修改，以保持所有数据的完整性。事务结束时，所有的内部数据结构（如B树索引或双向链表）都必须是正确的。<br/><br>隔离性：由并发事务所做的修改必须与任何其他并发事务所做的修改隔离。事务查看数据时数据所处的状态，要么是另一并发事务修改它之前<br/><br>的状态，要么是另一并发事务修改它之后的状态，事务不会查看中间状态的数据。这称为可串行性，因为它能够重新装载起始数据，并且重播一系列事务，以使数据结束时的状态与原始事务执行的状态相同。<br/><br>持久性：事务完成后，它对于系统的影响是永久性的。该修改即使出现系统故障也将一直保持。<br/></p>
<h2 id="1-36-数据库有几种隔离级别"><a href="#1-36-数据库有几种隔离级别" class="headerlink" title="1.36.数据库有几种隔离级别?"></a>1.36.数据库有几种隔离级别?</h2><p>答案：<br/><br>1、Serializable (串行化)：可避免脏读、不可重复读、幻读的发生<br/><br>2、Repeatable read (可重复读)：可避免脏读、不可重复读的发生。<br/><br>3、Read committed (读已提交)：可避免脏读的发生。<br/><br>4、Read uncommitted (读未提交)：最低级别，任何情况都无法保证<br/></p>
<h2 id="1-37-简述web-xml的作用"><a href="#1-37-简述web-xml的作用" class="headerlink" title="1.37.简述web.xml的作用"></a>1.37.简述web.xml的作用</h2><p>答案：<br/></p>
<p>属于部署描述符，在整个JAVA中只要是容器都会存在部署描述符，此部署描述符可以控制整个WEB中各个组件的运行状态，也可以配置整个窗口的状态</p>
<h2 id="1-38-sql优化：（索引、范式）"><a href="#1-38-sql优化：（索引、范式）" class="headerlink" title="1.38.sql优化：（索引、范式）"></a>1.38.sql优化：（索引、范式）</h2><p>答案：<br/><br>三范式：<br/><br>   第一范式（确保每列保持原子性）最基本范式。数据库表中所有字段值都是不可分解的原子值，就满足了第一范式。<br/><br>第二范式（确保表中的每列都和主键相关）在第一范式上更近一层。确保数据库表中的每一列都和主键相关，而不能只与主键的某一部分相关，也就是说一个表中只能保存一种数据，不可以吧多种数据保存在一张表中。<br/><br>第三范式：确保每列都和主键列直接相关，不是间接相关。<br/><br>索引：<br/><br>    避免对索引字段进行计算、避免索引在字段上使用not、&lt;&gt;、！=、避免在索引上使用IS NULL和NOT NULL、避免在索引列上出现数据类型转换、避免索引字段使用函数、避免建立索引的列出现空值</p>
<h2 id="1-39-Ajax原理"><a href="#1-39-Ajax原理" class="headerlink" title="1.39.Ajax原理"></a>1.39.Ajax原理</h2><p>答案：<br/></p>
<p>Ajax的工作原理相当于在用户和服务器之间加了—个中间层,使用户操作与服务器响应异步化。并不是所有的用户请求都提交给服务器,像—些数据验证和数据处理等都交给Ajax引擎自己来做, 只有确定需要从服务器读取新数据时再由Ajax引擎代为向服务器提交请求。<br/><br>    Ajax其核心只有JavaScript、XMLHTTPRequest和DOM，在旧的交互方式中,由用户触发一个HTTP请求到服务器,服务器对其进行处理后再返回一个新的HTHL页到客户端, 每当服务器处理客户端提交的请求时,客户都只能空闲等待,并且哪怕只是一次很小的交互、只需从服务器端得到很简单的一个数据,都要返回一个完整的HTML页,而用户每次都要浪费时间和带宽去重新读取整个页面。而使用Ajax后用户从感觉上几乎所有的操作都会很快响应没有页面重载（白屏）的等待。<br/></p>
<h2 id="1-40-JDBC的原理"><a href="#1-40-JDBC的原理" class="headerlink" title="1.40.JDBC的原理"></a>1.40.JDBC的原理</h2><p>答案：<br/></p>
<h2 id="1-41-SQL注入攻击"><a href="#1-41-SQL注入攻击" class="headerlink" title="1.41.SQL注入攻击"></a>1.41.SQL注入攻击</h2><p>答案：<br/><br>SQL注入是一种将SQL代码添加到输入参数中，传递到服务器解析并执行的一种攻击手法。<br/><br>SQL注入攻击是输入参数未经过滤，然后直接拼接到SQL语句当中解析，执行达到预想之外的一种行为，称之为SQL注入攻击。<br/></p>
<h2 id="1-42-如何防止SQL注入攻击"><a href="#1-42-如何防止SQL注入攻击" class="headerlink" title="1.42.如何防止SQL注入攻击"></a>1.42.如何防止SQL注入攻击</h2><p>答案：<br/><br>利用新对象PreparedStatement对象完成，先将SQL骨架发送给数据库服务器，然后再将参数单独发给服务器，并将参数中的关键字当做一个普通字符串来处理，进而起到防止SQL注入的问题</p>
<h2 id="1-43-对连接池的理解"><a href="#1-43-对连接池的理解" class="headerlink" title="1.43.对连接池的理解"></a>1.43.对连接池的理解</h2><p>答案：<br/><br>用来提高程序的效率，创建一个容器，容器中存放已经获取到了的数据库连接对象，对外提供获取连接和还回连接的方法，外界需要时就从容器中获取，用完就还回容器中。</p>
<h2 id="1-44-HTML和xml的区别？"><a href="#1-44-HTML和xml的区别？" class="headerlink" title="1.44.HTML和xml的区别？"></a>1.44.HTML和xml的区别？</h2><p>答案：<br/><br>XML是可扩展标记语言，而HTML超文本标记语言。不同之处：<br/><br>1、语法有所不同。XML语法比较严谨而HTML语法比较松散。<br/><br>2、用途不同。XML主要用于数据格式化存储而HTML主要用于网页的编辑。<br/></p>
<h2 id="1-45-在JS中-和-的区别？"><a href="#1-45-在JS中-和-的区别？" class="headerlink" title="1.45.在JS中==和===的区别？"></a>1.45.在JS中==和===的区别？</h2><p>答案：<br/><br>简单来说： == 代表相同， ===代表严格相同, 为啥这么说呢， <br/><br>这么理解： 当进行双等号比较时候： 先检查两个操作数数据类型，如果相同， 则进行===比较， 如果不同， 则愿意为你进行一次类型转换， 转换成相同类型后再进行比较， 而===比较时， 如果类型不同，直接就是false.</p>
<h2 id="1-46-SQL优化"><a href="#1-46-SQL优化" class="headerlink" title="1.46.SQL优化"></a>1.46.SQL优化</h2><p>答案：<br/><br>1.SELECT子句中避免使用‘*’<br/><br>2.SQL语句用大写的<br/><br>3.用IN来替换OR<br/><br>4.查询语句中不要使用 *<br/><br>5.尽量减少子查询，使用关联查询（left join,right join,inner  join）替代<br/><br>6.减少使用IN或者NOT IN ,使用exists，not exists或者关联查询语句替代<br/><br>7.or 的查询尽量用 union或者union all 代替<br/><br>8.合理的增加冗余的字段（减少表的联接查询）<br/><br>9.增加中间表进行优化（这个主要是在统计报表的场景，<br/></p>
<h2 id="1-47-Tomcat配置-部署优化"><a href="#1-47-Tomcat配置-部署优化" class="headerlink" title="1.47.Tomcat配置,部署优化"></a>1.47.Tomcat配置,部署优化</h2><p>答案：<br/></p>
<ol>
<li>内存优化:Tomcat依赖于JVM,可以配置JVM的内存配置<br/></li>
<li>最大连接数配置(并发能力)<br/><br>通常搭配Nginx提升Tomcat的并发性能<br/></li>
</ol>
<h2 id="1-48-自动刷新-定时刷新"><a href="#1-48-自动刷新-定时刷新" class="headerlink" title="1.48.自动刷新,定时刷新"></a>1.48.自动刷新,定时刷新</h2><p>答案：<br/></p>
<p>自动刷新不仅可以实现一段时间之后自动跳转到另一个页面，还可以实现一段时间之后自动刷新本页面。Servlet中通过HttpServletResponse对象设置Header属性实现自动刷新例如：<br/><br>Response.setHeader(“Refresh”,”1000;URL=<a href="http://localhost:8080/servlet/example.htm&quot;" target="_blank" rel="noopener">http://localhost:8080/servlet/example.htm&quot;</a>);<br/><br>其中1000为时间，单位为毫秒。URL指定就是要跳转的页面（如果设置自己的路径，就会实现没过一秒自动刷新本页面一次）<br/></p>
<h2 id="1-49-BS和CS的区别？"><a href="#1-49-BS和CS的区别？" class="headerlink" title="1.49.BS和CS的区别？"></a>1.49.BS和CS的区别？</h2><p>答案:<br/><br>1.C/S用户固定，并且处于相同区域，要求拥有相同的操作系统。B/S要有操作系统和浏览器就行。与操作系统平台无关。<br/><br>2.C/S客户端的计算机电脑配置要求较高。B/S客户端的计算机电脑配置要求较低。<br/><br>3.C/S每一个客户端都必须安装和配置软件,客户端不必安装，使用浏览器访问，易推广。B/S最大的优点就是可以在任何地方进行操作而不用安装任何专门的软件。<br/><br>4.C/S每一个客户端都要升级程序。可以采用自动升级。BS客户端不必安装及维护。<br/><br>5.C/S一般面向相对固定的用户群，程序更加注重流程，它可以对权限进行多层次校验，提供了更安全的存取模式，对信息安全的控制能力很强。一般高度机密的信息系统采用C/S结构适宜。<br/></p>
<h2 id="1-50-事务有哪些特性"><a href="#1-50-事务有哪些特性" class="headerlink" title="1.50.事务有哪些特性"></a>1.50.事务有哪些特性</h2><p>事务的特性:ACID<br/><br>A - 原子性 Atomic<br/><br>   数据操作的最小单元是事务，而不是SQL语句 <br/><br/><br>C - 一致性 Consistency<br/><br>转账前 a+b = 100<br/><br>转帐后 a+b = 100<br/><br/><br>I - 隔离性 Isolation<br/><br>一个事物进行中时，另一事物不能操作数据<br/><br>D - 持久性 Durancy<br/><br>事务没有提交之前，数据操作只保存在日志文件中<br/><br>提交事务之后，数据持久生效<br/></p>
]]></content>
      <categories>
        <category>面试题</category>
      </categories>
      <tags>
        <tag>web</tag>
      </tags>
  </entry>
</search>
